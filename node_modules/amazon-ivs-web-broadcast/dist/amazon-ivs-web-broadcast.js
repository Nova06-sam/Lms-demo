/*! For license information please see amazon-ivs-web-broadcast.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.IVSBroadcastClient=t():e.IVSBroadcastClient=t()}(self,(()=>(()=>{var e={2505:(e,t,n)=>{e.exports=n(8015)},5592:(e,t,n)=>{"use strict";var r=n(9516),i=n(7522),o=n(3948),s=n(9106),a=n(9615),c=n(2012),u=n(4202),l=n(4896),d=n(5845),h=n(8563),p=n(5656);e.exports=function(e){return new Promise((function(t,n){var f,g=e.data,m=e.headers,v=e.responseType;function E(){e.cancelToken&&e.cancelToken.unsubscribe(f),e.signal&&e.signal.removeEventListener("abort",f)}r.isFormData(g)&&r.isStandardBrowserEnv()&&delete m["Content-Type"];var S=new XMLHttpRequest;if(e.auth){var _=e.auth.username||"",y=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";m.Authorization="Basic "+btoa(_+":"+y)}var b=a(e.baseURL,e.url);function T(){if(S){var r="getAllResponseHeaders"in S?c(S.getAllResponseHeaders()):null,o={data:v&&"text"!==v&&"json"!==v?S.response:S.responseText,status:S.status,statusText:S.statusText,headers:r,config:e,request:S};i((function(e){t(e),E()}),(function(e){n(e),E()}),o),S=null}}if(S.open(e.method.toUpperCase(),s(b,e.params,e.paramsSerializer),!0),S.timeout=e.timeout,"onloadend"in S?S.onloadend=T:S.onreadystatechange=function(){S&&4===S.readyState&&(0!==S.status||S.responseURL&&0===S.responseURL.indexOf("file:"))&&setTimeout(T)},S.onabort=function(){S&&(n(new d("Request aborted",d.ECONNABORTED,e,S)),S=null)},S.onerror=function(){n(new d("Network Error",d.ERR_NETWORK,e,S,S)),S=null},S.ontimeout=function(){var t=e.timeout?"timeout of "+e.timeout+"ms exceeded":"timeout exceeded",r=e.transitional||l;e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),n(new d(t,r.clarifyTimeoutError?d.ETIMEDOUT:d.ECONNABORTED,e,S)),S=null},r.isStandardBrowserEnv()){var C=(e.withCredentials||u(b))&&e.xsrfCookieName?o.read(e.xsrfCookieName):void 0;C&&(m[e.xsrfHeaderName]=C)}"setRequestHeader"in S&&r.forEach(m,(function(e,t){void 0===g&&"content-type"===t.toLowerCase()?delete m[t]:S.setRequestHeader(t,e)})),r.isUndefined(e.withCredentials)||(S.withCredentials=!!e.withCredentials),v&&"json"!==v&&(S.responseType=e.responseType),"function"==typeof e.onDownloadProgress&&S.addEventListener("progress",e.onDownloadProgress),"function"==typeof e.onUploadProgress&&S.upload&&S.upload.addEventListener("progress",e.onUploadProgress),(e.cancelToken||e.signal)&&(f=function(e){S&&(n(!e||e&&e.type?new h:e),S.abort(),S=null)},e.cancelToken&&e.cancelToken.subscribe(f),e.signal&&(e.signal.aborted?f():e.signal.addEventListener("abort",f))),g||(g=null);var I=p(b);I&&-1===["http","https","file"].indexOf(I)?n(new d("Unsupported protocol "+I+":",d.ERR_BAD_REQUEST,e)):S.send(g)}))}},8015:(e,t,n)=>{"use strict";var r=n(9516),i=n(9012),o=n(5155),s=n(5343);var a=function e(t){var n=new o(t),a=i(o.prototype.request,n);return r.extend(a,o.prototype,n),r.extend(a,n),a.create=function(n){return e(s(t,n))},a}(n(7412));a.Axios=o,a.CanceledError=n(8563),a.CancelToken=n(3191),a.isCancel=n(3864),a.VERSION=n(9641).version,a.toFormData=n(6440),a.AxiosError=n(5845),a.Cancel=a.CanceledError,a.all=function(e){return Promise.all(e)},a.spread=n(7980),a.isAxiosError=n(5019),e.exports=a,e.exports.default=a},3191:(e,t,n)=>{"use strict";var r=n(8563);function i(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");var t;this.promise=new Promise((function(e){t=e}));var n=this;this.promise.then((function(e){if(n._listeners){var t,r=n._listeners.length;for(t=0;t<r;t++)n._listeners[t](e);n._listeners=null}})),this.promise.then=function(e){var t,r=new Promise((function(e){n.subscribe(e),t=e})).then(e);return r.cancel=function(){n.unsubscribe(t)},r},e((function(e){n.reason||(n.reason=new r(e),t(n.reason))}))}i.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},i.prototype.subscribe=function(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]},i.prototype.unsubscribe=function(e){if(this._listeners){var t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}},i.source=function(){var e;return{token:new i((function(t){e=t})),cancel:e}},e.exports=i},8563:(e,t,n)=>{"use strict";var r=n(5845);function i(e){r.call(this,null==e?"canceled":e,r.ERR_CANCELED),this.name="CanceledError"}n(9516).inherits(i,r,{__CANCEL__:!0}),e.exports=i},3864:e=>{"use strict";e.exports=function(e){return!(!e||!e.__CANCEL__)}},5155:(e,t,n)=>{"use strict";var r=n(9516),i=n(9106),o=n(3471),s=n(4490),a=n(5343),c=n(9615),u=n(4841),l=u.validators;function d(e){this.defaults=e,this.interceptors={request:new o,response:new o}}d.prototype.request=function(e,t){"string"==typeof e?(t=t||{}).url=e:t=e||{},(t=a(this.defaults,t)).method?t.method=t.method.toLowerCase():this.defaults.method?t.method=this.defaults.method.toLowerCase():t.method="get";var n=t.transitional;void 0!==n&&u.assertOptions(n,{silentJSONParsing:l.transitional(l.boolean),forcedJSONParsing:l.transitional(l.boolean),clarifyTimeoutError:l.transitional(l.boolean)},!1);var r=[],i=!0;this.interceptors.request.forEach((function(e){"function"==typeof e.runWhen&&!1===e.runWhen(t)||(i=i&&e.synchronous,r.unshift(e.fulfilled,e.rejected))}));var o,c=[];if(this.interceptors.response.forEach((function(e){c.push(e.fulfilled,e.rejected)})),!i){var d=[s,void 0];for(Array.prototype.unshift.apply(d,r),d=d.concat(c),o=Promise.resolve(t);d.length;)o=o.then(d.shift(),d.shift());return o}for(var h=t;r.length;){var p=r.shift(),f=r.shift();try{h=p(h)}catch(e){f(e);break}}try{o=s(h)}catch(e){return Promise.reject(e)}for(;c.length;)o=o.then(c.shift(),c.shift());return o},d.prototype.getUri=function(e){e=a(this.defaults,e);var t=c(e.baseURL,e.url);return i(t,e.params,e.paramsSerializer)},r.forEach(["delete","get","head","options"],(function(e){d.prototype[e]=function(t,n){return this.request(a(n||{},{method:e,url:t,data:(n||{}).data}))}})),r.forEach(["post","put","patch"],(function(e){function t(t){return function(n,r,i){return this.request(a(i||{},{method:e,headers:t?{"Content-Type":"multipart/form-data"}:{},url:n,data:r}))}}d.prototype[e]=t(),d.prototype[e+"Form"]=t(!0)})),e.exports=d},5845:(e,t,n)=>{"use strict";var r=n(9516);function i(e,t,n,r,i){Error.call(this),this.message=e,this.name="AxiosError",t&&(this.code=t),n&&(this.config=n),r&&(this.request=r),i&&(this.response=i)}r.inherits(i,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}}});var o=i.prototype,s={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED"].forEach((function(e){s[e]={value:e}})),Object.defineProperties(i,s),Object.defineProperty(o,"isAxiosError",{value:!0}),i.from=function(e,t,n,s,a,c){var u=Object.create(o);return r.toFlatObject(e,u,(function(e){return e!==Error.prototype})),i.call(u,e.message,t,n,s,a),u.name=e.name,c&&Object.assign(u,c),u},e.exports=i},3471:(e,t,n)=>{"use strict";var r=n(9516);function i(){this.handlers=[]}i.prototype.use=function(e,t,n){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!n&&n.synchronous,runWhen:n?n.runWhen:null}),this.handlers.length-1},i.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},i.prototype.forEach=function(e){r.forEach(this.handlers,(function(t){null!==t&&e(t)}))},e.exports=i},9615:(e,t,n)=>{"use strict";var r=n(9137),i=n(4680);e.exports=function(e,t){return e&&!r(t)?i(e,t):t}},4490:(e,t,n)=>{"use strict";var r=n(9516),i=n(2881),o=n(3864),s=n(7412),a=n(8563);function c(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new a}e.exports=function(e){return c(e),e.headers=e.headers||{},e.data=i.call(e,e.data,e.headers,e.transformRequest),e.headers=r.merge(e.headers.common||{},e.headers[e.method]||{},e.headers),r.forEach(["delete","get","head","post","put","patch","common"],(function(t){delete e.headers[t]})),(e.adapter||s.adapter)(e).then((function(t){return c(e),t.data=i.call(e,t.data,t.headers,e.transformResponse),t}),(function(t){return o(t)||(c(e),t&&t.response&&(t.response.data=i.call(e,t.response.data,t.response.headers,e.transformResponse))),Promise.reject(t)}))}},5343:(e,t,n)=>{"use strict";var r=n(9516);e.exports=function(e,t){t=t||{};var n={};function i(e,t){return r.isPlainObject(e)&&r.isPlainObject(t)?r.merge(e,t):r.isPlainObject(t)?r.merge({},t):r.isArray(t)?t.slice():t}function o(n){return r.isUndefined(t[n])?r.isUndefined(e[n])?void 0:i(void 0,e[n]):i(e[n],t[n])}function s(e){if(!r.isUndefined(t[e]))return i(void 0,t[e])}function a(n){return r.isUndefined(t[n])?r.isUndefined(e[n])?void 0:i(void 0,e[n]):i(void 0,t[n])}function c(n){return n in t?i(e[n],t[n]):n in e?i(void 0,e[n]):void 0}var u={url:s,method:s,data:s,baseURL:a,transformRequest:a,transformResponse:a,paramsSerializer:a,timeout:a,timeoutMessage:a,withCredentials:a,adapter:a,responseType:a,xsrfCookieName:a,xsrfHeaderName:a,onUploadProgress:a,onDownloadProgress:a,decompress:a,maxContentLength:a,maxBodyLength:a,beforeRedirect:a,transport:a,httpAgent:a,httpsAgent:a,cancelToken:a,socketPath:a,responseEncoding:a,validateStatus:c};return r.forEach(Object.keys(e).concat(Object.keys(t)),(function(e){var t=u[e]||o,i=t(e);r.isUndefined(i)&&t!==c||(n[e]=i)})),n}},7522:(e,t,n)=>{"use strict";var r=n(5845);e.exports=function(e,t,n){var i=n.config.validateStatus;n.status&&i&&!i(n.status)?t(new r("Request failed with status code "+n.status,[r.ERR_BAD_REQUEST,r.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n)):e(n)}},2881:(e,t,n)=>{"use strict";var r=n(9516),i=n(7412);e.exports=function(e,t,n){var o=this||i;return r.forEach(n,(function(n){e=n.call(o,e,t)})),e}},7412:(e,t,n)=>{"use strict";var r=n(9516),i=n(7018),o=n(5845),s=n(4896),a=n(6440),c={"Content-Type":"application/x-www-form-urlencoded"};function u(e,t){!r.isUndefined(e)&&r.isUndefined(e["Content-Type"])&&(e["Content-Type"]=t)}var l,d={transitional:s,adapter:(("undefined"!=typeof XMLHttpRequest||"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process))&&(l=n(5592)),l),transformRequest:[function(e,t){if(i(t,"Accept"),i(t,"Content-Type"),r.isFormData(e)||r.isArrayBuffer(e)||r.isBuffer(e)||r.isStream(e)||r.isFile(e)||r.isBlob(e))return e;if(r.isArrayBufferView(e))return e.buffer;if(r.isURLSearchParams(e))return u(t,"application/x-www-form-urlencoded;charset=utf-8"),e.toString();var n,o=r.isObject(e),s=t&&t["Content-Type"];if((n=r.isFileList(e))||o&&"multipart/form-data"===s){var c=this.env&&this.env.FormData;return a(n?{"files[]":e}:e,c&&new c)}return o||"application/json"===s?(u(t,"application/json"),function(e,t,n){if(r.isString(e))try{return(t||JSON.parse)(e),r.trim(e)}catch(e){if("SyntaxError"!==e.name)throw e}return(n||JSON.stringify)(e)}(e)):e}],transformResponse:[function(e){var t=this.transitional||d.transitional,n=t&&t.silentJSONParsing,i=t&&t.forcedJSONParsing,s=!n&&"json"===this.responseType;if(s||i&&r.isString(e)&&e.length)try{return JSON.parse(e)}catch(e){if(s){if("SyntaxError"===e.name)throw o.from(e,o.ERR_BAD_RESPONSE,this,null,this.response);throw e}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:n(1534)},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};r.forEach(["delete","get","head"],(function(e){d.headers[e]={}})),r.forEach(["post","put","patch"],(function(e){d.headers[e]=r.merge(c)})),e.exports=d},4896:e=>{"use strict";e.exports={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1}},9641:e=>{e.exports={version:"0.27.2"}},9012:e=>{"use strict";e.exports=function(e,t){return function(){for(var n=new Array(arguments.length),r=0;r<n.length;r++)n[r]=arguments[r];return e.apply(t,n)}}},9106:(e,t,n)=>{"use strict";var r=n(9516);function i(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}e.exports=function(e,t,n){if(!t)return e;var o;if(n)o=n(t);else if(r.isURLSearchParams(t))o=t.toString();else{var s=[];r.forEach(t,(function(e,t){null!=e&&(r.isArray(e)?t+="[]":e=[e],r.forEach(e,(function(e){r.isDate(e)?e=e.toISOString():r.isObject(e)&&(e=JSON.stringify(e)),s.push(i(t)+"="+i(e))})))})),o=s.join("&")}if(o){var a=e.indexOf("#");-1!==a&&(e=e.slice(0,a)),e+=(-1===e.indexOf("?")?"?":"&")+o}return e}},4680:e=>{"use strict";e.exports=function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}},3948:(e,t,n)=>{"use strict";var r=n(9516);e.exports=r.isStandardBrowserEnv()?{write:function(e,t,n,i,o,s){var a=[];a.push(e+"="+encodeURIComponent(t)),r.isNumber(n)&&a.push("expires="+new Date(n).toGMTString()),r.isString(i)&&a.push("path="+i),r.isString(o)&&a.push("domain="+o),!0===s&&a.push("secure"),document.cookie=a.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}}},9137:e=>{"use strict";e.exports=function(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)}},5019:(e,t,n)=>{"use strict";var r=n(9516);e.exports=function(e){return r.isObject(e)&&!0===e.isAxiosError}},4202:(e,t,n)=>{"use strict";var r=n(9516);e.exports=r.isStandardBrowserEnv()?function(){var e,t=/(msie|trident)/i.test(navigator.userAgent),n=document.createElement("a");function i(e){var r=e;return t&&(n.setAttribute("href",r),r=n.href),n.setAttribute("href",r),{href:n.href,protocol:n.protocol?n.protocol.replace(/:$/,""):"",host:n.host,search:n.search?n.search.replace(/^\?/,""):"",hash:n.hash?n.hash.replace(/^#/,""):"",hostname:n.hostname,port:n.port,pathname:"/"===n.pathname.charAt(0)?n.pathname:"/"+n.pathname}}return e=i(window.location.href),function(t){var n=r.isString(t)?i(t):t;return n.protocol===e.protocol&&n.host===e.host}}():function(){return!0}},7018:(e,t,n)=>{"use strict";var r=n(9516);e.exports=function(e,t){r.forEach(e,(function(n,r){r!==t&&r.toUpperCase()===t.toUpperCase()&&(e[t]=n,delete e[r])}))}},1534:e=>{e.exports=null},2012:(e,t,n)=>{"use strict";var r=n(9516),i=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];e.exports=function(e){var t,n,o,s={};return e?(r.forEach(e.split("\n"),(function(e){if(o=e.indexOf(":"),t=r.trim(e.substr(0,o)).toLowerCase(),n=r.trim(e.substr(o+1)),t){if(s[t]&&i.indexOf(t)>=0)return;s[t]="set-cookie"===t?(s[t]?s[t]:[]).concat([n]):s[t]?s[t]+", "+n:n}})),s):s}},5656:e=>{"use strict";e.exports=function(e){var t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(e);return t&&t[1]||""}},7980:e=>{"use strict";e.exports=function(e){return function(t){return e.apply(null,t)}}},6440:(e,t,n)=>{"use strict";var r=n(9516);e.exports=function(e,t){t=t||new FormData;var n=[];function i(e){return null===e?"":r.isDate(e)?e.toISOString():r.isArrayBuffer(e)||r.isTypedArray(e)?"function"==typeof Blob?new Blob([e]):Buffer.from(e):e}return function e(o,s){if(r.isPlainObject(o)||r.isArray(o)){if(-1!==n.indexOf(o))throw Error("Circular reference detected in "+s);n.push(o),r.forEach(o,(function(n,o){if(!r.isUndefined(n)){var a,c=s?s+"."+o:o;if(n&&!s&&"object"==typeof n)if(r.endsWith(o,"{}"))n=JSON.stringify(n);else if(r.endsWith(o,"[]")&&(a=r.toArray(n)))return void a.forEach((function(e){!r.isUndefined(e)&&t.append(c,i(e))}));e(n,c)}})),n.pop()}else t.append(s,i(o))}(e),t}},4841:(e,t,n)=>{"use strict";var r=n(9641).version,i=n(5845),o={};["object","boolean","number","function","string","symbol"].forEach((function(e,t){o[e]=function(n){return typeof n===e||"a"+(t<1?"n ":" ")+e}}));var s={};o.transitional=function(e,t,n){function o(e,t){return"[Axios v"+r+"] Transitional option '"+e+"'"+t+(n?". "+n:"")}return function(n,r,a){if(!1===e)throw new i(o(r," has been removed"+(t?" in "+t:"")),i.ERR_DEPRECATED);return t&&!s[r]&&(s[r]=!0,console.warn(o(r," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(n,r,a)}},e.exports={assertOptions:function(e,t,n){if("object"!=typeof e)throw new i("options must be an object",i.ERR_BAD_OPTION_VALUE);for(var r=Object.keys(e),o=r.length;o-- >0;){var s=r[o],a=t[s];if(a){var c=e[s],u=void 0===c||a(c,s,e);if(!0!==u)throw new i("option "+s+" must be "+u,i.ERR_BAD_OPTION_VALUE)}else if(!0!==n)throw new i("Unknown option "+s,i.ERR_BAD_OPTION)}},validators:o}},9516:(e,t,n)=>{"use strict";var r,i=n(9012),o=Object.prototype.toString,s=(r=Object.create(null),function(e){var t=o.call(e);return r[t]||(r[t]=t.slice(8,-1).toLowerCase())});function a(e){return e=e.toLowerCase(),function(t){return s(t)===e}}function c(e){return Array.isArray(e)}function u(e){return void 0===e}var l=a("ArrayBuffer");function d(e){return null!==e&&"object"==typeof e}function h(e){if("object"!==s(e))return!1;var t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}var p=a("Date"),f=a("File"),g=a("Blob"),m=a("FileList");function v(e){return"[object Function]"===o.call(e)}var E=a("URLSearchParams");function S(e,t){if(null!=e)if("object"!=typeof e&&(e=[e]),c(e))for(var n=0,r=e.length;n<r;n++)t.call(null,e[n],n,e);else for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.call(null,e[i],i,e)}var _,y=(_="undefined"!=typeof Uint8Array&&Object.getPrototypeOf(Uint8Array),function(e){return _&&e instanceof _});e.exports={isArray:c,isArrayBuffer:l,isBuffer:function(e){return null!==e&&!u(e)&&null!==e.constructor&&!u(e.constructor)&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)},isFormData:function(e){var t="[object FormData]";return e&&("function"==typeof FormData&&e instanceof FormData||o.call(e)===t||v(e.toString)&&e.toString()===t)},isArrayBufferView:function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&l(e.buffer)},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isObject:d,isPlainObject:h,isUndefined:u,isDate:p,isFile:f,isBlob:g,isFunction:v,isStream:function(e){return d(e)&&v(e.pipe)},isURLSearchParams:E,isStandardBrowserEnv:function(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&("undefined"!=typeof window&&"undefined"!=typeof document)},forEach:S,merge:function e(){var t={};function n(n,r){h(t[r])&&h(n)?t[r]=e(t[r],n):h(n)?t[r]=e({},n):c(n)?t[r]=n.slice():t[r]=n}for(var r=0,i=arguments.length;r<i;r++)S(arguments[r],n);return t},extend:function(e,t,n){return S(t,(function(t,r){e[r]=n&&"function"==typeof t?i(t,n):t})),e},trim:function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")},stripBOM:function(e){return 65279===e.charCodeAt(0)&&(e=e.slice(1)),e},inherits:function(e,t,n,r){e.prototype=Object.create(t.prototype,r),e.prototype.constructor=e,n&&Object.assign(e.prototype,n)},toFlatObject:function(e,t,n){var r,i,o,s={};t=t||{};do{for(i=(r=Object.getOwnPropertyNames(e)).length;i-- >0;)s[o=r[i]]||(t[o]=e[o],s[o]=!0);e=Object.getPrototypeOf(e)}while(e&&(!n||n(e,t))&&e!==Object.prototype);return t},kindOf:s,kindOfTest:a,endsWith:function(e,t,n){e=String(e),(void 0===n||n>e.length)&&(n=e.length),n-=t.length;var r=e.indexOf(t,n);return-1!==r&&r===n},toArray:function(e){if(!e)return null;var t=e.length;if(u(t))return null;for(var n=new Array(t);t-- >0;)n[t]=e[t];return n},isTypedArray:y,isFileList:m}},6880:function(e){e.exports=function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=90)}({17:function(e,t,n){"use strict";t.__esModule=!0,t.default=void 0;var r=n(18),i=function(){function e(){}return e.getFirstMatch=function(e,t){var n=t.match(e);return n&&n.length>0&&n[1]||""},e.getSecondMatch=function(e,t){var n=t.match(e);return n&&n.length>1&&n[2]||""},e.matchAndReturnConst=function(e,t,n){if(e.test(t))return n},e.getWindowsVersionName=function(e){switch(e){case"NT":return"NT";case"XP":case"NT 5.1":return"XP";case"NT 5.0":return"2000";case"NT 5.2":return"2003";case"NT 6.0":return"Vista";case"NT 6.1":return"7";case"NT 6.2":return"8";case"NT 6.3":return"8.1";case"NT 10.0":return"10";default:return}},e.getMacOSVersionName=function(e){var t=e.split(".").splice(0,2).map((function(e){return parseInt(e,10)||0}));if(t.push(0),10===t[0])switch(t[1]){case 5:return"Leopard";case 6:return"Snow Leopard";case 7:return"Lion";case 8:return"Mountain Lion";case 9:return"Mavericks";case 10:return"Yosemite";case 11:return"El Capitan";case 12:return"Sierra";case 13:return"High Sierra";case 14:return"Mojave";case 15:return"Catalina";default:return}},e.getAndroidVersionName=function(e){var t=e.split(".").splice(0,2).map((function(e){return parseInt(e,10)||0}));if(t.push(0),!(1===t[0]&&t[1]<5))return 1===t[0]&&t[1]<6?"Cupcake":1===t[0]&&t[1]>=6?"Donut":2===t[0]&&t[1]<2?"Eclair":2===t[0]&&2===t[1]?"Froyo":2===t[0]&&t[1]>2?"Gingerbread":3===t[0]?"Honeycomb":4===t[0]&&t[1]<1?"Ice Cream Sandwich":4===t[0]&&t[1]<4?"Jelly Bean":4===t[0]&&t[1]>=4?"KitKat":5===t[0]?"Lollipop":6===t[0]?"Marshmallow":7===t[0]?"Nougat":8===t[0]?"Oreo":9===t[0]?"Pie":void 0},e.getVersionPrecision=function(e){return e.split(".").length},e.compareVersions=function(t,n,r){void 0===r&&(r=!1);var i=e.getVersionPrecision(t),o=e.getVersionPrecision(n),s=Math.max(i,o),a=0,c=e.map([t,n],(function(t){var n=s-e.getVersionPrecision(t),r=t+new Array(n+1).join(".0");return e.map(r.split("."),(function(e){return new Array(20-e.length).join("0")+e})).reverse()}));for(r&&(a=s-Math.min(i,o)),s-=1;s>=a;){if(c[0][s]>c[1][s])return 1;if(c[0][s]===c[1][s]){if(s===a)return 0;s-=1}else if(c[0][s]<c[1][s])return-1}},e.map=function(e,t){var n,r=[];if(Array.prototype.map)return Array.prototype.map.call(e,t);for(n=0;n<e.length;n+=1)r.push(t(e[n]));return r},e.find=function(e,t){var n,r;if(Array.prototype.find)return Array.prototype.find.call(e,t);for(n=0,r=e.length;n<r;n+=1){var i=e[n];if(t(i,n))return i}},e.assign=function(e){for(var t,n,r=e,i=arguments.length,o=new Array(i>1?i-1:0),s=1;s<i;s++)o[s-1]=arguments[s];if(Object.assign)return Object.assign.apply(Object,[e].concat(o));var a=function(){var e=o[t];"object"==typeof e&&null!==e&&Object.keys(e).forEach((function(t){r[t]=e[t]}))};for(t=0,n=o.length;t<n;t+=1)a();return e},e.getBrowserAlias=function(e){return r.BROWSER_ALIASES_MAP[e]},e.getBrowserTypeByAlias=function(e){return r.BROWSER_MAP[e]||""},e}();t.default=i,e.exports=t.default},18:function(e,t,n){"use strict";t.__esModule=!0,t.ENGINE_MAP=t.OS_MAP=t.PLATFORMS_MAP=t.BROWSER_MAP=t.BROWSER_ALIASES_MAP=void 0,t.BROWSER_ALIASES_MAP={"Amazon Silk":"amazon_silk","Android Browser":"android",Bada:"bada",BlackBerry:"blackberry",Chrome:"chrome",Chromium:"chromium",Electron:"electron",Epiphany:"epiphany",Firefox:"firefox",Focus:"focus",Generic:"generic","Google Search":"google_search",Googlebot:"googlebot","Internet Explorer":"ie","K-Meleon":"k_meleon",Maxthon:"maxthon","Microsoft Edge":"edge","MZ Browser":"mz","NAVER Whale Browser":"naver",Opera:"opera","Opera Coast":"opera_coast",PhantomJS:"phantomjs",Puffin:"puffin",QupZilla:"qupzilla",QQ:"qq",QQLite:"qqlite",Safari:"safari",Sailfish:"sailfish","Samsung Internet for Android":"samsung_internet",SeaMonkey:"seamonkey",Sleipnir:"sleipnir",Swing:"swing",Tizen:"tizen","UC Browser":"uc",Vivaldi:"vivaldi","WebOS Browser":"webos",WeChat:"wechat","Yandex Browser":"yandex",Roku:"roku"},t.BROWSER_MAP={amazon_silk:"Amazon Silk",android:"Android Browser",bada:"Bada",blackberry:"BlackBerry",chrome:"Chrome",chromium:"Chromium",electron:"Electron",epiphany:"Epiphany",firefox:"Firefox",focus:"Focus",generic:"Generic",googlebot:"Googlebot",google_search:"Google Search",ie:"Internet Explorer",k_meleon:"K-Meleon",maxthon:"Maxthon",edge:"Microsoft Edge",mz:"MZ Browser",naver:"NAVER Whale Browser",opera:"Opera",opera_coast:"Opera Coast",phantomjs:"PhantomJS",puffin:"Puffin",qupzilla:"QupZilla",qq:"QQ Browser",qqlite:"QQ Browser Lite",safari:"Safari",sailfish:"Sailfish",samsung_internet:"Samsung Internet for Android",seamonkey:"SeaMonkey",sleipnir:"Sleipnir",swing:"Swing",tizen:"Tizen",uc:"UC Browser",vivaldi:"Vivaldi",webos:"WebOS Browser",wechat:"WeChat",yandex:"Yandex Browser"},t.PLATFORMS_MAP={tablet:"tablet",mobile:"mobile",desktop:"desktop",tv:"tv"},t.OS_MAP={WindowsPhone:"Windows Phone",Windows:"Windows",MacOS:"macOS",iOS:"iOS",Android:"Android",WebOS:"WebOS",BlackBerry:"BlackBerry",Bada:"Bada",Tizen:"Tizen",Linux:"Linux",ChromeOS:"Chrome OS",PlayStation4:"PlayStation 4",Roku:"Roku"},t.ENGINE_MAP={EdgeHTML:"EdgeHTML",Blink:"Blink",Trident:"Trident",Presto:"Presto",Gecko:"Gecko",WebKit:"WebKit"}},90:function(e,t,n){"use strict";t.__esModule=!0,t.default=void 0;var r,i=(r=n(91))&&r.__esModule?r:{default:r},o=n(18);function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var a=function(){function e(){}var t,n,r;return e.getParser=function(e,t){if(void 0===t&&(t=!1),"string"!=typeof e)throw new Error("UserAgent should be a string");return new i.default(e,t)},e.parse=function(e){return new i.default(e).getResult()},t=e,r=[{key:"BROWSER_MAP",get:function(){return o.BROWSER_MAP}},{key:"ENGINE_MAP",get:function(){return o.ENGINE_MAP}},{key:"OS_MAP",get:function(){return o.OS_MAP}},{key:"PLATFORMS_MAP",get:function(){return o.PLATFORMS_MAP}}],(n=null)&&s(t.prototype,n),r&&s(t,r),e}();t.default=a,e.exports=t.default},91:function(e,t,n){"use strict";t.__esModule=!0,t.default=void 0;var r=c(n(92)),i=c(n(93)),o=c(n(94)),s=c(n(95)),a=c(n(17));function c(e){return e&&e.__esModule?e:{default:e}}var u=function(){function e(e,t){if(void 0===t&&(t=!1),null==e||""===e)throw new Error("UserAgent parameter can't be empty");this._ua=e,this.parsedResult={},!0!==t&&this.parse()}var t=e.prototype;return t.getUA=function(){return this._ua},t.test=function(e){return e.test(this._ua)},t.parseBrowser=function(){var e=this;this.parsedResult.browser={};var t=a.default.find(r.default,(function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some((function(t){return e.test(t)}));throw new Error("Browser's test function is not valid")}));return t&&(this.parsedResult.browser=t.describe(this.getUA())),this.parsedResult.browser},t.getBrowser=function(){return this.parsedResult.browser?this.parsedResult.browser:this.parseBrowser()},t.getBrowserName=function(e){return e?String(this.getBrowser().name).toLowerCase()||"":this.getBrowser().name||""},t.getBrowserVersion=function(){return this.getBrowser().version},t.getOS=function(){return this.parsedResult.os?this.parsedResult.os:this.parseOS()},t.parseOS=function(){var e=this;this.parsedResult.os={};var t=a.default.find(i.default,(function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some((function(t){return e.test(t)}));throw new Error("Browser's test function is not valid")}));return t&&(this.parsedResult.os=t.describe(this.getUA())),this.parsedResult.os},t.getOSName=function(e){var t=this.getOS().name;return e?String(t).toLowerCase()||"":t||""},t.getOSVersion=function(){return this.getOS().version},t.getPlatform=function(){return this.parsedResult.platform?this.parsedResult.platform:this.parsePlatform()},t.getPlatformType=function(e){void 0===e&&(e=!1);var t=this.getPlatform().type;return e?String(t).toLowerCase()||"":t||""},t.parsePlatform=function(){var e=this;this.parsedResult.platform={};var t=a.default.find(o.default,(function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some((function(t){return e.test(t)}));throw new Error("Browser's test function is not valid")}));return t&&(this.parsedResult.platform=t.describe(this.getUA())),this.parsedResult.platform},t.getEngine=function(){return this.parsedResult.engine?this.parsedResult.engine:this.parseEngine()},t.getEngineName=function(e){return e?String(this.getEngine().name).toLowerCase()||"":this.getEngine().name||""},t.parseEngine=function(){var e=this;this.parsedResult.engine={};var t=a.default.find(s.default,(function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some((function(t){return e.test(t)}));throw new Error("Browser's test function is not valid")}));return t&&(this.parsedResult.engine=t.describe(this.getUA())),this.parsedResult.engine},t.parse=function(){return this.parseBrowser(),this.parseOS(),this.parsePlatform(),this.parseEngine(),this},t.getResult=function(){return a.default.assign({},this.parsedResult)},t.satisfies=function(e){var t=this,n={},r=0,i={},o=0;if(Object.keys(e).forEach((function(t){var s=e[t];"string"==typeof s?(i[t]=s,o+=1):"object"==typeof s&&(n[t]=s,r+=1)})),r>0){var s=Object.keys(n),c=a.default.find(s,(function(e){return t.isOS(e)}));if(c){var u=this.satisfies(n[c]);if(void 0!==u)return u}var l=a.default.find(s,(function(e){return t.isPlatform(e)}));if(l){var d=this.satisfies(n[l]);if(void 0!==d)return d}}if(o>0){var h=Object.keys(i),p=a.default.find(h,(function(e){return t.isBrowser(e,!0)}));if(void 0!==p)return this.compareVersion(i[p])}},t.isBrowser=function(e,t){void 0===t&&(t=!1);var n=this.getBrowserName().toLowerCase(),r=e.toLowerCase(),i=a.default.getBrowserTypeByAlias(r);return t&&i&&(r=i.toLowerCase()),r===n},t.compareVersion=function(e){var t=[0],n=e,r=!1,i=this.getBrowserVersion();if("string"==typeof i)return">"===e[0]||"<"===e[0]?(n=e.substr(1),"="===e[1]?(r=!0,n=e.substr(2)):t=[],">"===e[0]?t.push(1):t.push(-1)):"="===e[0]?n=e.substr(1):"~"===e[0]&&(r=!0,n=e.substr(1)),t.indexOf(a.default.compareVersions(i,n,r))>-1},t.isOS=function(e){return this.getOSName(!0)===String(e).toLowerCase()},t.isPlatform=function(e){return this.getPlatformType(!0)===String(e).toLowerCase()},t.isEngine=function(e){return this.getEngineName(!0)===String(e).toLowerCase()},t.is=function(e,t){return void 0===t&&(t=!1),this.isBrowser(e,t)||this.isOS(e)||this.isPlatform(e)},t.some=function(e){var t=this;return void 0===e&&(e=[]),e.some((function(e){return t.is(e)}))},e}();t.default=u,e.exports=t.default},92:function(e,t,n){"use strict";t.__esModule=!0,t.default=void 0;var r,i=(r=n(17))&&r.__esModule?r:{default:r},o=/version\/(\d+(\.?_?\d+)+)/i,s=[{test:[/googlebot/i],describe:function(e){var t={name:"Googlebot"},n=i.default.getFirstMatch(/googlebot\/(\d+(\.\d+))/i,e)||i.default.getFirstMatch(o,e);return n&&(t.version=n),t}},{test:[/opera/i],describe:function(e){var t={name:"Opera"},n=i.default.getFirstMatch(o,e)||i.default.getFirstMatch(/(?:opera)[\s/](\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/opr\/|opios/i],describe:function(e){var t={name:"Opera"},n=i.default.getFirstMatch(/(?:opr|opios)[\s/](\S+)/i,e)||i.default.getFirstMatch(o,e);return n&&(t.version=n),t}},{test:[/SamsungBrowser/i],describe:function(e){var t={name:"Samsung Internet for Android"},n=i.default.getFirstMatch(o,e)||i.default.getFirstMatch(/(?:SamsungBrowser)[\s/](\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/Whale/i],describe:function(e){var t={name:"NAVER Whale Browser"},n=i.default.getFirstMatch(o,e)||i.default.getFirstMatch(/(?:whale)[\s/](\d+(?:\.\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/MZBrowser/i],describe:function(e){var t={name:"MZ Browser"},n=i.default.getFirstMatch(/(?:MZBrowser)[\s/](\d+(?:\.\d+)+)/i,e)||i.default.getFirstMatch(o,e);return n&&(t.version=n),t}},{test:[/focus/i],describe:function(e){var t={name:"Focus"},n=i.default.getFirstMatch(/(?:focus)[\s/](\d+(?:\.\d+)+)/i,e)||i.default.getFirstMatch(o,e);return n&&(t.version=n),t}},{test:[/swing/i],describe:function(e){var t={name:"Swing"},n=i.default.getFirstMatch(/(?:swing)[\s/](\d+(?:\.\d+)+)/i,e)||i.default.getFirstMatch(o,e);return n&&(t.version=n),t}},{test:[/coast/i],describe:function(e){var t={name:"Opera Coast"},n=i.default.getFirstMatch(o,e)||i.default.getFirstMatch(/(?:coast)[\s/](\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/opt\/\d+(?:.?_?\d+)+/i],describe:function(e){var t={name:"Opera Touch"},n=i.default.getFirstMatch(/(?:opt)[\s/](\d+(\.?_?\d+)+)/i,e)||i.default.getFirstMatch(o,e);return n&&(t.version=n),t}},{test:[/yabrowser/i],describe:function(e){var t={name:"Yandex Browser"},n=i.default.getFirstMatch(/(?:yabrowser)[\s/](\d+(\.?_?\d+)+)/i,e)||i.default.getFirstMatch(o,e);return n&&(t.version=n),t}},{test:[/ucbrowser/i],describe:function(e){var t={name:"UC Browser"},n=i.default.getFirstMatch(o,e)||i.default.getFirstMatch(/(?:ucbrowser)[\s/](\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/Maxthon|mxios/i],describe:function(e){var t={name:"Maxthon"},n=i.default.getFirstMatch(o,e)||i.default.getFirstMatch(/(?:Maxthon|mxios)[\s/](\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/epiphany/i],describe:function(e){var t={name:"Epiphany"},n=i.default.getFirstMatch(o,e)||i.default.getFirstMatch(/(?:epiphany)[\s/](\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/puffin/i],describe:function(e){var t={name:"Puffin"},n=i.default.getFirstMatch(o,e)||i.default.getFirstMatch(/(?:puffin)[\s/](\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/sleipnir/i],describe:function(e){var t={name:"Sleipnir"},n=i.default.getFirstMatch(o,e)||i.default.getFirstMatch(/(?:sleipnir)[\s/](\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/k-meleon/i],describe:function(e){var t={name:"K-Meleon"},n=i.default.getFirstMatch(o,e)||i.default.getFirstMatch(/(?:k-meleon)[\s/](\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/micromessenger/i],describe:function(e){var t={name:"WeChat"},n=i.default.getFirstMatch(/(?:micromessenger)[\s/](\d+(\.?_?\d+)+)/i,e)||i.default.getFirstMatch(o,e);return n&&(t.version=n),t}},{test:[/qqbrowser/i],describe:function(e){var t={name:/qqbrowserlite/i.test(e)?"QQ Browser Lite":"QQ Browser"},n=i.default.getFirstMatch(/(?:qqbrowserlite|qqbrowser)[/](\d+(\.?_?\d+)+)/i,e)||i.default.getFirstMatch(o,e);return n&&(t.version=n),t}},{test:[/msie|trident/i],describe:function(e){var t={name:"Internet Explorer"},n=i.default.getFirstMatch(/(?:msie |rv:)(\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/\sedg\//i],describe:function(e){var t={name:"Microsoft Edge"},n=i.default.getFirstMatch(/\sedg\/(\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/edg([ea]|ios)/i],describe:function(e){var t={name:"Microsoft Edge"},n=i.default.getSecondMatch(/edg([ea]|ios)\/(\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/vivaldi/i],describe:function(e){var t={name:"Vivaldi"},n=i.default.getFirstMatch(/vivaldi\/(\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/seamonkey/i],describe:function(e){var t={name:"SeaMonkey"},n=i.default.getFirstMatch(/seamonkey\/(\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/sailfish/i],describe:function(e){var t={name:"Sailfish"},n=i.default.getFirstMatch(/sailfish\s?browser\/(\d+(\.\d+)?)/i,e);return n&&(t.version=n),t}},{test:[/silk/i],describe:function(e){var t={name:"Amazon Silk"},n=i.default.getFirstMatch(/silk\/(\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/phantom/i],describe:function(e){var t={name:"PhantomJS"},n=i.default.getFirstMatch(/phantomjs\/(\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/slimerjs/i],describe:function(e){var t={name:"SlimerJS"},n=i.default.getFirstMatch(/slimerjs\/(\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe:function(e){var t={name:"BlackBerry"},n=i.default.getFirstMatch(o,e)||i.default.getFirstMatch(/blackberry[\d]+\/(\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/(web|hpw)[o0]s/i],describe:function(e){var t={name:"WebOS Browser"},n=i.default.getFirstMatch(o,e)||i.default.getFirstMatch(/w(?:eb)?[o0]sbrowser\/(\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/bada/i],describe:function(e){var t={name:"Bada"},n=i.default.getFirstMatch(/dolfin\/(\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/tizen/i],describe:function(e){var t={name:"Tizen"},n=i.default.getFirstMatch(/(?:tizen\s?)?browser\/(\d+(\.?_?\d+)+)/i,e)||i.default.getFirstMatch(o,e);return n&&(t.version=n),t}},{test:[/qupzilla/i],describe:function(e){var t={name:"QupZilla"},n=i.default.getFirstMatch(/(?:qupzilla)[\s/](\d+(\.?_?\d+)+)/i,e)||i.default.getFirstMatch(o,e);return n&&(t.version=n),t}},{test:[/firefox|iceweasel|fxios/i],describe:function(e){var t={name:"Firefox"},n=i.default.getFirstMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/electron/i],describe:function(e){var t={name:"Electron"},n=i.default.getFirstMatch(/(?:electron)\/(\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/MiuiBrowser/i],describe:function(e){var t={name:"Miui"},n=i.default.getFirstMatch(/(?:MiuiBrowser)[\s/](\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/chromium/i],describe:function(e){var t={name:"Chromium"},n=i.default.getFirstMatch(/(?:chromium)[\s/](\d+(\.?_?\d+)+)/i,e)||i.default.getFirstMatch(o,e);return n&&(t.version=n),t}},{test:[/chrome|crios|crmo/i],describe:function(e){var t={name:"Chrome"},n=i.default.getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/GSA/i],describe:function(e){var t={name:"Google Search"},n=i.default.getFirstMatch(/(?:GSA)\/(\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:function(e){var t=!e.test(/like android/i),n=e.test(/android/i);return t&&n},describe:function(e){var t={name:"Android Browser"},n=i.default.getFirstMatch(o,e);return n&&(t.version=n),t}},{test:[/playstation 4/i],describe:function(e){var t={name:"PlayStation 4"},n=i.default.getFirstMatch(o,e);return n&&(t.version=n),t}},{test:[/safari|applewebkit/i],describe:function(e){var t={name:"Safari"},n=i.default.getFirstMatch(o,e);return n&&(t.version=n),t}},{test:[/.*/i],describe:function(e){var t=-1!==e.search("\\(")?/^(.*)\/(.*)[ \t]\((.*)/:/^(.*)\/(.*) /;return{name:i.default.getFirstMatch(t,e),version:i.default.getSecondMatch(t,e)}}}];t.default=s,e.exports=t.default},93:function(e,t,n){"use strict";t.__esModule=!0,t.default=void 0;var r,i=(r=n(17))&&r.__esModule?r:{default:r},o=n(18),s=[{test:[/Roku\/DVP/],describe:function(e){var t=i.default.getFirstMatch(/Roku\/DVP-(\d+\.\d+)/i,e);return{name:o.OS_MAP.Roku,version:t}}},{test:[/windows phone/i],describe:function(e){var t=i.default.getFirstMatch(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i,e);return{name:o.OS_MAP.WindowsPhone,version:t}}},{test:[/windows /i],describe:function(e){var t=i.default.getFirstMatch(/Windows ((NT|XP)( \d\d?.\d)?)/i,e),n=i.default.getWindowsVersionName(t);return{name:o.OS_MAP.Windows,version:t,versionName:n}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:function(e){var t={name:o.OS_MAP.iOS},n=i.default.getSecondMatch(/(Version\/)(\d[\d.]+)/,e);return n&&(t.version=n),t}},{test:[/macintosh/i],describe:function(e){var t=i.default.getFirstMatch(/mac os x (\d+(\.?_?\d+)+)/i,e).replace(/[_\s]/g,"."),n=i.default.getMacOSVersionName(t),r={name:o.OS_MAP.MacOS,version:t};return n&&(r.versionName=n),r}},{test:[/(ipod|iphone|ipad)/i],describe:function(e){var t=i.default.getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i,e).replace(/[_\s]/g,".");return{name:o.OS_MAP.iOS,version:t}}},{test:function(e){var t=!e.test(/like android/i),n=e.test(/android/i);return t&&n},describe:function(e){var t=i.default.getFirstMatch(/android[\s/-](\d+(\.\d+)*)/i,e),n=i.default.getAndroidVersionName(t),r={name:o.OS_MAP.Android,version:t};return n&&(r.versionName=n),r}},{test:[/(web|hpw)[o0]s/i],describe:function(e){var t=i.default.getFirstMatch(/(?:web|hpw)[o0]s\/(\d+(\.\d+)*)/i,e),n={name:o.OS_MAP.WebOS};return t&&t.length&&(n.version=t),n}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe:function(e){var t=i.default.getFirstMatch(/rim\stablet\sos\s(\d+(\.\d+)*)/i,e)||i.default.getFirstMatch(/blackberry\d+\/(\d+([_\s]\d+)*)/i,e)||i.default.getFirstMatch(/\bbb(\d+)/i,e);return{name:o.OS_MAP.BlackBerry,version:t}}},{test:[/bada/i],describe:function(e){var t=i.default.getFirstMatch(/bada\/(\d+(\.\d+)*)/i,e);return{name:o.OS_MAP.Bada,version:t}}},{test:[/tizen/i],describe:function(e){var t=i.default.getFirstMatch(/tizen[/\s](\d+(\.\d+)*)/i,e);return{name:o.OS_MAP.Tizen,version:t}}},{test:[/linux/i],describe:function(){return{name:o.OS_MAP.Linux}}},{test:[/CrOS/],describe:function(){return{name:o.OS_MAP.ChromeOS}}},{test:[/PlayStation 4/],describe:function(e){var t=i.default.getFirstMatch(/PlayStation 4[/\s](\d+(\.\d+)*)/i,e);return{name:o.OS_MAP.PlayStation4,version:t}}}];t.default=s,e.exports=t.default},94:function(e,t,n){"use strict";t.__esModule=!0,t.default=void 0;var r,i=(r=n(17))&&r.__esModule?r:{default:r},o=n(18),s=[{test:[/googlebot/i],describe:function(){return{type:"bot",vendor:"Google"}}},{test:[/huawei/i],describe:function(e){var t=i.default.getFirstMatch(/(can-l01)/i,e)&&"Nova",n={type:o.PLATFORMS_MAP.mobile,vendor:"Huawei"};return t&&(n.model=t),n}},{test:[/nexus\s*(?:7|8|9|10).*/i],describe:function(){return{type:o.PLATFORMS_MAP.tablet,vendor:"Nexus"}}},{test:[/ipad/i],describe:function(){return{type:o.PLATFORMS_MAP.tablet,vendor:"Apple",model:"iPad"}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:function(){return{type:o.PLATFORMS_MAP.tablet,vendor:"Apple",model:"iPad"}}},{test:[/kftt build/i],describe:function(){return{type:o.PLATFORMS_MAP.tablet,vendor:"Amazon",model:"Kindle Fire HD 7"}}},{test:[/silk/i],describe:function(){return{type:o.PLATFORMS_MAP.tablet,vendor:"Amazon"}}},{test:[/tablet(?! pc)/i],describe:function(){return{type:o.PLATFORMS_MAP.tablet}}},{test:function(e){var t=e.test(/ipod|iphone/i),n=e.test(/like (ipod|iphone)/i);return t&&!n},describe:function(e){var t=i.default.getFirstMatch(/(ipod|iphone)/i,e);return{type:o.PLATFORMS_MAP.mobile,vendor:"Apple",model:t}}},{test:[/nexus\s*[0-6].*/i,/galaxy nexus/i],describe:function(){return{type:o.PLATFORMS_MAP.mobile,vendor:"Nexus"}}},{test:[/[^-]mobi/i],describe:function(){return{type:o.PLATFORMS_MAP.mobile}}},{test:function(e){return"blackberry"===e.getBrowserName(!0)},describe:function(){return{type:o.PLATFORMS_MAP.mobile,vendor:"BlackBerry"}}},{test:function(e){return"bada"===e.getBrowserName(!0)},describe:function(){return{type:o.PLATFORMS_MAP.mobile}}},{test:function(e){return"windows phone"===e.getBrowserName()},describe:function(){return{type:o.PLATFORMS_MAP.mobile,vendor:"Microsoft"}}},{test:function(e){var t=Number(String(e.getOSVersion()).split(".")[0]);return"android"===e.getOSName(!0)&&t>=3},describe:function(){return{type:o.PLATFORMS_MAP.tablet}}},{test:function(e){return"android"===e.getOSName(!0)},describe:function(){return{type:o.PLATFORMS_MAP.mobile}}},{test:function(e){return"macos"===e.getOSName(!0)},describe:function(){return{type:o.PLATFORMS_MAP.desktop,vendor:"Apple"}}},{test:function(e){return"windows"===e.getOSName(!0)},describe:function(){return{type:o.PLATFORMS_MAP.desktop}}},{test:function(e){return"linux"===e.getOSName(!0)},describe:function(){return{type:o.PLATFORMS_MAP.desktop}}},{test:function(e){return"playstation 4"===e.getOSName(!0)},describe:function(){return{type:o.PLATFORMS_MAP.tv}}},{test:function(e){return"roku"===e.getOSName(!0)},describe:function(){return{type:o.PLATFORMS_MAP.tv}}}];t.default=s,e.exports=t.default},95:function(e,t,n){"use strict";t.__esModule=!0,t.default=void 0;var r,i=(r=n(17))&&r.__esModule?r:{default:r},o=n(18),s=[{test:function(e){return"microsoft edge"===e.getBrowserName(!0)},describe:function(e){if(/\sedg\//i.test(e))return{name:o.ENGINE_MAP.Blink};var t=i.default.getFirstMatch(/edge\/(\d+(\.?_?\d+)+)/i,e);return{name:o.ENGINE_MAP.EdgeHTML,version:t}}},{test:[/trident/i],describe:function(e){var t={name:o.ENGINE_MAP.Trident},n=i.default.getFirstMatch(/trident\/(\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:function(e){return e.test(/presto/i)},describe:function(e){var t={name:o.ENGINE_MAP.Presto},n=i.default.getFirstMatch(/presto\/(\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:function(e){var t=e.test(/gecko/i),n=e.test(/like gecko/i);return t&&!n},describe:function(e){var t={name:o.ENGINE_MAP.Gecko},n=i.default.getFirstMatch(/gecko\/(\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}},{test:[/(apple)?webkit\/537\.36/i],describe:function(){return{name:o.ENGINE_MAP.Blink}}},{test:[/(apple)?webkit/i],describe:function(e){var t={name:o.ENGINE_MAP.WebKit},n=i.default.getFirstMatch(/webkit\/(\d+(\.?_?\d+)+)/i,e);return n&&(t.version=n),t}}];t.default=s,e.exports=t.default}})},228:e=>{"use strict";var t=Object.prototype.hasOwnProperty,n="~";function r(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function o(e,t,r,o,s){if("function"!=typeof r)throw new TypeError("The listener must be a function");var a=new i(r,o||e,s),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function s(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function a(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),a.prototype.eventNames=function(){var e,r,i=[];if(0===this._eventsCount)return i;for(r in e=this._events)t.call(e,r)&&i.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},a.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var i=0,o=r.length,s=new Array(o);i<o;i++)s[i]=r[i].fn;return s},a.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},a.prototype.emit=function(e,t,r,i,o,s){var a=n?n+e:e;if(!this._events[a])return!1;var c,u,l=this._events[a],d=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),d){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,r),!0;case 4:return l.fn.call(l.context,t,r,i),!0;case 5:return l.fn.call(l.context,t,r,i,o),!0;case 6:return l.fn.call(l.context,t,r,i,o,s),!0}for(u=1,c=new Array(d-1);u<d;u++)c[u-1]=arguments[u];l.fn.apply(l.context,c)}else{var h,p=l.length;for(u=0;u<p;u++)switch(l[u].once&&this.removeListener(e,l[u].fn,void 0,!0),d){case 1:l[u].fn.call(l[u].context);break;case 2:l[u].fn.call(l[u].context,t);break;case 3:l[u].fn.call(l[u].context,t,r);break;case 4:l[u].fn.call(l[u].context,t,r,i);break;default:if(!c)for(h=1,c=new Array(d-1);h<d;h++)c[h-1]=arguments[h];l[u].fn.apply(l[u].context,c)}}return!0},a.prototype.on=function(e,t,n){return o(this,e,t,n,!1)},a.prototype.once=function(e,t,n){return o(this,e,t,n,!0)},a.prototype.removeListener=function(e,t,r,i){var o=n?n+e:e;if(!this._events[o])return this;if(!t)return s(this,o),this;var a=this._events[o];if(a.fn)a.fn!==t||i&&!a.once||r&&a.context!==r||s(this,o);else{for(var c=0,u=[],l=a.length;c<l;c++)(a[c].fn!==t||i&&!a[c].once||r&&a[c].context!==r)&&u.push(a[c]);u.length?this._events[o]=1===u.length?u[0]:u:s(this,o)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&s(this,t)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=n,a.EventEmitter=a,e.exports=a},8954:function(e){var t;t=()=>(()=>{var e={228:e=>{"use strict";var t=Object.prototype.hasOwnProperty,n="~";function r(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function o(e,t,r,o,s){if("function"!=typeof r)throw new TypeError("The listener must be a function");var a=new i(r,o||e,s),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function s(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function a(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),a.prototype.eventNames=function(){var e,r,i=[];if(0===this._eventsCount)return i;for(r in e=this._events)t.call(e,r)&&i.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},a.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var i=0,o=r.length,s=new Array(o);i<o;i++)s[i]=r[i].fn;return s},a.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},a.prototype.emit=function(e,t,r,i,o,s){var a=n?n+e:e;if(!this._events[a])return!1;var c,u,l=this._events[a],d=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),d){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,r),!0;case 4:return l.fn.call(l.context,t,r,i),!0;case 5:return l.fn.call(l.context,t,r,i,o),!0;case 6:return l.fn.call(l.context,t,r,i,o,s),!0}for(u=1,c=new Array(d-1);u<d;u++)c[u-1]=arguments[u];l.fn.apply(l.context,c)}else{var h,p=l.length;for(u=0;u<p;u++)switch(l[u].once&&this.removeListener(e,l[u].fn,void 0,!0),d){case 1:l[u].fn.call(l[u].context);break;case 2:l[u].fn.call(l[u].context,t);break;case 3:l[u].fn.call(l[u].context,t,r);break;case 4:l[u].fn.call(l[u].context,t,r,i);break;default:if(!c)for(h=1,c=new Array(d-1);h<d;h++)c[h-1]=arguments[h];l[u].fn.apply(l[u].context,c)}}return!0},a.prototype.on=function(e,t,n){return o(this,e,t,n,!1)},a.prototype.once=function(e,t,n){return o(this,e,t,n,!0)},a.prototype.removeListener=function(e,t,r,i){var o=n?n+e:e;if(!this._events[o])return this;if(!t)return s(this,o),this;var a=this._events[o];if(a.fn)a.fn!==t||i&&!a.once||r&&a.context!==r||s(this,o);else{for(var c=0,u=[],l=a.length;c<l;c++)(a[c].fn!==t||i&&!a[c].once||r&&a[c].context!==r)&&u.push(a[c]);u.length?this._events[o]=1===u.length?u[0]:u:s(this,o)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&s(this,t)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=n,a.EventEmitter=a,e.exports=a},1549:(e,t,n)=>{var r=n(2032),i=n(3862),o=n(6721),s=n(2749),a=n(5749);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=i,c.prototype.get=o,c.prototype.has=s,c.prototype.set=a,e.exports=c},79:(e,t,n)=>{var r=n(3702),i=n(80),o=n(4739),s=n(8655),a=n(1175);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=i,c.prototype.get=o,c.prototype.has=s,c.prototype.set=a,e.exports=c},8223:(e,t,n)=>{var r=n(6110)(n(9325),"Map");e.exports=r},3661:(e,t,n)=>{var r=n(3040),i=n(7670),o=n(289),s=n(4509),a=n(2949);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=i,c.prototype.get=o,c.prototype.has=s,c.prototype.set=a,e.exports=c},7217:(e,t,n)=>{var r=n(79),i=n(1420),o=n(938),s=n(3605),a=n(9817),c=n(945);function u(e){var t=this.__data__=new r(e);this.size=t.size}u.prototype.clear=i,u.prototype.delete=o,u.prototype.get=s,u.prototype.has=a,u.prototype.set=c,e.exports=u},1873:(e,t,n)=>{var r=n(9325).Symbol;e.exports=r},7828:(e,t,n)=>{var r=n(9325).Uint8Array;e.exports=r},1033:e=>{e.exports=function(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)}},695:(e,t,n)=>{var r=n(8096),i=n(2428),o=n(6449),s=n(3656),a=n(361),c=n(7167),u=Object.prototype.hasOwnProperty;e.exports=function(e,t){var n=o(e),l=!n&&i(e),d=!n&&!l&&s(e),h=!n&&!l&&!d&&c(e),p=n||l||d||h,f=p?r(e.length,String):[],g=f.length;for(var m in e)!t&&!u.call(e,m)||p&&("length"==m||d&&("offset"==m||"parent"==m)||h&&("buffer"==m||"byteLength"==m||"byteOffset"==m)||a(m,g))||f.push(m);return f}},7805:(e,t,n)=>{var r=n(3360),i=n(5288);e.exports=function(e,t,n){(void 0!==n&&!i(e[t],n)||void 0===n&&!(t in e))&&r(e,t,n)}},6547:(e,t,n)=>{var r=n(3360),i=n(5288),o=Object.prototype.hasOwnProperty;e.exports=function(e,t,n){var s=e[t];o.call(e,t)&&i(s,n)&&(void 0!==n||t in e)||r(e,t,n)}},6025:(e,t,n)=>{var r=n(5288);e.exports=function(e,t){for(var n=e.length;n--;)if(r(e[n][0],t))return n;return-1}},3360:(e,t,n)=>{var r=n(3243);e.exports=function(e,t,n){"__proto__"==t&&r?r(e,t,{configurable:!0,enumerable:!0,value:n,writable:!0}):e[t]=n}},9344:(e,t,n)=>{var r=n(3805),i=Object.create,o=function(){function e(){}return function(t){if(!r(t))return{};if(i)return i(t);e.prototype=t;var n=new e;return e.prototype=void 0,n}}();e.exports=o},6649:(e,t,n)=>{var r=n(3221)();e.exports=r},2552:(e,t,n)=>{var r=n(1873),i=n(659),o=n(9350),s=r?r.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":s&&s in Object(e)?i(e):o(e)}},7534:(e,t,n)=>{var r=n(2552),i=n(346);e.exports=function(e){return i(e)&&"[object Arguments]"==r(e)}},5083:(e,t,n)=>{var r=n(1882),i=n(7296),o=n(3805),s=n(7473),a=/^\[object .+?Constructor\]$/,c=Function.prototype,u=Object.prototype,l=c.toString,d=u.hasOwnProperty,h=RegExp("^"+l.call(d).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");e.exports=function(e){return!(!o(e)||i(e))&&(r(e)?h:a).test(s(e))}},4901:(e,t,n)=>{var r=n(2552),i=n(294),o=n(346),s={};s["[object Float32Array]"]=s["[object Float64Array]"]=s["[object Int8Array]"]=s["[object Int16Array]"]=s["[object Int32Array]"]=s["[object Uint8Array]"]=s["[object Uint8ClampedArray]"]=s["[object Uint16Array]"]=s["[object Uint32Array]"]=!0,s["[object Arguments]"]=s["[object Array]"]=s["[object ArrayBuffer]"]=s["[object Boolean]"]=s["[object DataView]"]=s["[object Date]"]=s["[object Error]"]=s["[object Function]"]=s["[object Map]"]=s["[object Number]"]=s["[object Object]"]=s["[object RegExp]"]=s["[object Set]"]=s["[object String]"]=s["[object WeakMap]"]=!1,e.exports=function(e){return o(e)&&i(e.length)&&!!s[r(e)]}},2903:(e,t,n)=>{var r=n(3805),i=n(5527),o=n(181),s=Object.prototype.hasOwnProperty;e.exports=function(e){if(!r(e))return o(e);var t=i(e),n=[];for(var a in e)("constructor"!=a||!t&&s.call(e,a))&&n.push(a);return n}},5250:(e,t,n)=>{var r=n(7217),i=n(7805),o=n(6649),s=n(2824),a=n(3805),c=n(7241),u=n(4974);e.exports=function e(t,n,l,d,h){t!==n&&o(n,(function(o,c){if(h||(h=new r),a(o))s(t,n,c,l,e,d,h);else{var p=d?d(u(t,c),o,c+"",t,n,h):void 0;void 0===p&&(p=o),i(t,c,p)}}),c)}},2824:(e,t,n)=>{var r=n(7805),i=n(3290),o=n(1961),s=n(3007),a=n(5529),c=n(2428),u=n(6449),l=n(3693),d=n(3656),h=n(1882),p=n(3805),f=n(1331),g=n(7167),m=n(4974),v=n(9884);e.exports=function(e,t,n,E,S,_,y){var b=m(e,n),T=m(t,n),C=y.get(T);if(C)r(e,n,C);else{var I=_?_(b,T,n+"",e,t,y):void 0,R=void 0===I;if(R){var O=u(T),w=!O&&d(T),A=!O&&!w&&g(T);I=T,O||w||A?u(b)?I=b:l(b)?I=s(b):w?(R=!1,I=i(T,!0)):A?(R=!1,I=o(T,!0)):I=[]:f(T)||c(T)?(I=b,c(b)?I=v(b):p(b)&&!h(b)||(I=a(T))):R=!1}R&&(y.set(T,I),S(I,T,E,_,y),y.delete(T)),r(e,n,I)}}},9302:(e,t,n)=>{var r=n(3488),i=n(6757),o=n(2865);e.exports=function(e,t){return o(i(e,t,r),e+"")}},9570:(e,t,n)=>{var r=n(7334),i=n(3243),o=n(3488),s=i?function(e,t){return i(e,"toString",{configurable:!0,enumerable:!1,value:r(t),writable:!0})}:o;e.exports=s},8096:e=>{e.exports=function(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}},7301:e=>{e.exports=function(e){return function(t){return e(t)}}},9653:(e,t,n)=>{var r=n(7828);e.exports=function(e){var t=new e.constructor(e.byteLength);return new r(t).set(new r(e)),t}},3290:(e,t,n)=>{e=n.nmd(e);var r=n(9325),i=t&&!t.nodeType&&t,o=i&&e&&!e.nodeType&&e,s=o&&o.exports===i?r.Buffer:void 0,a=s?s.allocUnsafe:void 0;e.exports=function(e,t){if(t)return e.slice();var n=e.length,r=a?a(n):new e.constructor(n);return e.copy(r),r}},1961:(e,t,n)=>{var r=n(9653);e.exports=function(e,t){var n=t?r(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}},3007:e=>{e.exports=function(e,t){var n=-1,r=e.length;for(t||(t=Array(r));++n<r;)t[n]=e[n];return t}},1791:(e,t,n)=>{var r=n(6547),i=n(3360);e.exports=function(e,t,n,o){var s=!n;n||(n={});for(var a=-1,c=t.length;++a<c;){var u=t[a],l=o?o(n[u],e[u],u,n,e):void 0;void 0===l&&(l=e[u]),s?i(n,u,l):r(n,u,l)}return n}},5481:(e,t,n)=>{var r=n(9325)["__core-js_shared__"];e.exports=r},999:(e,t,n)=>{var r=n(9302),i=n(6800);e.exports=function(e){return r((function(t,n){var r=-1,o=n.length,s=o>1?n[o-1]:void 0,a=o>2?n[2]:void 0;for(s=e.length>3&&"function"==typeof s?(o--,s):void 0,a&&i(n[0],n[1],a)&&(s=o<3?void 0:s,o=1),t=Object(t);++r<o;){var c=n[r];c&&e(t,c,r,s)}return t}))}},3221:e=>{e.exports=function(e){return function(t,n,r){for(var i=-1,o=Object(t),s=r(t),a=s.length;a--;){var c=s[e?a:++i];if(!1===n(o[c],c,o))break}return t}}},3243:(e,t,n)=>{var r=n(6110),i=function(){try{var e=r(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();e.exports=i},4840:(e,t,n)=>{var r="object"==typeof n.g&&n.g&&n.g.Object===Object&&n.g;e.exports=r},2651:(e,t,n)=>{var r=n(4218);e.exports=function(e,t){var n=e.__data__;return r(t)?n["string"==typeof t?"string":"hash"]:n.map}},6110:(e,t,n)=>{var r=n(5083),i=n(392);e.exports=function(e,t){var n=i(e,t);return r(n)?n:void 0}},8879:(e,t,n)=>{var r=n(4335)(Object.getPrototypeOf,Object);e.exports=r},659:(e,t,n)=>{var r=n(1873),i=Object.prototype,o=i.hasOwnProperty,s=i.toString,a=r?r.toStringTag:void 0;e.exports=function(e){var t=o.call(e,a),n=e[a];try{e[a]=void 0;var r=!0}catch(e){}var i=s.call(e);return r&&(t?e[a]=n:delete e[a]),i}},392:e=>{e.exports=function(e,t){return null==e?void 0:e[t]}},2032:(e,t,n)=>{var r=n(1042);e.exports=function(){this.__data__=r?r(null):{},this.size=0}},3862:e=>{e.exports=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}},6721:(e,t,n)=>{var r=n(1042),i=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;if(r){var n=t[e];return"__lodash_hash_undefined__"===n?void 0:n}return i.call(t,e)?t[e]:void 0}},2749:(e,t,n)=>{var r=n(1042),i=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;return r?void 0!==t[e]:i.call(t,e)}},5749:(e,t,n)=>{var r=n(1042);e.exports=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=r&&void 0===t?"__lodash_hash_undefined__":t,this}},5529:(e,t,n)=>{var r=n(9344),i=n(8879),o=n(5527);e.exports=function(e){return"function"!=typeof e.constructor||o(e)?{}:r(i(e))}},361:e=>{var t=/^(?:0|[1-9]\d*)$/;e.exports=function(e,n){var r=typeof e;return!!(n=null==n?9007199254740991:n)&&("number"==r||"symbol"!=r&&t.test(e))&&e>-1&&e%1==0&&e<n}},6800:(e,t,n)=>{var r=n(5288),i=n(4894),o=n(361),s=n(3805);e.exports=function(e,t,n){if(!s(n))return!1;var a=typeof t;return!!("number"==a?i(n)&&o(t,n.length):"string"==a&&t in n)&&r(n[t],e)}},4218:e=>{e.exports=function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}},7296:(e,t,n)=>{var r,i=n(5481),o=(r=/[^.]+$/.exec(i&&i.keys&&i.keys.IE_PROTO||""))?"Symbol(src)_1."+r:"";e.exports=function(e){return!!o&&o in e}},5527:e=>{var t=Object.prototype;e.exports=function(e){var n=e&&e.constructor;return e===("function"==typeof n&&n.prototype||t)}},3702:e=>{e.exports=function(){this.__data__=[],this.size=0}},80:(e,t,n)=>{var r=n(6025),i=Array.prototype.splice;e.exports=function(e){var t=this.__data__,n=r(t,e);return!(n<0||(n==t.length-1?t.pop():i.call(t,n,1),--this.size,0))}},4739:(e,t,n)=>{var r=n(6025);e.exports=function(e){var t=this.__data__,n=r(t,e);return n<0?void 0:t[n][1]}},8655:(e,t,n)=>{var r=n(6025);e.exports=function(e){return r(this.__data__,e)>-1}},1175:(e,t,n)=>{var r=n(6025);e.exports=function(e,t){var n=this.__data__,i=r(n,e);return i<0?(++this.size,n.push([e,t])):n[i][1]=t,this}},3040:(e,t,n)=>{var r=n(1549),i=n(79),o=n(8223);e.exports=function(){this.size=0,this.__data__={hash:new r,map:new(o||i),string:new r}}},7670:(e,t,n)=>{var r=n(2651);e.exports=function(e){var t=r(this,e).delete(e);return this.size-=t?1:0,t}},289:(e,t,n)=>{var r=n(2651);e.exports=function(e){return r(this,e).get(e)}},4509:(e,t,n)=>{var r=n(2651);e.exports=function(e){return r(this,e).has(e)}},2949:(e,t,n)=>{var r=n(2651);e.exports=function(e,t){var n=r(this,e),i=n.size;return n.set(e,t),this.size+=n.size==i?0:1,this}},1042:(e,t,n)=>{var r=n(6110)(Object,"create");e.exports=r},181:e=>{e.exports=function(e){var t=[];if(null!=e)for(var n in Object(e))t.push(n);return t}},6009:(e,t,n)=>{e=n.nmd(e);var r=n(4840),i=t&&!t.nodeType&&t,o=i&&e&&!e.nodeType&&e,s=o&&o.exports===i&&r.process,a=function(){try{return o&&o.require&&o.require("util").types||s&&s.binding&&s.binding("util")}catch(e){}}();e.exports=a},9350:e=>{var t=Object.prototype.toString;e.exports=function(e){return t.call(e)}},4335:e=>{e.exports=function(e,t){return function(n){return e(t(n))}}},6757:(e,t,n)=>{var r=n(1033),i=Math.max;e.exports=function(e,t,n){return t=i(void 0===t?e.length-1:t,0),function(){for(var o=arguments,s=-1,a=i(o.length-t,0),c=Array(a);++s<a;)c[s]=o[t+s];s=-1;for(var u=Array(t+1);++s<t;)u[s]=o[s];return u[t]=n(c),r(e,this,u)}}},9325:(e,t,n)=>{var r=n(4840),i="object"==typeof self&&self&&self.Object===Object&&self,o=r||i||Function("return this")();e.exports=o},4974:e=>{e.exports=function(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]}},2865:(e,t,n)=>{var r=n(9570),i=n(1811)(r);e.exports=i},1811:e=>{var t=Date.now;e.exports=function(e){var n=0,r=0;return function(){var i=t(),o=16-(i-r);if(r=i,o>0){if(++n>=800)return arguments[0]}else n=0;return e.apply(void 0,arguments)}}},1420:(e,t,n)=>{var r=n(79);e.exports=function(){this.__data__=new r,this.size=0}},938:e=>{e.exports=function(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n}},3605:e=>{e.exports=function(e){return this.__data__.get(e)}},9817:e=>{e.exports=function(e){return this.__data__.has(e)}},945:(e,t,n)=>{var r=n(79),i=n(8223),o=n(3661);e.exports=function(e,t){var n=this.__data__;if(n instanceof r){var s=n.__data__;if(!i||s.length<199)return s.push([e,t]),this.size=++n.size,this;n=this.__data__=new o(s)}return n.set(e,t),this.size=n.size,this}},7473:e=>{var t=Function.prototype.toString;e.exports=function(e){if(null!=e){try{return t.call(e)}catch(e){}try{return e+""}catch(e){}}return""}},7334:e=>{e.exports=function(e){return function(){return e}}},5288:e=>{e.exports=function(e,t){return e===t||e!=e&&t!=t}},3488:e=>{e.exports=function(e){return e}},2428:(e,t,n)=>{var r=n(7534),i=n(346),o=Object.prototype,s=o.hasOwnProperty,a=o.propertyIsEnumerable,c=r(function(){return arguments}())?r:function(e){return i(e)&&s.call(e,"callee")&&!a.call(e,"callee")};e.exports=c},6449:e=>{var t=Array.isArray;e.exports=t},4894:(e,t,n)=>{var r=n(1882),i=n(294);e.exports=function(e){return null!=e&&i(e.length)&&!r(e)}},3693:(e,t,n)=>{var r=n(4894),i=n(346);e.exports=function(e){return i(e)&&r(e)}},3656:(e,t,n)=>{e=n.nmd(e);var r=n(9325),i=n(9935),o=t&&!t.nodeType&&t,s=o&&e&&!e.nodeType&&e,a=s&&s.exports===o?r.Buffer:void 0,c=(a?a.isBuffer:void 0)||i;e.exports=c},1882:(e,t,n)=>{var r=n(2552),i=n(3805);e.exports=function(e){if(!i(e))return!1;var t=r(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t}},294:e=>{e.exports=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}},3805:e=>{e.exports=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}},346:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},1331:(e,t,n)=>{var r=n(2552),i=n(8879),o=n(346),s=Function.prototype,a=Object.prototype,c=s.toString,u=a.hasOwnProperty,l=c.call(Object);e.exports=function(e){if(!o(e)||"[object Object]"!=r(e))return!1;var t=i(e);if(null===t)return!0;var n=u.call(t,"constructor")&&t.constructor;return"function"==typeof n&&n instanceof n&&c.call(n)==l}},7167:(e,t,n)=>{var r=n(4901),i=n(7301),o=n(6009),s=o&&o.isTypedArray,a=s?i(s):r;e.exports=a},7241:(e,t,n)=>{var r=n(695),i=n(2903),o=n(4894);e.exports=function(e){return o(e)?r(e,!0):i(e)}},6924:(e,t,n)=>{var r=n(5250),i=n(999)((function(e,t,n,i){r(e,t,n,i)}));e.exports=i},9935:e=>{e.exports=function(){return!1}},9884:(e,t,n)=>{var r=n(1791),i=n(7241);e.exports=function(e){return r(e,i(e))}},4355:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CriteriaInputs=t.BooleanComparisonSchema=void 0;var r=n(4713);t.BooleanComparisonSchema={comparison:{type:"string",required:!0},format:{type:"string",required:!0},value:{type:"string",required:!1}};var i=function(){function e(e){this.inputs=e}return e.prototype.matches=function(e,t){if(0===t.length)return{success:!0,matched:!1};var n=this.inputs[e];if(void 0===n)return{success:!0,matched:!1};for(var r=0,i=t;r<i.length;r++){var o=i[r],s=this.matchSingleFilter(e,n,o);if(!s.success)return s;if(s.matched)return{success:!0,matched:!0}}return{success:!0,matched:!1}},e.prototype.matchSingleFilter=function(e,t,n){return this.isPrimitiveFilter(n)?this.matchPrimitive(t,n):this.isComparatorFilter(n)?this.matchComparator(e,t,n):{success:!1,error:"Invalid filter type for property ".concat(e)}},e.prototype.matchPrimitive=function(e,t){return typeof e!=typeof t?{success:!0,matched:!1}:"string"==typeof e&&"string"==typeof t?{success:!0,matched:(0,r.matchesWithWildcard)(e,t)}:{success:!0,matched:e===t}},e.prototype.matchComparator=function(e,t,n){var r=n.comparison,i=n.format,o=n.value;return this.isValidComparisonOperator(r)?"semver"===i?this.matchSemverComparator(t,r,o):"number"===i?this.matchNumberComparator(t,r,o):{success:!1,error:"Unknown comparator format: ".concat(i)}:{success:!1,error:"Invalid comparison operator: ".concat(r)}},e.prototype.matchSemverComparator=function(e,t,n){if("string"!=typeof e)return{success:!1,error:"Input value must be string for semver comparison"};var i=(0,r.compareSemvers)(e,n);return void 0===i?{success:!1,error:'Invalid semver: input="'.concat(e,'", filter="').concat(n,'"')}:{success:!0,matched:this.evaluateComparison(i,t)}},e.prototype.matchNumberComparator=function(e,t,n){if("number"!=typeof e)return{success:!1,error:"Input value must be number for number comparison"};var r,i=parseFloat(n);return isNaN(i)?{success:!1,error:"Invalid number in filter: ".concat(n)}:(r=e<i?-1:e>i?1:0,{success:!0,matched:this.evaluateComparison(r,t)})},e.prototype.evaluateComparison=function(e,t){switch(t){case"<":return e<0;case"<=":return e<=0;case">":return e>0;case">=":return e>=0;case"==":return 0===e;case"!=":return 0!==e;default:return!1}},e.prototype.isPrimitiveFilter=function(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e},e.prototype.isComparatorFilter=function(e){return"object"==typeof e&&null!==e&&"comparison"in e&&"format"in e&&"value"in e},e.prototype.isValidComparisonOperator=function(e){return["<","<=",">",">=","==","!="].includes(e)},e}();t.CriteriaInputs=i},5185:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CriteriaParser=t.DeviceConfigCriteriaConfigSchema=t.DeviceConfigCriteriaSchema=t.DeviceConfigRulesSchema=void 0;var r=n(4293);t.DeviceConfigRulesSchema={},t.DeviceConfigCriteriaSchema={version:{type:"number",required:!0},rules:{type:"object",required:!0,config:{schema:t.DeviceConfigRulesSchema}}},t.DeviceConfigCriteriaConfigSchema={criteria:{type:"object",required:!0,config:{schema:t.DeviceConfigCriteriaSchema}},payload:{type:"object",required:!0,config:{schema:{}}}};var i=function(){function e(){}return Object.defineProperty(e,"CURRENT_VERSION",{get:function(){return this.SUPPORTED_VERSION},enumerable:!1,configurable:!0}),e.evaluateCriteria=function(e,t){if(!e.criteria)return(0,r.err)("Missing criteria object");var n=e.criteria;if(n.version!==this.SUPPORTED_VERSION)return(0,r.ok)({matched:!1});if(!n.rules)return(0,r.err)("Missing rules in criteria");var i=n.rules;if(0===Object.keys(i).length)return(0,r.ok)({matched:!0,payload:e.payload});for(var o=0,s=Object.entries(i);o<s.length;o++){var a=s[o],c=a[0],u=a[1],l=t.matches(c,u);if(!l.success)return(0,r.err)(l.error||"Match evaluation failed");if(!l.matched)return(0,r.ok)({matched:!1})}return(0,r.ok)({matched:!0,payload:e.payload})},e.matchingPayloads=function(e,t){for(var n=[],i=[],o=0,s=e;o<s.length;o++){var a=s[o],c=this.evaluateCriteria(a,t);c.ok?c.value.matched&&void 0!==c.value.payload&&n.push(c.value.payload):i.push(c.error)}return i.length>0?(0,r.err)(i):(0,r.ok)({payloads:n})},e.matches=function(e,t,n){return n.matches(e,t)},e.SUPPORTED_VERSION=1,e}();t.CriteriaParser=i},4713:(e,t)=>{"use strict";function n(e){if(e&&"string"==typeof e){var t=e.split("+")[0];if(t){var n=t.split("-"),r=n[0],i=n.slice(1);if(r){var o=r.split(".");if(!(0===o.length||o.length>3||o.some((function(e){return""===e||!/^\d+$/.test(e)})))){var s=o.map((function(e){return parseInt(e,10)})),a=s[0],c=void 0===a?0:a,u=s[1],l=void 0===u?0:u,d=s[2],h={major:c,minor:l,patch:void 0===d?0:d};if(i.length>0){var p=i.join("-");p&&(h.prerelease=p.split("."))}return h}}}}}Object.defineProperty(t,"__esModule",{value:!0}),t.compareSemvers=t.parseSemver=t.matchesWithWildcard=void 0,t.matchesWithWildcard=function(e,t){if("*"===t)return!0;if(t.endsWith("*")){var n=t.slice(0,-1);return e.startsWith(n)}return e===t},t.parseSemver=n,t.compareSemvers=function(e,t){var r=n(e),i=n(t);if(r&&i){if(r.major!==i.major)return r.major>i.major?1:-1;if(r.minor!==i.minor)return r.minor>i.minor?1:-1;if(r.patch!==i.patch)return r.patch>i.patch?1:-1;var o=r.prerelease&&r.prerelease.length>0,s=i.prerelease&&i.prerelease.length>0;if(o&&!s)return-1;if(!o&&s)return 1;if(!o&&!s)return 0;for(var a=r.prerelease,c=i.prerelease,u=Math.max(a.length,c.length),l=0;l<u;l++){var d=a[l],h=c[l];if(void 0===d)return-1;if(void 0===h)return 1;var p=/^\d+$/.test(d),f=/^\d+$/.test(h);if(p&&f){var g=parseInt(d,10),m=parseInt(h,10);if(g!==m)return g>m?1:-1}else{if(p&&!f)return-1;if(!p&&f)return 1;if(d!==h)return d>h?1:-1}}return 0}}},6270:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceConfigRulesSchema=t.DeviceConfigCriteriaSchema=t.DeviceConfigCriteriaConfigSchema=t.CriteriaParser=t.BooleanComparisonSchema=t.CriteriaInputs=t.compareSemvers=t.parseSemver=t.matchesWithWildcard=void 0;var r=n(4713);Object.defineProperty(t,"matchesWithWildcard",{enumerable:!0,get:function(){return r.matchesWithWildcard}}),Object.defineProperty(t,"parseSemver",{enumerable:!0,get:function(){return r.parseSemver}}),Object.defineProperty(t,"compareSemvers",{enumerable:!0,get:function(){return r.compareSemvers}});var i=n(4355);Object.defineProperty(t,"CriteriaInputs",{enumerable:!0,get:function(){return i.CriteriaInputs}}),Object.defineProperty(t,"BooleanComparisonSchema",{enumerable:!0,get:function(){return i.BooleanComparisonSchema}});var o=n(5185);Object.defineProperty(t,"CriteriaParser",{enumerable:!0,get:function(){return o.CriteriaParser}}),Object.defineProperty(t,"DeviceConfigCriteriaConfigSchema",{enumerable:!0,get:function(){return o.DeviceConfigCriteriaConfigSchema}}),Object.defineProperty(t,"DeviceConfigCriteriaSchema",{enumerable:!0,get:function(){return o.DeviceConfigCriteriaSchema}}),Object.defineProperty(t,"DeviceConfigRulesSchema",{enumerable:!0,get:function(){return o.DeviceConfigRulesSchema}})},7094:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultClock=t.DefaultStorage=t.DefaultAnalytics=t.DefaultTrace=t.getDefaultConfigRefreshOptions=t.getDefaultCommonAnalytics=t.DEFAULT_INITIAL_DELAY_SECONDS=t.DEFAULT_HTTP_TIMEOUT_SECONDS=t.DEFAULT_STOP_REFRESH_AFTER_SECONDS=t.DEFAULT_MAX_AGE_CACHE_SECONDS=t.DEFAULT_RETRY_INTERVAL_SECONDS=t.DEFAULT_RETRY_COUNT=t.DEFAULT_REFRESH_INTERVAL_SECONDS=t.STORAGE_PREFIX_KEY=t.ENCODING_BASE64=t.STATE_KEY=t.DATA_KEY=void 0;var r=n(3259),i=n(4811);t.DATA_KEY="data",t.STATE_KEY="state",t.ENCODING_BASE64="base64",t.STORAGE_PREFIX_KEY="amazon_ivs_device_config_v1_",t.DEFAULT_REFRESH_INTERVAL_SECONDS=(0,r.minutesToSeconds)(15),t.DEFAULT_RETRY_COUNT=3,t.DEFAULT_RETRY_INTERVAL_SECONDS=10,t.DEFAULT_MAX_AGE_CACHE_SECONDS=(0,r.daysToSeconds)(3),t.DEFAULT_STOP_REFRESH_AFTER_SECONDS=(0,r.hoursToSeconds)(2),t.DEFAULT_HTTP_TIMEOUT_SECONDS=15,t.DEFAULT_INITIAL_DELAY_SECONDS=5,t.getDefaultCommonAnalytics=function(){return{client_sdk:"unknown",env:i.DeviceConfigEnv.PROD}},t.getDefaultConfigRefreshOptions=function(){return{refreshIntervalSeconds:t.DEFAULT_REFRESH_INTERVAL_SECONDS,retryCount:t.DEFAULT_RETRY_COUNT,retryIntervalSeconds:t.DEFAULT_RETRY_INTERVAL_SECONDS,maxCacheAgeSeconds:t.DEFAULT_MAX_AGE_CACHE_SECONDS,stopRefreshAfterSeconds:t.DEFAULT_STOP_REFRESH_AFTER_SECONDS,canRefreshNow:function(){return!0}}};var o=function(){function e(e){this.enableConsoleLog=e}return e.prototype.onTrace=function(e){this.enableConsoleLog&&console.log("DeviceConfig trace: "+e)},e}();t.DefaultTrace=o;var s=function(){function e(e){this.enableConsoleLog=e}return e.prototype.onValue=function(e){this.enableConsoleLog&&console.log("DeviceConfig analytics value:  ".concat(e))},e.prototype.onError=function(e){this.enableConsoleLog&&console.error("DeviceConfig analytics error: ".concat(e))},e.prototype.onTrace=function(e){this.enableConsoleLog&&console.log("DeviceConfig analytics trace: ".concat(e))},e}();t.DefaultAnalytics=s;var a=function(){function e(e,t){this.prefix=e,this.storage=t}return e.prototype.getJson=function(e){var t=this.prefix+"_"+e;try{var n=this.storage.getItem(t);if(n)return JSON.parse(n)}catch(e){console.error("Error getting local storage key ".concat(t)+e)}return null},e.prototype.setJson=function(e,t){var n=this.prefix+"_"+e;try{this.storage.setItem(n,JSON.stringify(t))}catch(e){console.error("Error setting local storage key ".concat(n,": ")+e)}},e}();t.DefaultStorage=a;var c=function(){function e(){}return e.prototype.getMillis=function(){return Date.now()},e}();t.DefaultClock=c},3259:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.daysToSeconds=t.hoursToSeconds=t.minutesToSeconds=t.secondsToMillis=void 0,t.secondsToMillis=function(e){return 1e3*e},t.minutesToSeconds=function(e){return 60*e},t.hoursToSeconds=function(e){return 60*e*60},t.daysToSeconds=function(e){return 60*e*60*24}},1743:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.validateSchema=void 0;var s=o(n(4293));t.validateSchema=function e(t,n){var r;if(null==t)return s.err("value is undefined or null");if("object"!=typeof t)return s.err("value is not an object");for(var i=t,o=0,a=Object.entries(n);o<a.length;o++){var c=a[o],u=c[0],l=c[1];if("object"===l.type){if(l.required&&!(u in i))return s.err("".concat(u," is required in schema"));if(i[u]&&!(f=e(i[u],null===(r=null==l?void 0:l.config)||void 0===r?void 0:r.schema)).ok)return s.err("".concat(u," ").concat(f.error))}else if("array"===l.type){if(l.required&&!(u in i))return s.err("".concat(u," is required in schema"));if(u in i){if(!Array.isArray(i[u]))return s.err("".concat(u," is not an array"));if(l.items)for(var d=0,h=i[u];d<h.length;d++){var p=h[d];if("string"===l.items.type||"number"===l.items.type||"boolean"===l.items.type){if(typeof p!==l.items.type)return s.err("".concat(p," in ").concat(u," is not an ").concat(l.items.type))}else if("object"===l.items.type&&l.items.config){var f;if(!(f=e(p,l.items.config.schema)).ok)return f}}}}else{if(l.required&&!(u in i))return s.err("".concat(u," is required in schema"));if(u in i&&typeof i[u]!==l.type)return s.err("".concat(u," is not of type ").concat(l.type))}}return s.ok(!0)}},3840:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.validateSchema=void 0;var r=n(1743);Object.defineProperty(t,"validateSchema",{enumerable:!0,get:function(){return r.validateSchema}})},4811:function(e,t,n){"use strict";var r,i=this&&this.__extends||(r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},r(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0}),t.HttpError=t.StateHolder=t.Property=t.ValueType=t.DeviceConfigEnv=void 0;var o,s,a=n(7094);!function(e){e.BETA="beta",e.PROD="prod",e.CUSTOM="custom"}(o||(t.DeviceConfigEnv=o={})),function(e){e[e.STRING=0]="STRING",e[e.NUMBER=1]="NUMBER",e[e.BOOLEAN=2]="BOOLEAN",e[e.JSON=3]="JSON"}(s||(t.ValueType=s={})),t.Property=function(e,t,n,r,i,o,c,u){switch(this.name=e,this.type=t,this.valueString=n,this.valueNumber=r,this.valueBoolean=i,this.valueJson=o,this.valueAnalytics=c,this.type){case s.STRING:u===a.ENCODING_BASE64&&n&&(this.valueString=atob(n));break;case s.JSON:u===a.ENCODING_BASE64&&o&&(this.valueJson=atob(o))}};var c=function(){function e(e,t){var n;this.storage=e,this.key=t,this.state=null!==(n=e.getJson(t))&&void 0!==n?n:{}}return e.prototype.getState=function(){return this.state},e.prototype.setState=function(e){Object.assign(this.state,e),this.storage.setJson(this.key,this.state)},e}();t.StateHolder=c;var u=function(e){function t(t){return e.call(this,t)||this}return i(t,e),t}(Error);t.HttpError=u},363:function(e,t,n){"use strict";var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},r.apply(this,arguments)},i=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.DeviceConfigPropertyHolder=t.DeviceConfigManager=void 0;var o=n(4478),s=n(6270),a=n(4355),c=n(7094),u=n(3259),l=n(1743),d=n(4811),h=function(){function e(e,t){var n,i,o,s;if(!t.fileKey)throw new Error("options.fileKey cannot be empty");var a=null!==(n=t.clock)&&void 0!==n?n:new c.DefaultClock,u=a.getMillis();switch(this.context=e,this.fileKey=t.fileKey,this.env=t.standardEnv,t.standardEnv){case d.DeviceConfigEnv.BETA:this.fetchServer="beta.ivs-device-config-beta.live-video.net";break;case d.DeviceConfigEnv.PROD:this.fetchServer="prod.ivs-device-config.live-video.net";break;case d.DeviceConfigEnv.CUSTOM:if(!t.customServer)throw new Error("Custom env requires options.customServer");this.fetchServer=t.customServer;break;default:throw new Error("Invalid value for standardEnv: ".concat(t.standardEnv))}this.trace=null!==(i=t.trace)&&void 0!==i?i:new c.DefaultTrace(t.enableConsoleLog),this.fetch=null!==(o=t.fetch)&&void 0!==o?o:new f(e),this.storage=new c.DefaultStorage(c.STORAGE_PREFIX_KEY+t.fileKey,e.localStorage),this.state=new d.StateHolder(this.storage,c.STATE_KEY),this.refresh=r(r({},(0,c.getDefaultConfigRefreshOptions)()),t.refresh),this.emitMetrics=t.emitMetrics,this.analyticsProperties=null!==(s=t.analyticsProperties)&&void 0!==s?s:(0,c.getDefaultCommonAnalytics)(),this.enableConsoleLog=t.enableConsoleLog,this.clock=a,this.isInitialRefreshDone=!1;var l=0,h=this.state.getState();h&&h.fetchServer===this.fetchServer&&h.lastFetchWhenMs&&(l=h.lastFetchWhenMs);var p,g=a.getMillis(),m=(g-l)/1e3;if(m<=this.refresh.maxCacheAgeSeconds){var v=this.storage.getJson(c.DATA_KEY);v&&v.fetchServer===this.fetchServer&&this.setData(v.json)}this.lastUseMs=g,m>=this.refresh.refreshIntervalSeconds||0==l?p=0:(p=Math.round(this.refresh.refreshIntervalSeconds-m),this.isInitialRefreshDone=!0),p<5&&(p=c.DEFAULT_INITIAL_DELAY_SECONDS),this.trace.onTrace("Will start refresh in "+p+" seconds"),this.fetchTask=this.context.setTimeout(this.startRefresh.bind(this),1e3*p);var E=a.getMillis();this.initialLoadTime=E-u}return e.getInstance=function(t,n){try{if(!(t.fetch&&t.setTimeout&&t.clearTimeout&&t.localStorage))return void console.log("Context needs to provide fetch, setTimeout, clearTimeout, localStorage")}catch(e){return void console.error("Error checking for context properties "+e)}if(this.gInstance){if(this.gInstance.fileKey!=n.fileKey)throw new Error("Existing instance has file key ".concat(this.gInstance.fileKey,", now asking for ").concat(n.fileKey));return this.gInstance}return this.gInstance=new e(t,n),this.gInstance},e.prototype.getConfigurationHolder=function(e){var t,n=this.clock.getMillis();this.lastUseMs=n;var r=null!==(t=e.analytics)&&void 0!==t?t:new c.DefaultAnalytics(this.enableConsoleLog),i=0,o=this.state.getState();return o&&o.fetchServer===this.fetchServer&&o.lastFetchWhenMs&&(i=o.lastFetchWhenMs),(n-i)/1e3<=this.refresh.maxCacheAgeSeconds?new p(r,this.analyticsProperties,this.properties,i,this.clock):new p(r,this.analyticsProperties,void 0,0,this.clock)},e.prototype.getFetchUrl=function(){var e="https://".concat(this.fetchServer,"/").concat(this.fileKey,".json"),t=new URL(e);return t.searchParams.set("version","1.0"),t},e.clearInstance=function(){var e;null===(e=this.gInstance)||void 0===e||e.clearInstanceImpl(),this.gInstance=void 0},e.prototype.clearInstanceImpl=function(){this.context.clearTimeout(this.fetchTask),this.fetchTask=void 0,this.context.clearTimeout(this.retryTask),this.retryTask=void 0},e.prototype.startRefresh=function(){var e=this;this.trace.onTrace("Starting refresh request"),this.fetchTask=void 0,this.retryTask&&(this.context.clearTimeout(this.retryTask),this.retryTask=void 0),this.fetchTask=this.context.setTimeout(this.startRefresh.bind(this),1e3*this.refresh.refreshIntervalSeconds);var t=this.clock.getMillis();if((t-this.lastUseMs)/1e3>this.refresh.stopRefreshAfterSeconds)this.trace.onTrace("Will not refresh due to refresh timeout");else if(!this.isInitialRefreshDone||this.refresh.canRefreshNow()){this.isInitialRefreshDone=!0;var n={};this.fetchData().then((function(r){e.processResponse(r,n,t),e.emitMetricsImpl(n)})).catch((function(t){e.exceptionMetrics(n,t),e.emitMetricsImpl(n),e.trace.onTrace("Fetch error: "+t),e.refresh.retryCount>0&&e.scheduleRetry(1)}))}else this.trace.onTrace("Will not refresh due to callback having returned false")},e.prototype.fetchData=function(){var e=this.getFetchUrl(),t=new Headers,n=this.state.getState();return n.fetchServer===this.fetchServer&&(n.lastFetchWhenFullMs&&this.clock.getMillis()-n.lastFetchWhenFullMs>1e3*(0,u.hoursToSeconds)(24)?this.trace.onTrace("Forcing full refresh"):this.properties&&n.lastFetchEtagHeader&&t.set("If-None-Match",n.lastFetchEtagHeader)),this.fetch.fetchUrl(e,t)},e.prototype.processResponse=function(e,t,n){var r={fetchServer:this.fetchServer,lastFetchWhenMs:this.clock.getMillis()},i=e.headers.get("etag");if(i&&(r.lastFetchEtagHeader=i),e.status<300&&e.json)if(this.setData(e.json)){this.trace.onTrace("Successfully parsed fetched data"),this.storage.setJson(c.DATA_KEY,{fetchServer:this.fetchServer,json:e.json});var o=this.clock.getMillis();r.lastFetchWhenFullMs=o,this.state.setState(r),t.success_new_data_count=1,t.fetch_duration_average=Math.max(0,o-n)}else t.fail_invalid_data_count=1;else{if(304!==e.status){var s="Unexpected http fetch status: "+e.status;throw this.trace.onTrace(s),new d.HttpError(s)}this.trace.onTrace("Server said no change in data"),o=this.clock.getMillis(),r.lastFetchWhenMs=o,this.state.setState(r),t.success_no_change_count=1,t.fetch_duration_average=Math.max(0,o-n)}},e.prototype.scheduleRetry=function(e){var t=this;this.retryTask&&this.context.clearTimeout(this.retryTask);var n=e*this.refresh.retryIntervalSeconds;this.retryTask=this.context.setTimeout((function(){t.retryTask=void 0,t.fetchRetry(e)}),1e3*n)},e.prototype.fetchRetry=function(e){var t=this;this.trace.onTrace("Starting retry request ".concat(e,"..."));var n={},r=this.clock.getMillis();this.fetchData().then((function(e){t.processResponse(e,n,r),t.emitMetricsImpl(n)})).catch((function(r){t.exceptionMetrics(n,r),t.emitMetricsImpl(n),t.trace.onTrace("Fetch error: "+r),t.refresh.retryCount>e&&t.scheduleRetry(e+1)}))},e.prototype.setData=function(e){if(!e)return!1;if("1.0"!==e.version)return this.trace.onTrace("Data version is not 1.0, not applying"),!1;var t=e.properties;if(!t||!Array.isArray(t))return this.trace.onTrace("Data properties is not an array, not applying"),!1;for(var n=new Map,r=0,i=t;r<i.length;r++){var o=i[r];if(o.name&&o.type&&this.isValidValueType(o.type)){if(o.value_string&&"string"!=typeof o.value_string){this.trace.onTrace("Invalid type of value.value_string "+typeof o.value_string);continue}if(o.value_number&&"number"!=typeof o.value_number){this.trace.onTrace("Invalid type of value.value_number "+typeof o.value_number);continue}if(o.value_boolean&&"boolean"!=typeof o.value_boolean){this.trace.onTrace("Invalid type of value.value_boolean "+typeof o.value_boolean);continue}if(o.value_json&&"string"!=typeof o.value_json){this.trace.onTrace("Invalid type of value.value_json "+typeof o.value_json);continue}if(o.value_analytics&&"string"!=typeof o.value_analytics){this.trace.onTrace("Invalid type of item.value_analytics "+typeof o.value_analytics);continue}var s=new d.Property(o.name,this.parseValueType(o.type),o.value_string,o.value_number,o.value_boolean,o.value_json,o.value_analytics,o.encoding);n.set(s.name,s)}}return 0!=n.size&&(this.properties=n,!0)},e.prototype.isValidValueType=function(e){return"string"===e||"number"===e||"boolean"===e||"json"==e},e.prototype.parseValueType=function(e){switch(e){case"string":return d.ValueType.STRING;case"number":return d.ValueType.NUMBER;case"boolean":return d.ValueType.BOOLEAN;case"json":return d.ValueType.JSON;default:throw new Error("Unsupported value type ".concat(e))}},e.prototype.emitMetricsImpl=function(e){var t,n,i,o,s,a,c=r(r({},this.analyticsProperties),{initial_load_time:this.initialLoadTime,fetch_attempt_count:1,fetch_duration_average:null!==(t=e.fetch_duration_average)&&void 0!==t?t:0,success_no_change_count:null!==(n=e.success_no_change_count)&&void 0!==n?n:0,success_new_data_count:null!==(i=e.success_new_data_count)&&void 0!==i?i:0,fail_exception_count:null!==(o=e.fail_exception_count)&&void 0!==o?o:0,fail_http_error_count:null!==(s=e.fail_http_error_count)&&void 0!==s?s:0,fail_invalid_data_count:null!==(a=e.fail_invalid_data_count)&&void 0!==a?a:0});this.emitMetrics(c)},e.prototype.exceptionMetrics=function(e,t){var n;t instanceof d.HttpError||(null===(n=null==t?void 0:t.message)||void 0===n?void 0:n.startsWith("http error"))?e.fail_http_error_count=1:e.fail_exception_count=1},e}();t.DeviceConfigManager=h;var p=function(){function e(e,t,n,i,o){var s=this;this.emitValue=function(e,t){s.analytics.onValue(r(r({},s.analyticsProperties),{key_name:e,value:"".concat(t),fetched_seconds_ago:s.getFetchedSecondsAgo()}))},this.emitTrace=function(e,t){s.analytics.onTrace(r(r({},s.analyticsProperties),{key_name:e,message:t}))},this.emitError=function(e,t){s.analytics.onError(r(r({},s.analyticsProperties),{key_name:e,message:t}))},this.analytics=e,this.analyticsProperties=t,this.properties=n,this.dataFetchedWhenMs=i,this.clock=o}return e.prototype.getSize=function(){return this.properties?this.properties.size:-1},e.prototype.getStringValue=function(e){var t,n;if(this.properties){var r=this.properties.get(e);if(r){if(r.type===d.ValueType.STRING){var i=null!==(t=r.valueString)&&void 0!==t?t:"";return this.emitValue(r.name,null!==(n=r.valueAnalytics)&&void 0!==n?n:i),i}this.emitError(r.name,"Type is not a string")}else this.emitError(e,"No property exists for key name")}else this.emitTrace(e,"No properties, local cache is expired")},e.prototype.getNumberValue=function(e){var t,n;if(this.properties){var r=this.properties.get(e);if(r){if(r.type===d.ValueType.NUMBER){var i=null!==(t=r.valueNumber)&&void 0!==t?t:0;return this.emitValue(r.name,null!==(n=r.valueAnalytics)&&void 0!==n?n:i),i}this.emitError(r.name,"Type is not a number")}else this.emitError(e,"No property exists for key name")}else this.emitTrace(e,"No properties, local cache is expired")},e.prototype.getBooleanValue=function(e){var t,n;if(this.properties){var r=this.properties.get(e);if(r){if(r.type===d.ValueType.BOOLEAN){var i=null!==(t=r.valueBoolean)&&void 0!==t&&t;return this.emitValue(r.name,null!==(n=r.valueAnalytics)&&void 0!==n?n:i),i}this.emitError(r.name,"Type is not a boolean")}else this.emitError(e,"No property exists for key name")}else this.emitTrace(e,"No properties, local cache is expired")},e.prototype.getJsonValue=function(e){var t,n;if(this.properties){var r=this.properties.get(e);if(r)if(r.type===d.ValueType.JSON){var i=null!==(t=r.valueAnalytics)&&void 0!==t?t:"",o=r.valueJson;if(o)try{var s=JSON.parse(o);return this.emitValue(r.name,null!==(n=r.valueAnalytics)&&void 0!==n?n:s),s}catch(e){return void this.emitError(r.name,"JSON parse error")}else this.emitValue(r.name,i)}else this.emitError(r.name,"Type is not JSON");else this.emitError(e,"No property exists for key name")}else this.emitTrace(e,"No properties, local cache is expired")},e.prototype.getResolvedConfigForPropertyKey=function(e){var t=e.key,n=e.context,r=e.schema,c=e.trace,u=void 0!==c&&c,d=this.getJsonValue(t);if(void 0!==d)if(0!==d.length){for(var h=[],p=0,f=d;p<f.length;p++){var g=f[p];(T=(0,l.validateSchema)(g,s.DeviceConfigCriteriaConfigSchema)).ok?h.push(g):this.emitError(t,"Criteria structure invalid: ".concat(T.error))}for(var m=new a.CriteriaInputs(n),v=[],E=0,S=h;E<S.length;E++)g=S[E],(T=s.CriteriaParser.evaluateCriteria(g,m)).ok?T.value.matched&&v.push(T.value.payload):this.emitError(t,T.error);if(0!==v.length){for(var _=[],y=0,b=v;y<b.length;y++){var T;g=b[y],(T=(0,l.validateSchema)(g,r)).ok?_.push(g):this.emitError(t,"Payload structure invalid: ".concat(T.error))}var C=o.mergeConfigs.apply(void 0,i([{}],_,!1)),I=JSON.stringify(C);return this.emitValue(t,"Resolved: ".concat(I)),C}if(u){var R=h.length;this.emitTrace(t,"No matches from ".concat(R," payloads"))}}else u&&this.emitTrace(t,"No payloads exist for key")},e.prototype.getFetchedSecondsAgo=function(){if(this.dataFetchedWhenMs)return(this.clock.getMillis()-this.dataFetchedWhenMs)/1e3},e}();t.DeviceConfigPropertyHolder=p;var f=function(){function e(e){this.context=e}return e.prototype.fetchUrl=function(e,t){var n=this,r={headers:t,cache:"no-store"},i=null;if("undefined"!=typeof AbortController){var o=new AbortController;i=this.context.setTimeout((function(){return o.abort()}),1e3*c.DEFAULT_HTTP_TIMEOUT_SECONDS),r.signal=o.signal}return new Promise((function(t,o){n.context.fetch(e,r).then((function(e){if(e.status>=400)o(new d.HttpError("http error ".concat(e.status,", ").concat(e.statusText)));else{var n={status:e.status,headers:e.headers};e.json().then((function(e){n.json=e,t(n)})).catch((function(){t(n)}))}})).catch((function(e){o(e)})).finally((function(){i&&n.context.clearTimeout(i)}))}))},e}()},3864:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),i(n(363),t),i(n(4811),t),i(n(7094),t),i(n(3259),t),i(n(3840),t),i(n(6270),t)},9456:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),i(n(8903),t)},8903:function(e,t,n){"use strict";var r=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.TypedEmitter=void 0;var i=n(228),o=function(){function e(e){var t;this.emitter=new i.EventEmitter,this.propagateErrors=null!==(t=null==e?void 0:e.propagateErrors)&&void 0!==t&&t}return e.prototype.on=function(e,t){t.call=this.wrapCall(e,t),this.emitter.on(e,t)},e.prototype.off=function(e,t){this.emitter.off(e,t)},e.prototype.emit=function(e){for(var t,n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];(t=this.emitter).emit.apply(t,r([e],n,!1))},e.prototype.removeAllListeners=function(){this.emitter.removeAllListeners()},e.prototype.wrapCall=function(e,t){var n=this;return function(r){for(var i=[],o=1;o<arguments.length;o++)i[o-1]=arguments[o];if(n.propagateErrors)t.apply(r,i);else try{t.apply(r,i)}catch(n){var s="Error in callback for ".concat(e),a=t.name;return a&&(s+=" for function ".concat(a)),void console.error(s,n)}}},e}();t.TypedEmitter=o},5987:function(e,t,n){"use strict";var r,i=this&&this.__extends||(r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},r(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),o=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.createFsm=t.FsmWildcardState=t.RejectedTransitionError=t.InvalidStateTransitionError=void 0;var c=a(n(4293)),u=function(e){function t(t,n){var r=e.call(this,"Invalid transition from '".concat(n,"' via event '").concat(t,"'"))||this;return r.name="InvalidStateTransitionError",r}return i(t,e),t}(Error);t.InvalidStateTransitionError=u;var l=function(e){function t(t,n,r){var i=e.call(this,"Transition from '".concat(n,"' via event '").concat(t,"' was rejected for: ").concat(r))||this;return i.name="RejectedTransitionError",i}return i(t,e),t}(Error);t.RejectedTransitionError=l,t.FsmWildcardState="*",t.createFsm=function(e){var n,r=e.transitions,i=e.callbacks,o=e.initialState,s=function(e){var n,i=null===(n=r[e])||void 0===n?void 0:n.from;return!!i&&("string"==typeof i?i===t.FsmWildcardState:i.includes(o))};return{canTransition:s,transition:function(e,t){var a,d,h,p,f,g;if(!s(e))return c.err(new u(String(o),String(e)));var m=r[e];return void 0===m.shouldTransition||m.shouldTransition(o)?(null===(d=null===(a=null==i?void 0:i[o])||void 0===a?void 0:a.onExiting)||void 0===d||d.call(a),null===(h=null==i?void 0:i.onStateExiting)||void 0===h||h.call(i,o),n=o,o=m.to,null===(f=null===(p=null==i?void 0:i[o])||void 0===p?void 0:p.onChanged)||void 0===f||f.call(p,n,t),null===(g=null==i?void 0:i.onStateChanged)||void 0===g||g.call(i,n,o,t),c.ok(o)):c.err(new l(String(o),String(e),"shouldTransition returned false"))},previousState:function(){return n},currentState:function(){return o}}}},8156:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),t.VERSION=void 0,t.VERSION="0.8.0",i(n(3864),t),i(n(9456),t),i(n(5987),t),i(n(9266),t),i(n(6925),t)},6925:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),i(n(6166),t),i(n(7612),t),i(n(7056),t),i(n(8139),t),i(n(3877),t)},6166:function(e,t,n){"use strict";var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},r.apply(this,arguments)},i=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.getLogConfig=t.setLogConfig=t.setLogConfigByLevel=t.extractLogConfig=void 0;var o=n(7612),s=n(7056),a=n(8139),c=n(4478),u={enabled:!1,levels:{debug:!0,log:!0,info:!0,warn:!0,error:!0},targets:[(0,s.createConsoleLogTarget)()],categories:{}},l=Object.keys(u);t.extractLogConfig=function(e){var t={};if(Object.keys(e).some((function(e){return l.includes(e)}))){for(var n=0,r=l;n<r.length;n++){var i=r[n];if(void 0!==e[i]){var o=e[i];t[i]=o}}return t}},t.setLogConfigByLevel=function(e){var n=e.enabled||u.enabled,r=e.targets||u.targets,i={debug:!1,log:!1,info:!1,warn:!1,error:!1},o=function(e,t){for(var n=0,r=e;n<r.length;n++){var o=r[n];i[o]=t}};switch(e.level){case"debug":o(["debug","log","info","warn","error"],n);break;case"log":o(["log","info","warn","error"],n);break;case"info":o(["info","warn","error"],!0);break;case"warn":o(["warn","error"],!0);break;case"error":o(["error"],!0)}(0,t.setLogConfig)({enabled:n,levels:i,targets:r})},t.setLogConfig=function(e){var t=(0,c.mergeConfigs)(u,e);t&&(u=t,o.defaultLogEmitter.emit(a.LogEventType.CONFIG_UPDATED,u))},t.getLogConfig=function(){return{enabled:u.enabled,levels:r({},u.levels),targets:i([],u.targets,!0),categories:r({},u.categories)}}},7612:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultLogEmitter=void 0;var r=n(9456);t.defaultLogEmitter=new r.TypedEmitter({})},7056:function(e,t,n){"use strict";var r=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.createEventLogTarget=t.createConsoleLogTarget=void 0;var i=n(8139);t.createConsoleLogTarget=function(){return{handleMessage:function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];console[e].apply(console,t)}}},t.createEventLogTarget=function(e){return{handleMessage:function(t){for(var n=[],o=1;o<arguments.length;o++)n[o-1]=arguments[o];e.emit.apply(e,r([i.LogEventType.MESSAGE_LOGGED,t],n,!1))}}}},8139:(e,t)=>{"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),t.LogEventType=void 0,function(e){e.CONFIG_UPDATED="logConfigUpdated",e.MESSAGE_LOGGED="messageLogged"}(n||(t.LogEventType=n={}))},3877:function(e,t,n){"use strict";var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},r.apply(this,arguments)},i=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.createLogger=void 0;var o=n(4478),s=n(6166),a=n(7612),c=n(8139),u=function(e,t){return(0,o.mergeConfigs)(e,t)||e};t.createLogger=function(e){var n=e.name,o=e.category,l=e.parent,d=(0,s.extractLogConfig)(e)||{},h=u((0,s.getLogConfig)(),d);a.defaultLogEmitter.on(c.LogEventType.CONFIG_UPDATED,(function(e){h=u(e,d||{})}));var p=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(l&&!l.canLog(e))return!1;if(!g(e))return!1;for(var r=f(),o=(new Date).toTimeString().split(" ")[0],s=i(["".concat(o," - (").concat(r,")")],t,!0),a=0,c=h.targets;a<c.length;a++){var u=c[a];u.handleMessage.apply(u,i([e],s,!1))}return!0},f=function(){return l?"".concat(l.getName()," | ").concat(n):n},g=function(e){return!(!h.enabled||!h.levels[e]||0===h.targets.length||void 0!==o&&!h.categories[o])},m={debug:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return p.apply(void 0,i(["debug"],e,!1))},log:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return p.apply(void 0,i(["log"],e,!1))},info:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return p.apply(void 0,i(["info"],e,!1))},warn:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return p.apply(void 0,i(["warn"],e,!1))},error:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return p.apply(void 0,i(["error"],e,!1))},getName:f,canLog:g,getChildLogger:function(e){return(0,t.createLogger)(r(r({},e),{parent:m}))},setConfig:function(e){h=u(h,d=e)}};return m}},8177:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t},s=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))},a=this&&this.__generator||function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(s=0)),s;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((i=(i=s.trys).length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.hashProperty=void 0;var c=o(n(4293));t.hashProperty=function(e){return s(void 0,void 0,void 0,(function(){var t,n,r,i,o;return a(this,(function(s){switch(s.label){case 0:if("undefined"==typeof crypto)return console.error("here1"),[2,c.err("WebCrypto is unsupported, skipping hash")];if("function"!=typeof(null===crypto||void 0===crypto?void 0:crypto.subtle.digest))return console.error("here2"),[2,c.err("WebCrypto subtle.digest does not exist, possible insecure origin")];s.label=1;case 1:return s.trys.push([1,3,,4]),t=(new TextEncoder).encode(e),[4,crypto.subtle.digest("SHA-256",t)];case 2:return n=s.sent(),r=Array.from(new Uint8Array(n)),i=r.map((function(e){return e.toString(16).padStart(2,"0")})).join(""),[2,c.ok({key:e,hash:i})];case 3:return o=s.sent(),[2,c.err("Unable to hash rule: ".concat(o))];case 4:return[2]}}))}))}},9266:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),i(n(8177),t),i(n(3012),t),i(n(4293),t)},4478:function(e,t,n){"use strict";var r=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.mergeConfigs=void 0;var o=i(n(6924)),s=function(e,t){if(Array.isArray(e))return t};t.mergeConfigs=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var i=t.map((function(e){return null==e||"object"!=typeof e})).filter(Boolean).length>0;if("object"==typeof e&&!i)return o.default.apply(void 0,r(r([{},e],t,!1),[s],!1))}},4293:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getErr=t.getOk_or=t.getOk=t.isNotOk=t.isOk=t.err=t.ok=void 0,t.ok=function(e){return{ok:!0,value:e}},t.err=function(e){return{ok:!1,error:e}},t.isOk=function(e){return!0===e.ok},t.isNotOk=function(e){return!(0,t.isOk)(e)},t.getOk=function(e){return!0===e.ok?e.value:void 0},t.getOk_or=function(e,t){return!0===e.ok?e.value:t},t.getErr=function(e){return!0===e.ok?void 0:e.error}},3012:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.timedThrottle=void 0,t.timedThrottle=function(e,t){var n=0;return function(){for(var r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];var o=Date.now();o-n>=t&&(n=o,e.apply(this,r))}}}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var o=t[r]={id:r,loaded:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}return n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),n(8156)})(),e.exports=t()},1549:(e,t,n)=>{var r=n(2032),i=n(3862),o=n(6721),s=n(2749),a=n(5749);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=i,c.prototype.get=o,c.prototype.has=s,c.prototype.set=a,e.exports=c},79:(e,t,n)=>{var r=n(3702),i=n(80),o=n(4739),s=n(8655),a=n(1175);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=i,c.prototype.get=o,c.prototype.has=s,c.prototype.set=a,e.exports=c},8223:(e,t,n)=>{var r=n(6110)(n(9325),"Map");e.exports=r},3661:(e,t,n)=>{var r=n(3040),i=n(7670),o=n(289),s=n(4509),a=n(2949);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=i,c.prototype.get=o,c.prototype.has=s,c.prototype.set=a,e.exports=c},7217:(e,t,n)=>{var r=n(79),i=n(1420),o=n(938),s=n(3605),a=n(9817),c=n(945);function u(e){var t=this.__data__=new r(e);this.size=t.size}u.prototype.clear=i,u.prototype.delete=o,u.prototype.get=s,u.prototype.has=a,u.prototype.set=c,e.exports=u},1873:(e,t,n)=>{var r=n(9325).Symbol;e.exports=r},7828:(e,t,n)=>{var r=n(9325).Uint8Array;e.exports=r},1033:e=>{e.exports=function(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)}},695:(e,t,n)=>{var r=n(8096),i=n(2428),o=n(6449),s=n(3656),a=n(361),c=n(7167),u=Object.prototype.hasOwnProperty;e.exports=function(e,t){var n=o(e),l=!n&&i(e),d=!n&&!l&&s(e),h=!n&&!l&&!d&&c(e),p=n||l||d||h,f=p?r(e.length,String):[],g=f.length;for(var m in e)!t&&!u.call(e,m)||p&&("length"==m||d&&("offset"==m||"parent"==m)||h&&("buffer"==m||"byteLength"==m||"byteOffset"==m)||a(m,g))||f.push(m);return f}},7805:(e,t,n)=>{var r=n(3360),i=n(5288);e.exports=function(e,t,n){(void 0!==n&&!i(e[t],n)||void 0===n&&!(t in e))&&r(e,t,n)}},6547:(e,t,n)=>{var r=n(3360),i=n(5288),o=Object.prototype.hasOwnProperty;e.exports=function(e,t,n){var s=e[t];o.call(e,t)&&i(s,n)&&(void 0!==n||t in e)||r(e,t,n)}},6025:(e,t,n)=>{var r=n(5288);e.exports=function(e,t){for(var n=e.length;n--;)if(r(e[n][0],t))return n;return-1}},3360:(e,t,n)=>{var r=n(3243);e.exports=function(e,t,n){"__proto__"==t&&r?r(e,t,{configurable:!0,enumerable:!0,value:n,writable:!0}):e[t]=n}},9344:(e,t,n)=>{var r=n(3805),i=Object.create,o=function(){function e(){}return function(t){if(!r(t))return{};if(i)return i(t);e.prototype=t;var n=new e;return e.prototype=void 0,n}}();e.exports=o},6649:(e,t,n)=>{var r=n(3221)();e.exports=r},2552:(e,t,n)=>{var r=n(1873),i=n(659),o=n(9350),s=r?r.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":s&&s in Object(e)?i(e):o(e)}},7534:(e,t,n)=>{var r=n(2552),i=n(346);e.exports=function(e){return i(e)&&"[object Arguments]"==r(e)}},5083:(e,t,n)=>{var r=n(1882),i=n(7296),o=n(3805),s=n(7473),a=/^\[object .+?Constructor\]$/,c=Function.prototype,u=Object.prototype,l=c.toString,d=u.hasOwnProperty,h=RegExp("^"+l.call(d).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");e.exports=function(e){return!(!o(e)||i(e))&&(r(e)?h:a).test(s(e))}},4901:(e,t,n)=>{var r=n(2552),i=n(294),o=n(346),s={};s["[object Float32Array]"]=s["[object Float64Array]"]=s["[object Int8Array]"]=s["[object Int16Array]"]=s["[object Int32Array]"]=s["[object Uint8Array]"]=s["[object Uint8ClampedArray]"]=s["[object Uint16Array]"]=s["[object Uint32Array]"]=!0,s["[object Arguments]"]=s["[object Array]"]=s["[object ArrayBuffer]"]=s["[object Boolean]"]=s["[object DataView]"]=s["[object Date]"]=s["[object Error]"]=s["[object Function]"]=s["[object Map]"]=s["[object Number]"]=s["[object Object]"]=s["[object RegExp]"]=s["[object Set]"]=s["[object String]"]=s["[object WeakMap]"]=!1,e.exports=function(e){return o(e)&&i(e.length)&&!!s[r(e)]}},2903:(e,t,n)=>{var r=n(3805),i=n(5527),o=n(181),s=Object.prototype.hasOwnProperty;e.exports=function(e){if(!r(e))return o(e);var t=i(e),n=[];for(var a in e)("constructor"!=a||!t&&s.call(e,a))&&n.push(a);return n}},5250:(e,t,n)=>{var r=n(7217),i=n(7805),o=n(6649),s=n(2824),a=n(3805),c=n(7241),u=n(4974);e.exports=function e(t,n,l,d,h){t!==n&&o(n,(function(o,c){if(h||(h=new r),a(o))s(t,n,c,l,e,d,h);else{var p=d?d(u(t,c),o,c+"",t,n,h):void 0;void 0===p&&(p=o),i(t,c,p)}}),c)}},2824:(e,t,n)=>{var r=n(7805),i=n(3290),o=n(1961),s=n(3007),a=n(5529),c=n(2428),u=n(6449),l=n(3693),d=n(3656),h=n(1882),p=n(3805),f=n(1331),g=n(7167),m=n(4974),v=n(9884);e.exports=function(e,t,n,E,S,_,y){var b=m(e,n),T=m(t,n),C=y.get(T);if(C)r(e,n,C);else{var I=_?_(b,T,n+"",e,t,y):void 0,R=void 0===I;if(R){var O=u(T),w=!O&&d(T),A=!O&&!w&&g(T);I=T,O||w||A?u(b)?I=b:l(b)?I=s(b):w?(R=!1,I=i(T,!0)):A?(R=!1,I=o(T,!0)):I=[]:f(T)||c(T)?(I=b,c(b)?I=v(b):p(b)&&!h(b)||(I=a(T))):R=!1}R&&(y.set(T,I),S(I,T,E,_,y),y.delete(T)),r(e,n,I)}}},9302:(e,t,n)=>{var r=n(3488),i=n(6757),o=n(2865);e.exports=function(e,t){return o(i(e,t,r),e+"")}},9570:(e,t,n)=>{var r=n(7334),i=n(3243),o=n(3488),s=i?function(e,t){return i(e,"toString",{configurable:!0,enumerable:!1,value:r(t),writable:!0})}:o;e.exports=s},8096:e=>{e.exports=function(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}},7301:e=>{e.exports=function(e){return function(t){return e(t)}}},9653:(e,t,n)=>{var r=n(7828);e.exports=function(e){var t=new e.constructor(e.byteLength);return new r(t).set(new r(e)),t}},3290:(e,t,n)=>{e=n.nmd(e);var r=n(9325),i=t&&!t.nodeType&&t,o=i&&e&&!e.nodeType&&e,s=o&&o.exports===i?r.Buffer:void 0,a=s?s.allocUnsafe:void 0;e.exports=function(e,t){if(t)return e.slice();var n=e.length,r=a?a(n):new e.constructor(n);return e.copy(r),r}},1961:(e,t,n)=>{var r=n(9653);e.exports=function(e,t){var n=t?r(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}},3007:e=>{e.exports=function(e,t){var n=-1,r=e.length;for(t||(t=Array(r));++n<r;)t[n]=e[n];return t}},1791:(e,t,n)=>{var r=n(6547),i=n(3360);e.exports=function(e,t,n,o){var s=!n;n||(n={});for(var a=-1,c=t.length;++a<c;){var u=t[a],l=o?o(n[u],e[u],u,n,e):void 0;void 0===l&&(l=e[u]),s?i(n,u,l):r(n,u,l)}return n}},5481:(e,t,n)=>{var r=n(9325)["__core-js_shared__"];e.exports=r},999:(e,t,n)=>{var r=n(9302),i=n(6800);e.exports=function(e){return r((function(t,n){var r=-1,o=n.length,s=o>1?n[o-1]:void 0,a=o>2?n[2]:void 0;for(s=e.length>3&&"function"==typeof s?(o--,s):void 0,a&&i(n[0],n[1],a)&&(s=o<3?void 0:s,o=1),t=Object(t);++r<o;){var c=n[r];c&&e(t,c,r,s)}return t}))}},3221:e=>{e.exports=function(e){return function(t,n,r){for(var i=-1,o=Object(t),s=r(t),a=s.length;a--;){var c=s[e?a:++i];if(!1===n(o[c],c,o))break}return t}}},3243:(e,t,n)=>{var r=n(6110),i=function(){try{var e=r(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();e.exports=i},4840:(e,t,n)=>{var r="object"==typeof n.g&&n.g&&n.g.Object===Object&&n.g;e.exports=r},2651:(e,t,n)=>{var r=n(4218);e.exports=function(e,t){var n=e.__data__;return r(t)?n["string"==typeof t?"string":"hash"]:n.map}},6110:(e,t,n)=>{var r=n(5083),i=n(392);e.exports=function(e,t){var n=i(e,t);return r(n)?n:void 0}},8879:(e,t,n)=>{var r=n(4335)(Object.getPrototypeOf,Object);e.exports=r},659:(e,t,n)=>{var r=n(1873),i=Object.prototype,o=i.hasOwnProperty,s=i.toString,a=r?r.toStringTag:void 0;e.exports=function(e){var t=o.call(e,a),n=e[a];try{e[a]=void 0;var r=!0}catch(e){}var i=s.call(e);return r&&(t?e[a]=n:delete e[a]),i}},392:e=>{e.exports=function(e,t){return null==e?void 0:e[t]}},2032:(e,t,n)=>{var r=n(1042);e.exports=function(){this.__data__=r?r(null):{},this.size=0}},3862:e=>{e.exports=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}},6721:(e,t,n)=>{var r=n(1042),i=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;if(r){var n=t[e];return"__lodash_hash_undefined__"===n?void 0:n}return i.call(t,e)?t[e]:void 0}},2749:(e,t,n)=>{var r=n(1042),i=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;return r?void 0!==t[e]:i.call(t,e)}},5749:(e,t,n)=>{var r=n(1042);e.exports=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=r&&void 0===t?"__lodash_hash_undefined__":t,this}},5529:(e,t,n)=>{var r=n(9344),i=n(8879),o=n(5527);e.exports=function(e){return"function"!=typeof e.constructor||o(e)?{}:r(i(e))}},361:e=>{var t=/^(?:0|[1-9]\d*)$/;e.exports=function(e,n){var r=typeof e;return!!(n=null==n?9007199254740991:n)&&("number"==r||"symbol"!=r&&t.test(e))&&e>-1&&e%1==0&&e<n}},6800:(e,t,n)=>{var r=n(5288),i=n(4894),o=n(361),s=n(3805);e.exports=function(e,t,n){if(!s(n))return!1;var a=typeof t;return!!("number"==a?i(n)&&o(t,n.length):"string"==a&&t in n)&&r(n[t],e)}},4218:e=>{e.exports=function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}},7296:(e,t,n)=>{var r,i=n(5481),o=(r=/[^.]+$/.exec(i&&i.keys&&i.keys.IE_PROTO||""))?"Symbol(src)_1."+r:"";e.exports=function(e){return!!o&&o in e}},5527:e=>{var t=Object.prototype;e.exports=function(e){var n=e&&e.constructor;return e===("function"==typeof n&&n.prototype||t)}},3702:e=>{e.exports=function(){this.__data__=[],this.size=0}},80:(e,t,n)=>{var r=n(6025),i=Array.prototype.splice;e.exports=function(e){var t=this.__data__,n=r(t,e);return!(n<0)&&(n==t.length-1?t.pop():i.call(t,n,1),--this.size,!0)}},4739:(e,t,n)=>{var r=n(6025);e.exports=function(e){var t=this.__data__,n=r(t,e);return n<0?void 0:t[n][1]}},8655:(e,t,n)=>{var r=n(6025);e.exports=function(e){return r(this.__data__,e)>-1}},1175:(e,t,n)=>{var r=n(6025);e.exports=function(e,t){var n=this.__data__,i=r(n,e);return i<0?(++this.size,n.push([e,t])):n[i][1]=t,this}},3040:(e,t,n)=>{var r=n(1549),i=n(79),o=n(8223);e.exports=function(){this.size=0,this.__data__={hash:new r,map:new(o||i),string:new r}}},7670:(e,t,n)=>{var r=n(2651);e.exports=function(e){var t=r(this,e).delete(e);return this.size-=t?1:0,t}},289:(e,t,n)=>{var r=n(2651);e.exports=function(e){return r(this,e).get(e)}},4509:(e,t,n)=>{var r=n(2651);e.exports=function(e){return r(this,e).has(e)}},2949:(e,t,n)=>{var r=n(2651);e.exports=function(e,t){var n=r(this,e),i=n.size;return n.set(e,t),this.size+=n.size==i?0:1,this}},1042:(e,t,n)=>{var r=n(6110)(Object,"create");e.exports=r},181:e=>{e.exports=function(e){var t=[];if(null!=e)for(var n in Object(e))t.push(n);return t}},6009:(e,t,n)=>{e=n.nmd(e);var r=n(4840),i=t&&!t.nodeType&&t,o=i&&e&&!e.nodeType&&e,s=o&&o.exports===i&&r.process,a=function(){try{var e=o&&o.require&&o.require("util").types;return e||s&&s.binding&&s.binding("util")}catch(e){}}();e.exports=a},9350:e=>{var t=Object.prototype.toString;e.exports=function(e){return t.call(e)}},4335:e=>{e.exports=function(e,t){return function(n){return e(t(n))}}},6757:(e,t,n)=>{var r=n(1033),i=Math.max;e.exports=function(e,t,n){return t=i(void 0===t?e.length-1:t,0),function(){for(var o=arguments,s=-1,a=i(o.length-t,0),c=Array(a);++s<a;)c[s]=o[t+s];s=-1;for(var u=Array(t+1);++s<t;)u[s]=o[s];return u[t]=n(c),r(e,this,u)}}},9325:(e,t,n)=>{var r=n(4840),i="object"==typeof self&&self&&self.Object===Object&&self,o=r||i||Function("return this")();e.exports=o},4974:e=>{e.exports=function(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]}},2865:(e,t,n)=>{var r=n(9570),i=n(1811)(r);e.exports=i},1811:e=>{var t=Date.now;e.exports=function(e){var n=0,r=0;return function(){var i=t(),o=16-(i-r);if(r=i,o>0){if(++n>=800)return arguments[0]}else n=0;return e.apply(void 0,arguments)}}},1420:(e,t,n)=>{var r=n(79);e.exports=function(){this.__data__=new r,this.size=0}},938:e=>{e.exports=function(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n}},3605:e=>{e.exports=function(e){return this.__data__.get(e)}},9817:e=>{e.exports=function(e){return this.__data__.has(e)}},945:(e,t,n)=>{var r=n(79),i=n(8223),o=n(3661);e.exports=function(e,t){var n=this.__data__;if(n instanceof r){var s=n.__data__;if(!i||s.length<199)return s.push([e,t]),this.size=++n.size,this;n=this.__data__=new o(s)}return n.set(e,t),this.size=n.size,this}},7473:e=>{var t=Function.prototype.toString;e.exports=function(e){if(null!=e){try{return t.call(e)}catch(e){}try{return e+""}catch(e){}}return""}},7334:e=>{e.exports=function(e){return function(){return e}}},5288:e=>{e.exports=function(e,t){return e===t||e!=e&&t!=t}},3488:e=>{e.exports=function(e){return e}},2428:(e,t,n)=>{var r=n(7534),i=n(346),o=Object.prototype,s=o.hasOwnProperty,a=o.propertyIsEnumerable,c=r(function(){return arguments}())?r:function(e){return i(e)&&s.call(e,"callee")&&!a.call(e,"callee")};e.exports=c},6449:e=>{var t=Array.isArray;e.exports=t},4894:(e,t,n)=>{var r=n(1882),i=n(294);e.exports=function(e){return null!=e&&i(e.length)&&!r(e)}},3693:(e,t,n)=>{var r=n(4894),i=n(346);e.exports=function(e){return i(e)&&r(e)}},3656:(e,t,n)=>{e=n.nmd(e);var r=n(9325),i=n(9935),o=t&&!t.nodeType&&t,s=o&&e&&!e.nodeType&&e,a=s&&s.exports===o?r.Buffer:void 0,c=(a?a.isBuffer:void 0)||i;e.exports=c},1882:(e,t,n)=>{var r=n(2552),i=n(3805);e.exports=function(e){if(!i(e))return!1;var t=r(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t}},294:e=>{e.exports=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}},3805:e=>{e.exports=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}},346:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},1331:(e,t,n)=>{var r=n(2552),i=n(8879),o=n(346),s=Function.prototype,a=Object.prototype,c=s.toString,u=a.hasOwnProperty,l=c.call(Object);e.exports=function(e){if(!o(e)||"[object Object]"!=r(e))return!1;var t=i(e);if(null===t)return!0;var n=u.call(t,"constructor")&&t.constructor;return"function"==typeof n&&n instanceof n&&c.call(n)==l}},7167:(e,t,n)=>{var r=n(4901),i=n(7301),o=n(6009),s=o&&o.isTypedArray,a=s?i(s):r;e.exports=a},7241:(e,t,n)=>{var r=n(695),i=n(2903),o=n(4894);e.exports=function(e){return o(e)?r(e,!0):i(e)}},2543:function(e,t,n){var r;e=n.nmd(e),function(){var i,o="Expected a function",s="__lodash_hash_undefined__",a="__lodash_placeholder__",c=16,u=32,l=64,d=128,h=256,p=1/0,f=9007199254740991,g=NaN,m=4294967295,v=[["ary",d],["bind",1],["bindKey",2],["curry",8],["curryRight",c],["flip",512],["partial",u],["partialRight",l],["rearg",h]],E="[object Arguments]",S="[object Array]",_="[object Boolean]",y="[object Date]",b="[object Error]",T="[object Function]",C="[object GeneratorFunction]",I="[object Map]",R="[object Number]",O="[object Object]",w="[object Promise]",A="[object RegExp]",k="[object Set]",P="[object String]",D="[object Symbol]",N="[object WeakMap]",L="[object ArrayBuffer]",M="[object DataView]",x="[object Float32Array]",B="[object Float64Array]",U="[object Int8Array]",j="[object Int16Array]",F="[object Int32Array]",V="[object Uint8Array]",G="[object Uint8ClampedArray]",H="[object Uint16Array]",W="[object Uint32Array]",$=/\b__p \+= '';/g,q=/\b(__p \+=) '' \+/g,z=/(__e\(.*?\)|\b__t\)) \+\n'';/g,K=/&(?:amp|lt|gt|quot|#39);/g,J=/[&<>"']/g,Y=RegExp(K.source),Q=RegExp(J.source),X=/<%-([\s\S]+?)%>/g,Z=/<%([\s\S]+?)%>/g,ee=/<%=([\s\S]+?)%>/g,te=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,ne=/^\w*$/,re=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,ie=/[\\^$.*+?()[\]{}|]/g,oe=RegExp(ie.source),se=/^\s+/,ae=/\s/,ce=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,ue=/\{\n\/\* \[wrapped with (.+)\] \*/,le=/,? & /,de=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,he=/[()=,{}\[\]\/\s]/,pe=/\\(\\)?/g,fe=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,ge=/\w*$/,me=/^[-+]0x[0-9a-f]+$/i,ve=/^0b[01]+$/i,Ee=/^\[object .+?Constructor\]$/,Se=/^0o[0-7]+$/i,_e=/^(?:0|[1-9]\d*)$/,ye=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,be=/($^)/,Te=/['\n\r\u2028\u2029\\]/g,Ce="\\ud800-\\udfff",Ie="\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff",Re="\\u2700-\\u27bf",Oe="a-z\\xdf-\\xf6\\xf8-\\xff",we="A-Z\\xc0-\\xd6\\xd8-\\xde",Ae="\\ufe0e\\ufe0f",ke="\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",Pe="[']",De="["+Ce+"]",Ne="["+ke+"]",Le="["+Ie+"]",Me="\\d+",xe="["+Re+"]",Be="["+Oe+"]",Ue="[^"+Ce+ke+Me+Re+Oe+we+"]",je="\\ud83c[\\udffb-\\udfff]",Fe="[^"+Ce+"]",Ve="(?:\\ud83c[\\udde6-\\uddff]){2}",Ge="[\\ud800-\\udbff][\\udc00-\\udfff]",He="["+we+"]",We="\\u200d",$e="(?:"+Be+"|"+Ue+")",qe="(?:"+He+"|"+Ue+")",ze="(?:['](?:d|ll|m|re|s|t|ve))?",Ke="(?:['](?:D|LL|M|RE|S|T|VE))?",Je="(?:"+Le+"|"+je+")"+"?",Ye="["+Ae+"]?",Qe=Ye+Je+("(?:"+We+"(?:"+[Fe,Ve,Ge].join("|")+")"+Ye+Je+")*"),Xe="(?:"+[xe,Ve,Ge].join("|")+")"+Qe,Ze="(?:"+[Fe+Le+"?",Le,Ve,Ge,De].join("|")+")",et=RegExp(Pe,"g"),tt=RegExp(Le,"g"),nt=RegExp(je+"(?="+je+")|"+Ze+Qe,"g"),rt=RegExp([He+"?"+Be+"+"+ze+"(?="+[Ne,He,"$"].join("|")+")",qe+"+"+Ke+"(?="+[Ne,He+$e,"$"].join("|")+")",He+"?"+$e+"+"+ze,He+"+"+Ke,"\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])","\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",Me,Xe].join("|"),"g"),it=RegExp("["+We+Ce+Ie+Ae+"]"),ot=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,st=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],at=-1,ct={};ct[x]=ct[B]=ct[U]=ct[j]=ct[F]=ct[V]=ct[G]=ct[H]=ct[W]=!0,ct[E]=ct[S]=ct[L]=ct[_]=ct[M]=ct[y]=ct[b]=ct[T]=ct[I]=ct[R]=ct[O]=ct[A]=ct[k]=ct[P]=ct[N]=!1;var ut={};ut[E]=ut[S]=ut[L]=ut[M]=ut[_]=ut[y]=ut[x]=ut[B]=ut[U]=ut[j]=ut[F]=ut[I]=ut[R]=ut[O]=ut[A]=ut[k]=ut[P]=ut[D]=ut[V]=ut[G]=ut[H]=ut[W]=!0,ut[b]=ut[T]=ut[N]=!1;var lt={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},dt=parseFloat,ht=parseInt,pt="object"==typeof n.g&&n.g&&n.g.Object===Object&&n.g,ft="object"==typeof self&&self&&self.Object===Object&&self,gt=pt||ft||Function("return this")(),mt=t&&!t.nodeType&&t,vt=mt&&e&&!e.nodeType&&e,Et=vt&&vt.exports===mt,St=Et&&pt.process,_t=function(){try{var e=vt&&vt.require&&vt.require("util").types;return e||St&&St.binding&&St.binding("util")}catch(e){}}(),yt=_t&&_t.isArrayBuffer,bt=_t&&_t.isDate,Tt=_t&&_t.isMap,Ct=_t&&_t.isRegExp,It=_t&&_t.isSet,Rt=_t&&_t.isTypedArray;function Ot(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)}function wt(e,t,n,r){for(var i=-1,o=null==e?0:e.length;++i<o;){var s=e[i];t(r,s,n(s),e)}return r}function At(e,t){for(var n=-1,r=null==e?0:e.length;++n<r&&!1!==t(e[n],n,e););return e}function kt(e,t){for(var n=null==e?0:e.length;n--&&!1!==t(e[n],n,e););return e}function Pt(e,t){for(var n=-1,r=null==e?0:e.length;++n<r;)if(!t(e[n],n,e))return!1;return!0}function Dt(e,t){for(var n=-1,r=null==e?0:e.length,i=0,o=[];++n<r;){var s=e[n];t(s,n,e)&&(o[i++]=s)}return o}function Nt(e,t){return!!(null==e?0:e.length)&&Ht(e,t,0)>-1}function Lt(e,t,n){for(var r=-1,i=null==e?0:e.length;++r<i;)if(n(t,e[r]))return!0;return!1}function Mt(e,t){for(var n=-1,r=null==e?0:e.length,i=Array(r);++n<r;)i[n]=t(e[n],n,e);return i}function xt(e,t){for(var n=-1,r=t.length,i=e.length;++n<r;)e[i+n]=t[n];return e}function Bt(e,t,n,r){var i=-1,o=null==e?0:e.length;for(r&&o&&(n=e[++i]);++i<o;)n=t(n,e[i],i,e);return n}function Ut(e,t,n,r){var i=null==e?0:e.length;for(r&&i&&(n=e[--i]);i--;)n=t(n,e[i],i,e);return n}function jt(e,t){for(var n=-1,r=null==e?0:e.length;++n<r;)if(t(e[n],n,e))return!0;return!1}var Ft=zt("length");function Vt(e,t,n){var r;return n(e,(function(e,n,i){if(t(e,n,i))return r=n,!1})),r}function Gt(e,t,n,r){for(var i=e.length,o=n+(r?1:-1);r?o--:++o<i;)if(t(e[o],o,e))return o;return-1}function Ht(e,t,n){return t==t?function(e,t,n){var r=n-1,i=e.length;for(;++r<i;)if(e[r]===t)return r;return-1}(e,t,n):Gt(e,$t,n)}function Wt(e,t,n,r){for(var i=n-1,o=e.length;++i<o;)if(r(e[i],t))return i;return-1}function $t(e){return e!=e}function qt(e,t){var n=null==e?0:e.length;return n?Yt(e,t)/n:g}function zt(e){return function(t){return null==t?i:t[e]}}function Kt(e){return function(t){return null==e?i:e[t]}}function Jt(e,t,n,r,i){return i(e,(function(e,i,o){n=r?(r=!1,e):t(n,e,i,o)})),n}function Yt(e,t){for(var n,r=-1,o=e.length;++r<o;){var s=t(e[r]);s!==i&&(n=n===i?s:n+s)}return n}function Qt(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}function Xt(e){return e?e.slice(0,mn(e)+1).replace(se,""):e}function Zt(e){return function(t){return e(t)}}function en(e,t){return Mt(t,(function(t){return e[t]}))}function tn(e,t){return e.has(t)}function nn(e,t){for(var n=-1,r=e.length;++n<r&&Ht(t,e[n],0)>-1;);return n}function rn(e,t){for(var n=e.length;n--&&Ht(t,e[n],0)>-1;);return n}var on=Kt({:"A",:"A",:"A",:"A",:"A",:"A",:"a",:"a",:"a",:"a",:"a",:"a",:"C",:"c",:"D",:"d",:"E",:"E",:"E",:"E",:"e",:"e",:"e",:"e",:"I",:"I",:"I",:"I",:"i",:"i",:"i",:"i",:"N",:"n",:"O",:"O",:"O",:"O",:"O",:"O",:"o",:"o",:"o",:"o",:"o",:"o",:"U",:"U",:"U",:"U",:"u",:"u",:"u",:"u",:"Y",:"y",:"y",:"Ae",:"ae",:"Th",:"th",:"ss",:"A",:"A",:"A",:"a",:"a",:"a",:"C",:"C",:"C",:"C",:"c",:"c",:"c",:"c",:"D",:"D",:"d",:"d",:"E",:"E",:"E",:"E",:"E",:"e",:"e",:"e",:"e",:"e",:"G",:"G",:"G",:"G",:"g",:"g",:"g",:"g",:"H",:"H",:"h",:"h",:"I",:"I",:"I",:"I",:"I",:"i",:"i",:"i",:"i",:"i",:"J",:"j",:"K",:"k",:"k",:"L",:"L",:"L",:"L",:"L",:"l",:"l",:"l",:"l",:"l",:"N",:"N",:"N",:"N",:"n",:"n",:"n",:"n",:"O",:"O",:"O",:"o",:"o",:"o",:"R",:"R",:"R",:"r",:"r",:"r",:"S",:"S",:"S",:"S",:"s",:"s",:"s",:"s",:"T",:"T",:"T",:"t",:"t",:"t",:"U",:"U",:"U",:"U",:"U",:"U",:"u",:"u",:"u",:"u",:"u",:"u",:"W",:"w",:"Y",:"y",:"Y",:"Z",:"Z",:"Z",:"z",:"z",:"z",:"IJ",:"ij",:"Oe",:"oe",:"'n",:"s"}),sn=Kt({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"});function an(e){return"\\"+lt[e]}function cn(e){return it.test(e)}function un(e){var t=-1,n=Array(e.size);return e.forEach((function(e,r){n[++t]=[r,e]})),n}function ln(e,t){return function(n){return e(t(n))}}function dn(e,t){for(var n=-1,r=e.length,i=0,o=[];++n<r;){var s=e[n];s!==t&&s!==a||(e[n]=a,o[i++]=n)}return o}function hn(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=e})),n}function pn(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=[e,e]})),n}function fn(e){return cn(e)?function(e){var t=nt.lastIndex=0;for(;nt.test(e);)++t;return t}(e):Ft(e)}function gn(e){return cn(e)?function(e){return e.match(nt)||[]}(e):function(e){return e.split("")}(e)}function mn(e){for(var t=e.length;t--&&ae.test(e.charAt(t)););return t}var vn=Kt({"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"});var En=function e(t){var n,r=(t=null==t?gt:En.defaults(gt.Object(),t,En.pick(gt,st))).Array,ae=t.Date,Ce=t.Error,Ie=t.Function,Re=t.Math,Oe=t.Object,we=t.RegExp,Ae=t.String,ke=t.TypeError,Pe=r.prototype,De=Ie.prototype,Ne=Oe.prototype,Le=t["__core-js_shared__"],Me=De.toString,xe=Ne.hasOwnProperty,Be=0,Ue=(n=/[^.]+$/.exec(Le&&Le.keys&&Le.keys.IE_PROTO||""))?"Symbol(src)_1."+n:"",je=Ne.toString,Fe=Me.call(Oe),Ve=gt._,Ge=we("^"+Me.call(xe).replace(ie,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),He=Et?t.Buffer:i,We=t.Symbol,$e=t.Uint8Array,qe=He?He.allocUnsafe:i,ze=ln(Oe.getPrototypeOf,Oe),Ke=Oe.create,Je=Ne.propertyIsEnumerable,Ye=Pe.splice,Qe=We?We.isConcatSpreadable:i,Xe=We?We.iterator:i,Ze=We?We.toStringTag:i,nt=function(){try{var e=po(Oe,"defineProperty");return e({},"",{}),e}catch(e){}}(),it=t.clearTimeout!==gt.clearTimeout&&t.clearTimeout,lt=ae&&ae.now!==gt.Date.now&&ae.now,pt=t.setTimeout!==gt.setTimeout&&t.setTimeout,ft=Re.ceil,mt=Re.floor,vt=Oe.getOwnPropertySymbols,St=He?He.isBuffer:i,_t=t.isFinite,Ft=Pe.join,Kt=ln(Oe.keys,Oe),Sn=Re.max,_n=Re.min,yn=ae.now,bn=t.parseInt,Tn=Re.random,Cn=Pe.reverse,In=po(t,"DataView"),Rn=po(t,"Map"),On=po(t,"Promise"),wn=po(t,"Set"),An=po(t,"WeakMap"),kn=po(Oe,"create"),Pn=An&&new An,Dn={},Nn=jo(In),Ln=jo(Rn),Mn=jo(On),xn=jo(wn),Bn=jo(An),Un=We?We.prototype:i,jn=Un?Un.valueOf:i,Fn=Un?Un.toString:i;function Vn(e){if(na(e)&&!$s(e)&&!(e instanceof $n)){if(e instanceof Wn)return e;if(xe.call(e,"__wrapped__"))return Fo(e)}return new Wn(e)}var Gn=function(){function e(){}return function(t){if(!ta(t))return{};if(Ke)return Ke(t);e.prototype=t;var n=new e;return e.prototype=i,n}}();function Hn(){}function Wn(e,t){this.__wrapped__=e,this.__actions__=[],this.__chain__=!!t,this.__index__=0,this.__values__=i}function $n(e){this.__wrapped__=e,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=m,this.__views__=[]}function qn(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function zn(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function Kn(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function Jn(e){var t=-1,n=null==e?0:e.length;for(this.__data__=new Kn;++t<n;)this.add(e[t])}function Yn(e){var t=this.__data__=new zn(e);this.size=t.size}function Qn(e,t){var n=$s(e),r=!n&&Ws(e),i=!n&&!r&&Js(e),o=!n&&!r&&!i&&la(e),s=n||r||i||o,a=s?Qt(e.length,Ae):[],c=a.length;for(var u in e)!t&&!xe.call(e,u)||s&&("length"==u||i&&("offset"==u||"parent"==u)||o&&("buffer"==u||"byteLength"==u||"byteOffset"==u)||_o(u,c))||a.push(u);return a}function Xn(e){var t=e.length;return t?e[Jr(0,t-1)]:i}function Zn(e,t){return xo(ki(e),cr(t,0,e.length))}function er(e){return xo(ki(e))}function tr(e,t,n){(n!==i&&!Vs(e[t],n)||n===i&&!(t in e))&&sr(e,t,n)}function nr(e,t,n){var r=e[t];xe.call(e,t)&&Vs(r,n)&&(n!==i||t in e)||sr(e,t,n)}function rr(e,t){for(var n=e.length;n--;)if(Vs(e[n][0],t))return n;return-1}function ir(e,t,n,r){return pr(e,(function(e,i,o){t(r,e,n(e),o)})),r}function or(e,t){return e&&Pi(t,Da(t),e)}function sr(e,t,n){"__proto__"==t&&nt?nt(e,t,{configurable:!0,enumerable:!0,value:n,writable:!0}):e[t]=n}function ar(e,t){for(var n=-1,o=t.length,s=r(o),a=null==e;++n<o;)s[n]=a?i:Oa(e,t[n]);return s}function cr(e,t,n){return e==e&&(n!==i&&(e=e<=n?e:n),t!==i&&(e=e>=t?e:t)),e}function ur(e,t,n,r,o,s){var a,c=1&t,u=2&t,l=4&t;if(n&&(a=o?n(e,r,o,s):n(e)),a!==i)return a;if(!ta(e))return e;var d=$s(e);if(d){if(a=function(e){var t=e.length,n=new e.constructor(t);t&&"string"==typeof e[0]&&xe.call(e,"index")&&(n.index=e.index,n.input=e.input);return n}(e),!c)return ki(e,a)}else{var h=mo(e),p=h==T||h==C;if(Js(e))return Ci(e,c);if(h==O||h==E||p&&!o){if(a=u||p?{}:Eo(e),!c)return u?function(e,t){return Pi(e,go(e),t)}(e,function(e,t){return e&&Pi(t,Na(t),e)}(a,e)):function(e,t){return Pi(e,fo(e),t)}(e,or(a,e))}else{if(!ut[h])return o?e:{};a=function(e,t,n){var r=e.constructor;switch(t){case L:return Ii(e);case _:case y:return new r(+e);case M:return function(e,t){var n=t?Ii(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.byteLength)}(e,n);case x:case B:case U:case j:case F:case V:case G:case H:case W:return Ri(e,n);case I:return new r;case R:case P:return new r(e);case A:return function(e){var t=new e.constructor(e.source,ge.exec(e));return t.lastIndex=e.lastIndex,t}(e);case k:return new r;case D:return i=e,jn?Oe(jn.call(i)):{}}var i}(e,h,c)}}s||(s=new Yn);var f=s.get(e);if(f)return f;s.set(e,a),aa(e)?e.forEach((function(r){a.add(ur(r,t,n,r,e,s))})):ra(e)&&e.forEach((function(r,i){a.set(i,ur(r,t,n,i,e,s))}));var g=d?i:(l?u?oo:io:u?Na:Da)(e);return At(g||e,(function(r,i){g&&(r=e[i=r]),nr(a,i,ur(r,t,n,i,e,s))})),a}function lr(e,t,n){var r=n.length;if(null==e)return!r;for(e=Oe(e);r--;){var o=n[r],s=t[o],a=e[o];if(a===i&&!(o in e)||!s(a))return!1}return!0}function dr(e,t,n){if("function"!=typeof e)throw new ke(o);return Do((function(){e.apply(i,n)}),t)}function hr(e,t,n,r){var i=-1,o=Nt,s=!0,a=e.length,c=[],u=t.length;if(!a)return c;n&&(t=Mt(t,Zt(n))),r?(o=Lt,s=!1):t.length>=200&&(o=tn,s=!1,t=new Jn(t));e:for(;++i<a;){var l=e[i],d=null==n?l:n(l);if(l=r||0!==l?l:0,s&&d==d){for(var h=u;h--;)if(t[h]===d)continue e;c.push(l)}else o(t,d,r)||c.push(l)}return c}Vn.templateSettings={escape:X,evaluate:Z,interpolate:ee,variable:"",imports:{_:Vn}},Vn.prototype=Hn.prototype,Vn.prototype.constructor=Vn,Wn.prototype=Gn(Hn.prototype),Wn.prototype.constructor=Wn,$n.prototype=Gn(Hn.prototype),$n.prototype.constructor=$n,qn.prototype.clear=function(){this.__data__=kn?kn(null):{},this.size=0},qn.prototype.delete=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},qn.prototype.get=function(e){var t=this.__data__;if(kn){var n=t[e];return n===s?i:n}return xe.call(t,e)?t[e]:i},qn.prototype.has=function(e){var t=this.__data__;return kn?t[e]!==i:xe.call(t,e)},qn.prototype.set=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=kn&&t===i?s:t,this},zn.prototype.clear=function(){this.__data__=[],this.size=0},zn.prototype.delete=function(e){var t=this.__data__,n=rr(t,e);return!(n<0)&&(n==t.length-1?t.pop():Ye.call(t,n,1),--this.size,!0)},zn.prototype.get=function(e){var t=this.__data__,n=rr(t,e);return n<0?i:t[n][1]},zn.prototype.has=function(e){return rr(this.__data__,e)>-1},zn.prototype.set=function(e,t){var n=this.__data__,r=rr(n,e);return r<0?(++this.size,n.push([e,t])):n[r][1]=t,this},Kn.prototype.clear=function(){this.size=0,this.__data__={hash:new qn,map:new(Rn||zn),string:new qn}},Kn.prototype.delete=function(e){var t=lo(this,e).delete(e);return this.size-=t?1:0,t},Kn.prototype.get=function(e){return lo(this,e).get(e)},Kn.prototype.has=function(e){return lo(this,e).has(e)},Kn.prototype.set=function(e,t){var n=lo(this,e),r=n.size;return n.set(e,t),this.size+=n.size==r?0:1,this},Jn.prototype.add=Jn.prototype.push=function(e){return this.__data__.set(e,s),this},Jn.prototype.has=function(e){return this.__data__.has(e)},Yn.prototype.clear=function(){this.__data__=new zn,this.size=0},Yn.prototype.delete=function(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n},Yn.prototype.get=function(e){return this.__data__.get(e)},Yn.prototype.has=function(e){return this.__data__.has(e)},Yn.prototype.set=function(e,t){var n=this.__data__;if(n instanceof zn){var r=n.__data__;if(!Rn||r.length<199)return r.push([e,t]),this.size=++n.size,this;n=this.__data__=new Kn(r)}return n.set(e,t),this.size=n.size,this};var pr=Li(yr),fr=Li(br,!0);function gr(e,t){var n=!0;return pr(e,(function(e,r,i){return n=!!t(e,r,i)})),n}function mr(e,t,n){for(var r=-1,o=e.length;++r<o;){var s=e[r],a=t(s);if(null!=a&&(c===i?a==a&&!ua(a):n(a,c)))var c=a,u=s}return u}function vr(e,t){var n=[];return pr(e,(function(e,r,i){t(e,r,i)&&n.push(e)})),n}function Er(e,t,n,r,i){var o=-1,s=e.length;for(n||(n=So),i||(i=[]);++o<s;){var a=e[o];t>0&&n(a)?t>1?Er(a,t-1,n,r,i):xt(i,a):r||(i[i.length]=a)}return i}var Sr=Mi(),_r=Mi(!0);function yr(e,t){return e&&Sr(e,t,Da)}function br(e,t){return e&&_r(e,t,Da)}function Tr(e,t){return Dt(t,(function(t){return Xs(e[t])}))}function Cr(e,t){for(var n=0,r=(t=_i(t,e)).length;null!=e&&n<r;)e=e[Uo(t[n++])];return n&&n==r?e:i}function Ir(e,t,n){var r=t(e);return $s(e)?r:xt(r,n(e))}function Rr(e){return null==e?e===i?"[object Undefined]":"[object Null]":Ze&&Ze in Oe(e)?function(e){var t=xe.call(e,Ze),n=e[Ze];try{e[Ze]=i;var r=!0}catch(e){}var o=je.call(e);r&&(t?e[Ze]=n:delete e[Ze]);return o}(e):function(e){return je.call(e)}(e)}function Or(e,t){return e>t}function wr(e,t){return null!=e&&xe.call(e,t)}function Ar(e,t){return null!=e&&t in Oe(e)}function kr(e,t,n){for(var o=n?Lt:Nt,s=e[0].length,a=e.length,c=a,u=r(a),l=1/0,d=[];c--;){var h=e[c];c&&t&&(h=Mt(h,Zt(t))),l=_n(h.length,l),u[c]=!n&&(t||s>=120&&h.length>=120)?new Jn(c&&h):i}h=e[0];var p=-1,f=u[0];e:for(;++p<s&&d.length<l;){var g=h[p],m=t?t(g):g;if(g=n||0!==g?g:0,!(f?tn(f,m):o(d,m,n))){for(c=a;--c;){var v=u[c];if(!(v?tn(v,m):o(e[c],m,n)))continue e}f&&f.push(m),d.push(g)}}return d}function Pr(e,t,n){var r=null==(e=Ao(e,t=_i(t,e)))?e:e[Uo(Qo(t))];return null==r?i:Ot(r,e,n)}function Dr(e){return na(e)&&Rr(e)==E}function Nr(e,t,n,r,o){return e===t||(null==e||null==t||!na(e)&&!na(t)?e!=e&&t!=t:function(e,t,n,r,o,s){var a=$s(e),c=$s(t),u=a?S:mo(e),l=c?S:mo(t),d=(u=u==E?O:u)==O,h=(l=l==E?O:l)==O,p=u==l;if(p&&Js(e)){if(!Js(t))return!1;a=!0,d=!1}if(p&&!d)return s||(s=new Yn),a||la(e)?no(e,t,n,r,o,s):function(e,t,n,r,i,o,s){switch(n){case M:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case L:return!(e.byteLength!=t.byteLength||!o(new $e(e),new $e(t)));case _:case y:case R:return Vs(+e,+t);case b:return e.name==t.name&&e.message==t.message;case A:case P:return e==t+"";case I:var a=un;case k:var c=1&r;if(a||(a=hn),e.size!=t.size&&!c)return!1;var u=s.get(e);if(u)return u==t;r|=2,s.set(e,t);var l=no(a(e),a(t),r,i,o,s);return s.delete(e),l;case D:if(jn)return jn.call(e)==jn.call(t)}return!1}(e,t,u,n,r,o,s);if(!(1&n)){var f=d&&xe.call(e,"__wrapped__"),g=h&&xe.call(t,"__wrapped__");if(f||g){var m=f?e.value():e,v=g?t.value():t;return s||(s=new Yn),o(m,v,n,r,s)}}if(!p)return!1;return s||(s=new Yn),function(e,t,n,r,o,s){var a=1&n,c=io(e),u=c.length,l=io(t),d=l.length;if(u!=d&&!a)return!1;var h=u;for(;h--;){var p=c[h];if(!(a?p in t:xe.call(t,p)))return!1}var f=s.get(e),g=s.get(t);if(f&&g)return f==t&&g==e;var m=!0;s.set(e,t),s.set(t,e);var v=a;for(;++h<u;){var E=e[p=c[h]],S=t[p];if(r)var _=a?r(S,E,p,t,e,s):r(E,S,p,e,t,s);if(!(_===i?E===S||o(E,S,n,r,s):_)){m=!1;break}v||(v="constructor"==p)}if(m&&!v){var y=e.constructor,b=t.constructor;y==b||!("constructor"in e)||!("constructor"in t)||"function"==typeof y&&y instanceof y&&"function"==typeof b&&b instanceof b||(m=!1)}return s.delete(e),s.delete(t),m}(e,t,n,r,o,s)}(e,t,n,r,Nr,o))}function Lr(e,t,n,r){var o=n.length,s=o,a=!r;if(null==e)return!s;for(e=Oe(e);o--;){var c=n[o];if(a&&c[2]?c[1]!==e[c[0]]:!(c[0]in e))return!1}for(;++o<s;){var u=(c=n[o])[0],l=e[u],d=c[1];if(a&&c[2]){if(l===i&&!(u in e))return!1}else{var h=new Yn;if(r)var p=r(l,d,u,e,t,h);if(!(p===i?Nr(d,l,3,r,h):p))return!1}}return!0}function Mr(e){return!(!ta(e)||(t=e,Ue&&Ue in t))&&(Xs(e)?Ge:Ee).test(jo(e));var t}function xr(e){return"function"==typeof e?e:null==e?ic:"object"==typeof e?$s(e)?Gr(e[0],e[1]):Vr(e):pc(e)}function Br(e){if(!Io(e))return Kt(e);var t=[];for(var n in Oe(e))xe.call(e,n)&&"constructor"!=n&&t.push(n);return t}function Ur(e){if(!ta(e))return function(e){var t=[];if(null!=e)for(var n in Oe(e))t.push(n);return t}(e);var t=Io(e),n=[];for(var r in e)("constructor"!=r||!t&&xe.call(e,r))&&n.push(r);return n}function jr(e,t){return e<t}function Fr(e,t){var n=-1,i=zs(e)?r(e.length):[];return pr(e,(function(e,r,o){i[++n]=t(e,r,o)})),i}function Vr(e){var t=ho(e);return 1==t.length&&t[0][2]?Oo(t[0][0],t[0][1]):function(n){return n===e||Lr(n,e,t)}}function Gr(e,t){return bo(e)&&Ro(t)?Oo(Uo(e),t):function(n){var r=Oa(n,e);return r===i&&r===t?wa(n,e):Nr(t,r,3)}}function Hr(e,t,n,r,o){e!==t&&Sr(t,(function(s,a){if(o||(o=new Yn),ta(s))!function(e,t,n,r,o,s,a){var c=ko(e,n),u=ko(t,n),l=a.get(u);if(l)return void tr(e,n,l);var d=s?s(c,u,n+"",e,t,a):i,h=d===i;if(h){var p=$s(u),f=!p&&Js(u),g=!p&&!f&&la(u);d=u,p||f||g?$s(c)?d=c:Ks(c)?d=ki(c):f?(h=!1,d=Ci(u,!0)):g?(h=!1,d=Ri(u,!0)):d=[]:oa(u)||Ws(u)?(d=c,Ws(c)?d=Ea(c):ta(c)&&!Xs(c)||(d=Eo(u))):h=!1}h&&(a.set(u,d),o(d,u,r,s,a),a.delete(u));tr(e,n,d)}(e,t,a,n,Hr,r,o);else{var c=r?r(ko(e,a),s,a+"",e,t,o):i;c===i&&(c=s),tr(e,a,c)}}),Na)}function Wr(e,t){var n=e.length;if(n)return _o(t+=t<0?n:0,n)?e[t]:i}function $r(e,t,n){t=t.length?Mt(t,(function(e){return $s(e)?function(t){return Cr(t,1===e.length?e[0]:e)}:e})):[ic];var r=-1;t=Mt(t,Zt(uo()));var i=Fr(e,(function(e,n,i){var o=Mt(t,(function(t){return t(e)}));return{criteria:o,index:++r,value:e}}));return function(e,t){var n=e.length;for(e.sort(t);n--;)e[n]=e[n].value;return e}(i,(function(e,t){return function(e,t,n){var r=-1,i=e.criteria,o=t.criteria,s=i.length,a=n.length;for(;++r<s;){var c=Oi(i[r],o[r]);if(c)return r>=a?c:c*("desc"==n[r]?-1:1)}return e.index-t.index}(e,t,n)}))}function qr(e,t,n){for(var r=-1,i=t.length,o={};++r<i;){var s=t[r],a=Cr(e,s);n(a,s)&&ei(o,_i(s,e),a)}return o}function zr(e,t,n,r){var i=r?Wt:Ht,o=-1,s=t.length,a=e;for(e===t&&(t=ki(t)),n&&(a=Mt(e,Zt(n)));++o<s;)for(var c=0,u=t[o],l=n?n(u):u;(c=i(a,l,c,r))>-1;)a!==e&&Ye.call(a,c,1),Ye.call(e,c,1);return e}function Kr(e,t){for(var n=e?t.length:0,r=n-1;n--;){var i=t[n];if(n==r||i!==o){var o=i;_o(i)?Ye.call(e,i,1):hi(e,i)}}return e}function Jr(e,t){return e+mt(Tn()*(t-e+1))}function Yr(e,t){var n="";if(!e||t<1||t>f)return n;do{t%2&&(n+=e),(t=mt(t/2))&&(e+=e)}while(t);return n}function Qr(e,t){return No(wo(e,t,ic),e+"")}function Xr(e){return Xn(Va(e))}function Zr(e,t){var n=Va(e);return xo(n,cr(t,0,n.length))}function ei(e,t,n,r){if(!ta(e))return e;for(var o=-1,s=(t=_i(t,e)).length,a=s-1,c=e;null!=c&&++o<s;){var u=Uo(t[o]),l=n;if("__proto__"===u||"constructor"===u||"prototype"===u)return e;if(o!=a){var d=c[u];(l=r?r(d,u,c):i)===i&&(l=ta(d)?d:_o(t[o+1])?[]:{})}nr(c,u,l),c=c[u]}return e}var ti=Pn?function(e,t){return Pn.set(e,t),e}:ic,ni=nt?function(e,t){return nt(e,"toString",{configurable:!0,enumerable:!1,value:tc(t),writable:!0})}:ic;function ri(e){return xo(Va(e))}function ii(e,t,n){var i=-1,o=e.length;t<0&&(t=-t>o?0:o+t),(n=n>o?o:n)<0&&(n+=o),o=t>n?0:n-t>>>0,t>>>=0;for(var s=r(o);++i<o;)s[i]=e[i+t];return s}function oi(e,t){var n;return pr(e,(function(e,r,i){return!(n=t(e,r,i))})),!!n}function si(e,t,n){var r=0,i=null==e?r:e.length;if("number"==typeof t&&t==t&&i<=2147483647){for(;r<i;){var o=r+i>>>1,s=e[o];null!==s&&!ua(s)&&(n?s<=t:s<t)?r=o+1:i=o}return i}return ai(e,t,ic,n)}function ai(e,t,n,r){var o=0,s=null==e?0:e.length;if(0===s)return 0;for(var a=(t=n(t))!=t,c=null===t,u=ua(t),l=t===i;o<s;){var d=mt((o+s)/2),h=n(e[d]),p=h!==i,f=null===h,g=h==h,m=ua(h);if(a)var v=r||g;else v=l?g&&(r||p):c?g&&p&&(r||!f):u?g&&p&&!f&&(r||!m):!f&&!m&&(r?h<=t:h<t);v?o=d+1:s=d}return _n(s,4294967294)}function ci(e,t){for(var n=-1,r=e.length,i=0,o=[];++n<r;){var s=e[n],a=t?t(s):s;if(!n||!Vs(a,c)){var c=a;o[i++]=0===s?0:s}}return o}function ui(e){return"number"==typeof e?e:ua(e)?g:+e}function li(e){if("string"==typeof e)return e;if($s(e))return Mt(e,li)+"";if(ua(e))return Fn?Fn.call(e):"";var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}function di(e,t,n){var r=-1,i=Nt,o=e.length,s=!0,a=[],c=a;if(n)s=!1,i=Lt;else if(o>=200){var u=t?null:Yi(e);if(u)return hn(u);s=!1,i=tn,c=new Jn}else c=t?[]:a;e:for(;++r<o;){var l=e[r],d=t?t(l):l;if(l=n||0!==l?l:0,s&&d==d){for(var h=c.length;h--;)if(c[h]===d)continue e;t&&c.push(d),a.push(l)}else i(c,d,n)||(c!==a&&c.push(d),a.push(l))}return a}function hi(e,t){return null==(e=Ao(e,t=_i(t,e)))||delete e[Uo(Qo(t))]}function pi(e,t,n,r){return ei(e,t,n(Cr(e,t)),r)}function fi(e,t,n,r){for(var i=e.length,o=r?i:-1;(r?o--:++o<i)&&t(e[o],o,e););return n?ii(e,r?0:o,r?o+1:i):ii(e,r?o+1:0,r?i:o)}function gi(e,t){var n=e;return n instanceof $n&&(n=n.value()),Bt(t,(function(e,t){return t.func.apply(t.thisArg,xt([e],t.args))}),n)}function mi(e,t,n){var i=e.length;if(i<2)return i?di(e[0]):[];for(var o=-1,s=r(i);++o<i;)for(var a=e[o],c=-1;++c<i;)c!=o&&(s[o]=hr(s[o]||a,e[c],t,n));return di(Er(s,1),t,n)}function vi(e,t,n){for(var r=-1,o=e.length,s=t.length,a={};++r<o;){var c=r<s?t[r]:i;n(a,e[r],c)}return a}function Ei(e){return Ks(e)?e:[]}function Si(e){return"function"==typeof e?e:ic}function _i(e,t){return $s(e)?e:bo(e,t)?[e]:Bo(Sa(e))}var yi=Qr;function bi(e,t,n){var r=e.length;return n=n===i?r:n,!t&&n>=r?e:ii(e,t,n)}var Ti=it||function(e){return gt.clearTimeout(e)};function Ci(e,t){if(t)return e.slice();var n=e.length,r=qe?qe(n):new e.constructor(n);return e.copy(r),r}function Ii(e){var t=new e.constructor(e.byteLength);return new $e(t).set(new $e(e)),t}function Ri(e,t){var n=t?Ii(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}function Oi(e,t){if(e!==t){var n=e!==i,r=null===e,o=e==e,s=ua(e),a=t!==i,c=null===t,u=t==t,l=ua(t);if(!c&&!l&&!s&&e>t||s&&a&&u&&!c&&!l||r&&a&&u||!n&&u||!o)return 1;if(!r&&!s&&!l&&e<t||l&&n&&o&&!r&&!s||c&&n&&o||!a&&o||!u)return-1}return 0}function wi(e,t,n,i){for(var o=-1,s=e.length,a=n.length,c=-1,u=t.length,l=Sn(s-a,0),d=r(u+l),h=!i;++c<u;)d[c]=t[c];for(;++o<a;)(h||o<s)&&(d[n[o]]=e[o]);for(;l--;)d[c++]=e[o++];return d}function Ai(e,t,n,i){for(var o=-1,s=e.length,a=-1,c=n.length,u=-1,l=t.length,d=Sn(s-c,0),h=r(d+l),p=!i;++o<d;)h[o]=e[o];for(var f=o;++u<l;)h[f+u]=t[u];for(;++a<c;)(p||o<s)&&(h[f+n[a]]=e[o++]);return h}function ki(e,t){var n=-1,i=e.length;for(t||(t=r(i));++n<i;)t[n]=e[n];return t}function Pi(e,t,n,r){var o=!n;n||(n={});for(var s=-1,a=t.length;++s<a;){var c=t[s],u=r?r(n[c],e[c],c,n,e):i;u===i&&(u=e[c]),o?sr(n,c,u):nr(n,c,u)}return n}function Di(e,t){return function(n,r){var i=$s(n)?wt:ir,o=t?t():{};return i(n,e,uo(r,2),o)}}function Ni(e){return Qr((function(t,n){var r=-1,o=n.length,s=o>1?n[o-1]:i,a=o>2?n[2]:i;for(s=e.length>3&&"function"==typeof s?(o--,s):i,a&&yo(n[0],n[1],a)&&(s=o<3?i:s,o=1),t=Oe(t);++r<o;){var c=n[r];c&&e(t,c,r,s)}return t}))}function Li(e,t){return function(n,r){if(null==n)return n;if(!zs(n))return e(n,r);for(var i=n.length,o=t?i:-1,s=Oe(n);(t?o--:++o<i)&&!1!==r(s[o],o,s););return n}}function Mi(e){return function(t,n,r){for(var i=-1,o=Oe(t),s=r(t),a=s.length;a--;){var c=s[e?a:++i];if(!1===n(o[c],c,o))break}return t}}function xi(e){return function(t){var n=cn(t=Sa(t))?gn(t):i,r=n?n[0]:t.charAt(0),o=n?bi(n,1).join(""):t.slice(1);return r[e]()+o}}function Bi(e){return function(t){return Bt(Xa(Wa(t).replace(et,"")),e,"")}}function Ui(e){return function(){var t=arguments;switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3]);case 5:return new e(t[0],t[1],t[2],t[3],t[4]);case 6:return new e(t[0],t[1],t[2],t[3],t[4],t[5]);case 7:return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6])}var n=Gn(e.prototype),r=e.apply(n,t);return ta(r)?r:n}}function ji(e){return function(t,n,r){var o=Oe(t);if(!zs(t)){var s=uo(n,3);t=Da(t),n=function(e){return s(o[e],e,o)}}var a=e(t,n,r);return a>-1?o[s?t[a]:a]:i}}function Fi(e){return ro((function(t){var n=t.length,r=n,s=Wn.prototype.thru;for(e&&t.reverse();r--;){var a=t[r];if("function"!=typeof a)throw new ke(o);if(s&&!c&&"wrapper"==ao(a))var c=new Wn([],!0)}for(r=c?r:n;++r<n;){var u=ao(a=t[r]),l="wrapper"==u?so(a):i;c=l&&To(l[0])&&424==l[1]&&!l[4].length&&1==l[9]?c[ao(l[0])].apply(c,l[3]):1==a.length&&To(a)?c[u]():c.thru(a)}return function(){var e=arguments,r=e[0];if(c&&1==e.length&&$s(r))return c.plant(r).value();for(var i=0,o=n?t[i].apply(this,e):r;++i<n;)o=t[i].call(this,o);return o}}))}function Vi(e,t,n,o,s,a,c,u,l,h){var p=t&d,f=1&t,g=2&t,m=24&t,v=512&t,E=g?i:Ui(e);return function d(){for(var S=arguments.length,_=r(S),y=S;y--;)_[y]=arguments[y];if(m)var b=co(d),T=function(e,t){for(var n=e.length,r=0;n--;)e[n]===t&&++r;return r}(_,b);if(o&&(_=wi(_,o,s,m)),a&&(_=Ai(_,a,c,m)),S-=T,m&&S<h){var C=dn(_,b);return Ki(e,t,Vi,d.placeholder,n,_,C,u,l,h-S)}var I=f?n:this,R=g?I[e]:e;return S=_.length,u?_=function(e,t){var n=e.length,r=_n(t.length,n),o=ki(e);for(;r--;){var s=t[r];e[r]=_o(s,n)?o[s]:i}return e}(_,u):v&&S>1&&_.reverse(),p&&l<S&&(_.length=l),this&&this!==gt&&this instanceof d&&(R=E||Ui(R)),R.apply(I,_)}}function Gi(e,t){return function(n,r){return function(e,t,n,r){return yr(e,(function(e,i,o){t(r,n(e),i,o)})),r}(n,e,t(r),{})}}function Hi(e,t){return function(n,r){var o;if(n===i&&r===i)return t;if(n!==i&&(o=n),r!==i){if(o===i)return r;"string"==typeof n||"string"==typeof r?(n=li(n),r=li(r)):(n=ui(n),r=ui(r)),o=e(n,r)}return o}}function Wi(e){return ro((function(t){return t=Mt(t,Zt(uo())),Qr((function(n){var r=this;return e(t,(function(e){return Ot(e,r,n)}))}))}))}function $i(e,t){var n=(t=t===i?" ":li(t)).length;if(n<2)return n?Yr(t,e):t;var r=Yr(t,ft(e/fn(t)));return cn(t)?bi(gn(r),0,e).join(""):r.slice(0,e)}function qi(e){return function(t,n,o){return o&&"number"!=typeof o&&yo(t,n,o)&&(n=o=i),t=fa(t),n===i?(n=t,t=0):n=fa(n),function(e,t,n,i){for(var o=-1,s=Sn(ft((t-e)/(n||1)),0),a=r(s);s--;)a[i?s:++o]=e,e+=n;return a}(t,n,o=o===i?t<n?1:-1:fa(o),e)}}function zi(e){return function(t,n){return"string"==typeof t&&"string"==typeof n||(t=va(t),n=va(n)),e(t,n)}}function Ki(e,t,n,r,o,s,a,c,d,h){var p=8&t;t|=p?u:l,4&(t&=~(p?l:u))||(t&=-4);var f=[e,t,o,p?s:i,p?a:i,p?i:s,p?i:a,c,d,h],g=n.apply(i,f);return To(e)&&Po(g,f),g.placeholder=r,Lo(g,e,t)}function Ji(e){var t=Re[e];return function(e,n){if(e=va(e),(n=null==n?0:_n(ga(n),292))&&_t(e)){var r=(Sa(e)+"e").split("e");return+((r=(Sa(t(r[0]+"e"+(+r[1]+n)))+"e").split("e"))[0]+"e"+(+r[1]-n))}return t(e)}}var Yi=wn&&1/hn(new wn([,-0]))[1]==p?function(e){return new wn(e)}:uc;function Qi(e){return function(t){var n=mo(t);return n==I?un(t):n==k?pn(t):function(e,t){return Mt(t,(function(t){return[t,e[t]]}))}(t,e(t))}}function Xi(e,t,n,s,p,f,g,m){var v=2&t;if(!v&&"function"!=typeof e)throw new ke(o);var E=s?s.length:0;if(E||(t&=-97,s=p=i),g=g===i?g:Sn(ga(g),0),m=m===i?m:ga(m),E-=p?p.length:0,t&l){var S=s,_=p;s=p=i}var y=v?i:so(e),b=[e,t,n,s,p,S,_,f,g,m];if(y&&function(e,t){var n=e[1],r=t[1],i=n|r,o=i<131,s=r==d&&8==n||r==d&&n==h&&e[7].length<=t[8]||384==r&&t[7].length<=t[8]&&8==n;if(!o&&!s)return e;1&r&&(e[2]=t[2],i|=1&n?0:4);var c=t[3];if(c){var u=e[3];e[3]=u?wi(u,c,t[4]):c,e[4]=u?dn(e[3],a):t[4]}(c=t[5])&&(u=e[5],e[5]=u?Ai(u,c,t[6]):c,e[6]=u?dn(e[5],a):t[6]);(c=t[7])&&(e[7]=c);r&d&&(e[8]=null==e[8]?t[8]:_n(e[8],t[8]));null==e[9]&&(e[9]=t[9]);e[0]=t[0],e[1]=i}(b,y),e=b[0],t=b[1],n=b[2],s=b[3],p=b[4],!(m=b[9]=b[9]===i?v?0:e.length:Sn(b[9]-E,0))&&24&t&&(t&=-25),t&&1!=t)T=8==t||t==c?function(e,t,n){var o=Ui(e);return function s(){for(var a=arguments.length,c=r(a),u=a,l=co(s);u--;)c[u]=arguments[u];var d=a<3&&c[0]!==l&&c[a-1]!==l?[]:dn(c,l);return(a-=d.length)<n?Ki(e,t,Vi,s.placeholder,i,c,d,i,i,n-a):Ot(this&&this!==gt&&this instanceof s?o:e,this,c)}}(e,t,m):t!=u&&33!=t||p.length?Vi.apply(i,b):function(e,t,n,i){var o=1&t,s=Ui(e);return function t(){for(var a=-1,c=arguments.length,u=-1,l=i.length,d=r(l+c),h=this&&this!==gt&&this instanceof t?s:e;++u<l;)d[u]=i[u];for(;c--;)d[u++]=arguments[++a];return Ot(h,o?n:this,d)}}(e,t,n,s);else var T=function(e,t,n){var r=1&t,i=Ui(e);return function t(){return(this&&this!==gt&&this instanceof t?i:e).apply(r?n:this,arguments)}}(e,t,n);return Lo((y?ti:Po)(T,b),e,t)}function Zi(e,t,n,r){return e===i||Vs(e,Ne[n])&&!xe.call(r,n)?t:e}function eo(e,t,n,r,o,s){return ta(e)&&ta(t)&&(s.set(t,e),Hr(e,t,i,eo,s),s.delete(t)),e}function to(e){return oa(e)?i:e}function no(e,t,n,r,o,s){var a=1&n,c=e.length,u=t.length;if(c!=u&&!(a&&u>c))return!1;var l=s.get(e),d=s.get(t);if(l&&d)return l==t&&d==e;var h=-1,p=!0,f=2&n?new Jn:i;for(s.set(e,t),s.set(t,e);++h<c;){var g=e[h],m=t[h];if(r)var v=a?r(m,g,h,t,e,s):r(g,m,h,e,t,s);if(v!==i){if(v)continue;p=!1;break}if(f){if(!jt(t,(function(e,t){if(!tn(f,t)&&(g===e||o(g,e,n,r,s)))return f.push(t)}))){p=!1;break}}else if(g!==m&&!o(g,m,n,r,s)){p=!1;break}}return s.delete(e),s.delete(t),p}function ro(e){return No(wo(e,i,qo),e+"")}function io(e){return Ir(e,Da,fo)}function oo(e){return Ir(e,Na,go)}var so=Pn?function(e){return Pn.get(e)}:uc;function ao(e){for(var t=e.name+"",n=Dn[t],r=xe.call(Dn,t)?n.length:0;r--;){var i=n[r],o=i.func;if(null==o||o==e)return i.name}return t}function co(e){return(xe.call(Vn,"placeholder")?Vn:e).placeholder}function uo(){var e=Vn.iteratee||oc;return e=e===oc?xr:e,arguments.length?e(arguments[0],arguments[1]):e}function lo(e,t){var n,r,i=e.__data__;return("string"==(r=typeof(n=t))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==n:null===n)?i["string"==typeof t?"string":"hash"]:i.map}function ho(e){for(var t=Da(e),n=t.length;n--;){var r=t[n],i=e[r];t[n]=[r,i,Ro(i)]}return t}function po(e,t){var n=function(e,t){return null==e?i:e[t]}(e,t);return Mr(n)?n:i}var fo=vt?function(e){return null==e?[]:(e=Oe(e),Dt(vt(e),(function(t){return Je.call(e,t)})))}:mc,go=vt?function(e){for(var t=[];e;)xt(t,fo(e)),e=ze(e);return t}:mc,mo=Rr;function vo(e,t,n){for(var r=-1,i=(t=_i(t,e)).length,o=!1;++r<i;){var s=Uo(t[r]);if(!(o=null!=e&&n(e,s)))break;e=e[s]}return o||++r!=i?o:!!(i=null==e?0:e.length)&&ea(i)&&_o(s,i)&&($s(e)||Ws(e))}function Eo(e){return"function"!=typeof e.constructor||Io(e)?{}:Gn(ze(e))}function So(e){return $s(e)||Ws(e)||!!(Qe&&e&&e[Qe])}function _o(e,t){var n=typeof e;return!!(t=null==t?f:t)&&("number"==n||"symbol"!=n&&_e.test(e))&&e>-1&&e%1==0&&e<t}function yo(e,t,n){if(!ta(n))return!1;var r=typeof t;return!!("number"==r?zs(n)&&_o(t,n.length):"string"==r&&t in n)&&Vs(n[t],e)}function bo(e,t){if($s(e))return!1;var n=typeof e;return!("number"!=n&&"symbol"!=n&&"boolean"!=n&&null!=e&&!ua(e))||(ne.test(e)||!te.test(e)||null!=t&&e in Oe(t))}function To(e){var t=ao(e),n=Vn[t];if("function"!=typeof n||!(t in $n.prototype))return!1;if(e===n)return!0;var r=so(n);return!!r&&e===r[0]}(In&&mo(new In(new ArrayBuffer(1)))!=M||Rn&&mo(new Rn)!=I||On&&mo(On.resolve())!=w||wn&&mo(new wn)!=k||An&&mo(new An)!=N)&&(mo=function(e){var t=Rr(e),n=t==O?e.constructor:i,r=n?jo(n):"";if(r)switch(r){case Nn:return M;case Ln:return I;case Mn:return w;case xn:return k;case Bn:return N}return t});var Co=Le?Xs:vc;function Io(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||Ne)}function Ro(e){return e==e&&!ta(e)}function Oo(e,t){return function(n){return null!=n&&(n[e]===t&&(t!==i||e in Oe(n)))}}function wo(e,t,n){return t=Sn(t===i?e.length-1:t,0),function(){for(var i=arguments,o=-1,s=Sn(i.length-t,0),a=r(s);++o<s;)a[o]=i[t+o];o=-1;for(var c=r(t+1);++o<t;)c[o]=i[o];return c[t]=n(a),Ot(e,this,c)}}function Ao(e,t){return t.length<2?e:Cr(e,ii(t,0,-1))}function ko(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]}var Po=Mo(ti),Do=pt||function(e,t){return gt.setTimeout(e,t)},No=Mo(ni);function Lo(e,t,n){var r=t+"";return No(e,function(e,t){var n=t.length;if(!n)return e;var r=n-1;return t[r]=(n>1?"& ":"")+t[r],t=t.join(n>2?", ":" "),e.replace(ce,"{\n/* [wrapped with "+t+"] */\n")}(r,function(e,t){return At(v,(function(n){var r="_."+n[0];t&n[1]&&!Nt(e,r)&&e.push(r)})),e.sort()}(function(e){var t=e.match(ue);return t?t[1].split(le):[]}(r),n)))}function Mo(e){var t=0,n=0;return function(){var r=yn(),o=16-(r-n);if(n=r,o>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(i,arguments)}}function xo(e,t){var n=-1,r=e.length,o=r-1;for(t=t===i?r:t;++n<t;){var s=Jr(n,o),a=e[s];e[s]=e[n],e[n]=a}return e.length=t,e}var Bo=function(e){var t=Ms(e,(function(e){return 500===n.size&&n.clear(),e})),n=t.cache;return t}((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(re,(function(e,n,r,i){t.push(r?i.replace(pe,"$1"):n||e)})),t}));function Uo(e){if("string"==typeof e||ua(e))return e;var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}function jo(e){if(null!=e){try{return Me.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function Fo(e){if(e instanceof $n)return e.clone();var t=new Wn(e.__wrapped__,e.__chain__);return t.__actions__=ki(e.__actions__),t.__index__=e.__index__,t.__values__=e.__values__,t}var Vo=Qr((function(e,t){return Ks(e)?hr(e,Er(t,1,Ks,!0)):[]})),Go=Qr((function(e,t){var n=Qo(t);return Ks(n)&&(n=i),Ks(e)?hr(e,Er(t,1,Ks,!0),uo(n,2)):[]})),Ho=Qr((function(e,t){var n=Qo(t);return Ks(n)&&(n=i),Ks(e)?hr(e,Er(t,1,Ks,!0),i,n):[]}));function Wo(e,t,n){var r=null==e?0:e.length;if(!r)return-1;var i=null==n?0:ga(n);return i<0&&(i=Sn(r+i,0)),Gt(e,uo(t,3),i)}function $o(e,t,n){var r=null==e?0:e.length;if(!r)return-1;var o=r-1;return n!==i&&(o=ga(n),o=n<0?Sn(r+o,0):_n(o,r-1)),Gt(e,uo(t,3),o,!0)}function qo(e){return(null==e?0:e.length)?Er(e,1):[]}function zo(e){return e&&e.length?e[0]:i}var Ko=Qr((function(e){var t=Mt(e,Ei);return t.length&&t[0]===e[0]?kr(t):[]})),Jo=Qr((function(e){var t=Qo(e),n=Mt(e,Ei);return t===Qo(n)?t=i:n.pop(),n.length&&n[0]===e[0]?kr(n,uo(t,2)):[]})),Yo=Qr((function(e){var t=Qo(e),n=Mt(e,Ei);return(t="function"==typeof t?t:i)&&n.pop(),n.length&&n[0]===e[0]?kr(n,i,t):[]}));function Qo(e){var t=null==e?0:e.length;return t?e[t-1]:i}var Xo=Qr(Zo);function Zo(e,t){return e&&e.length&&t&&t.length?zr(e,t):e}var es=ro((function(e,t){var n=null==e?0:e.length,r=ar(e,t);return Kr(e,Mt(t,(function(e){return _o(e,n)?+e:e})).sort(Oi)),r}));function ts(e){return null==e?e:Cn.call(e)}var ns=Qr((function(e){return di(Er(e,1,Ks,!0))})),rs=Qr((function(e){var t=Qo(e);return Ks(t)&&(t=i),di(Er(e,1,Ks,!0),uo(t,2))})),is=Qr((function(e){var t=Qo(e);return t="function"==typeof t?t:i,di(Er(e,1,Ks,!0),i,t)}));function os(e){if(!e||!e.length)return[];var t=0;return e=Dt(e,(function(e){if(Ks(e))return t=Sn(e.length,t),!0})),Qt(t,(function(t){return Mt(e,zt(t))}))}function ss(e,t){if(!e||!e.length)return[];var n=os(e);return null==t?n:Mt(n,(function(e){return Ot(t,i,e)}))}var as=Qr((function(e,t){return Ks(e)?hr(e,t):[]})),cs=Qr((function(e){return mi(Dt(e,Ks))})),us=Qr((function(e){var t=Qo(e);return Ks(t)&&(t=i),mi(Dt(e,Ks),uo(t,2))})),ls=Qr((function(e){var t=Qo(e);return t="function"==typeof t?t:i,mi(Dt(e,Ks),i,t)})),ds=Qr(os);var hs=Qr((function(e){var t=e.length,n=t>1?e[t-1]:i;return n="function"==typeof n?(e.pop(),n):i,ss(e,n)}));function ps(e){var t=Vn(e);return t.__chain__=!0,t}function fs(e,t){return t(e)}var gs=ro((function(e){var t=e.length,n=t?e[0]:0,r=this.__wrapped__,o=function(t){return ar(t,e)};return!(t>1||this.__actions__.length)&&r instanceof $n&&_o(n)?((r=r.slice(n,+n+(t?1:0))).__actions__.push({func:fs,args:[o],thisArg:i}),new Wn(r,this.__chain__).thru((function(e){return t&&!e.length&&e.push(i),e}))):this.thru(o)}));var ms=Di((function(e,t,n){xe.call(e,n)?++e[n]:sr(e,n,1)}));var vs=ji(Wo),Es=ji($o);function Ss(e,t){return($s(e)?At:pr)(e,uo(t,3))}function _s(e,t){return($s(e)?kt:fr)(e,uo(t,3))}var ys=Di((function(e,t,n){xe.call(e,n)?e[n].push(t):sr(e,n,[t])}));var bs=Qr((function(e,t,n){var i=-1,o="function"==typeof t,s=zs(e)?r(e.length):[];return pr(e,(function(e){s[++i]=o?Ot(t,e,n):Pr(e,t,n)})),s})),Ts=Di((function(e,t,n){sr(e,n,t)}));function Cs(e,t){return($s(e)?Mt:Fr)(e,uo(t,3))}var Is=Di((function(e,t,n){e[n?0:1].push(t)}),(function(){return[[],[]]}));var Rs=Qr((function(e,t){if(null==e)return[];var n=t.length;return n>1&&yo(e,t[0],t[1])?t=[]:n>2&&yo(t[0],t[1],t[2])&&(t=[t[0]]),$r(e,Er(t,1),[])})),Os=lt||function(){return gt.Date.now()};function ws(e,t,n){return t=n?i:t,t=e&&null==t?e.length:t,Xi(e,d,i,i,i,i,t)}function As(e,t){var n;if("function"!=typeof t)throw new ke(o);return e=ga(e),function(){return--e>0&&(n=t.apply(this,arguments)),e<=1&&(t=i),n}}var ks=Qr((function(e,t,n){var r=1;if(n.length){var i=dn(n,co(ks));r|=u}return Xi(e,r,t,n,i)})),Ps=Qr((function(e,t,n){var r=3;if(n.length){var i=dn(n,co(Ps));r|=u}return Xi(t,r,e,n,i)}));function Ds(e,t,n){var r,s,a,c,u,l,d=0,h=!1,p=!1,f=!0;if("function"!=typeof e)throw new ke(o);function g(t){var n=r,o=s;return r=s=i,d=t,c=e.apply(o,n)}function m(e){var n=e-l;return l===i||n>=t||n<0||p&&e-d>=a}function v(){var e=Os();if(m(e))return E(e);u=Do(v,function(e){var n=t-(e-l);return p?_n(n,a-(e-d)):n}(e))}function E(e){return u=i,f&&r?g(e):(r=s=i,c)}function S(){var e=Os(),n=m(e);if(r=arguments,s=this,l=e,n){if(u===i)return function(e){return d=e,u=Do(v,t),h?g(e):c}(l);if(p)return Ti(u),u=Do(v,t),g(l)}return u===i&&(u=Do(v,t)),c}return t=va(t)||0,ta(n)&&(h=!!n.leading,a=(p="maxWait"in n)?Sn(va(n.maxWait)||0,t):a,f="trailing"in n?!!n.trailing:f),S.cancel=function(){u!==i&&Ti(u),d=0,r=l=s=u=i},S.flush=function(){return u===i?c:E(Os())},S}var Ns=Qr((function(e,t){return dr(e,1,t)})),Ls=Qr((function(e,t,n){return dr(e,va(t)||0,n)}));function Ms(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new ke(o);var n=function(){var r=arguments,i=t?t.apply(this,r):r[0],o=n.cache;if(o.has(i))return o.get(i);var s=e.apply(this,r);return n.cache=o.set(i,s)||o,s};return n.cache=new(Ms.Cache||Kn),n}function xs(e){if("function"!=typeof e)throw new ke(o);return function(){var t=arguments;switch(t.length){case 0:return!e.call(this);case 1:return!e.call(this,t[0]);case 2:return!e.call(this,t[0],t[1]);case 3:return!e.call(this,t[0],t[1],t[2])}return!e.apply(this,t)}}Ms.Cache=Kn;var Bs=yi((function(e,t){var n=(t=1==t.length&&$s(t[0])?Mt(t[0],Zt(uo())):Mt(Er(t,1),Zt(uo()))).length;return Qr((function(r){for(var i=-1,o=_n(r.length,n);++i<o;)r[i]=t[i].call(this,r[i]);return Ot(e,this,r)}))})),Us=Qr((function(e,t){var n=dn(t,co(Us));return Xi(e,u,i,t,n)})),js=Qr((function(e,t){var n=dn(t,co(js));return Xi(e,l,i,t,n)})),Fs=ro((function(e,t){return Xi(e,h,i,i,i,t)}));function Vs(e,t){return e===t||e!=e&&t!=t}var Gs=zi(Or),Hs=zi((function(e,t){return e>=t})),Ws=Dr(function(){return arguments}())?Dr:function(e){return na(e)&&xe.call(e,"callee")&&!Je.call(e,"callee")},$s=r.isArray,qs=yt?Zt(yt):function(e){return na(e)&&Rr(e)==L};function zs(e){return null!=e&&ea(e.length)&&!Xs(e)}function Ks(e){return na(e)&&zs(e)}var Js=St||vc,Ys=bt?Zt(bt):function(e){return na(e)&&Rr(e)==y};function Qs(e){if(!na(e))return!1;var t=Rr(e);return t==b||"[object DOMException]"==t||"string"==typeof e.message&&"string"==typeof e.name&&!oa(e)}function Xs(e){if(!ta(e))return!1;var t=Rr(e);return t==T||t==C||"[object AsyncFunction]"==t||"[object Proxy]"==t}function Zs(e){return"number"==typeof e&&e==ga(e)}function ea(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=f}function ta(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}function na(e){return null!=e&&"object"==typeof e}var ra=Tt?Zt(Tt):function(e){return na(e)&&mo(e)==I};function ia(e){return"number"==typeof e||na(e)&&Rr(e)==R}function oa(e){if(!na(e)||Rr(e)!=O)return!1;var t=ze(e);if(null===t)return!0;var n=xe.call(t,"constructor")&&t.constructor;return"function"==typeof n&&n instanceof n&&Me.call(n)==Fe}var sa=Ct?Zt(Ct):function(e){return na(e)&&Rr(e)==A};var aa=It?Zt(It):function(e){return na(e)&&mo(e)==k};function ca(e){return"string"==typeof e||!$s(e)&&na(e)&&Rr(e)==P}function ua(e){return"symbol"==typeof e||na(e)&&Rr(e)==D}var la=Rt?Zt(Rt):function(e){return na(e)&&ea(e.length)&&!!ct[Rr(e)]};var da=zi(jr),ha=zi((function(e,t){return e<=t}));function pa(e){if(!e)return[];if(zs(e))return ca(e)?gn(e):ki(e);if(Xe&&e[Xe])return function(e){for(var t,n=[];!(t=e.next()).done;)n.push(t.value);return n}(e[Xe]());var t=mo(e);return(t==I?un:t==k?hn:Va)(e)}function fa(e){return e?(e=va(e))===p||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}function ga(e){var t=fa(e),n=t%1;return t==t?n?t-n:t:0}function ma(e){return e?cr(ga(e),0,m):0}function va(e){if("number"==typeof e)return e;if(ua(e))return g;if(ta(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=ta(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=Xt(e);var n=ve.test(e);return n||Se.test(e)?ht(e.slice(2),n?2:8):me.test(e)?g:+e}function Ea(e){return Pi(e,Na(e))}function Sa(e){return null==e?"":li(e)}var _a=Ni((function(e,t){if(Io(t)||zs(t))Pi(t,Da(t),e);else for(var n in t)xe.call(t,n)&&nr(e,n,t[n])})),ya=Ni((function(e,t){Pi(t,Na(t),e)})),ba=Ni((function(e,t,n,r){Pi(t,Na(t),e,r)})),Ta=Ni((function(e,t,n,r){Pi(t,Da(t),e,r)})),Ca=ro(ar);var Ia=Qr((function(e,t){e=Oe(e);var n=-1,r=t.length,o=r>2?t[2]:i;for(o&&yo(t[0],t[1],o)&&(r=1);++n<r;)for(var s=t[n],a=Na(s),c=-1,u=a.length;++c<u;){var l=a[c],d=e[l];(d===i||Vs(d,Ne[l])&&!xe.call(e,l))&&(e[l]=s[l])}return e})),Ra=Qr((function(e){return e.push(i,eo),Ot(Ma,i,e)}));function Oa(e,t,n){var r=null==e?i:Cr(e,t);return r===i?n:r}function wa(e,t){return null!=e&&vo(e,t,Ar)}var Aa=Gi((function(e,t,n){null!=t&&"function"!=typeof t.toString&&(t=je.call(t)),e[t]=n}),tc(ic)),ka=Gi((function(e,t,n){null!=t&&"function"!=typeof t.toString&&(t=je.call(t)),xe.call(e,t)?e[t].push(n):e[t]=[n]}),uo),Pa=Qr(Pr);function Da(e){return zs(e)?Qn(e):Br(e)}function Na(e){return zs(e)?Qn(e,!0):Ur(e)}var La=Ni((function(e,t,n){Hr(e,t,n)})),Ma=Ni((function(e,t,n,r){Hr(e,t,n,r)})),xa=ro((function(e,t){var n={};if(null==e)return n;var r=!1;t=Mt(t,(function(t){return t=_i(t,e),r||(r=t.length>1),t})),Pi(e,oo(e),n),r&&(n=ur(n,7,to));for(var i=t.length;i--;)hi(n,t[i]);return n}));var Ba=ro((function(e,t){return null==e?{}:function(e,t){return qr(e,t,(function(t,n){return wa(e,n)}))}(e,t)}));function Ua(e,t){if(null==e)return{};var n=Mt(oo(e),(function(e){return[e]}));return t=uo(t),qr(e,n,(function(e,n){return t(e,n[0])}))}var ja=Qi(Da),Fa=Qi(Na);function Va(e){return null==e?[]:en(e,Da(e))}var Ga=Bi((function(e,t,n){return t=t.toLowerCase(),e+(n?Ha(t):t)}));function Ha(e){return Qa(Sa(e).toLowerCase())}function Wa(e){return(e=Sa(e))&&e.replace(ye,on).replace(tt,"")}var $a=Bi((function(e,t,n){return e+(n?"-":"")+t.toLowerCase()})),qa=Bi((function(e,t,n){return e+(n?" ":"")+t.toLowerCase()})),za=xi("toLowerCase");var Ka=Bi((function(e,t,n){return e+(n?"_":"")+t.toLowerCase()}));var Ja=Bi((function(e,t,n){return e+(n?" ":"")+Qa(t)}));var Ya=Bi((function(e,t,n){return e+(n?" ":"")+t.toUpperCase()})),Qa=xi("toUpperCase");function Xa(e,t,n){return e=Sa(e),(t=n?i:t)===i?function(e){return ot.test(e)}(e)?function(e){return e.match(rt)||[]}(e):function(e){return e.match(de)||[]}(e):e.match(t)||[]}var Za=Qr((function(e,t){try{return Ot(e,i,t)}catch(e){return Qs(e)?e:new Ce(e)}})),ec=ro((function(e,t){return At(t,(function(t){t=Uo(t),sr(e,t,ks(e[t],e))})),e}));function tc(e){return function(){return e}}var nc=Fi(),rc=Fi(!0);function ic(e){return e}function oc(e){return xr("function"==typeof e?e:ur(e,1))}var sc=Qr((function(e,t){return function(n){return Pr(n,e,t)}})),ac=Qr((function(e,t){return function(n){return Pr(e,n,t)}}));function cc(e,t,n){var r=Da(t),i=Tr(t,r);null!=n||ta(t)&&(i.length||!r.length)||(n=t,t=e,e=this,i=Tr(t,Da(t)));var o=!(ta(n)&&"chain"in n&&!n.chain),s=Xs(e);return At(i,(function(n){var r=t[n];e[n]=r,s&&(e.prototype[n]=function(){var t=this.__chain__;if(o||t){var n=e(this.__wrapped__);return(n.__actions__=ki(this.__actions__)).push({func:r,args:arguments,thisArg:e}),n.__chain__=t,n}return r.apply(e,xt([this.value()],arguments))})})),e}function uc(){}var lc=Wi(Mt),dc=Wi(Pt),hc=Wi(jt);function pc(e){return bo(e)?zt(Uo(e)):function(e){return function(t){return Cr(t,e)}}(e)}var fc=qi(),gc=qi(!0);function mc(){return[]}function vc(){return!1}var Ec=Hi((function(e,t){return e+t}),0),Sc=Ji("ceil"),_c=Hi((function(e,t){return e/t}),1),yc=Ji("floor");var bc,Tc=Hi((function(e,t){return e*t}),1),Cc=Ji("round"),Ic=Hi((function(e,t){return e-t}),0);return Vn.after=function(e,t){if("function"!=typeof t)throw new ke(o);return e=ga(e),function(){if(--e<1)return t.apply(this,arguments)}},Vn.ary=ws,Vn.assign=_a,Vn.assignIn=ya,Vn.assignInWith=ba,Vn.assignWith=Ta,Vn.at=Ca,Vn.before=As,Vn.bind=ks,Vn.bindAll=ec,Vn.bindKey=Ps,Vn.castArray=function(){if(!arguments.length)return[];var e=arguments[0];return $s(e)?e:[e]},Vn.chain=ps,Vn.chunk=function(e,t,n){t=(n?yo(e,t,n):t===i)?1:Sn(ga(t),0);var o=null==e?0:e.length;if(!o||t<1)return[];for(var s=0,a=0,c=r(ft(o/t));s<o;)c[a++]=ii(e,s,s+=t);return c},Vn.compact=function(e){for(var t=-1,n=null==e?0:e.length,r=0,i=[];++t<n;){var o=e[t];o&&(i[r++]=o)}return i},Vn.concat=function(){var e=arguments.length;if(!e)return[];for(var t=r(e-1),n=arguments[0],i=e;i--;)t[i-1]=arguments[i];return xt($s(n)?ki(n):[n],Er(t,1))},Vn.cond=function(e){var t=null==e?0:e.length,n=uo();return e=t?Mt(e,(function(e){if("function"!=typeof e[1])throw new ke(o);return[n(e[0]),e[1]]})):[],Qr((function(n){for(var r=-1;++r<t;){var i=e[r];if(Ot(i[0],this,n))return Ot(i[1],this,n)}}))},Vn.conforms=function(e){return function(e){var t=Da(e);return function(n){return lr(n,e,t)}}(ur(e,1))},Vn.constant=tc,Vn.countBy=ms,Vn.create=function(e,t){var n=Gn(e);return null==t?n:or(n,t)},Vn.curry=function e(t,n,r){var o=Xi(t,8,i,i,i,i,i,n=r?i:n);return o.placeholder=e.placeholder,o},Vn.curryRight=function e(t,n,r){var o=Xi(t,c,i,i,i,i,i,n=r?i:n);return o.placeholder=e.placeholder,o},Vn.debounce=Ds,Vn.defaults=Ia,Vn.defaultsDeep=Ra,Vn.defer=Ns,Vn.delay=Ls,Vn.difference=Vo,Vn.differenceBy=Go,Vn.differenceWith=Ho,Vn.drop=function(e,t,n){var r=null==e?0:e.length;return r?ii(e,(t=n||t===i?1:ga(t))<0?0:t,r):[]},Vn.dropRight=function(e,t,n){var r=null==e?0:e.length;return r?ii(e,0,(t=r-(t=n||t===i?1:ga(t)))<0?0:t):[]},Vn.dropRightWhile=function(e,t){return e&&e.length?fi(e,uo(t,3),!0,!0):[]},Vn.dropWhile=function(e,t){return e&&e.length?fi(e,uo(t,3),!0):[]},Vn.fill=function(e,t,n,r){var o=null==e?0:e.length;return o?(n&&"number"!=typeof n&&yo(e,t,n)&&(n=0,r=o),function(e,t,n,r){var o=e.length;for((n=ga(n))<0&&(n=-n>o?0:o+n),(r=r===i||r>o?o:ga(r))<0&&(r+=o),r=n>r?0:ma(r);n<r;)e[n++]=t;return e}(e,t,n,r)):[]},Vn.filter=function(e,t){return($s(e)?Dt:vr)(e,uo(t,3))},Vn.flatMap=function(e,t){return Er(Cs(e,t),1)},Vn.flatMapDeep=function(e,t){return Er(Cs(e,t),p)},Vn.flatMapDepth=function(e,t,n){return n=n===i?1:ga(n),Er(Cs(e,t),n)},Vn.flatten=qo,Vn.flattenDeep=function(e){return(null==e?0:e.length)?Er(e,p):[]},Vn.flattenDepth=function(e,t){return(null==e?0:e.length)?Er(e,t=t===i?1:ga(t)):[]},Vn.flip=function(e){return Xi(e,512)},Vn.flow=nc,Vn.flowRight=rc,Vn.fromPairs=function(e){for(var t=-1,n=null==e?0:e.length,r={};++t<n;){var i=e[t];r[i[0]]=i[1]}return r},Vn.functions=function(e){return null==e?[]:Tr(e,Da(e))},Vn.functionsIn=function(e){return null==e?[]:Tr(e,Na(e))},Vn.groupBy=ys,Vn.initial=function(e){return(null==e?0:e.length)?ii(e,0,-1):[]},Vn.intersection=Ko,Vn.intersectionBy=Jo,Vn.intersectionWith=Yo,Vn.invert=Aa,Vn.invertBy=ka,Vn.invokeMap=bs,Vn.iteratee=oc,Vn.keyBy=Ts,Vn.keys=Da,Vn.keysIn=Na,Vn.map=Cs,Vn.mapKeys=function(e,t){var n={};return t=uo(t,3),yr(e,(function(e,r,i){sr(n,t(e,r,i),e)})),n},Vn.mapValues=function(e,t){var n={};return t=uo(t,3),yr(e,(function(e,r,i){sr(n,r,t(e,r,i))})),n},Vn.matches=function(e){return Vr(ur(e,1))},Vn.matchesProperty=function(e,t){return Gr(e,ur(t,1))},Vn.memoize=Ms,Vn.merge=La,Vn.mergeWith=Ma,Vn.method=sc,Vn.methodOf=ac,Vn.mixin=cc,Vn.negate=xs,Vn.nthArg=function(e){return e=ga(e),Qr((function(t){return Wr(t,e)}))},Vn.omit=xa,Vn.omitBy=function(e,t){return Ua(e,xs(uo(t)))},Vn.once=function(e){return As(2,e)},Vn.orderBy=function(e,t,n,r){return null==e?[]:($s(t)||(t=null==t?[]:[t]),$s(n=r?i:n)||(n=null==n?[]:[n]),$r(e,t,n))},Vn.over=lc,Vn.overArgs=Bs,Vn.overEvery=dc,Vn.overSome=hc,Vn.partial=Us,Vn.partialRight=js,Vn.partition=Is,Vn.pick=Ba,Vn.pickBy=Ua,Vn.property=pc,Vn.propertyOf=function(e){return function(t){return null==e?i:Cr(e,t)}},Vn.pull=Xo,Vn.pullAll=Zo,Vn.pullAllBy=function(e,t,n){return e&&e.length&&t&&t.length?zr(e,t,uo(n,2)):e},Vn.pullAllWith=function(e,t,n){return e&&e.length&&t&&t.length?zr(e,t,i,n):e},Vn.pullAt=es,Vn.range=fc,Vn.rangeRight=gc,Vn.rearg=Fs,Vn.reject=function(e,t){return($s(e)?Dt:vr)(e,xs(uo(t,3)))},Vn.remove=function(e,t){var n=[];if(!e||!e.length)return n;var r=-1,i=[],o=e.length;for(t=uo(t,3);++r<o;){var s=e[r];t(s,r,e)&&(n.push(s),i.push(r))}return Kr(e,i),n},Vn.rest=function(e,t){if("function"!=typeof e)throw new ke(o);return Qr(e,t=t===i?t:ga(t))},Vn.reverse=ts,Vn.sampleSize=function(e,t,n){return t=(n?yo(e,t,n):t===i)?1:ga(t),($s(e)?Zn:Zr)(e,t)},Vn.set=function(e,t,n){return null==e?e:ei(e,t,n)},Vn.setWith=function(e,t,n,r){return r="function"==typeof r?r:i,null==e?e:ei(e,t,n,r)},Vn.shuffle=function(e){return($s(e)?er:ri)(e)},Vn.slice=function(e,t,n){var r=null==e?0:e.length;return r?(n&&"number"!=typeof n&&yo(e,t,n)?(t=0,n=r):(t=null==t?0:ga(t),n=n===i?r:ga(n)),ii(e,t,n)):[]},Vn.sortBy=Rs,Vn.sortedUniq=function(e){return e&&e.length?ci(e):[]},Vn.sortedUniqBy=function(e,t){return e&&e.length?ci(e,uo(t,2)):[]},Vn.split=function(e,t,n){return n&&"number"!=typeof n&&yo(e,t,n)&&(t=n=i),(n=n===i?m:n>>>0)?(e=Sa(e))&&("string"==typeof t||null!=t&&!sa(t))&&!(t=li(t))&&cn(e)?bi(gn(e),0,n):e.split(t,n):[]},Vn.spread=function(e,t){if("function"!=typeof e)throw new ke(o);return t=null==t?0:Sn(ga(t),0),Qr((function(n){var r=n[t],i=bi(n,0,t);return r&&xt(i,r),Ot(e,this,i)}))},Vn.tail=function(e){var t=null==e?0:e.length;return t?ii(e,1,t):[]},Vn.take=function(e,t,n){return e&&e.length?ii(e,0,(t=n||t===i?1:ga(t))<0?0:t):[]},Vn.takeRight=function(e,t,n){var r=null==e?0:e.length;return r?ii(e,(t=r-(t=n||t===i?1:ga(t)))<0?0:t,r):[]},Vn.takeRightWhile=function(e,t){return e&&e.length?fi(e,uo(t,3),!1,!0):[]},Vn.takeWhile=function(e,t){return e&&e.length?fi(e,uo(t,3)):[]},Vn.tap=function(e,t){return t(e),e},Vn.throttle=function(e,t,n){var r=!0,i=!0;if("function"!=typeof e)throw new ke(o);return ta(n)&&(r="leading"in n?!!n.leading:r,i="trailing"in n?!!n.trailing:i),Ds(e,t,{leading:r,maxWait:t,trailing:i})},Vn.thru=fs,Vn.toArray=pa,Vn.toPairs=ja,Vn.toPairsIn=Fa,Vn.toPath=function(e){return $s(e)?Mt(e,Uo):ua(e)?[e]:ki(Bo(Sa(e)))},Vn.toPlainObject=Ea,Vn.transform=function(e,t,n){var r=$s(e),i=r||Js(e)||la(e);if(t=uo(t,4),null==n){var o=e&&e.constructor;n=i?r?new o:[]:ta(e)&&Xs(o)?Gn(ze(e)):{}}return(i?At:yr)(e,(function(e,r,i){return t(n,e,r,i)})),n},Vn.unary=function(e){return ws(e,1)},Vn.union=ns,Vn.unionBy=rs,Vn.unionWith=is,Vn.uniq=function(e){return e&&e.length?di(e):[]},Vn.uniqBy=function(e,t){return e&&e.length?di(e,uo(t,2)):[]},Vn.uniqWith=function(e,t){return t="function"==typeof t?t:i,e&&e.length?di(e,i,t):[]},Vn.unset=function(e,t){return null==e||hi(e,t)},Vn.unzip=os,Vn.unzipWith=ss,Vn.update=function(e,t,n){return null==e?e:pi(e,t,Si(n))},Vn.updateWith=function(e,t,n,r){return r="function"==typeof r?r:i,null==e?e:pi(e,t,Si(n),r)},Vn.values=Va,Vn.valuesIn=function(e){return null==e?[]:en(e,Na(e))},Vn.without=as,Vn.words=Xa,Vn.wrap=function(e,t){return Us(Si(t),e)},Vn.xor=cs,Vn.xorBy=us,Vn.xorWith=ls,Vn.zip=ds,Vn.zipObject=function(e,t){return vi(e||[],t||[],nr)},Vn.zipObjectDeep=function(e,t){return vi(e||[],t||[],ei)},Vn.zipWith=hs,Vn.entries=ja,Vn.entriesIn=Fa,Vn.extend=ya,Vn.extendWith=ba,cc(Vn,Vn),Vn.add=Ec,Vn.attempt=Za,Vn.camelCase=Ga,Vn.capitalize=Ha,Vn.ceil=Sc,Vn.clamp=function(e,t,n){return n===i&&(n=t,t=i),n!==i&&(n=(n=va(n))==n?n:0),t!==i&&(t=(t=va(t))==t?t:0),cr(va(e),t,n)},Vn.clone=function(e){return ur(e,4)},Vn.cloneDeep=function(e){return ur(e,5)},Vn.cloneDeepWith=function(e,t){return ur(e,5,t="function"==typeof t?t:i)},Vn.cloneWith=function(e,t){return ur(e,4,t="function"==typeof t?t:i)},Vn.conformsTo=function(e,t){return null==t||lr(e,t,Da(t))},Vn.deburr=Wa,Vn.defaultTo=function(e,t){return null==e||e!=e?t:e},Vn.divide=_c,Vn.endsWith=function(e,t,n){e=Sa(e),t=li(t);var r=e.length,o=n=n===i?r:cr(ga(n),0,r);return(n-=t.length)>=0&&e.slice(n,o)==t},Vn.eq=Vs,Vn.escape=function(e){return(e=Sa(e))&&Q.test(e)?e.replace(J,sn):e},Vn.escapeRegExp=function(e){return(e=Sa(e))&&oe.test(e)?e.replace(ie,"\\$&"):e},Vn.every=function(e,t,n){var r=$s(e)?Pt:gr;return n&&yo(e,t,n)&&(t=i),r(e,uo(t,3))},Vn.find=vs,Vn.findIndex=Wo,Vn.findKey=function(e,t){return Vt(e,uo(t,3),yr)},Vn.findLast=Es,Vn.findLastIndex=$o,Vn.findLastKey=function(e,t){return Vt(e,uo(t,3),br)},Vn.floor=yc,Vn.forEach=Ss,Vn.forEachRight=_s,Vn.forIn=function(e,t){return null==e?e:Sr(e,uo(t,3),Na)},Vn.forInRight=function(e,t){return null==e?e:_r(e,uo(t,3),Na)},Vn.forOwn=function(e,t){return e&&yr(e,uo(t,3))},Vn.forOwnRight=function(e,t){return e&&br(e,uo(t,3))},Vn.get=Oa,Vn.gt=Gs,Vn.gte=Hs,Vn.has=function(e,t){return null!=e&&vo(e,t,wr)},Vn.hasIn=wa,Vn.head=zo,Vn.identity=ic,Vn.includes=function(e,t,n,r){e=zs(e)?e:Va(e),n=n&&!r?ga(n):0;var i=e.length;return n<0&&(n=Sn(i+n,0)),ca(e)?n<=i&&e.indexOf(t,n)>-1:!!i&&Ht(e,t,n)>-1},Vn.indexOf=function(e,t,n){var r=null==e?0:e.length;if(!r)return-1;var i=null==n?0:ga(n);return i<0&&(i=Sn(r+i,0)),Ht(e,t,i)},Vn.inRange=function(e,t,n){return t=fa(t),n===i?(n=t,t=0):n=fa(n),function(e,t,n){return e>=_n(t,n)&&e<Sn(t,n)}(e=va(e),t,n)},Vn.invoke=Pa,Vn.isArguments=Ws,Vn.isArray=$s,Vn.isArrayBuffer=qs,Vn.isArrayLike=zs,Vn.isArrayLikeObject=Ks,Vn.isBoolean=function(e){return!0===e||!1===e||na(e)&&Rr(e)==_},Vn.isBuffer=Js,Vn.isDate=Ys,Vn.isElement=function(e){return na(e)&&1===e.nodeType&&!oa(e)},Vn.isEmpty=function(e){if(null==e)return!0;if(zs(e)&&($s(e)||"string"==typeof e||"function"==typeof e.splice||Js(e)||la(e)||Ws(e)))return!e.length;var t=mo(e);if(t==I||t==k)return!e.size;if(Io(e))return!Br(e).length;for(var n in e)if(xe.call(e,n))return!1;return!0},Vn.isEqual=function(e,t){return Nr(e,t)},Vn.isEqualWith=function(e,t,n){var r=(n="function"==typeof n?n:i)?n(e,t):i;return r===i?Nr(e,t,i,n):!!r},Vn.isError=Qs,Vn.isFinite=function(e){return"number"==typeof e&&_t(e)},Vn.isFunction=Xs,Vn.isInteger=Zs,Vn.isLength=ea,Vn.isMap=ra,Vn.isMatch=function(e,t){return e===t||Lr(e,t,ho(t))},Vn.isMatchWith=function(e,t,n){return n="function"==typeof n?n:i,Lr(e,t,ho(t),n)},Vn.isNaN=function(e){return ia(e)&&e!=+e},Vn.isNative=function(e){if(Co(e))throw new Ce("Unsupported core-js use. Try https://npms.io/search?q=ponyfill.");return Mr(e)},Vn.isNil=function(e){return null==e},Vn.isNull=function(e){return null===e},Vn.isNumber=ia,Vn.isObject=ta,Vn.isObjectLike=na,Vn.isPlainObject=oa,Vn.isRegExp=sa,Vn.isSafeInteger=function(e){return Zs(e)&&e>=-9007199254740991&&e<=f},Vn.isSet=aa,Vn.isString=ca,Vn.isSymbol=ua,Vn.isTypedArray=la,Vn.isUndefined=function(e){return e===i},Vn.isWeakMap=function(e){return na(e)&&mo(e)==N},Vn.isWeakSet=function(e){return na(e)&&"[object WeakSet]"==Rr(e)},Vn.join=function(e,t){return null==e?"":Ft.call(e,t)},Vn.kebabCase=$a,Vn.last=Qo,Vn.lastIndexOf=function(e,t,n){var r=null==e?0:e.length;if(!r)return-1;var o=r;return n!==i&&(o=(o=ga(n))<0?Sn(r+o,0):_n(o,r-1)),t==t?function(e,t,n){for(var r=n+1;r--;)if(e[r]===t)return r;return r}(e,t,o):Gt(e,$t,o,!0)},Vn.lowerCase=qa,Vn.lowerFirst=za,Vn.lt=da,Vn.lte=ha,Vn.max=function(e){return e&&e.length?mr(e,ic,Or):i},Vn.maxBy=function(e,t){return e&&e.length?mr(e,uo(t,2),Or):i},Vn.mean=function(e){return qt(e,ic)},Vn.meanBy=function(e,t){return qt(e,uo(t,2))},Vn.min=function(e){return e&&e.length?mr(e,ic,jr):i},Vn.minBy=function(e,t){return e&&e.length?mr(e,uo(t,2),jr):i},Vn.stubArray=mc,Vn.stubFalse=vc,Vn.stubObject=function(){return{}},Vn.stubString=function(){return""},Vn.stubTrue=function(){return!0},Vn.multiply=Tc,Vn.nth=function(e,t){return e&&e.length?Wr(e,ga(t)):i},Vn.noConflict=function(){return gt._===this&&(gt._=Ve),this},Vn.noop=uc,Vn.now=Os,Vn.pad=function(e,t,n){e=Sa(e);var r=(t=ga(t))?fn(e):0;if(!t||r>=t)return e;var i=(t-r)/2;return $i(mt(i),n)+e+$i(ft(i),n)},Vn.padEnd=function(e,t,n){e=Sa(e);var r=(t=ga(t))?fn(e):0;return t&&r<t?e+$i(t-r,n):e},Vn.padStart=function(e,t,n){e=Sa(e);var r=(t=ga(t))?fn(e):0;return t&&r<t?$i(t-r,n)+e:e},Vn.parseInt=function(e,t,n){return n||null==t?t=0:t&&(t=+t),bn(Sa(e).replace(se,""),t||0)},Vn.random=function(e,t,n){if(n&&"boolean"!=typeof n&&yo(e,t,n)&&(t=n=i),n===i&&("boolean"==typeof t?(n=t,t=i):"boolean"==typeof e&&(n=e,e=i)),e===i&&t===i?(e=0,t=1):(e=fa(e),t===i?(t=e,e=0):t=fa(t)),e>t){var r=e;e=t,t=r}if(n||e%1||t%1){var o=Tn();return _n(e+o*(t-e+dt("1e-"+((o+"").length-1))),t)}return Jr(e,t)},Vn.reduce=function(e,t,n){var r=$s(e)?Bt:Jt,i=arguments.length<3;return r(e,uo(t,4),n,i,pr)},Vn.reduceRight=function(e,t,n){var r=$s(e)?Ut:Jt,i=arguments.length<3;return r(e,uo(t,4),n,i,fr)},Vn.repeat=function(e,t,n){return t=(n?yo(e,t,n):t===i)?1:ga(t),Yr(Sa(e),t)},Vn.replace=function(){var e=arguments,t=Sa(e[0]);return e.length<3?t:t.replace(e[1],e[2])},Vn.result=function(e,t,n){var r=-1,o=(t=_i(t,e)).length;for(o||(o=1,e=i);++r<o;){var s=null==e?i:e[Uo(t[r])];s===i&&(r=o,s=n),e=Xs(s)?s.call(e):s}return e},Vn.round=Cc,Vn.runInContext=e,Vn.sample=function(e){return($s(e)?Xn:Xr)(e)},Vn.size=function(e){if(null==e)return 0;if(zs(e))return ca(e)?fn(e):e.length;var t=mo(e);return t==I||t==k?e.size:Br(e).length},Vn.snakeCase=Ka,Vn.some=function(e,t,n){var r=$s(e)?jt:oi;return n&&yo(e,t,n)&&(t=i),r(e,uo(t,3))},Vn.sortedIndex=function(e,t){return si(e,t)},Vn.sortedIndexBy=function(e,t,n){return ai(e,t,uo(n,2))},Vn.sortedIndexOf=function(e,t){var n=null==e?0:e.length;if(n){var r=si(e,t);if(r<n&&Vs(e[r],t))return r}return-1},Vn.sortedLastIndex=function(e,t){return si(e,t,!0)},Vn.sortedLastIndexBy=function(e,t,n){return ai(e,t,uo(n,2),!0)},Vn.sortedLastIndexOf=function(e,t){if(null==e?0:e.length){var n=si(e,t,!0)-1;if(Vs(e[n],t))return n}return-1},Vn.startCase=Ja,Vn.startsWith=function(e,t,n){return e=Sa(e),n=null==n?0:cr(ga(n),0,e.length),t=li(t),e.slice(n,n+t.length)==t},Vn.subtract=Ic,Vn.sum=function(e){return e&&e.length?Yt(e,ic):0},Vn.sumBy=function(e,t){return e&&e.length?Yt(e,uo(t,2)):0},Vn.template=function(e,t,n){var r=Vn.templateSettings;n&&yo(e,t,n)&&(t=i),e=Sa(e),t=ba({},t,r,Zi);var o,s,a=ba({},t.imports,r.imports,Zi),c=Da(a),u=en(a,c),l=0,d=t.interpolate||be,h="__p += '",p=we((t.escape||be).source+"|"+d.source+"|"+(d===ee?fe:be).source+"|"+(t.evaluate||be).source+"|$","g"),f="//# sourceURL="+(xe.call(t,"sourceURL")?(t.sourceURL+"").replace(/\s/g," "):"lodash.templateSources["+ ++at+"]")+"\n";e.replace(p,(function(t,n,r,i,a,c){return r||(r=i),h+=e.slice(l,c).replace(Te,an),n&&(o=!0,h+="' +\n__e("+n+") +\n'"),a&&(s=!0,h+="';\n"+a+";\n__p += '"),r&&(h+="' +\n((__t = ("+r+")) == null ? '' : __t) +\n'"),l=c+t.length,t})),h+="';\n";var g=xe.call(t,"variable")&&t.variable;if(g){if(he.test(g))throw new Ce("Invalid `variable` option passed into `_.template`")}else h="with (obj) {\n"+h+"\n}\n";h=(s?h.replace($,""):h).replace(q,"$1").replace(z,"$1;"),h="function("+(g||"obj")+") {\n"+(g?"":"obj || (obj = {});\n")+"var __t, __p = ''"+(o?", __e = _.escape":"")+(s?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+h+"return __p\n}";var m=Za((function(){return Ie(c,f+"return "+h).apply(i,u)}));if(m.source=h,Qs(m))throw m;return m},Vn.times=function(e,t){if((e=ga(e))<1||e>f)return[];var n=m,r=_n(e,m);t=uo(t),e-=m;for(var i=Qt(r,t);++n<e;)t(n);return i},Vn.toFinite=fa,Vn.toInteger=ga,Vn.toLength=ma,Vn.toLower=function(e){return Sa(e).toLowerCase()},Vn.toNumber=va,Vn.toSafeInteger=function(e){return e?cr(ga(e),-9007199254740991,f):0===e?e:0},Vn.toString=Sa,Vn.toUpper=function(e){return Sa(e).toUpperCase()},Vn.trim=function(e,t,n){if((e=Sa(e))&&(n||t===i))return Xt(e);if(!e||!(t=li(t)))return e;var r=gn(e),o=gn(t);return bi(r,nn(r,o),rn(r,o)+1).join("")},Vn.trimEnd=function(e,t,n){if((e=Sa(e))&&(n||t===i))return e.slice(0,mn(e)+1);if(!e||!(t=li(t)))return e;var r=gn(e);return bi(r,0,rn(r,gn(t))+1).join("")},Vn.trimStart=function(e,t,n){if((e=Sa(e))&&(n||t===i))return e.replace(se,"");if(!e||!(t=li(t)))return e;var r=gn(e);return bi(r,nn(r,gn(t))).join("")},Vn.truncate=function(e,t){var n=30,r="...";if(ta(t)){var o="separator"in t?t.separator:o;n="length"in t?ga(t.length):n,r="omission"in t?li(t.omission):r}var s=(e=Sa(e)).length;if(cn(e)){var a=gn(e);s=a.length}if(n>=s)return e;var c=n-fn(r);if(c<1)return r;var u=a?bi(a,0,c).join(""):e.slice(0,c);if(o===i)return u+r;if(a&&(c+=u.length-c),sa(o)){if(e.slice(c).search(o)){var l,d=u;for(o.global||(o=we(o.source,Sa(ge.exec(o))+"g")),o.lastIndex=0;l=o.exec(d);)var h=l.index;u=u.slice(0,h===i?c:h)}}else if(e.indexOf(li(o),c)!=c){var p=u.lastIndexOf(o);p>-1&&(u=u.slice(0,p))}return u+r},Vn.unescape=function(e){return(e=Sa(e))&&Y.test(e)?e.replace(K,vn):e},Vn.uniqueId=function(e){var t=++Be;return Sa(e)+t},Vn.upperCase=Ya,Vn.upperFirst=Qa,Vn.each=Ss,Vn.eachRight=_s,Vn.first=zo,cc(Vn,(bc={},yr(Vn,(function(e,t){xe.call(Vn.prototype,t)||(bc[t]=e)})),bc),{chain:!1}),Vn.VERSION="4.17.21",At(["bind","bindKey","curry","curryRight","partial","partialRight"],(function(e){Vn[e].placeholder=Vn})),At(["drop","take"],(function(e,t){$n.prototype[e]=function(n){n=n===i?1:Sn(ga(n),0);var r=this.__filtered__&&!t?new $n(this):this.clone();return r.__filtered__?r.__takeCount__=_n(n,r.__takeCount__):r.__views__.push({size:_n(n,m),type:e+(r.__dir__<0?"Right":"")}),r},$n.prototype[e+"Right"]=function(t){return this.reverse()[e](t).reverse()}})),At(["filter","map","takeWhile"],(function(e,t){var n=t+1,r=1==n||3==n;$n.prototype[e]=function(e){var t=this.clone();return t.__iteratees__.push({iteratee:uo(e,3),type:n}),t.__filtered__=t.__filtered__||r,t}})),At(["head","last"],(function(e,t){var n="take"+(t?"Right":"");$n.prototype[e]=function(){return this[n](1).value()[0]}})),At(["initial","tail"],(function(e,t){var n="drop"+(t?"":"Right");$n.prototype[e]=function(){return this.__filtered__?new $n(this):this[n](1)}})),$n.prototype.compact=function(){return this.filter(ic)},$n.prototype.find=function(e){return this.filter(e).head()},$n.prototype.findLast=function(e){return this.reverse().find(e)},$n.prototype.invokeMap=Qr((function(e,t){return"function"==typeof e?new $n(this):this.map((function(n){return Pr(n,e,t)}))})),$n.prototype.reject=function(e){return this.filter(xs(uo(e)))},$n.prototype.slice=function(e,t){e=ga(e);var n=this;return n.__filtered__&&(e>0||t<0)?new $n(n):(e<0?n=n.takeRight(-e):e&&(n=n.drop(e)),t!==i&&(n=(t=ga(t))<0?n.dropRight(-t):n.take(t-e)),n)},$n.prototype.takeRightWhile=function(e){return this.reverse().takeWhile(e).reverse()},$n.prototype.toArray=function(){return this.take(m)},yr($n.prototype,(function(e,t){var n=/^(?:filter|find|map|reject)|While$/.test(t),r=/^(?:head|last)$/.test(t),o=Vn[r?"take"+("last"==t?"Right":""):t],s=r||/^find/.test(t);o&&(Vn.prototype[t]=function(){var t=this.__wrapped__,a=r?[1]:arguments,c=t instanceof $n,u=a[0],l=c||$s(t),d=function(e){var t=o.apply(Vn,xt([e],a));return r&&h?t[0]:t};l&&n&&"function"==typeof u&&1!=u.length&&(c=l=!1);var h=this.__chain__,p=!!this.__actions__.length,f=s&&!h,g=c&&!p;if(!s&&l){t=g?t:new $n(this);var m=e.apply(t,a);return m.__actions__.push({func:fs,args:[d],thisArg:i}),new Wn(m,h)}return f&&g?e.apply(this,a):(m=this.thru(d),f?r?m.value()[0]:m.value():m)})})),At(["pop","push","shift","sort","splice","unshift"],(function(e){var t=Pe[e],n=/^(?:push|sort|unshift)$/.test(e)?"tap":"thru",r=/^(?:pop|shift)$/.test(e);Vn.prototype[e]=function(){var e=arguments;if(r&&!this.__chain__){var i=this.value();return t.apply($s(i)?i:[],e)}return this[n]((function(n){return t.apply($s(n)?n:[],e)}))}})),yr($n.prototype,(function(e,t){var n=Vn[t];if(n){var r=n.name+"";xe.call(Dn,r)||(Dn[r]=[]),Dn[r].push({name:t,func:n})}})),Dn[Vi(i,2).name]=[{name:"wrapper",func:i}],$n.prototype.clone=function(){var e=new $n(this.__wrapped__);return e.__actions__=ki(this.__actions__),e.__dir__=this.__dir__,e.__filtered__=this.__filtered__,e.__iteratees__=ki(this.__iteratees__),e.__takeCount__=this.__takeCount__,e.__views__=ki(this.__views__),e},$n.prototype.reverse=function(){if(this.__filtered__){var e=new $n(this);e.__dir__=-1,e.__filtered__=!0}else(e=this.clone()).__dir__*=-1;return e},$n.prototype.value=function(){var e=this.__wrapped__.value(),t=this.__dir__,n=$s(e),r=t<0,i=n?e.length:0,o=function(e,t,n){var r=-1,i=n.length;for(;++r<i;){var o=n[r],s=o.size;switch(o.type){case"drop":e+=s;break;case"dropRight":t-=s;break;case"take":t=_n(t,e+s);break;case"takeRight":e=Sn(e,t-s)}}return{start:e,end:t}}(0,i,this.__views__),s=o.start,a=o.end,c=a-s,u=r?a:s-1,l=this.__iteratees__,d=l.length,h=0,p=_n(c,this.__takeCount__);if(!n||!r&&i==c&&p==c)return gi(e,this.__actions__);var f=[];e:for(;c--&&h<p;){for(var g=-1,m=e[u+=t];++g<d;){var v=l[g],E=v.iteratee,S=v.type,_=E(m);if(2==S)m=_;else if(!_){if(1==S)continue e;break e}}f[h++]=m}return f},Vn.prototype.at=gs,Vn.prototype.chain=function(){return ps(this)},Vn.prototype.commit=function(){return new Wn(this.value(),this.__chain__)},Vn.prototype.next=function(){this.__values__===i&&(this.__values__=pa(this.value()));var e=this.__index__>=this.__values__.length;return{done:e,value:e?i:this.__values__[this.__index__++]}},Vn.prototype.plant=function(e){for(var t,n=this;n instanceof Hn;){var r=Fo(n);r.__index__=0,r.__values__=i,t?o.__wrapped__=r:t=r;var o=r;n=n.__wrapped__}return o.__wrapped__=e,t},Vn.prototype.reverse=function(){var e=this.__wrapped__;if(e instanceof $n){var t=e;return this.__actions__.length&&(t=new $n(this)),(t=t.reverse()).__actions__.push({func:fs,args:[ts],thisArg:i}),new Wn(t,this.__chain__)}return this.thru(ts)},Vn.prototype.toJSON=Vn.prototype.valueOf=Vn.prototype.value=function(){return gi(this.__wrapped__,this.__actions__)},Vn.prototype.first=Vn.prototype.head,Xe&&(Vn.prototype[Xe]=function(){return this}),Vn}();gt._=En,(r=function(){return En}.call(t,n,t,e))===i||(e.exports=r)}.call(this)},5364:(e,t,n)=>{var r=n(5250),i=n(999)((function(e,t,n){r(e,t,n)}));e.exports=i},9935:e=>{e.exports=function(){return!1}},9884:(e,t,n)=>{var r=n(1791),i=n(7241);e.exports=function(e){return r(e,i(e))}},5602:e=>{var t=e.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(t).forEach((function(e){t[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))},7363:(e,t,n)=>{var r=n(5020),i=n(3804);t.M9=i,t.qg=r.parse,t.Sl=r.parseParams,r.parseFmtpConfig,r.parsePayloads,r.parseRemoteCandidates,r.parseImageAttributes,r.parseSimulcastStreamList},5020:(e,t,n)=>{var r=function(e){return String(Number(e))===e?Number(e):e},i=function(e,t,n){var i=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:i&&!t[e.name]&&(t[e.name]={});var o=e.push?{}:i?t[e.name]:t;!function(e,t,n,i){if(i&&!n)t[i]=r(e[1]);else for(var o=0;o<n.length;o+=1)null!=e[o+1]&&(t[n[o]]=r(e[o+1]))}(n.match(e.reg),o,e.names,e.name),e.push&&t[e.push].push(o)},o=n(5602),s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(e){var t={},n=[],r=t;return e.split(/(\r\n|\r|\n)/).filter(s).forEach((function(e){var t=e[0],s=e.slice(2);"m"===t&&(n.push({rtp:[],fmtp:[]}),r=n[n.length-1]);for(var a=0;a<(o[t]||[]).length;a+=1){var c=o[t][a];if(c.reg.test(s))return i(c,r,s)}})),t.media=n,t};var a=function(e,t){var n=t.split(/=(.+)/,2);return 2===n.length?e[n[0]]=r(n[1]):1===n.length&&t.length>1&&(e[n[0]]=void 0),e};t.parseParams=function(e){return e.split(/;\s?/).reduce(a,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(e){return e.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(e){for(var t=[],n=e.split(" ").map(r),i=0;i<n.length;i+=3)t.push({component:n[i],ip:n[i+1],port:n[i+2]});return t},t.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(a,{})}))},t.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var t,n=!1;return"~"!==e[0]?t=r(e):(t=r(e.substring(1,e.length)),n=!0),{scid:t,paused:n}}))}))}},3804:(e,t,n)=>{var r=n(5602),i=/%[sdv%]/g,o=function(e){var t=1,n=arguments,r=n.length;return e.replace(i,(function(e){if(t>=r)return e;var i=n[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(i);case"%d":return Number(i);case"%v":return""}}))},s=function(e,t,n){var r=[e+"="+(t.format instanceof Function?t.format(t.push?n:n[t.name]):t.format)];if(t.names)for(var i=0;i<t.names.length;i+=1){var s=t.names[i];t.name?r.push(n[t.name][s]):r.push(n[t.names[i]])}else r.push(n[t.name]);return o.apply(null,r)},a=["v","o","s","i","u","e","p","c","b","t","r","z","a"],c=["i","c","b","a"];e.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var n=t.outerOrder||a,i=t.innerOrder||c,o=[];return n.forEach((function(t){r[t].forEach((function(n){n.name in e&&null!=e[n.name]?o.push(s(t,n,e)):n.push in e&&null!=e[n.push]&&e[n.push].forEach((function(e){o.push(s(t,n,e))}))}))})),e.media.forEach((function(e){o.push(s("m",r.m[0],e)),i.forEach((function(t){r[t].forEach((function(n){n.name in e&&null!=e[n.name]?o.push(s(t,n,e)):n.push in e&&null!=e[n.push]&&e[n.push].forEach((function(e){o.push(s(t,n,e))}))}))}))})),o.join("\r\n")+"\r\n"}},7963:e=>{"use strict";const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((e=>e.trim()))},t.splitSections=function(e){return e.split("\nm=").map(((e,t)=>(t>0?"m="+e:e).trim()+"\r\n"))},t.getDescription=function(e){const n=t.splitSections(e);return n&&n[0]},t.getMediaSections=function(e){const n=t.splitSections(e);return n.shift(),n},t.matchPrefix=function(e,n){return t.splitLines(e).filter((e=>0===e.indexOf(n)))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const n={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let e=8;e<t.length;e+=2)switch(t[e]){case"raddr":n.relatedAddress=t[e+1];break;case"rport":n.relatedPort=parseInt(t[e+1],10);break;case"tcptype":n.tcpType=t[e+1];break;case"ufrag":n.ufrag=t[e+1],n.usernameFragment=t[e+1];break;default:void 0===n[t[e]]&&(n[t[e]]=t[e+1])}return n},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const n=e.component;"rtp"===n?t.push(1):"rtcp"===n?t.push(2):t.push(n),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substring(14).split(" ")},t.parseRtpMap=function(e){let t=e.substring(9).split(" ");const n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.channels=3===t.length?parseInt(t[2],10):1,n.numChannels=n.channels,n},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const n=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==n?"/"+n:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substring(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+"\r\n"},t.parseFmtp=function(e){const t={};let n;const r=e.substring(e.indexOf(" ")+1).split(";");for(let e=0;e<r.length;e++)n=r[e].trim().split("="),t[n[0].trim()]=n[1];return t},t.writeFmtp=function(e){let t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const r=[];Object.keys(e.parameters).forEach((t=>{void 0!==e.parameters[t]?r.push(t+"="+e.parameters[t]):r.push(t)})),t+="a=fmtp:"+n+" "+r.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substring(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),n={ssrc:parseInt(e.substring(7,t),10)},r=e.indexOf(":",t);return r>-1?(n.attribute=e.substring(t+1,r),n.value=e.substring(r+1)):n.attribute=e.substring(t+1),n},t.parseSsrcGroup=function(e){const t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}},t.getMid=function(e){const n=t.matchPrefix(e,"a=mid:")[0];if(n)return n.substring(6)},t.parseFingerprint=function(e){const t=e.substring(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,n){return{role:"auto",fingerprints:t.matchPrefix(e+n,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let n="a=setup:"+t+"\r\n";return e.fingerprints.forEach((e=>{n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),n},t.parseCryptoLine=function(e){const t=e.substring(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substring(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,n){return t.matchPrefix(e+n,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,n){const r=t.matchPrefix(e+n,"a=ice-ufrag:")[0],i=t.matchPrefix(e+n,"a=ice-pwd:")[0];return r&&i?{usernameFragment:r.substring(12),password:i.substring(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const n={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=t.splitLines(e)[0].split(" ");n.profile=r[2];for(let i=3;i<r.length;i++){const o=r[i],s=t.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(s){const r=t.parseRtpMap(s),i=t.matchPrefix(e,"a=fmtp:"+o+" ");switch(r.parameters=i.length?t.parseFmtp(i[0]):{},r.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(t.parseRtcpFb),n.codecs.push(r),r.name.toUpperCase()){case"RED":case"ULPFEC":n.fecMechanisms.push(r.name.toUpperCase())}}}t.matchPrefix(e,"a=extmap:").forEach((e=>{n.headerExtensions.push(t.parseExtmap(e))}));const i=t.matchPrefix(e,"a=rtcp-fb:* ").map(t.parseRtcpFb);return n.codecs.forEach((e=>{i.forEach((t=>{e.rtcpFeedback.find((e=>e.type===t.type&&e.parameter===t.parameter))||e.rtcpFeedback.push(t)}))})),n},t.writeRtpDescription=function(e,n){let r="";r+="m="+e+" ",r+=n.codecs.length>0?"9":"0",r+=" "+(n.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=n.codecs.map((e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",n.codecs.forEach((e=>{r+=t.writeRtpMap(e),r+=t.writeFmtp(e),r+=t.writeRtcpFb(e)}));let i=0;return n.codecs.forEach((e=>{e.maxptime>i&&(i=e.maxptime)})),i>0&&(r+="a=maxptime:"+i+"\r\n"),n.headerExtensions&&n.headerExtensions.forEach((e=>{r+=t.writeExtmap(e)})),r},t.parseRtpEncodingParameters=function(e){const n=[],r=t.parseRtpParameters(e),i=-1!==r.fecMechanisms.indexOf("RED"),o=-1!==r.fecMechanisms.indexOf("ULPFEC"),s=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute)),a=s.length>0&&s[0].ssrc;let c;const u=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>e.substring(17).split(" ").map((e=>parseInt(e,10)))));u.length>0&&u[0].length>1&&u[0][0]===a&&(c=u[0][1]),r.codecs.forEach((e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:a,codecPayloadType:parseInt(e.parameters.apt,10)};a&&c&&(t.rtx={ssrc:c}),n.push(t),i&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:a,mechanism:o?"red+ulpfec":"red"},n.push(t))}})),0===n.length&&a&&n.push({ssrc:a});let l=t.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substring(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substring(5),10)*.95-16e3:void 0,n.forEach((e=>{e.maxBitrate=l}))),n},t.parseRtcpParameters=function(e){const n={},r=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute))[0];r&&(n.cname=r.value,n.ssrc=r.ssrc);const i=t.matchPrefix(e,"a=rtcp-rsize");n.reducedSize=i.length>0,n.compound=0===i.length;const o=t.matchPrefix(e,"a=rtcp-mux");return n.mux=o.length>0,n},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let n;const r=t.matchPrefix(e,"a=msid:");if(1===r.length)return n=r[0].substring(7).split(" "),{stream:n[0],track:n[1]};const i=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"msid"===e.attribute));return i.length>0?(n=i[0].value.split(" "),{stream:n[0],track:n[1]}):void 0},t.parseSctpDescription=function(e){const n=t.parseMLine(e),r=t.matchPrefix(e,"a=max-message-size:");let i;r.length>0&&(i=parseInt(r[0].substring(19),10)),isNaN(i)&&(i=65536);const o=t.matchPrefix(e,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:n.fmt,maxMessageSize:i};const s=t.matchPrefix(e,"a=sctpmap:");if(s.length>0){const e=s[0].substring(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:i}}},t.writeSctpDescription=function(e,t){let n=[];return n="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&n.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),n.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(e,n,r){let i;const o=void 0!==n?n:2;i=e||t.generateSessionId();return"v=0\r\no="+(r||"thisisadapterortc")+" "+i+" "+o+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,n){const r=t.splitLines(e);for(let e=0;e<r.length;e++)switch(r[e]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[e].substring(2)}return n?t.getDirection(n):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substring(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const n=t.splitLines(e)[0].substring(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},t.parseOLine=function(e){const n=t.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const n=t.splitLines(e);for(let e=0;e<n.length;e++)if(n[e].length<2||"="!==n[e].charAt(1))return!1;return!0},e.exports=t},5512:e=>{"use strict";e.exports=function(e,t,n,r){var i=self||window;try{try{var o;try{o=new i.Blob([e])}catch(t){(o=new(i.BlobBuilder||i.WebKitBlobBuilder||i.MozBlobBuilder||i.MSBlobBuilder)).append(e),o=o.getBlob()}var s=i.URL||i.webkitURL,a=s.createObjectURL(o),c=new i[t](a,n);return s.revokeObjectURL(a),c}catch(r){return new i[t]("data:application/javascript,".concat(encodeURIComponent(e)),n)}}catch(e){if(!r)throw Error("Inline worker is not supported");return new i[t](r,n)}}},8630:(e,t,n)=>{var r;!function(e){!function(){var t="object"==typeof globalThis?globalThis:"object"==typeof n.g?n.g:"object"==typeof self?self:"object"==typeof this?this:function(){try{return Function("return this;")()}catch(e){}}()||function(){try{return(0,eval)("(function() { return this; })()")}catch(e){}}(),r=i(e);function i(e,t){return function(n,r){Object.defineProperty(e,n,{configurable:!0,writable:!0,value:r}),t&&t(n,r)}}void 0!==t.Reflect&&(r=i(t.Reflect,r)),function(e,t){var n=Object.prototype.hasOwnProperty,r="function"==typeof Symbol,i=r&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",o=r&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",s="function"==typeof Object.create,a={__proto__:[]}instanceof Array,c=!s&&!a,u={create:s?function(){return de(Object.create(null))}:a?function(){return de({__proto__:null})}:function(){return de({})},has:c?function(e,t){return n.call(e,t)}:function(e,t){return t in e},get:c?function(e,t){return n.call(e,t)?e[t]:void 0}:function(e,t){return e[t]}},l=Object.getPrototypeOf(Function),d="function"==typeof Map&&"function"==typeof Map.prototype.entries?Map:ce(),h="function"==typeof Set&&"function"==typeof Set.prototype.entries?Set:ue(),p="function"==typeof WeakMap?WeakMap:le(),f=r?Symbol.for("@reflect-metadata:registry"):void 0,g=ie(),m=oe(g);function v(e,t,n,r){if(B(n)){if(!q(e))throw new TypeError;if(!K(t))throw new TypeError;return O(e,t)}if(!q(e))throw new TypeError;if(!F(t))throw new TypeError;if(!F(r)&&!B(r)&&!U(r))throw new TypeError;return U(r)&&(r=void 0),w(e,t,n=$(n),r)}function E(e,t){function n(n,r){if(!F(n))throw new TypeError;if(!B(r)&&!J(r))throw new TypeError;N(e,t,n,r)}return n}function S(e,t,n,r){if(!F(n))throw new TypeError;return B(r)||(r=$(r)),N(e,t,n,r)}function _(e,t,n){if(!F(t))throw new TypeError;return B(n)||(n=$(n)),A(e,t,n)}function y(e,t,n){if(!F(t))throw new TypeError;return B(n)||(n=$(n)),k(e,t,n)}function b(e,t,n){if(!F(t))throw new TypeError;return B(n)||(n=$(n)),P(e,t,n)}function T(e,t,n){if(!F(t))throw new TypeError;return B(n)||(n=$(n)),D(e,t,n)}function C(e,t){if(!F(e))throw new TypeError;return B(t)||(t=$(t)),L(e,t)}function I(e,t){if(!F(e))throw new TypeError;return B(t)||(t=$(t)),M(e,t)}function R(e,t,n){if(!F(t))throw new TypeError;if(B(n)||(n=$(n)),!F(t))throw new TypeError;B(n)||(n=$(n));var r=ae(t,n,!1);return!B(r)&&r.OrdinaryDeleteMetadata(e,t,n)}function O(e,t){for(var n=e.length-1;n>=0;--n){var r=(0,e[n])(t);if(!B(r)&&!U(r)){if(!K(r))throw new TypeError;t=r}}return t}function w(e,t,n,r){for(var i=e.length-1;i>=0;--i){var o=(0,e[i])(t,n,r);if(!B(o)&&!U(o)){if(!F(o))throw new TypeError;r=o}}return r}function A(e,t,n){if(k(e,t,n))return!0;var r=ne(t);return!U(r)&&A(e,r,n)}function k(e,t,n){var r=ae(t,n,!1);return!B(r)&&H(r.OrdinaryHasOwnMetadata(e,t,n))}function P(e,t,n){if(k(e,t,n))return D(e,t,n);var r=ne(t);return U(r)?void 0:P(e,r,n)}function D(e,t,n){var r=ae(t,n,!1);if(!B(r))return r.OrdinaryGetOwnMetadata(e,t,n)}function N(e,t,n,r){ae(n,r,!0).OrdinaryDefineOwnMetadata(e,t,n,r)}function L(e,t){var n=M(e,t),r=ne(e);if(null===r)return n;var i=L(r,t);if(i.length<=0)return n;if(n.length<=0)return i;for(var o=new h,s=[],a=0,c=n;a<c.length;a++){var u=c[a];o.has(u)||(o.add(u),s.push(u))}for(var l=0,d=i;l<d.length;l++){u=d[l];o.has(u)||(o.add(u),s.push(u))}return s}function M(e,t){var n=ae(e,t,!1);return n?n.OrdinaryOwnMetadataKeys(e,t):[]}function x(e){if(null===e)return 1;switch(typeof e){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===e?1:6;default:return 6}}function B(e){return void 0===e}function U(e){return null===e}function j(e){return"symbol"==typeof e}function F(e){return"object"==typeof e?null!==e:"function"==typeof e}function V(e,t){switch(x(e)){case 0:case 1:case 2:case 3:case 4:case 5:return e}var n=3===t?"string":5===t?"number":"default",r=Q(e,i);if(void 0!==r){var o=r.call(e,n);if(F(o))throw new TypeError;return o}return G(e,"default"===n?"number":n)}function G(e,t){if("string"===t){var n=e.toString;if(z(n))if(!F(i=n.call(e)))return i;if(z(r=e.valueOf))if(!F(i=r.call(e)))return i}else{var r;if(z(r=e.valueOf))if(!F(i=r.call(e)))return i;var i,o=e.toString;if(z(o))if(!F(i=o.call(e)))return i}throw new TypeError}function H(e){return!!e}function W(e){return""+e}function $(e){var t=V(e,3);return j(t)?t:W(t)}function q(e){return Array.isArray?Array.isArray(e):e instanceof Object?e instanceof Array:"[object Array]"===Object.prototype.toString.call(e)}function z(e){return"function"==typeof e}function K(e){return"function"==typeof e}function J(e){switch(x(e)){case 3:case 4:return!0;default:return!1}}function Y(e,t){return e===t||e!=e&&t!=t}function Q(e,t){var n=e[t];if(null!=n){if(!z(n))throw new TypeError;return n}}function X(e){var t=Q(e,o);if(!z(t))throw new TypeError;var n=t.call(e);if(!F(n))throw new TypeError;return n}function Z(e){return e.value}function ee(e){var t=e.next();return!t.done&&t}function te(e){var t=e.return;t&&t.call(e)}function ne(e){var t=Object.getPrototypeOf(e);if("function"!=typeof e||e===l)return t;if(t!==l)return t;var n=e.prototype,r=n&&Object.getPrototypeOf(n);if(null==r||r===Object.prototype)return t;var i=r.constructor;return"function"!=typeof i||i===e?t:i}function re(){var e,n,r,i;B(f)||void 0===t.Reflect||f in t.Reflect||"function"!=typeof t.Reflect.defineMetadata||(e=se(t.Reflect));var o=new p,s={registerProvider:a,getProvider:u,setProvider:g};return s;function a(t){if(!Object.isExtensible(s))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case e===t:break;case B(n):n=t;break;case n===t:break;case B(r):r=t;break;case r===t:break;default:void 0===i&&(i=new h),i.add(t)}}function c(t,o){if(!B(n)){if(n.isProviderFor(t,o))return n;if(!B(r)){if(r.isProviderFor(t,o))return n;if(!B(i))for(var s=X(i);;){var a=ee(s);if(!a)return;var c=Z(a);if(c.isProviderFor(t,o))return te(s),c}}}if(!B(e)&&e.isProviderFor(t,o))return e}function u(e,t){var n,r=o.get(e);return B(r)||(n=r.get(t)),B(n)?(B(n=c(e,t))||(B(r)&&(r=new d,o.set(e,r)),r.set(t,n)),n):n}function l(e){if(B(e))throw new TypeError;return n===e||r===e||!B(i)&&i.has(e)}function g(e,t,n){if(!l(n))throw new Error("Metadata provider not registered.");var r=u(e,t);if(r!==n){if(!B(r))return!1;var i=o.get(e);B(i)&&(i=new d,o.set(e,i)),i.set(t,n)}return!0}}function ie(){var e;return!B(f)&&F(t.Reflect)&&Object.isExtensible(t.Reflect)&&(e=t.Reflect[f]),B(e)&&(e=re()),!B(f)&&F(t.Reflect)&&Object.isExtensible(t.Reflect)&&Object.defineProperty(t.Reflect,f,{enumerable:!1,configurable:!1,writable:!1,value:e}),e}function oe(e){var t=new p,n={isProviderFor:function(e,n){var r=t.get(e);return!B(r)&&r.has(n)},OrdinaryDefineOwnMetadata:s,OrdinaryHasOwnMetadata:i,OrdinaryGetOwnMetadata:o,OrdinaryOwnMetadataKeys:a,OrdinaryDeleteMetadata:c};return g.registerProvider(n),n;function r(r,i,o){var s=t.get(r),a=!1;if(B(s)){if(!o)return;s=new d,t.set(r,s),a=!0}var c=s.get(i);if(B(c)){if(!o)return;if(c=new d,s.set(i,c),!e.setProvider(r,i,n))throw s.delete(i),a&&t.delete(r),new Error("Wrong provider for target.")}return c}function i(e,t,n){var i=r(t,n,!1);return!B(i)&&H(i.has(e))}function o(e,t,n){var i=r(t,n,!1);if(!B(i))return i.get(e)}function s(e,t,n,i){r(n,i,!0).set(e,t)}function a(e,t){var n=[],i=r(e,t,!1);if(B(i))return n;for(var o=X(i.keys()),s=0;;){var a=ee(o);if(!a)return n.length=s,n;var c=Z(a);try{n[s]=c}catch(e){try{te(o)}finally{throw e}}s++}}function c(e,n,i){var o=r(n,i,!1);if(B(o))return!1;if(!o.delete(e))return!1;if(0===o.size){var s=t.get(n);B(s)||(s.delete(i),0===s.size&&t.delete(s))}return!0}}function se(e){var t=e.defineMetadata,n=e.hasOwnMetadata,r=e.getOwnMetadata,i=e.getOwnMetadataKeys,o=e.deleteMetadata,s=new p;return{isProviderFor:function(e,t){var n=s.get(e);return!(B(n)||!n.has(t))||!!i(e,t).length&&(B(n)&&(n=new h,s.set(e,n)),n.add(t),!0)},OrdinaryDefineOwnMetadata:t,OrdinaryHasOwnMetadata:n,OrdinaryGetOwnMetadata:r,OrdinaryOwnMetadataKeys:i,OrdinaryDeleteMetadata:o}}function ae(e,t,n){var r=g.getProvider(e,t);if(!B(r))return r;if(n){if(g.setProvider(e,t,m))return m;throw new Error("Illegal state.")}}function ce(){var e={},t=[],n=function(){function e(e,t,n){this._index=0,this._keys=e,this._values=t,this._selector=n}return e.prototype["@@iterator"]=function(){return this},e.prototype[o]=function(){return this},e.prototype.next=function(){var e=this._index;if(e>=0&&e<this._keys.length){var n=this._selector(this._keys[e],this._values[e]);return e+1>=this._keys.length?(this._index=-1,this._keys=t,this._values=t):this._index++,{value:n,done:!1}}return{value:void 0,done:!0}},e.prototype.throw=function(e){throw this._index>=0&&(this._index=-1,this._keys=t,this._values=t),e},e.prototype.return=function(e){return this._index>=0&&(this._index=-1,this._keys=t,this._values=t),{value:e,done:!0}},e}();return function(){function t(){this._keys=[],this._values=[],this._cacheKey=e,this._cacheIndex=-2}return Object.defineProperty(t.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),t.prototype.has=function(e){return this._find(e,!1)>=0},t.prototype.get=function(e){var t=this._find(e,!1);return t>=0?this._values[t]:void 0},t.prototype.set=function(e,t){var n=this._find(e,!0);return this._values[n]=t,this},t.prototype.delete=function(t){var n=this._find(t,!1);if(n>=0){for(var r=this._keys.length,i=n+1;i<r;i++)this._keys[i-1]=this._keys[i],this._values[i-1]=this._values[i];return this._keys.length--,this._values.length--,Y(t,this._cacheKey)&&(this._cacheKey=e,this._cacheIndex=-2),!0}return!1},t.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=e,this._cacheIndex=-2},t.prototype.keys=function(){return new n(this._keys,this._values,r)},t.prototype.values=function(){return new n(this._keys,this._values,i)},t.prototype.entries=function(){return new n(this._keys,this._values,s)},t.prototype["@@iterator"]=function(){return this.entries()},t.prototype[o]=function(){return this.entries()},t.prototype._find=function(e,t){if(!Y(this._cacheKey,e)){this._cacheIndex=-1;for(var n=0;n<this._keys.length;n++)if(Y(this._keys[n],e)){this._cacheIndex=n;break}}return this._cacheIndex<0&&t&&(this._cacheIndex=this._keys.length,this._keys.push(e),this._values.push(void 0)),this._cacheIndex},t}();function r(e,t){return e}function i(e,t){return t}function s(e,t){return[e,t]}}function ue(){return function(){function e(){this._map=new d}return Object.defineProperty(e.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),e.prototype.has=function(e){return this._map.has(e)},e.prototype.add=function(e){return this._map.set(e,e),this},e.prototype.delete=function(e){return this._map.delete(e)},e.prototype.clear=function(){this._map.clear()},e.prototype.keys=function(){return this._map.keys()},e.prototype.values=function(){return this._map.keys()},e.prototype.entries=function(){return this._map.entries()},e.prototype["@@iterator"]=function(){return this.keys()},e.prototype[o]=function(){return this.keys()},e}()}function le(){var e=16,t=u.create(),r=i();return function(){function e(){this._key=i()}return e.prototype.has=function(e){var t=o(e,!1);return void 0!==t&&u.has(t,this._key)},e.prototype.get=function(e){var t=o(e,!1);return void 0!==t?u.get(t,this._key):void 0},e.prototype.set=function(e,t){return o(e,!0)[this._key]=t,this},e.prototype.delete=function(e){var t=o(e,!1);return void 0!==t&&delete t[this._key]},e.prototype.clear=function(){this._key=i()},e}();function i(){var e;do{e="@@WeakMap@@"+c()}while(u.has(t,e));return t[e]=!0,e}function o(e,t){if(!n.call(e,r)){if(!t)return;Object.defineProperty(e,r,{value:u.create()})}return e[r]}function s(e,t){for(var n=0;n<t;++n)e[n]=255*Math.random()|0;return e}function a(e){if("function"==typeof Uint8Array){var t=new Uint8Array(e);return"undefined"!=typeof crypto?crypto.getRandomValues(t):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(t):s(t,e),t}return s(new Array(e),e)}function c(){var t=a(e);t[6]=79&t[6]|64,t[8]=191&t[8]|128;for(var n="",r=0;r<e;++r){var i=t[r];4!==r&&6!==r&&8!==r||(n+="-"),i<16&&(n+="0"),n+=i.toString(16).toLowerCase()}return n}}function de(e){return e.__=void 0,delete e.__,e}e("decorate",v),e("metadata",E),e("defineMetadata",S),e("hasMetadata",_),e("hasOwnMetadata",y),e("getMetadata",b),e("getOwnMetadata",T),e("getMetadataKeys",C),e("getOwnMetadataKeys",I),e("deleteMetadata",R)}(r,t),void 0===t.Reflect&&(t.Reflect=e)}()}(r||(r={}))}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var o=t[r]={id:r,loaded:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e);var r={};return(()=>{"use strict";n.r(r),n.d(r,{BASIC_FULL_HD_LANDSCAPE:()=>ut,BASIC_FULL_HD_PORTRAIT:()=>lt,BASIC_LANDSCAPE:()=>at,BASIC_PORTRAIT:()=>ct,BroadcastClientError:()=>BroadcastClientError,BroadcastClientEvents:()=>xt,ConnectionState:()=>Gt,Errors:()=>s,InitialLayerPreference:()=>un,JitterBufferMinDelay:()=>fn,LOG_LEVEL:()=>le,LocalStageStream:()=>LocalStageStream,LocalStageStreamEvents:()=>na,LogLevels:()=>le,RemoteStageStream:()=>RemoteStageStream,RemoteStageStreamEvents:()=>ea,SIMULCAST_DUPLICATE_LAYERS_CONFIGURED:()=>Io,SIMULCAST_LAYER_CONFIGURATION_CONFLICT:()=>Do,SIMULCAST_LAYER_INPUT_FRAMERATE_INSUFFICIENT:()=>Mo,SIMULCAST_LAYER_INPUT_RESOLUTION_INSUFFICIENT:()=>Lo,SIMULCAST_LAYER_INVALID_TYPE:()=>To,SIMULCAST_LAYER_ORIENTATION_MISMATCH:()=>No,SIMULCAST_MAX_LAYERS_EXCEEDED:()=>Co,SIMULCAST_MAX_LAYER_BITRATE_EXCEEDED:()=>Ro,SIMULCAST_MAX_LAYER_DIMENSIONS_EXCEEDED:()=>ko,SIMULCAST_MAX_LAYER_FRAMERATE_EXCEEDED:()=>wo,SIMULCAST_MIN_LAYER_BITRATE_EXCEEDED:()=>Oo,SIMULCAST_MIN_LAYER_DIMENSIONS_EXCEEDED:()=>Po,SIMULCAST_MIN_LAYER_FRAMERATE_EXCEEDED:()=>Ao,SIMULCAST_UNSUPPORTED:()=>bo,STAGE_MAX_AUDIO_BITRATE_KBPS:()=>Gi,STAGE_MAX_AUDIO_BITRATE_KBPS_DEFAULT:()=>Hi,STAGE_MAX_BITRATE:()=>Li,STAGE_MAX_FRAMERATE:()=>xi,STAGE_MAX_RESOLUTION:()=>Ui,STAGE_MIN_AUDIO_BITRATE_KBPS:()=>Vi,STAGE_MIN_BITRATE:()=>Ni,STAGE_MIN_FRAMERATE:()=>Mi,STAGE_MIN_RESOLUTION:()=>Bi,STANDARD_LANDSCAPE:()=>dt,STANDARD_PORTRAIT:()=>ht,SimulcastLayerPresets:()=>Ai,Stage:()=>Stage,StageConnectionState:()=>ds,StageErrorCategory:()=>Hs,StageErrorCode:()=>Ws,StageEvents:()=>Ca,StageLeftReason:()=>wa,StageParticipantPublishState:()=>oa,StageParticipantSubscribeState:()=>sa,StageStream:()=>StageStream,StageStreamLayerSelectedReason:()=>ta,StreamType:()=>qn,SubscribeType:()=>Fs,__version:()=>gr,create:()=>fr,default:()=>Aa,isSupported:()=>ue});var e={};n.r(e),n.d(e,{fixNegotiationNeeded:()=>P,shimAddTrackRemoveTrack:()=>A,shimAddTrackRemoveTrackWithNative:()=>w,shimGetDisplayMedia:()=>b,shimGetSendersWithDtmf:()=>I,shimGetStats:()=>R,shimGetUserMedia:()=>y,shimMediaStream:()=>T,shimOnTrack:()=>C,shimPeerConnection:()=>k,shimSenderReceiverGetStats:()=>O});var t={};n.r(t),n.d(t,{shimAddTransceiver:()=>F,shimCreateAnswer:()=>H,shimCreateOffer:()=>G,shimGetDisplayMedia:()=>N,shimGetParameters:()=>V,shimGetUserMedia:()=>D,shimOnTrack:()=>L,shimPeerConnection:()=>M,shimRTCDataChannel:()=>j,shimReceiverGetStats:()=>B,shimRemoveStream:()=>U,shimSenderGetStats:()=>x});var i={};n.r(i),n.d(i,{shimAudioContext:()=>X,shimCallbacksAPI:()=>q,shimConstraints:()=>K,shimCreateOfferLegacy:()=>Q,shimGetUserMedia:()=>z,shimLocalStreamsAPI:()=>W,shimRTCIceServerUrls:()=>J,shimRemoteStreamsAPI:()=>$,shimTrackEventTransceiver:()=>Y});var o={};n.r(o),n.d(o,{removeExtmapAllowMixed:()=>se,shimAddIceCandidateNullOrEmpty:()=>ae,shimConnectionState:()=>oe,shimMaxMessageSize:()=>re,shimParameterlessSetLocalDescription:()=>ce,shimRTCIceCandidate:()=>te,shimRTCIceCandidateRelayProtocol:()=>ne,shimSendThrowTypeError:()=>ie});var s={};n.r(s),n.d(s,{ADD_DEVICE_COMPOSITION_INDEX_MISSING_ERROR:()=>ye,ADD_DEVICE_COMPOSITION_MISSING_ERROR:()=>_e,ADD_DEVICE_CONSTRAINTS_ERROR:()=>Ce,ADD_DEVICE_DEVICE_ERROR:()=>Ee,ADD_DEVICE_NAME_EXISTS_ERROR:()=>Se,ADD_DEVICE_NAME_MISSING_ERROR:()=>be,ADD_DEVICE_UNSUPPORTED:()=>Te,BROADCAST_CONFIGURATION_ERROR:()=>Me,BROADCAST_ERROR:()=>ge,CAMERA_ERROR:()=>me,CLIENT_INVALID_ERROR:()=>Ve,EXCHANGE_POSITION_DEVICE_NOT_FOUND_ERROR:()=>ke,FAILED_TO_ADD_IMAGE_ERROR:()=>Pe,INGEST_ENDPOINT_TYPE_ERROR:()=>Be,INGEST_ENDPOINT_URL_ERROR:()=>Ue,INPUT_ERROR:()=>ve,INVALID_STREAM_KEY:()=>Le,LOGGER_TYPE_ERROR:()=>Fe,LOG_LEVEL_TYPE_ERROR:()=>je,NETWORK_RECONNECT_CONFIGURATION_ERROR:()=>Ge,NETWORK_RECONNECT_CONFIGURATION_INVALID_TIMEOUT_ERROR:()=>He,PEER_CONNECTION_ERROR:()=>Ne,PEER_SETUP_ERROR:()=>De,REMOVE_DEVICE_NOT_FOUND_ERROR:()=>Ie,REMOVE_IMAGE_NOT_FOUND_ERROR:()=>Re,STAGE_TOKEN_TYPE_ERROR:()=>$e,STAGE_WHIP_OVERRIDE_ERROR:()=>qe,STREAM_CONFIGURATION_ERROR:()=>xe,STREAM_KEY_INVALID_CHAR_ERROR:()=>We,UPDATE_VIDEO_DEVICE_COMPOSITION_INDEX_MISSING_ERROR:()=>we,UPDATE_VIDEO_DEVICE_COMPOSITION_MISSING_ERROR:()=>Oe,UPDATE_VIDEO_DEVICE_COMPOSITION_NAME_NOT_FOUND_ERROR:()=>Ae});var a={};n.r(a),n.d(a,{BASIC_FULL_HD_LANDSCAPE:()=>ut,BASIC_FULL_HD_PORTRAIT:()=>lt,BASIC_LANDSCAPE:()=>at,BASIC_PORTRAIT:()=>ct,BroadcastClientError:()=>BroadcastClientError,BroadcastClientEvents:()=>xt,ConnectionState:()=>Gt,Errors:()=>s,LOG_LEVEL:()=>le,LogLevels:()=>le,STANDARD_LANDSCAPE:()=>dt,STANDARD_PORTRAIT:()=>ht,__version:()=>gr,create:()=>fr,isSupported:()=>ue});let c=!0,u=!0;function l(e,t,n){const r=e.match(t);return r&&r.length>=n&&parseInt(r[n],10)}function d(e,t,n){if(!e.RTCPeerConnection)return;const r=e.RTCPeerConnection.prototype,i=r.addEventListener;r.addEventListener=function(e,r){if(e!==t)return i.apply(this,arguments);const o=e=>{const t=n(e);t&&(r.handleEvent?r.handleEvent(t):r(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(r,o),i.apply(this,[e,o])};const o=r.removeEventListener;r.removeEventListener=function(e,n){if(e!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(n))return o.apply(this,arguments);const r=this._eventMap[t].get(n);return this._eventMap[t].delete(n),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,o.apply(this,[e,r])},Object.defineProperty(r,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function h(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(c=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function p(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(u=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function f(){if("object"==typeof window){if(c)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function g(e,t){u&&console.warn(e+" is deprecated, please use "+t+" instead.")}function m(e){return"[object Object]"===Object.prototype.toString.call(e)}function v(e){return m(e)?Object.keys(e).reduce((function(t,n){const r=m(e[n]),i=r?v(e[n]):e[n],o=r&&!Object.keys(i).length;return void 0===i||o?t:Object.assign(t,{[n]:i})}),{}):e}function E(e,t,n){t&&!n.has(t.id)&&(n.set(t.id,t),Object.keys(t).forEach((r=>{r.endsWith("Id")?E(e,e.get(t[r]),n):r.endsWith("Ids")&&t[r].forEach((t=>{E(e,e.get(t),n)}))})))}function S(e,t,n){const r=n?"outbound-rtp":"inbound-rtp",i=new Map;if(null===t)return i;const o=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&o.push(e)})),o.forEach((t=>{e.forEach((n=>{n.type===r&&n.trackId===t.id&&E(e,n,i)}))})),i}const _=f;function y(e,t){const n=e&&e.navigator;if(!n.mediaDevices)return;const r=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((n=>{if("require"===n||"advanced"===n||"mediaSource"===n)return;const r="object"==typeof e[n]?e[n]:{ideal:e[n]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);const i=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==r.ideal){t.optional=t.optional||[];let e={};"number"==typeof r.ideal?(e[i("min",n)]=r.ideal,t.optional.push(e),e={},e[i("max",n)]=r.ideal,t.optional.push(e)):(e[i("",n)]=r.ideal,t.optional.push(e))}void 0!==r.exact&&"number"!=typeof r.exact?(t.mandatory=t.mandatory||{},t.mandatory[i("",n)]=r.exact):["min","max"].forEach((e=>{void 0!==r[e]&&(t.mandatory=t.mandatory||{},t.mandatory[i(e,n)]=r[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},i=function(e,i){if(t.version>=61)return i(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=r(e.audio)}if(e&&"object"==typeof e.video){let o=e.video.facingMode;o=o&&("object"==typeof o?o:{ideal:o});const s=t.version<66;if(o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||s)){let t;if(delete e.video.facingMode,"environment"===o.exact||"environment"===o.ideal?t=["back","rear"]:"user"!==o.exact&&"user"!==o.ideal||(t=["front"]),t)return n.mediaDevices.enumerateDevices().then((n=>{let s=(n=n.filter((e=>"videoinput"===e.kind))).find((e=>t.some((t=>e.label.toLowerCase().includes(t)))));return!s&&n.length&&t.includes("back")&&(s=n[n.length-1]),s&&(e.video.deviceId=o.exact?{exact:s.deviceId}:{ideal:s.deviceId}),e.video=r(e.video),_("chrome: "+JSON.stringify(e)),i(e)}))}e.video=r(e.video)}return _("chrome: "+JSON.stringify(e)),i(e)},o=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(n.getUserMedia=function(e,t,r){i(e,(e=>{n.webkitGetUserMedia(e,t,(e=>{r&&r(o(e))}))}))}.bind(n),n.mediaDevices.getUserMedia){const e=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(t){return i(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(o(e))))))}}}function b(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(n){return t(n).then((t=>{const r=n.video&&n.video.width,i=n.video&&n.video.height,o=n.video&&n.video.frameRate;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:o||3}},r&&(n.video.mandatory.maxWidth=r),i&&(n.video.mandatory.maxHeight=i),e.navigator.mediaDevices.getUserMedia(n)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}function T(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function C(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(n=>{let r;r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===n.track.id)):{track:n.track};const i=new Event("track");i.track=n.track,i.receiver=r,i.transceiver={receiver:r},i.streams=[t.stream],this.dispatchEvent(i)})),t.stream.getTracks().forEach((n=>{let r;r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===n.id)):{track:n};const i=new Event("track");i.track=n,i.receiver=r,i.transceiver={receiver:r},i.streams=[t.stream],this.dispatchEvent(i)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else d(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function I(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const n=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){let i=n.apply(this,arguments);return i||(i=t(this,e),this._senders.push(i)),i};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){r.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],r.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function R(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,n,r]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const i=function(e){const t={};return e.result().forEach((e=>{const n={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{n[t]=e.stat(t)})),t[n.id]=n})),t},o=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};if(arguments.length>=2){const r=function(e){n(o(i(e)))};return t.apply(this,[r,e])}return new Promise(((e,n)=>{t.apply(this,[function(t){e(o(i(t)))},n])})).then(n,r)}}function O(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>S(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),d(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>S(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,n,r;return this.getSenders().forEach((n=>{n.track===e&&(t?r=!0:t=n)})),this.getReceivers().forEach((t=>(t.track===e&&(n?r=!0:n=t),t.track===e))),r||t&&n?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():n?n.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function w(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){if(!n)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const r=t.apply(this,arguments);return this._shimmedLocalStreams[n.id]?-1===this._shimmedLocalStreams[n.id].indexOf(r)&&this._shimmedLocalStreams[n.id].push(r):this._shimmedLocalStreams[n.id]=[n,r],r};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();n.apply(this,arguments);const r=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(r)};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],r.apply(this,arguments)};const i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const n=this._shimmedLocalStreams[t].indexOf(e);-1!==n&&this._shimmedLocalStreams[t].splice(n,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),i.apply(this,arguments)}}function A(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return w(e);const n=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=n.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const n=new e.MediaStream(t.getTracks());this._streams[t.id]=n,this._reverseStreams[n.id]=t,t=n}r.apply(this,[t])};const i=e.RTCPeerConnection.prototype.removeStream;function o(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const r=e._reverseStreams[t],i=e._streams[r.id];n=n.replace(new RegExp(i.id,"g"),r.id)})),new RTCSessionDescription({type:t.type,sdp:n})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},i.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,n){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const r=[].slice.call(arguments,1);if(1!==r.length||!r[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find((e=>e.track===t)))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const i=this._streams[n.id];if(i)i.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const r=new e.MediaStream([t]);this._streams[n.id]=r,this._reverseStreams[r.id]=n,this.addStream(r)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],r={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?n.apply(this,[t=>{const n=o(this,t);e[0].apply(null,[n])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):n.apply(this,arguments).then((e=>o(this,e)))}};e.RTCPeerConnection.prototype[t]=r[t]}));const s=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const r=e._reverseStreams[t],i=e._streams[r.id];n=n.replace(new RegExp(r.id,"g"),i.id)})),new RTCSessionDescription({type:t.type,sdp:n})}(this,arguments[0]),s.apply(this,arguments)):s.apply(this,arguments)};const a=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=a.get.apply(this);return""===e.type?e:o(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((n=>{this._streams[n].getTracks().find((t=>e.track===t))&&(t=this._streams[n])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function k(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=r[t]}))}function P(e,t){d(e,"negotiationneeded",(e=>{const n=e.target;if(!(t.version<72||n.getConfiguration&&"plan-b"===n.getConfiguration().sdpSemantics)||"stable"===n.signalingState)return e}))}function D(e,t){const n=e&&e.navigator,r=e&&e.MediaStreamTrack;if(n.getUserMedia=function(e,t,r){g("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(e).then(t,r)},!(t.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const e=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])},t=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(n){return"object"==typeof n&&"object"==typeof n.audio&&(n=JSON.parse(JSON.stringify(n)),e(n.audio,"autoGainControl","mozAutoGainControl"),e(n.audio,"noiseSuppression","mozNoiseSuppression")),t(n)},r&&r.prototype.getSettings){const t=r.prototype.getSettings;r.prototype.getSettings=function(){const n=t.apply(this,arguments);return e(n,"mozAutoGainControl","autoGainControl"),e(n,"mozNoiseSuppression","noiseSuppression"),n}}if(r&&r.prototype.applyConstraints){const t=r.prototype.applyConstraints;r.prototype.applyConstraints=function(n){return"audio"===this.kind&&"object"==typeof n&&(n=JSON.parse(JSON.stringify(n)),e(n,"autoGainControl","mozAutoGainControl"),e(n,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[n])}}}}function N(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===n.video?n.video={mediaSource:t}:n.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(n)})}function L(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function M(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=r[t]}));const n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},r=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,o]=arguments;return r.apply(this,[e||null]).then((e=>{if(t.version<53&&!i)try{e.forEach((e=>{e.type=n[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach(((t,r)=>{e.set(r,Object.assign({},t,{type:n[t.type]||t.type}))}))}return e})).then(i,o)}}function x(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function B(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),d(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function U(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){g("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function j(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function F(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let e=arguments[1]&&arguments[1].sendEncodings;void 0===e&&(e=[]),e=[...e];const n=e.length>0;n&&e.forEach((e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const r=t.apply(this,arguments);if(n){const{sender:t}=r,n=t.getParameters();(!("encodings"in n)||1===n.encodings.length&&0===Object.keys(n.encodings[0]).length)&&(n.encodings=e,t.sendEncodings=e,this.setParametersPromises.push(t.setParameters(n).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return r})}function V(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function G(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function H(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function W(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((n=>t.call(this,n,e))),e.getVideoTracks().forEach((n=>t.call(this,n,e)))},e.RTCPeerConnection.prototype.addTrack=function(e,...n){return n&&n.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const n=e.getTracks();this.getSenders().forEach((e=>{n.includes(e.track)&&this.removeTrack(e)}))})}}function $(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const n=new Event("addstream");n.stream=t,e.dispatchEvent(n)}))}),t.apply(e,arguments)}}}function q(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,n=t.createOffer,r=t.createAnswer,i=t.setLocalDescription,o=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(e,t){const r=arguments.length>=2?arguments[2]:arguments[0],i=n.apply(this,[r]);return t?(i.then(e,t),Promise.resolve()):i},t.createAnswer=function(e,t){const n=arguments.length>=2?arguments[2]:arguments[0],i=r.apply(this,[n]);return t?(i.then(e,t),Promise.resolve()):i};let a=function(e,t,n){const r=i.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r};t.setLocalDescription=a,a=function(e,t,n){const r=o.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r},t.setRemoteDescription=a,a=function(e,t,n){const r=s.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r},t.addIceCandidate=a}function z(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,n=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>n(K(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,n,r){t.mediaDevices.getUserMedia(e).then(n,r)}.bind(t))}function K(e){return e&&void 0!==e.video?Object.assign({},e,{video:v(e.video)}):e}function J(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,n){if(e&&e.iceServers){const t=[];for(let n=0;n<e.iceServers.length;n++){let r=e.iceServers[n];void 0===r.urls&&r.url?(g("RTCIceServer.url","RTCIceServer.urls"),r=JSON.parse(JSON.stringify(r)),r.urls=r.url,delete r.url,t.push(r)):t.push(e.iceServers[n])}e.iceServers=t}return new t(e,n)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function Y(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Q(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const n=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&n?"sendrecv"===n.direction?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":"recvonly"===n.direction&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):!0!==e.offerToReceiveVideo||n||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function X(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var Z=n(7963),ee=n.n(Z);function te(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substring(2)),e.candidate&&e.candidate.length){const n=new t(e),r=ee().parseCandidate(e.candidate);for(const e in r)e in n||Object.defineProperty(n,e,{value:r[e]});return n.toJSON=function(){return{candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex,usernameFragment:n.usernameFragment}},n}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,d(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function ne(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||d(e,"icecandidate",(e=>{if(e.candidate){const t=ee().parseCandidate(e.candidate.candidate);"relay"===t.type&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e}))}function re(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(function(e){if(!e||!e.sdp)return!1;const t=ee().splitSections(e.sdp);return t.shift(),t.some((e=>{const t=ee().parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))}(arguments[0])){const e=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const n=parseInt(t[1],10);return n!=n?-1:n}(arguments[0]),n=function(e){let n=65536;return"firefox"===t.browser&&(n=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),n}(e),r=function(e,n){let r=65536;"firefox"===t.browser&&57===t.version&&(r=65535);const i=ee().matchPrefix(e.sdp,"a=max-message-size:");return i.length>0?r=parseInt(i[0].substring(19),10):"firefox"===t.browser&&-1!==n&&(r=2147483637),r}(arguments[0],e);let i;i=0===n&&0===r?Number.POSITIVE_INFINITY:0===n||0===r?Math.max(n,r):Math.min(n,r);const o={};Object.defineProperty(o,"maxMessageSize",{get:()=>i}),this._sctp=o}return n.apply(this,arguments)}}function ie(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const n=e.send;e.send=function(){const r=arguments[0],i=r.length||r.size||r.byteLength;if("open"===e.readyState&&t.sctp&&i>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return n.apply(e,arguments)}}const n=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=n.apply(this,arguments);return t(e,this),e},d(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function oe(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const n=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const n=new Event("connectionstatechange",e);t.dispatchEvent(n)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}}))}function se(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const n=t.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==e.trim())).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:n}):t.sdp=n}return n.apply(this,arguments)}}function ae(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const n=e.RTCPeerConnection.prototype.addIceCandidate;n&&0!==n.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function ce(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const n=e.RTCPeerConnection.prototype.setLocalDescription;n&&0!==n.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if("object"!=typeof e||e.type&&e.sdp)return n.apply(this,arguments);if(e={type:e.type,sdp:e.sdp},!e.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer"}if(e.sdp||"offer"!==e.type&&"answer"!==e.type)return n.apply(this,[e]);return("offer"===e.type?this.createOffer:this.createAnswer).apply(this).then((e=>n.apply(this,[e])))})}!function({window:n}={},r={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){const s=f,a=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator||!e.navigator.userAgent)return t.browser="Not a browser.",t;const{navigator:n}=e;if(n.mozGetUserMedia)t.browser="firefox",t.version=l(n.userAgent,/Firefox\/(\d+)\./,1);else if(n.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection)t.browser="chrome",t.version=l(n.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!e.RTCPeerConnection||!n.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=l(n.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}(n),c={browserDetails:a,commonShim:o,extractVersion:l,disableLog:h,disableWarnings:p,sdp:Z};switch(a.browser){case"chrome":if(!e||!k||!r.shimChrome)return s("Chrome shim is not included in this adapter release."),c;if(null===a.version)return s("Chrome shim can not determine version, not shimming."),c;s("adapter.js shimming chrome."),c.browserShim=e,ae(n,a),ce(n),y(n,a),T(n),k(n,a),C(n),A(n,a),I(n),R(n),O(n),P(n,a),te(n),ne(n),oe(n),re(n,a),ie(n),se(n,a);break;case"firefox":if(!t||!M||!r.shimFirefox)return s("Firefox shim is not included in this adapter release."),c;s("adapter.js shimming firefox."),c.browserShim=t,ae(n,a),ce(n),D(n,a),M(n,a),L(n),U(n),x(n),B(n),j(n),F(n),V(n),G(n),H(n),te(n),oe(n),re(n,a),ie(n);break;case"safari":if(!i||!r.shimSafari)return s("Safari shim is not included in this adapter release."),c;s("adapter.js shimming safari."),c.browserShim=i,ae(n,a),ce(n),J(n),Q(n),q(n),W(n),$(n),Y(n),z(n),X(n),te(n),ne(n),re(n,a),ie(n),se(n,a);break;default:s("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window});n(8630);const ue=()=>"function"==typeof RTCPeerConnection;var le,de;!function(e){e[e.TRACE=0]="TRACE",e[e.DEBUG=1]="DEBUG",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.SILENT=5]="SILENT"}(le||(le={})),function(e){e.TIME="Time",e.WEBRTC="WebRTC",e.EMITTER="Emitter",e.MEDIA="Media",e.SUBSCRIPTION="StageSubscription",e.PUBLICATION="StagePublication",e.CONNECTION="StageConnection",e.SOCKET="StageSocket",e.BROADCAST_STAGE_CLIENT="BroadcastStageClient",e.STAGE="Stage",e.REMOTE_PARTICIPANT="RemoteParticipant",e.LOCAL_PARTICIPANT="LocalParticipant",e.CONFIGURATION="Configuration",e.REMOTE_PLAYBACK="RemotePlaybackController",e.REMOTE_STAGE_STREAM="RemoteStageStream"}(de||(de={}));const he=12e4,pe=3e5,fe=(new Uint8Array([158,80,78,165,238,90,79,2,148,159,176,51,163,118,141,162]),"no-rid");class BroadcastClientError extends Error{constructor({name:e,message:t,code:n,details:r,cause:i,params:o}){super(t),Error.captureStackTrace&&Error.captureStackTrace(this,BroadcastClientError),this.name=e||"BroadcastClientError",this.message=t,this.code=n,this.details=r,this.cause=i,this.params=o}}const ge={name:"BroadcastError",code:1e3,message:"Unable to broadcast"},me={name:"CameraError",code:2e3,message:"Camera could not be captured"},ve={name:"InputError",code:3e3,message:"Input could not be attached"},Ee={name:"AddDeviceError",code:4e3,message:"Device is missing"},Se={name:"AddDeviceNameExistsError",code:4001,message:"Name is already registered"},_e={name:"AddDeviceCompositionMissingError",code:4002,message:"VideoComposition is missing"},ye={name:"AddDeviceCompositionIndexMissingError",code:4003,message:'VideoComposition\'s "index" property is missing'},be={name:"AddDeviceNameMissingError",code:4004,message:"Name property is missing"},Te={name:"AddDeviceUnsupported",code:4005,message:"Unsupported device"},Ce={name:"AddDeviceConstraintsError",code:4006,message:"Constraints error"},Ie={name:"RemoveDeviceNotFoundError",code:5e3,message:"Device not found"},Re={name:"RemoveImageNotFoundError",code:6e3,message:"Image not found"},Oe={name:"UpdateVideoDeviceCompositionMissingError",code:7e3,message:"VideoComposition is missing"},we={name:"UpdateVideoDeviceCompositionIndexMissingError",code:7001,message:'VideoComposition\'s "index" property is missing'},Ae={name:"UpdateVideoDeviceCompositionNameMissingError",code:7002,message:"Video device with that name is not found"},ke={name:"ExchangePositionDeviceNotFoundError",code:8e3,message:"Device with that name is not found"},Pe={name:"FailedToAddImageError",code:9e3,message:"Failed to add image"},De={name:"PeerSetupError",code:1e4,message:"Unexpected return value from setup request"},Ne={name:"PeerConnectionError",code:10001,message:"Peer connection has failed."},Le={name:"InvalidStreamKey",code:10003,message:"Invalid Stream Key."},Me={name:"BroadcastConfigurationError",code:11e3,message:"Error when configuring broadcast client"},xe={name:"StreamConfigurationError",code:12e3,message:"Error when configuring stream"},Be={name:"IngestEndpointTypeError",code:13e3,message:"Ingest endpoint must be a string"},Ue={name:"IngestEndpointUrlError",code:13001,message:"Ingest endpoint must be a valid https or rtmps URL"},je={name:"LogLevelTypeError",code:14e3,message:"Log Level must be a valid integer between [0..5]"},Fe={name:"LoggerTypeError",code:15e3,message:"Logger must be an object"},Ve={name:"ClientInvalidError",code:16e3,message:"Client is no longer valid, possibly due to delete() invocation."},Ge={name:"NetworkReconnectConfigurationError",code:17e3,message:"Error when configuring network reconnect"},He={name:"NetworkReconnectConfigurationInvalidTimeoutError",code:17001,message:"Network reconnect timeout value must be a number between [10000, 300000]"},We={name:"StreamKeyInvalidCharError",code:18e3,message:"Streamkey must contain only [A-Za-z0-9_-] characters"},$e={name:"StageTokenTypeError",code:19e3,message:"Stage token must be a string"},qe={name:"StageWhipUrlOverrideError",code:19001,message:"Stage WHIP override URL must be a string starting with http"};var ze,Ke,Je,Ye,Qe,Xe,Ze,et,tt,nt=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)},rt=function(e,t,n,r,i){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?i.call(e,n):i?i.value=n:t.set(e,n),n};const it=1920,ot=1080,st=le.ERROR,at={maxResolution:{width:852,height:480},maxFramerate:30,maxBitrate:1500},ct={maxResolution:{width:480,height:852},maxFramerate:30,maxBitrate:1500},ut={maxResolution:{width:1920,height:1080},maxFramerate:30,maxBitrate:3500},lt={maxResolution:{width:1080,height:1920},maxFramerate:30,maxBitrate:3500},dt={maxResolution:{width:1920,height:1080},maxFramerate:30,maxBitrate:8500},ht={maxResolution:{width:1080,height:1920},maxFramerate:30,maxBitrate:8500},pt={reconnect:!1,timeout:he};function ft(e){var t,n;if("string"!=typeof e&&void 0!==e)throw new BroadcastClientError(Be);if(e){if(e.startsWith("https"))return e;{const r=/(?<protocol>(rtmps|https):\/\/)?(?<id>.+)\.(?<environment>(?=\S*['-])([a-zA-Z'-]+))\.live-video\.net.*/.exec(e);if("rtmps"===(null===(t=null==r?void 0:r.groups)||void 0===t?void 0:t.protocol)&&console.warn("rtmps server url detected; please pass in the ingest endpoint (no rtmps:// protocol) instead"),null===(n=null==r?void 0:r.groups)||void 0===n?void 0:n.id)return`https://${r.groups.id}.webrtc.live-video.net:4443`;throw new BroadcastClientError(Ue)}}return""}class Config{constructor(e,t,n=at,r,i=pt){this.LOG_LEVEL=le,this.BASIC_LANDSCAPE=at,this.BASIC_PORTRAIT=ct,this.BASIC_FULL_HD_LANDSCAPE=ut,this.BASIC_FULL_HD_PORTRAIT=lt,this.STANDARD_LANDSCAPE=dt,this.STANDARD_PORTRAIT=ht,ze.set(this,void 0),Ke.set(this,void 0),Je.set(this,at),Ye.set(this,void 0),Qe.set(this,pt),Xe.set(this,(e=>{if(!e)throw new BroadcastClientError(Object.assign(Object.assign({},xe),{details:"missing stream configuration"}));if(!(e.maxBitrate<=8500&&e.maxBitrate>=200))throw new BroadcastClientError(Object.assign(Object.assign({},xe),{details:"maxBitrate must be between 200 and 8500"}));if(!(e.maxFramerate<=60&&e.maxFramerate>=10))throw new BroadcastClientError(Object.assign(Object.assign({},xe),{details:"maxFramerate must be between 10 and 60"}));const t=e.maxResolution.width,n=e.maxResolution.height;if(t>it||n>it||t<160||n<160||(t===it&&n>ot||n===it&&t>ot))throw new BroadcastClientError(Object.assign(Object.assign({},xe),{details:"maxResolution values must be between 1080x1920 or 1920x1080"}))})),Ze.set(this,(e=>{if(!e)return;const t=Number(e),n=Number.isInteger(t),r=t>=le.TRACE,i=t<=le.SILENT;if(!n||!r||!i)throw new BroadcastClientError(je)})),et.set(this,(e=>{if(e&&"object"!=typeof e)throw new BroadcastClientError(Fe)})),tt.set(this,(e=>{if(!e)return;if("object"!=typeof e||"boolean"!=typeof e.reconnect)throw new BroadcastClientError(Ge);const{timeout:t}=e;if(void 0!==t&&(Number.isNaN(t)||"number"!=typeof t||t<1e4||t>pe))throw new BroadcastClientError(He)})),nt(this,et,"f").call(this,r),nt(this,Ze,"f").call(this,t),nt(this,Xe,"f").call(this,n),rt(this,ze,e,"f"),rt(this,Ke,t,"f"),rt(this,Je,n,"f"),rt(this,Ye,r,"f"),rt(this,Qe,i,"f")}get ingestEndpoint(){return nt(this,ze,"f")}set ingestEndpoint(e){rt(this,ze,ft(e),"f")}get streamConfig(){return nt(this,Je,"f")}set streamConfig(e){nt(this,Xe,"f").call(this,e),rt(this,Je,e,"f")}get logLevel(){return nt(this,Ke,"f")}set logLevel(e){nt(this,Ze,"f").call(this,e),rt(this,Ke,e,"f")}get logger(){return nt(this,Ye,"f")}set logger(e){nt(this,et,"f").call(this,e),rt(this,Ye,e,"f")}get networkReconnectConfig(){return nt(this,Qe,"f")}set networkReconnectConfig(e){nt(this,tt,"f").call(this,e),rt(this,Qe,e,"f")}}ze=new WeakMap,Ke=new WeakMap,Je=new WeakMap,Ye=new WeakMap,Qe=new WeakMap,Xe=new WeakMap,Ze=new WeakMap,et=new WeakMap,tt=new WeakMap;var gt,mt=n(228);!function(e){e.PUBLISHED_VIDEO_STATS="ivs_broadcast_webrtc_published_video_stats",e.PUBLISHED_VIDEO_STATS_WINDOW="ivs_broadcast_webrtc_published_video_stats_window",e.PUBLISHED_AUDIO_STATS="ivs_broadcast_webrtc_published_audio_stats",e.PUBLISHED_AUDIO_STATS_WINDOW="ivs_broadcast_webrtc_published_audio_stats_window",e.SUBSCRIBED_VIDEO_STATS="ivs_broadcast_webrtc_subscribed_video_stats",e.SUBSCRIBED_VIDEO_STATS_WINDOW="ivs_broadcast_webrtc_sbcrbd_video_stats_window",e.SUBSCRIBED_AUDIO_STATS="ivs_broadcast_webrtc_subscribed_audio_stats",e.SUBSCRIBED_AUDIO_STATS_WINDOW="ivs_broadcast_webrtc_sbcrbd_audio_stats_window",e.PUBLISH="ivs_broadcast_multihost_publish",e.UNPUBLISH="ivs_broadcast_multihost_unpublish",e.SUBSCRIBE="ivs_broadcast_multihost_subscribe",e.UNSUBSCRIBE="ivs_broadcast_multihost_unsubscribe",e.PUBLISH_STARTED="ivs_broadcast_multihost_publish_started",e.PUBLISH_FAILED="ivs_broadcast_multihost_publish_failed",e.PUBLISH_ENDED="ivs_broadcast_multihost_publish_ended",e.STATE_UPDATED="ivs_broadcast_multihost_event_state_updated",e.SUBSCRIBE_STARTED="ivs_broadcast_multihost_subscribe_started",e.SUBSCRIBE_FAILED="ivs_broadcast_multihost_subscribe_failed",e.SUBSCRIBE_ENDED="ivs_broadcast_multihost_subscribe_ended",e.FIRST_FRAME="ivs_broadcast_multihost_first_frame",e.JOIN="ivs_broadcast_multihost_join",e.JOIN_ATTEMPT="ivs_broadcast_multihost_event_connect_attempt",e.JOIN_ATTEMPT_FAILED="ivs_broadcast_multihost_event_connect_failed",e.JOIN_ENDED="ivs_broadcast_multihost_join_ended",e.LEAVE="ivs_broadcast_multihost_leave",e.REASSIGNMENT_REQUEST="ivs_broadcast_multihost_reassignment_request",e.SERVER_REQUEST="ivs_broadcast_multihost_server_request",e.TRACE="ivs_broadcast_stage_trace",e.ERROR="ivs_broadcast_error",e.MINUTE="ivs_broadcast_multihost_minute",e.CONNECTION_STATE="ivs_broadcast_webrtc_connection_state",e.ICE_GATHERING_STATE="ivs_broadcast_webrtc_gathering_state",e.EDP_CONNECTED="ivs_broadcast_multihost_event_connected",e.EDP_DISCONNECTED="ivs_broadcast_multihost_event_disconnected",e.EDP_PONG="ivs_broadcast_multihost_edp_rtt",e.SIMULCAST_LAYER_INFO="ivs_broadcast_simulcast_layer_info",e.MULTIHOST_CONFIGURATION="ivs_broadcast_multihost_configuration",e.MULTIHOST_SUBSCRIBE_CONFIGURATION="ivs_broadcast_multihost_subscribe_configuration",e.PLAYBACK_LAYER_REQUEST="ivs_broadcast_multihost_playback_layer_request",e.PLAYBACK_LAYER_STATE="ivs_broadcast_multihost_playback_layer_state",e.SELECTED_PAIR_CHANGE="ivs_broadcast_webrtc_selected_pair_change",e.ANALYTICS_HEALTH_REPORT="ivs_broadcast_analytics_health_report",e.DEVCONF_ERROR="ivs_devconf_error",e.DEVCONF_OPS_METRICS="ivs_devconf_ops_metrics",e.DEVCONF_TRACE="ivs_devconf_trace",e.DEVCONF_VALUE="ivs_devconf_value"}(gt||(gt={}));class StageAnalyticsEvent{constructor(e,t,n,r){this.event=e,this.properties={client_time:(new Date).toISOString(),customer_id:t.customerId,device_software:window.navigator.userAgent,multihost_id:t.stageARN,participant_id:t.participantID,participant_user_id:t.userID,platform:"web",sdk_version:"1.30.0",stage_arn:t.stageARN,trace_id:n.value},t.attrGsRole&&(this.properties.token_attribute_0=t.attrGsRole),t.attrGsSessionId&&(this.properties.token_attribute_1=t.attrGsSessionId),this.critical=r}}class StageErrorEvent extends StageAnalyticsEvent{constructor(e){super(gt.ERROR,e.token,e.traceId,!0),Object.assign(this.properties,{code:e.code,tag:e.tag,description:e.message,remote_participant_id:e.remoteParticipantId,request_uuid:e.requestUUID,is_nominal:e.nominal,is_fatal:e.fatal,details:e.details,location:e.location,event_count:e.count})}}function vt(e){const t=window.IVS_CLIENT_OVERRIDES;return"object"==typeof t?t[e]:"logLevel"===e?window.STAGES_LOG_LEVEL:"appLabel"===e?window.IVS_APP_LABEL:"whipUrl"===e?window.IVS_DATA_PLANE_ENDPOINT:void 0}function Et(e){const t=vt(e);if("string"==typeof t)return t}function St(e){const t=vt(e);if("boolean"==typeof t)return t}function _t(e){const t=vt(e);if("number"==typeof t)return t;if("string"==typeof t){const e=parseFloat(t);if(!isNaN(e))return e}}function yt(){const e=vt("logLevel");if("number"==typeof e&&Object.values(le).includes(e))return e}function bt(){const e=Et("appLabel");if(void 0!==e)return e.substring(0,64)}function Tt(){return St("disableXdp")}function Ct(){return St("preferMainProfile")}function It(){return St("enableInitialLayerOnSdp")}function Rt(){return St("disableAudioRtcpRsize")}var Ot=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};function wt(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}function At(e,t=e=>{}){(()=>{Ot(this,void 0,void 0,(function*(){try{yield e()}catch(e){t(e)}}))})()}var kt=n(6880),Pt=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};function Dt(e,t,n={},r=""){return Pt(this,void 0,void 0,(function*(){const i=new XMLHttpRequest;return i.open(e,t,!0),n&&Object.keys(n).forEach((e=>{n.hasOwnProperty(e)&&i.setRequestHeader(e,n[e])})),new Promise(((n,o)=>{i.onreadystatechange=()=>{4===i.readyState&&(i.status>=200&&i.status<300?n(i.responseText):o(new Error(`Ingest ${e} ${t} responded ${i.status}\n${i.responseText}`)))},i.send(r)}))}))}function Nt(e){const t=Date.now();for(const n of e)n.properties.batch_time_millis=t;var n;return{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:`data=${n=JSON.stringify(e),btoa(encodeURIComponent(n).replace(/%([0-9A-F]{2})/g,((e,t)=>String.fromCharCode(Number(`0x${t}`)))))}`}}class EventSender{send(e,t=!1){return Pt(this,void 0,void 0,(function*(){const{currentEndpoint:n}=Ln,{headers:r,body:i}=Nt(e),o="eventSenderResult",s=e.length;if(t){const e=navigator.sendBeacon(n,i);Ln.trackEvent({type:o,success:e,count:s})}else At((()=>Pt(this,void 0,void 0,(function*(){yield Dt("POST",n,r,i),Ln.trackEvent({type:o,success:!0,count:s})}))),(()=>{Ln.trackEvent({type:o,success:!1,count:s})}))}))}}var Lt=n(2505),Mt=n.n(Lt);const xt={CONNECTION_STATE_CHANGE:"connectionStateChange",ERROR:"clientError",ACTIVE_STATE_CHANGE:"activeStateChange"},Bt="connectionStateChange",Ut="sdpNegotiated",jt="clientError",Ft="seiMessageReceived",Vt="transformError";var Gt;!function(e){e.CLOSED="closed",e.COMPLETED="completed",e.CONNECTED="connected",e.CONNECTING="connecting",e.DISCONNECTED="disconnected",e.FAILED="failed",e.IDLE="idle",e.NEW="new",e.NONE="none"}(Gt||(Gt={}));var Ht=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};function Wt(e,t){return Ht(this,void 0,void 0,(function*(){e.validateStatus=e=>e>=200&&e<300||403===e;const n=yield Mt()(e);if(403===n.status){if(2003===n.data.code)throw new Lt.AxiosError("Request failed with status code 403","ERR_BAD_REQUEST",e,n.request,n);return e.url===n.request.responseURL?(e.validateStatus=e=>e>=200&&e<300,Mt()(e)):(e.url=n.request.responseURL,t<5?Wt(e,t+1):(e.validateStatus=e=>e>=200&&e<300,Mt()(e)))}return n}))}function $t(e){return Ht(this,void 0,void 0,(function*(){return Wt(e,0)}))}function qt(){}function zt(e){switch(e){case"new":return Gt.NEW;case"closed":return Gt.CLOSED;case"disconnected":return Gt.DISCONNECTED;case"failed":return Gt.FAILED;case"idle":return Gt.IDLE;case"checking":case"connecting":return Gt.CONNECTING;case"completed":case"connected":return Gt.CONNECTED;default:throw new Error(`unknown connecion state: ${e}`)}}function Kt(e,t,n){let r=document.createElement(t);const i=()=>{r&&(r.removeEventListener("loadeddata",o),r.removeEventListener("error",i),r.srcObject=null,r.src="",r=null)},o=()=>{i(),n(t)};return r.addEventListener("loadeddata",o),r.addEventListener("error",i),r.srcObject=e,i}class TypedEmitter{constructor(){this.emitter=new mt}hasListenersFor(e){return this.emitter.listenerCount(e)>0}on(e,t,n){t.call=function(e,t){return function(n,...r){try{t.apply(n,r)}catch(n){let r=`Error in callback for ${e}`;const i=t.name;return i&&(r+=` for function ${i}`),void console.error(`${r}\n`,n)}}}(e,t),this.emitter.on(e,t,n)}off(e,t,n){this.emitter.off(e,t,n)}emit(e,...t){this.emitter.emit(e,...t)}removeAllListeners(){this.emitter.removeAllListeners()}}const Jt="https://broadcast.stats.live-video.net/";class AnalyticsHealthReport{constructor({totalEvents:e,totalEventsLost:t,windowedEvents:n,windowedEventsLost:r,currentEndpoint:i}){this.transformProperties=(e,t,n,r,i)=>({total_events:e,total_events_lost:t,windowed_events:n,windowed_events_lost:r,current_endpoint:null!=i?i:Jt});const o=this.transformProperties(e,t,n,r,i);this.data={event:gt.ANALYTICS_HEALTH_REPORT,properties:Object.assign({},o)}}}const Yt={totalEvents:0,totalEventsSent:0,totalEventsLost:0,windowedEvents:0,windowedEventsSent:0,windowedEventsLost:0};var Qt,Xt;!function(e){e.ANALYTICS_EVENT="ANALYTICS_EVENT"}(Qt||(Qt={}));class HealthReporter extends TypedEmitter{constructor(){super(),this.eventSenderMetrics=Object.assign({},Yt),this.scheduleHealthReport=()=>{this.reportTimer=window.setTimeout(this.onHealthReportInterval,6e4)},this.onHealthReportInterval=()=>{const e=Object.assign({},this.eventSenderMetrics);if(0===this.eventSenderMetrics.windowedEvents?this.emptyWindows++:this.emptyWindows=0,this.emptyWindows>3)return window.clearTimeout(this.reportTimer),void(this.reportTimer=void 0);this.postHealthReport(e),this.eventSenderMetrics.windowedEvents=0,this.eventSenderMetrics.windowedEventsSent=0,this.eventSenderMetrics.windowedEventsLost=0,this.scheduleHealthReport()},this.emptyWindows=0}trackEventSendResult(e){const{count:t,success:n}=e;this.eventSenderMetrics.totalEvents+=t,this.eventSenderMetrics.windowedEvents+=t,n?(this.eventSenderMetrics.totalEventsSent+=t,this.eventSenderMetrics.windowedEventsSent+=t):(this.eventSenderMetrics.totalEventsLost+=t,this.eventSenderMetrics.windowedEventsLost+=t),this.isHealthReportScheduled()||this.scheduleHealthReport()}isHealthReportScheduled(){return"number"==typeof this.reportTimer}postHealthReport(e){const t=new AnalyticsHealthReport(e);this.emit(Qt.ANALYTICS_EVENT,t)}}!function(e){e[e.EXCELLENT=4]="EXCELLENT",e[e.GOOD=3]="GOOD",e[e.NORMAL=2]="NORMAL",e[e.POOR=1]="POOR",e[e.DOWN=0]="DOWN"}(Xt||(Xt={}));var Zt,en,tn,nn;!function(e){e.NETWORK_QUALITY_CHANGE="networkQualityChange"}(Zt||(Zt={}));class NetworkQualityMonitor extends TypedEmitter{constructor(){super(),this.lastNetworkStatus={},this.networkAssessment={networkQuality:Xt.NORMAL,reason:"no-data"},this.checkNetworkStatus=()=>{var e,t;const n=null!==(e=null===navigator||void 0===navigator?void 0:navigator.connection)&&void 0!==e?e:{},r={downlink:n.downlink,effectiveType:n.effectiveType,rtt:n.rtt,isOnline:null===(t=navigator.onLine)||void 0===t||t};if(!this.isChangedNetworkStatus(this.lastNetworkStatus,r))return;this.lastNetworkStatus=r;const i=this.networkAssessment,o=function(e){const{rtt:t,downlink:n,isOnline:r}=e;if(!r)return{networkQuality:Xt.DOWN,reason:"offline"};if("number"!=typeof t||"number"!=typeof n)return{networkQuality:Xt.NORMAL,reason:"no-data"};let i=0;t>800?i+=2:t>300&&(i+=1),n<2.5?i+=2:n<5&&(i+=1);const o="score";switch(i){case 4:return{networkQuality:Xt.POOR,reason:o};case 0:return{networkQuality:Xt.EXCELLENT,reason:o};default:return{networkQuality:i<=2?Xt.GOOD:Xt.NORMAL,reason:o}}}(r);i.networkQuality!==o.networkQuality&&this.emit(Zt.NETWORK_QUALITY_CHANGE,i.networkQuality,o.networkQuality),this.networkAssessment=o},this.getNetworkQuality=()=>this.networkAssessment.networkQuality,this.setupWindowListeners(),this.checkNetworkStatus()}setupWindowListeners(){window.addEventListener("online",(()=>{this.checkNetworkStatus()})),window.addEventListener("offline",(()=>{this.checkNetworkStatus()})),window.navigator.connection&&window.navigator.connection.addEventListener("change",(()=>{this.checkNetworkStatus()}))}isChangedNetworkStatus(e,t){const{downlink:n,effectiveType:r,rtt:i,isOnline:o}=t;return e.effectiveType!==r||e.downlink!==n||e.rtt!==i||e.isOnline!==o}}!function(e){e.ANALYTICS_EVENT="ANALYTICS_EVENT",e.REFRESH="REFRESH"}(en||(en={})),function(e){e.IDLE="idle",e.ACTIVATING="activating",e.ACTIVE="active",e.REFRESHING="refreshing",e.PAUSED="paused",e.DESTROYED="destroyed"}(tn||(tn={})),function(e){e.INITIALIZE="initialize",e.REFRESH="refresh",e.ACTIVATE="activate",e.PAUSE="pause",e.DESTROY="destroy"}(nn||(nn={}));const rn={[nn.INITIALIZE]:{from:[tn.IDLE],to:tn.ACTIVATING},[nn.REFRESH]:{from:[tn.ACTIVATING,tn.ACTIVE,tn.PAUSED],to:tn.REFRESHING},[nn.ACTIVATE]:{from:[tn.ACTIVATING,tn.REFRESHING,tn.PAUSED],to:tn.ACTIVE},[nn.PAUSE]:{from:[tn.REFRESHING,tn.ACTIVE],to:tn.PAUSED},[nn.DESTROY]:{from:[tn.ACTIVE,tn.PAUSED],to:tn.DESTROYED}};var on,sn;!function(e){e.STAGE_CONFIGURATION="stage_configuration",e.STAGE_SUBSCRIBE_CONFIGURATION="stage_subscribe_configuration",e.STAGE_LOCAL_STREAM_CONFIGURATION="stage_local_stream_configuration",e.BROADCAST_CONFIGURATION="broadcast_configuration"}(on||(on={})),function(e){e.RT="real_time",e.LL="low_latency"}(sn||(sn={}));var an,cn,un,ln=n(8954);class CongestionTimeEvent{constructor(e,t){this.transformProperties=(e,t)=>({sum:e.sum,median:e.median(),min:e.min,max:e.max,p90:e.percentile(.9),event_count:e.data.length,period:t});const n=this.transformProperties(e,t);this.data={event:an.CONGESTION_TIME,properties:n}}}class ConnectionEstablishedEvent{constructor(e,t,n){this.transformProperties=(e,t,n)=>({duration:(e.getTime()-((null==t?void 0:t.getTime())||0))/1e3,ecn_negotiated:!1,ingest_session_id:n});const r=this.transformProperties(e,t,n);this.data={event:an.CONNECTION_ESTABLISHED,properties:r}}}class ConnectionRTTEvent{constructor(e,t){this.transformProperties=(e,t)=>({sum:e.sum,median:e.median(),min:e.min,max:e.max,p90:e.percentile(.9),event_count:e.data.length,period:t});const n=this.transformProperties(e,t);this.data={event:an.CONNECTION_RTT,properties:n}}}class DevConfErrorEvent{constructor(e){this.transformProperties=()=>({}),this.data={event:gt.DEVCONF_ERROR,properties:e}}}class DevConfOpsMetricsEvent{constructor(e){this.transformProperties=()=>({}),this.data={event:gt.DEVCONF_OPS_METRICS,properties:e}}}class DevConfTraceEvent{constructor(e){this.transformProperties=()=>({}),this.data={event:gt.DEVCONF_TRACE,properties:e}}}class DevConfValueEvent{constructor(e){this.transformProperties=()=>({}),this.data={event:gt.DEVCONF_VALUE,properties:e}}}class ErrorEvent{constructor(e){this.transformProperties=e=>{var t;return{is_fatal:null!==(t=e.isFatal)&&void 0!==t&&t,value:e.value,code:e.code,description:e.description}};const t=this.transformProperties(e);this.data={event:an.ERROR,properties:t}}}class InputDeviceAttachedEvent{constructor(e,t){this.transformProperties=(e,t)=>({type:e,input_device_id:t.deviceId,position:t.facingMode||"unknown"});const n=this.transformProperties(e,t);this.data={event:an.INPUT_DEVICE_ATTACHED,properties:n}}}class InputDeviceDetachedEvent{constructor(e,t){this.transformProperties=(e,t)=>({type:e,input_device_id:t.deviceId,position:t.facingMode||"unknown"});const n=this.transformProperties(e,t);this.data={event:an.INPUT_DEVICE_DETACHED,properties:n}}}class MeasuredBitrateEvent{constructor(e,t){this.transformProperties=(e,t)=>({sum:e.sum,median:e.median(),min:e.min,max:e.max,p90:e.percentile(.9),event_count:e.data.length,period:t});const n=this.transformProperties(e,t);this.data={event:an.MEASURED_BITRATE,properties:n}}}class MinuteBroadcastEvent{constructor(e,t){this.transformProperties=(e,t)=>({minutes_logged:Math.round((e.timestamp-t)/6e4)});const n=this.transformProperties(e,t);this.data={event:an.MINUTE_BROADCAST,properties:n}}}class RecommendedBitrateEvent{constructor(e,t){this.transformProperties=(e,t)=>({sum:e.sum,median:e.median(),min:e.min,max:e.max,p90:e.percentile(.9),event_count:e.data.length,period:t});const n=this.transformProperties(e,t);this.data={event:an.RECOMMENDED_BITRATE,properties:n}}}class SessionAudioEncoderConfiguredEvent{constructor(e){this.transformProperties=e=>({codec:e.mimeType,bitrate:0,sample_rate:e.clockRate,channel_count:e.channels});const t=this.transformProperties(e);this.data={event:an.SESSION_AUDIO_ENCODER_CONFIGURED,properties:t}}}class SessionAudioPropertiesEvent{constructor(e){this.transformProperties=e=>({codec:"audio",bitrate:32e3,sample_rate:e.sampleRate,channel_count:e.channelCount});const t=this.transformProperties(e);this.data={event:an.SESSION_AUDIO_PROPERTIES,properties:t}}}class SessionVideoEncoderConfiguredEvent{constructor(e,t,n){this.transformProperties=(e,t,n)=>({codec:n.mimeType,codec_profile:t.profile,codec_level:t.level,rate_mode:"vbr",initial_bitrate:0,keyframe_interval:2,width:e.width,height:e.height,bframe_count:0,target_fps:e.frameRate});const r=this.transformProperties(e,t,n);this.data={event:an.SESSION_VIDEO_ENCODER_CONFIGURED,properties:r}}}class SessionVideoPropertiesEvent{constructor(e){this.transformProperties=e=>({codec:"video",initial_bitrate:32e3,min_bitrate:0,max_bitrate:0,keyframe_interval:2,width:e.width,height:e.height,auto_bitrate_enabled:!0,bframes_enabled:!1,target_fps:e.frameRate});const t=this.transformProperties(e);this.data={event:an.SESSION_VIDEO_PROPERTIES,properties:t}}}class SourceAudioLatencyEvent{constructor(e,t){this.transformProperties=(e,t)=>({sum:e.sum,median:e.median(),min:e.min,max:e.max,p90:e.percentile(.9),event_count:e.data.length,period:t});const n=this.transformProperties(e,t);this.data={event:an.SOURCE_AUDIO_LATENCY,properties:n}}}class SourceVideoLatencyEvent{constructor(e,t){this.transformProperties=(e,t)=>({sum:e.sum,median:e.median(),min:e.min,max:e.max,p90:e.percentile(.9),event_count:e.data.length,period:t});const n=this.transformProperties(e,t);this.data={event:an.SOURCE_VIDEO_LATENCY,properties:n}}}class StartBroadcastEvent{constructor(e,t){this.transformProperties=({protocol:e,hostname:t,port:n},r)=>({protocol:e,endpoint_host:t,endpoint_port:n,reason:r});const n=this.transformProperties(e,t);this.data={event:an.START_BROADCAST,properties:n}}}class StopBroadcastEvent{constructor(e){this.transformProperties=({protocol:e,hostname:t,port:n})=>({protocol:e,endpoint_host:t,endpoint_port:n});const t=this.transformProperties(e);this.data={event:an.STOP_BROADCAST,properties:t}}}class WebRTCAudioStatsEvent{constructor(e){this.transformProperties=e=>({bytes_sent:e.bytesSent,header_bytes_sent:e.headerBytesSent,nack_count:e.nackCount,packets_sent:e.packetsSent,retransmitted_bytes_sent:e.retransmittedBytesSent,retransmitted_packets_sent:e.retransmittedPacketsSent});const t=this.transformProperties(e);this.data={event:an.WEBRTC_AUDIO_STATS,properties:t}}}class WebRTCVideoStatsEvent{constructor(e){this.transformProperties=e=>({bytes_sent:e.bytesSent,fir_count:e.firCount,frames_encoded:e.framesEncoded,frames_sent:e.framesSent,header_bytes_sent:e.headerBytesSent,huge_frames_sent:e.hugeFramesSent,key_frames_encoded:e.keyFramesEncoded,nack_count:e.nackCount,packets_sent:e.packetsSent,pli_count:e.pliCount,quality_limitation_reason:e.qualityLimitationReason,quality_limitation_resolution_changes:e.qualityLimitationResolutionChanges,retransmitted_bytes_sent:e.retransmittedBytesSent,retransmitted_packets_sent:e.retransmittedPacketsSent,total_encode_time:e.totalEncodeTime,total_encoded_bytes_target:e.totalEncodedBytesTarget,total_packet_send_delay:e.totalPacketSendDelay});const t=this.transformProperties(e);this.data={event:an.WEBRTC_VIDEO_STATS,properties:t}}}!function(e){e.START_BROADCAST="ivs_broadcast_start_broadcast",e.STOP_BROADCAST="ivs_broadcast_stop_broadcast",e.MINUTE_BROADCAST="ivs_broadcast_minute_broadcast",e.WEBRTC_AUDIO_STATS="ivs_broadcast_webrtc_audio_stats",e.WEBRTC_VIDEO_STATS="ivs_broadcast_webrtc_video_stats",e.WEBRTC_AUDIO_STATS_WINDOW="ivs_broadcast_webrtc_audio_stats_window",e.WEBRTC_VIDEO_STATS_WINDOW="ivs_broadcast_webrtc_video_stats_window",e.CONNECTION_ESTABLISHED="ivs_broadcast_connection_established",e.SESSION_VIDEO_PROPERTIES="ivs_broadcast_session_video_properties",e.SESSION_AUDIO_PROPERTIES="ivs_broadcast_session_audio_properties",e.SESSION_VIDEO_ENCODER_CONFIGURED="ivs_broadcast_session_video_encoder_configured",e.SESSION_AUDIO_ENCODER_CONFIGURED="ivs_broadcast_session_audio_encoder_configured",e.SOURCE_AUDIO_LATENCY="ivs_broadcast_source_audio_latency",e.SOURCE_VIDEO_LATENCY="ivs_broadcast_source_video_latency",e.INPUT_DEVICE_ATTACHED="ivs_broadcast_input_device_attached",e.INPUT_DEVICE_DETACHED="ivs_broadcast_input_device_detached",e.CONGESTION_TIME="ivs_broadcast_congestion_time",e.BUFFER_DURATION="ivs_broadcast_buffer_duration",e.MEASURED_BITRATE="ivs_broadcast_measured_bitrate",e.RECOMMENDED_BITRATE="ivs_broadcast_recommended_bitrate",e.CONNECTION_RTT="ivs_broadcast_connection_rtt",e.ERROR="ivs_broadcast_error"}(an||(an={})),function(e){e.USER_INITIATED="user-initiated",e.NETWORK_DISCONNECT="network-disconnect"}(cn||(cn={})),function(e){e.LOWEST_QUALITY="lowest_quality",e.HIGHEST_QUALITY="highest_quality"}(un||(un={}));var dn,hn,pn,fn;!function(e){e.HI="hi",e.MID="mid",e.LOW="low"}(dn||(dn={})),function(e){e.PORTRAIT="portrait",e.LANDSCAPE="landscape"}(hn||(hn={})),function(e){e.VIDEO="video",e.AUDIO="audio"}(pn||(pn={})),function(e){e.DEFAULT="default",e.LOW="low",e.MEDIUM="medium",e.HIGH="high"}(fn||(fn={}));const gn={jitterBuffer:{type:"object",required:!1,config:{schema:{minDelayWhenPublishing:{type:"number",required:!1},minDelayWhenSubscribeOnly:{type:"number",required:!1}}}},inBandMessaging:{type:"object",required:!1,config:{schema:{enabled:{type:"boolean",required:!1}}}},simulcast:{type:"object",required:!1,config:{schema:{initialLayerPreference:{type:"string",required:!1},layerPollingEnabled:{type:"boolean",required:!1},layerPollingIntervalMs:{type:"number",required:!1}}}}};var mn=n(2543);const vn=function(){if("undefined"!=typeof URLSearchParams){const e=new URLSearchParams(window.location.search);return{get:t=>e.get(t),has:t=>e.has(t)}}const e=window.location.search.slice(1),t={};return e&&e.split("&").forEach((e=>{const[n,r]=e.split("=");t[decodeURIComponent(n)]=decodeURIComponent(r||"")})),{get:e=>{var n;return null!==(n=t[e])&&void 0!==n?n:null},has:e=>e in t}}();var En,Sn;const _n=vn.get("ivs_dc_cnf_env")===ln.DeviceConfigEnv.BETA?ln.DeviceConfigEnv.BETA:ln.DeviceConfigEnv.PROD,yn=ln.DEFAULT_REFRESH_INTERVAL_SECONDS,bn=_n===ln.DeviceConfigEnv.BETA?10:yn,Tn="broadcast-web-v1",Cn=(null===(Sn=null===(En=window.location)||void 0===En?void 0:En.hostname)||void 0===Sn?void 0:Sn.indexOf("localhost"))>-1,In=`amazon_ivs_device_config_v1_${Tn}_context`,Rn=()=>({[sn.RT]:{customerIds:[],hosts:[]},[sn.LL]:{customerIds:[],hosts:[]}});var On=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};const wn=e=>{let t=(0,mn.merge)(Rn(),e);const n=(()=>{try{const e=localStorage.getItem(In);return null===e?ln.err("Key does not exist"):ln.ok(JSON.parse(e))}catch(e){return ln.err(`Error while parsing: ${e}`)}})();if(!n.ok)return t;const r=n.value;return t=kn(sn.RT,r[sn.RT],t),t=kn(sn.LL,r[sn.LL],t),t},An=(e,t)=>e.hash===t.hash&&e.key===t.key,kn=(e,t,n)=>{const r=Object.keys(n[e]);for(const i of r)n[e][i]=(0,mn.uniqWith)([...t[i],...n[e][i]],An);return n},Pn=e=>e?{customer_id:e.customerId}:{};var Dn=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};class GlobalConfigManager extends TypedEmitter{constructor(e){var t;super(),this.onStateChanged=(e,t)=>{this.logger.log(`[onStateChanged] From ${e} to ${t}`)},this.handleRefresh=()=>{this.logger.log("[handleRefresh] Starting refresh trigger");const e=this.fsm.currentState()===tn.ACTIVATING||this.fsm.currentState()===tn.ACTIVE;return e?(this.logger.log("[handleRefresh] Starting refresh"),this.fsm.transition(nn.REFRESH)):this.logger.log("[handleRefresh] Skipping refresh due to inactive state"),e},this.onMetricsEmitted=e=>{this.fsm.currentState()!==tn.ACTIVATING&&this.fsm.currentState()!==tn.REFRESHING||this.fsm.transition(nn.ACTIVATE);const t=new DevConfOpsMetricsEvent(Object.assign({},e));this.emit(en.ANALYTICS_EVENT,t),this.emit(en.REFRESH)},this.onConfigValue=(e,t)=>{const n=new DevConfValueEvent(Object.assign(Object.assign({},e),Pn(t)));this.emit(en.ANALYTICS_EVENT,n)},this.onConfigError=(e,t)=>{const n=new DevConfErrorEvent(Object.assign(Object.assign({},e),Pn(t)));this.emit(en.ANALYTICS_EVENT,n)},this.onConfigTrace=(e,t)=>{const n=new DevConfTraceEvent(Object.assign(Object.assign({},e),Pn(t)));this.emit(en.ANALYTICS_EVENT,n)},this.cacheContextForSource=(e,t)=>Dn(this,void 0,void 0,(function*(){const n=yield(e=>On(void 0,void 0,void 0,(function*(){const t={customerIds:[],hosts:[]};if(e.customerId){const n=yield(0,ln.hashProperty)(e.customerId);if(!n.ok)return ln.err(`customerId: ${n.error}`);t.customerIds.push(n.value)}if(e.host){const n=yield(0,ln.hashProperty)(e.host);if(!n.ok)return ln.err(`host: ${n.error}`);t.hosts.push(n.value)}return ln.ok(t)})))(t);n.ok?(this.context=kn(e,n.value,this.context),(e=>{try{const t=JSON.stringify(e);return localStorage.setItem(In,t),ln.ok(void 0)}catch(e){return ln.err(`Error while storing: ${e}`)}})(this.context)):this.logger.error("[cacheContextForSource] ",n.error)})),this.disableConfigRefresh=()=>{this.fsm.transition(nn.PAUSE)},this.enableConfigRefresh=()=>{this.fsm.transition(nn.ACTIVATE)},this.logger=(t={name:"GlobalConfigManager"},(0,ln.createLogger)(t)),this.logger.setConfig({enabled:!0,levels:{debug:!1,log:Cn,info:Cn,error:Cn,warn:Cn}}),this.context=wn(Rn()),this.overrides=Object.assign(Object.assign({},{refreshIntervalSeconds:bn}),e),this.fsm=(0,ln.createFsm)({initialState:tn.IDLE,transitions:rn,callbacks:{onStateChanged:this.onStateChanged}}),this.manager=ln.DeviceConfigManager.getInstance(window,{fileKey:Tn,standardEnv:_n,refresh:{refreshIntervalSeconds:this.overrides.refreshIntervalSeconds,canRefreshNow:this.handleRefresh},fetch:this.overrides.refreshRequestHook,trace:{onTrace:e=>{this.logger.log("[onTrace] ",e)}},emitMetrics:this.onMetricsEmitted,analyticsProperties:{env:_n,client_sdk:"broadcast-web"},enableConsoleLog:Cn}),this.fsm.transition(nn.INITIALIZE)}get state(){return this.fsm.currentState()}getRemoteStageSubscribeConfiguration(e){const t=((e,t,n)=>{const r=(0,mn.cloneDeep)(null!=e?e:{}),i=Object.assign(Object.assign({},r),{cFilter:r.customerId,hFilter:r.host});for(const r of n[t].customerIds)r.key===e.customerId&&(i.cFilter=r.hash);for(const r of n[t].hosts)r.key===e.host&&(i.hFilter=r.hash);return i})(e,sn.RT,this.context);return this.getRemoteConfigurationForProperty(on.STAGE_SUBSCRIBE_CONFIGURATION,t,gn)}getRemoteConfigurationForProperty(e,t,n){var r;const i=null===(r=this.manager)||void 0===r?void 0:r.getConfigurationHolder({analytics:{onValue:e=>{this.onConfigValue(e,t)},onError:e=>{this.onConfigError(e,t)},onTrace:e=>{this.onConfigTrace(e,t)}}});if(i)return i.getResolvedConfigForPropertyKey({key:e,context:t,schema:n,trace:Cn});this.logger.error("[getRemoteConfigurationForProperty] No config manager is present")}}var Nn=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};class IVSGlobalSession{constructor(){this.globalSessionId=wt(),this.currentGlobalEndpoint=Jt,this.signalInternalUsage=()=>{this.usageReferences>0?this.configManager.enableConfigRefresh():this.configManager.disableConfigRefresh()},this.markSdkUsage=()=>{this.usageReferences++,this.signalInternalUsage()},this.removeSdkUsage=()=>{this.usageReferences=Math.max(0,this.usageReferences-1),this.signalInternalUsage()},this.usageReferences=0,this.healthReporter=new HealthReporter,this.networkMonitor=new NetworkQualityMonitor,this.configManager=new GlobalConfigManager,this.healthReporter.on(Qt.ANALYTICS_EVENT,(e=>{this.trackGlobalEvent(e)})),this.configManager.on(en.ANALYTICS_EVENT,(e=>{this.trackGlobalEvent(e)})),this.configManager.on(en.REFRESH,(()=>{this.signalInternalUsage()}));const e=kt.getParser(navigator.userAgent),t=function(e){const t=/^(\d+)\.(\d+)\.(\d+)[+|-]?(.*)?$/.exec(e)||/^(\d+)\.(\d+)[+|-]?(.*)?$/.exec(e)||/^(\d+)$/.exec(e)||[];return{major:parseInt(t[1],10)||0,minor:parseInt(t[2],10)||0,patch:parseInt(t[3],10)||0}}(String(e.getBrowserVersion()));this.globalProperties={browser:navigator.appVersion,browser_family:e.getBrowserName().toLowerCase(),browser_version:`${t.major}.${t.minor}`,customer_id:"ivs",host:window.location.hostname,os_name:e.getOSName(),os_version:String(e.getOSVersion()),platform:"web",global_session_id:this.getGlobalSessionId(),sdk_version:"1.30.0",user_agent:navigator.userAgent,is_backgrounded:"hidden"===(null===document||void 0===document?void 0:document.visibilityState)}}trackGlobalEvent(e){const t=this.getGlobalProperties();e.data.properties=Object.assign(Object.assign(Object.assign({},t),e.data.properties),{current_endpoint:this.currentEndpoint});const{headers:n,body:r}=Nt([e.data]);At((()=>Nn(this,void 0,void 0,(function*(){yield Dt("POST",this.currentEndpoint,n,r)}))))}updateGlobalProperties(){this.globalProperties=Object.assign(Object.assign({},this.globalProperties),{is_backgrounded:"hidden"===(null===document||void 0===document?void 0:document.visibilityState)})}enrichContext(e){var t;return Object.assign({appLabel:null!==(t=bt())&&void 0!==t?t:"default",customerId:this.globalProperties.customer_id,host:this.globalProperties.host,browserFamily:this.globalProperties.browser_family,browserVersion:this.globalProperties.browser_version,osName:this.globalProperties.os_name,osVersion:this.globalProperties.os_version,userAgent:this.globalProperties.user_agent,sdkVersion:this.globalProperties.sdk_version},e)}getGlobalSessionId(){return this.globalSessionId}getGlobalProperties(){return this.updateGlobalProperties(),this.globalProperties}set currentEndpoint(e){this.currentGlobalEndpoint=e}get currentEndpoint(){var e;return(null===(e=window.IVS_CLIENT_OVERRIDES)||void 0===e?void 0:e.analyticsPostUrl)?window.IVS_CLIENT_OVERRIDES.analyticsPostUrl:this.currentGlobalEndpoint}trackEvent(e){"eventSenderResult"===e.type&&this.healthReporter.trackEventSendResult(e)}getNetworkQuality(){return this.networkMonitor.getNetworkQuality()}cacheRealTimeContext(e){const t=this.enrichContext(e);this.configManager.cacheContextForSource(sn.RT,t).catch(qt)}cacheLowLatencyContext(e){const t=this.enrichContext(e);this.configManager.cacheContextForSource(sn.LL,t).catch(qt)}getRemoteSubscribeConfig(e){const t=this.enrichContext(e);return this.configManager.getRemoteStageSubscribeConfiguration(t)}}window.IVS_CLIENT_GLOBAL_STATE||(window.IVS_CLIENT_GLOBAL_STATE={}),window.IVS_CLIENT_GLOBAL_STATE.session||(window.IVS_CLIENT_GLOBAL_STATE.session=new IVSGlobalSession);const Ln=window.IVS_CLIENT_GLOBAL_STATE.session;function Mn(e){if(!e)throw new Error("eventSender is not defined")}class AnalyticsTracker{constructor(){this.sharedProperties={},this.eventSender={},this.queuedEvents=[],this.genSessionId();const e=bt();this.eventSender=new EventSender,this.initSharedProperties({appLabel:e}),this.errorReports=new Map}start(){this.flushInterval||(this.flushInterval=window.setInterval((()=>{this.queueAggregateErrors({force:!1}),this.flushEvents()}),1e3))}stop(e){let t=!1;clearInterval(this.flushInterval),this.flushInterval=void 0,this.queueAggregateErrors({force:!0}),e&&(this.queuedEvents=this.queuedEvents.filter((e=>e.critical)),t=!0),this.flushEvents(t),this.genSessionId()}trackEvent(e,t=!1){let n=this.sharedProperties;t&&(n={global_session_id:this.sharedProperties.global_session_id,session_id:this.sharedProperties.session_id,browser:this.sharedProperties.browser,browser_family:this.sharedProperties.browser_family,browser_version:this.sharedProperties.browser_version,os_name:this.sharedProperties.os_name,os_version:this.sharedProperties.os_version,is_backgrounded:this.sharedProperties.is_backgrounded}),"hidden"===(null===document||void 0===document?void 0:document.visibilityState)&&(n.is_backgrounded=!0),"data"in e?(e.data.properties=Object.assign({},n,e.data.properties),this.queuedEvents.push(e.data)):(e.properties=Object.assign({},n,e.properties),this.queuedEvents.push(e))}trackEventNoSharedProps(e){this.trackEvent(e,!0)}trackErrorAndThrow(e){throw this.trackError(e),e}trackError(e){const t=`${e.code}${e.fatal}${e.nominal}${e.tag}${e.traceId.value}`,n=this.errorReports.get(t),r={error:e,queuedAt:Date.now(),count:0};if(!n)return this.errorReports.set(t,r),void this.trackEvent(new StageErrorEvent(e));0===n.count&&(n.error=e),n.count+=1;return n.queuedAt+6e4<=Date.now()?(this.trackErrorReportIfNeeded(n),void this.errorReports.set(t,r)):void 0}queueAggregateErrors({force:e=!1}){this.errorReports.forEach(((t,n)=>{const r=t.queuedAt+6e4;!e&&r>Date.now()||(this.trackErrorReportIfNeeded(t),this.errorReports.delete(n))}))}trackErrorReportIfNeeded(e){if(0===e.count)return;const t=e.error;t.count=e.count,this.trackEvent(new StageErrorEvent(t))}batchEvents(e){Mn(this.eventSender);const t=e.map((e=>(e.data.properties=Object.assign({},this.sharedProperties,e.data.properties),e.data)));this.eventSender.send(t)}initSharedProperties({appLabel:e}){const t=Ln.getGlobalProperties();this.sharedProperties=Object.assign(Object.assign({},t),{session_id:this.sessionId}),e&&(this.sharedProperties.app_label=e)}genSessionId(){this.sessionId=wt(),this.sharedProperties.session_id=this.sessionId}flushEvents(e=!1){Mn(this.eventSender),this.queuedEvents.length>0&&this.eventSender.send(this.queuedEvents,e),this.queuedEvents=[]}getSessionId(){return this.sessionId}}const xn={[le.INFO]:"#528bff",[le.WARN]:"#ffb31a",[le.DEBUG]:"#00f593",[le.ERROR]:"#ff4f4d",[le.TRACE]:"",[le.SILENT]:"",[de.TIME]:"#53535f",[de.WEBRTC]:"#0e9bd8",[de.SUBSCRIPTION]:"#ffc400",[de.CONNECTION]:"#ff5edb",[de.SOCKET]:"#8585ff",[de.EMITTER]:"#adadb8",[de.LOCAL_PARTICIPANT]:"#1DD21D",[de.STAGE]:"#EC9806",[de.REMOTE_PARTICIPANT]:"#0680EC",details:"#808080"},Bn=({label:e})=>`background: ${xn[e]||"#333333"}; color: white; padding: 3px; margin-left: 3px;`,Un=Object.entries(le),jn=(e,t,n)=>{const r=Bn({label:e}),[i]=Un.find((([,t])=>t===Number(e)))||[],o=`%c${i}`,s=Bn({label:t}),a=`%c${t}`,c=Bn({label:de.TIME}),u=`%c[${(new Date).toISOString()}]`,l=Bn({label:"details"}),d=`%c[${n}]`,h=[u,o,a],p=[c,r,s];return n&&(h.push(d),p.push(l)),[h.join(""),...p]},Fn={debug(e){console.groupCollapsed(...jn(le.DEBUG,e.scope,e.label)),console.debug(e.msg,Object.assign(Object.assign({},e),{level:"debug"})),console.groupEnd()},info(e){console.groupCollapsed(...jn(le.INFO,e.scope,e.label)),console.info(e.msg,Object.assign(Object.assign({},e),{level:"info"})),console.groupEnd()},warn(e){console.groupCollapsed(...jn(le.WARN,e.scope,e.label)),console.warn(e.msg,Object.assign(Object.assign({},e),{level:"warn"})),console.groupEnd()},error(e){console.groupCollapsed(...jn(le.ERROR,e.scope,e.label)),console.error(e),console.groupEnd()}};var Vn=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n};Object.entries(le);class Logger{constructor(e=st,t=Fn){this.logLevel=e,this.loggerInstance=t}debug(e){var t,n;this.logLevel>le.DEBUG||null===(n=(t=this.loggerInstance).debug)||void 0===n||n.call(t,JSON.parse(JSON.stringify(Object.assign(Object.assign({},e),{level:"debug"}))))}info(e){var t,n;this.logLevel>le.INFO||null===(n=(t=this.loggerInstance).info)||void 0===n||n.call(t,JSON.parse(JSON.stringify(Object.assign(Object.assign({},e),{level:"info"}))))}warn(e){var t,n;this.logLevel>le.WARN||null===(n=(t=this.loggerInstance).warn)||void 0===n||n.call(t,JSON.parse(JSON.stringify(Object.assign(Object.assign({},e),{level:"warn"}))))}error(e){var t,n,{err:r}=e,i=Vn(e,["err"]);this.logLevel>le.ERROR||null===(n=(t=this.loggerInstance).error)||void 0===n||n.call(t,Object.assign({err:r},i))}}class ScopedLogger{constructor(e,t){this.logger=e,this.scope=t}debug(e){var t,n;null===(n=(t=this.logger).debug)||void 0===n||n.call(t,JSON.parse(JSON.stringify(Object.assign(Object.assign({},e),{scope:this.scope}))))}info(e){var t,n;null===(n=(t=this.logger).info)||void 0===n||n.call(t,JSON.parse(JSON.stringify(Object.assign(Object.assign({},e),{scope:this.scope}))))}warn(e){var t,n;null===(n=(t=this.logger).warn)||void 0===n||n.call(t,JSON.parse(JSON.stringify(Object.assign(Object.assign({},e),{scope:this.scope}))))}error(e){var t,n,{err:r}=e,i=Vn(e,["err"]);null===(n=(t=this.logger).error)||void 0===n||n.call(t,Object.assign(Object.assign({err:r},i),{scope:this.scope}))}unwrap(){return this.logger}}class Samples{constructor(){this.min=0,this.max=0,this.sum=0,this.data=[]}push(e){(0===this.min||e<this.min)&&(this.min=e),e>=this.max&&(this.max=e),this.data.push(e),this.sum+=e}median(){this.data.sort();const e=this.data.length>>1;return this.data.length%2==0?this.data[e-1]+this.data[e]>>1:this.data[e]}percentile(e){if(0===this.data.length)return 0;if(e<=0)return this.data[0];if(e>=1)return this.data[this.data.length-1];const t=(this.data.length-1)*e,n=Math.floor(t),r=n+1,i=t%1;return r>=this.data.length?this.data[n]:this.data[n]*(1-i)+this.data[r]*i}}var Gn=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};class PeerStatsTracker{constructor(e,t,n,r){this.peerClient=e,this.broadcastCanvasManager=t,this.analyticsTracker=r,this.logger=new ScopedLogger(n,de.EMITTER),this.previousBytesSent=0,this.startTimestamp=0,this.initializeSamples()}start(){this.logger.info({msg:"start emitter"}),this.collectSamplesTimerId=window.setInterval((()=>{this.collectSamples()}),1e3),this.trackSamplesTimerId=window.setInterval((()=>{this.trackSamples()}),3e4),this.trackPeerConnectionStatsTimerId=window.setInterval((()=>{this.trackPeerConnectionStats()}),6e4),this.trackSamples()}stop(){clearInterval(this.collectSamplesTimerId),clearInterval(this.trackSamplesTimerId),clearInterval(this.trackPeerConnectionStatsTimerId),this.collectSamplesTimerId=void 0,this.trackSamplesTimerId=void 0,this.trackPeerConnectionStatsTimerId=void 0}trackPeerConnectionStats(){return Gn(this,void 0,void 0,(function*(){(yield this.peerClient.getReports()).forEach((e=>{if("outbound-rtp"===e.type)switch(e.kind){case"audio":this.analyticsTracker.trackEvent(new WebRTCAudioStatsEvent(e));break;case"video":{const t=new WebRTCVideoStatsEvent(e),n=new MinuteBroadcastEvent(e,this.startTimestamp);this.analyticsTracker.batchEvents([t,n]);break}default:this.logger.warn({msg:"unknown report kind: ",reportKind:e.kind})}}))}))}collectSamples(){return Gn(this,void 0,void 0,(function*(){let e=0;this.audioLatencySamples.push(this.broadcastCanvasManager.getAudioLatency()),this.videoLatencySamples.push(this.broadcastCanvasManager.getVideoLatency());(yield this.peerClient.getReports()).forEach((t=>{switch(t.type){case"candidate-pair":t.nominated&&(this.rttSamples.push(t.currentRoundTripTime),this.recommendedBitrateSamples.push(t.availableOutgoingBitrate));break;case"outbound-rtp":e+=t.bytesSent||0,0===this.startTimestamp&&"video"===t.kind&&(this.startTimestamp=t.timestamp)}}));const t=8*Math.round(e-this.previousBytesSent);this.previousBytesSent=e,this.measuredBitrateSamples.push(t)}))}trackSamples(){const e=30,t=new SourceAudioLatencyEvent(this.audioLatencySamples,e),n=new SourceVideoLatencyEvent(this.videoLatencySamples,e),r=new CongestionTimeEvent(this.congestionTimeSamples,e),i=new MeasuredBitrateEvent(this.measuredBitrateSamples,e),o=new RecommendedBitrateEvent(this.recommendedBitrateSamples,e),s=new ConnectionRTTEvent(this.rttSamples,e);this.analyticsTracker.batchEvents([t,n,r,i,o,s]),this.initializeSamples()}initializeSamples(){this.audioLatencySamples=new Samples,this.videoLatencySamples=new Samples,this.congestionTimeSamples=new Samples,this.measuredBitrateSamples=new Samples,this.recommendedBitrateSamples=new Samples,this.rttSamples=new Samples}}const Hn=e=>{const t=e=>{var t;return(null===(t=e.deviceId)||void 0===t?void 0:t.startsWith("web-contents-media-stream"))?"tab":void 0},n=e=>{var t;return(null===(t=e.deviceId)||void 0===t?void 0:t.startsWith("window"))&&"window"===e.displaySurface?"window":void 0},r=e=>{var t;return(null===(t=e.deviceId)||void 0===t?void 0:t.startsWith("screen"))&&"monitor"===e.displaySurface?"screen":void 0};return(t(i=e)||n(i)||r(i)?void 0:"camera")||r(e)||n(e)||t(e)||"unknown";var i};function Wn(e,t){return e.find((e=>e.kind===t))}function $n(e){return"live"===(null==e?void 0:e.readyState)}var qn;!function(e){e.VIDEO="video",e.AUDIO="audio"}(qn||(qn={}));class MediaStreamManager{constructor(){this.mediaTracks=new Map([[qn.VIDEO,void 0],[qn.AUDIO,void 0]])}setTrack(e,t){this.mediaTracks.set(e,t)}getTrack(e){return this.mediaTracks.get(e)}}class SDPFmtpLine{constructor(){this.levelAsymmetryAllowed=!1,this.packetisationMode=!1,this.profile="",this.level=0}extractVideoSdpFmtpLine(e){if(!e)return{levelAsymmetryAllowed:this.levelAsymmetryAllowed,packetisationMode:this.packetisationMode,profile:this.profile,level:this.level};return e.split("\r").join(";").split("\n").join(";").split(" ").join(";").split(";").map((e=>e.trim())).filter(Boolean).forEach((e=>{const t=e.split("=");if(2===t.length)switch(t[0]){case"level-asymmetry-allowed":"1"===t[1]?this.levelAsymmetryAllowed=!0:this.levelAsymmetryAllowed=!1;break;case"packetization-mode":"1"===t[1]?this.packetisationMode=!0:this.packetisationMode=!1;break;case"profile-level-id":this.profile=this.getProfileFromId(t[1]),this.level=this.getLevelFromId(t[1])}})),{levelAsymmetryAllowed:this.levelAsymmetryAllowed,packetisationMode:this.packetisationMode,profile:this.profile,level:this.level}}getProfileFromId(e){const t=e.substr(0,2),n=e.substr(2,2);switch(t.substr(0,2)){case"42":return"baseline";case"4d":return"main";case"58":return"extended";case"64":return"high";case"6e":return"00"===n?"high 10":"high 10 intra";case"7a":return"00"===n?"high 42":"high 42 intra";case"f4":return"00"===n?"high 44":"high 44 intra";default:return"unknown"}}getLevelFromId(e){return parseInt(e.substr(4,2),16)}}function zn(e){return btoa(JSON.stringify(e))}var Kn,Jn=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};!function(e){e.IDLE="idle",e.EXECUTING="executing",e.RECONNECTING="reconnecting"}(Kn||(Kn={}));class BaseReconnectStrategy{constructor(e,t=12e4,n,r){this.state=Kn.IDLE,this.failureCallback=()=>{},this.peerClient=e,this.timeout=t,this.logger=n,this.emitter=r}onFailure(e){this.failureCallback=e}setStartConfig(e,t){this.ingestEndpoint=e,this.streamKey=t}execute(){const{id:e}=this;this.state===Kn.IDLE&&(this.state=Kn.EXECUTING,this.emitter.emit(xt.CONNECTION_STATE_CHANGE,Gt.CONNECTING),this.logger.info({msg:"Starting execution of reconnect strategy.",id:e}),this.startTimeoutTimer(this.timeout),this.executeStrategy())}startTimeoutTimer(e){this.timeoutTimerId=window.setTimeout((()=>{this.state!==Kn.IDLE&&(this.logger.info({msg:"Reconnect strategy timed out."}),this.stop(),this.emitter.emit(xt.CONNECTION_STATE_CHANGE,Gt.FAILED),this.failureCallback())}),e)}stop(){this.state=Kn.IDLE,clearTimeout(this.timeoutTimerId),this.stopStrategy()}reconnect(){return Jn(this,void 0,void 0,(function*(){if(this.ingestEndpoint&&this.streamKey){const e=this.peerClient.getConnectionState();try{this.logger.info({msg:"Attempting reconnect."}),e===Gt.CONNECTED?this.logger.info({msg:"Already connected! Stopping reconnect strategy."}):(yield this.peerClient.start(this.ingestEndpoint,this.streamKey),this.logger.info({msg:"Reconnect succeeded!"})),this.stop()}catch(e){throw this.logger.error({err:e}),e}}}))}isActive(){return this.state!==Kn.IDLE}}class ExponentialBackoffStrategy extends BaseReconnectStrategy{constructor(){super(...arguments),this.id="ExponentialBackoffStrategy"}executeStrategy(){let e=5e3;const t=()=>Jn(this,void 0,void 0,(function*(){if(this.state===Kn.EXECUTING)try{this.state=Kn.RECONNECTING,yield this.reconnect()}catch(n){this.logger.warn({msg:"Attempted reconnect failed. Trying again in: ",nextRetry:e}),this.state=Kn.EXECUTING,this.currentTimeoutId=window.setTimeout(t,e),e*=2}}));this.currentTimeoutId=window.setTimeout(t,0)}stopStrategy(){clearTimeout(this.currentTimeoutId)}}class NetworkApiStrategy extends BaseReconnectStrategy{constructor(){super(...arguments),this.id="NetworkApiStrategy",this.onConnectionChange=()=>Jn(this,void 0,void 0,(function*(){if(navigator.onLine&&this.state===Kn.EXECUTING){this.state=Kn.RECONNECTING;try{yield this.reconnect()}catch(e){this.logger.warn({msg:"Attempted reconnect failed."}),this.state=Kn.EXECUTING}}}))}executeStrategy(){navigator.connection.addEventListener("change",this.onConnectionChange),this.onConnectionChange()}stopStrategy(){navigator.connection.removeEventListener("change",this.onConnectionChange)}}class PeerClientReconnectStrategyFactory{static create(e,t=pt,n,r){const{reconnect:i,timeout:o}=t;if(i){const t=kt.getParser(navigator.userAgent).getBrowserName().toLowerCase();return["edge","chrome"].includes(t)&&navigator.connection?new NetworkApiStrategy(e,o,n,r):new ExponentialBackoffStrategy(e,o,n,r)}}}var Yn,Qn=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))},Xn=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};const Zn=e=>!!e;function er(e){if(!e)throw new Error("PeerConnection is not defined")}const tr={bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",enableDtlsSrtp:{exact:!0},enableRtpDataChannels:{exact:!1},optional:[{googHighStartBitrate:{exact:0}},{googPayloadPadding:{exact:!0}},{googScreencastMinBitrate:{exact:100}},{googCpuOveruseDetection:{exact:!0}},{googCpuOveruseEncodeUsage:{exact:!0}},{googCpuUnderuseThreshold:{exact:55}},{googCpuOveruseThreshold:{exact:85}},{enableDscp:{exact:!0}}]};class PeerClient{constructor(e,t,n,r,i){this.config=e,this.emitter=t,this.mediaStreamManager=n,this.analyticsTracker=i,this.establishConnection=(e,t)=>Qn(this,void 0,void 0,(function*(){var n,r,i;er(this.peerConnection);try{const n=yield this.peerConnection.createOffer({offerToReceiveAudio:!1,offerToReceiveVideo:!1});yield this.handleLocalDescription(n),yield this.sendSetupRequest(e,t,n)}catch(e){if(e instanceof Error){null!==(n=(i=e).code)&&void 0!==n||(i.code=De.code);const t=new BroadcastClientError(Object.assign(Object.assign({},De),{name:e.name,message:e.message,code:null==e?void 0:e.code,cause:e}));throw(null===(r=this.reconnectStrategy)||void 0===r?void 0:r.isActive())||this.handleError(e.code,e.message),this.stop(),t}}})),this.getSessionId=()=>this.ingestSessionId,this.getConnectionState=()=>{var e;if(!this.peerConnection)return Gt.NONE;const t=null===(e=this.reconnectStrategy)||void 0===e?void 0:e.isActive(),n=this.peerConnection.connectionState||this.peerConnection.iceConnectionState;switch(n){case"new":return Gt.NEW;case"closed":return Gt.CLOSED;case"disconnected":return t?Gt.CONNECTING:Gt.DISCONNECTED;case"failed":return t?Gt.CONNECTING:Gt.FAILED;case"idle":return Gt.IDLE;case"checking":case"connecting":return Gt.CONNECTING;case"completed":case"connected":return Gt.CONNECTED;default:return this.logger.warn({msg:"Unhandled connection state:",rawState:n}),Gt.IDLE}},this.onConnectionStateChange=()=>{var e;const t=this.getConnectionState();switch(t){case Gt.CONNECTED:{this.emitter.emit(xt.CONNECTION_STATE_CHANGE,t);const n=new Date;this.analyticsTracker.trackEvent(new ConnectionEstablishedEvent(n,this.connectionStartDate,this.ingestSessionId));const r=this.mediaStreamManager.getTrack(qn.AUDIO),i=this.mediaStreamManager.getTrack(qn.VIDEO);if(i){const e=i.getSettings();this.analyticsTracker.trackEvent(new SessionVideoPropertiesEvent(e))}if(r){const e=r.getSettings();this.analyticsTracker.trackEvent(new SessionAudioPropertiesEvent(e))}((null===(e=this.peerConnection)||void 0===e?void 0:e.getSenders())||[]).forEach((e=>{var t;((null===(t=e.getParameters())||void 0===t?void 0:t.codecs)||[]).forEach((t=>{var n;switch(null===(n=e.track)||void 0===n?void 0:n.kind){case"video":{if(!i)break;const e=(new SDPFmtpLine).extractVideoSdpFmtpLine(t.sdpFmtpLine),n=i.getSettings();this.analyticsTracker.trackEvent(new SessionVideoEncoderConfiguredEvent(n,e,t));break}case"audio":if(!r)break;this.analyticsTracker.trackEvent(new SessionAudioEncoderConfiguredEvent(t))}}))}));break}case Gt.CONNECTING:this.emitter.emit(xt.CONNECTION_STATE_CHANGE,t),this.connectionStartDate=new Date,this.disconnectionStartDate=void 0;break;case Gt.FAILED:this.reconnectStrategy?this.reconnectStrategy.execute():(this.emitter.emit(xt.CONNECTION_STATE_CHANGE,t),this.handleTerminalConnectionFailure());break;case Gt.DISCONNECTED:this.emitter.emit(xt.CONNECTION_STATE_CHANGE,t),this.disconnectionStartDate=new Date;break;default:this.emitter.emit(xt.CONNECTION_STATE_CHANGE,t)}},this.handleLocalDescription=e=>Qn(this,void 0,void 0,(function*(){var t;return null===(t=this.peerConnection)||void 0===t?void 0:t.setLocalDescription(e)})),Yn.set(this,(e=>{if("string"!=typeof e)throw new BroadcastClientError(Be);try{new URL(e)}catch(e){throw new BroadcastClientError(Ue)}})),this.logger=new ScopedLogger(r,de.WEBRTC),this.createReconnectStrategy(e)}start(e,t){var n;return Qn(this,void 0,void 0,(function*(){Xn(this,Yn,"f").call(this,e);const r=[this.mediaStreamManager.getTrack(qn.VIDEO),this.mediaStreamManager.getTrack(qn.AUDIO)].filter(Zn);this.createPeerConnection(),this.addTracks({tracks:r}),this.reconnectStrategy&&this.reconnectStrategy.setStartConfig(e,t),yield this.establishConnection(e,t);if(null===(n=this.reconnectStrategy)||void 0===n?void 0:n.isActive()){const t=new URL(e);this.analyticsTracker.trackEvent(new StartBroadcastEvent({protocol:"webrtc",hostname:t.hostname,port:t.port},cn.NETWORK_DISCONNECT))}}))}stop(){var e,t,n,r;this.stateCheckInterval&&(clearInterval(this.stateCheckInterval),this.stateCheckInterval=void 0),this.stopStreamDataChannel&&"open"===this.stopStreamDataChannel.readyState&&this.stopStreamDataChannel.send(" "),[Gt.NEW,Gt.CONNECTING,Gt.CONNECTED].includes(this.getConnectionState())&&this.emitter.emit(xt.CONNECTION_STATE_CHANGE,Gt.CLOSED),null===(e=this.peerConnection)||void 0===e||e.close(),null===(t=this.peerConnection)||void 0===t||t.removeEventListener("connectionstatechange",this.onConnectionStateChange),null===(n=this.peerConnection)||void 0===n||n.removeEventListener("iceconnectionstatechange",this.onConnectionStateChange),this.ingestSessionId=void 0,null===(r=this.reconnectStrategy)||void 0===r||r.stop()}addTracks(e){var t;if(er(this.peerConnection),!e)return;const n=this.peerConnection.getSenders().map((e=>{var t;return null===(t=e.track)||void 0===t?void 0:t.id})),r=e.tracks.filter((e=>!n.includes(e.id)));for(const e of r)null===(t=this.peerConnection)||void 0===t||t.addTrack(e)}getReports(){var e;return Qn(this,void 0,void 0,(function*(){try{const t=(yield null===(e=this.peerConnection)||void 0===e?void 0:e.getStats())||[],n=[];return t.forEach((e=>{n.push(e)})),n}catch(e){return[]}}))}sendSetupRequest(e,t,n){var r;return Qn(this,void 0,void 0,(function*(){const i=yield fetch(`${e}/v1/offer`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Object.assign({offer:zn(n),streamKey:t},this.config.streamConfig))});if(!i.ok)throw function(e){let t=new BroadcastClientError(Object.assign({},De));1007===(null==e?void 0:e.code)&&(t=new BroadcastClientError(Object.assign({},Le)));(null==e?void 0:e.message)&&(t.message=e.message);return t}(yield i.json());const o=yield i.json();(null==o?void 0:o.answer)&&(yield null===(r=this.peerConnection)||void 0===r?void 0:r.setRemoteDescription(function(e){return JSON.parse(atob(e))}(o.answer)),this.ingestSessionId=o.ingestSessionId)}))}handleTerminalConnectionFailure(){const e=new BroadcastClientError(Ne);this.handleError(e.code,e.message)}handleError(e,t){this.analyticsTracker.trackEvent(new ErrorEvent({code:e,description:t,isFatal:!0})),this.emitter.emit(xt.ERROR,{code:e,message:t})}createPeerConnection(){var e;const t=this.getConnectionState(),n=t!==Gt.NONE,r=t!==Gt.CLOSED,i=null===(e=this.reconnectStrategy)||void 0===e?void 0:e.isActive();n&&r&&!i||(this.stateCheckInterval&&(clearInterval(this.stateCheckInterval),this.stateCheckInterval=void 0),this.stateCheckInterval=window.setInterval((()=>{const e=this.getConnectionState();if(this.reconnectStrategy&&e===Gt.DISCONNECTED&&this.disconnectionStartDate){const e=Date.now()-this.disconnectionStartDate.getTime();this.logger.info({msg:"Time since disconnected:",timeSinceDisconnect:e}),e>1e4&&(this.disconnectionStartDate=void 0,this.reconnectStrategy.execute())}else e===Gt.CLOSED&&(this.handleTerminalConnectionFailure(),clearInterval(this.stateCheckInterval),this.stateCheckInterval=void 0)}),1e3),this.peerConnection=new RTCPeerConnection(tr),this.stopStreamDataChannel=this.peerConnection.createDataChannel("stopStream"),this.peerConnection.addEventListener("connectionstatechange",this.onConnectionStateChange),this.peerConnection.addEventListener("iceconnectionstatechange",this.onConnectionStateChange))}createReconnectStrategy(e){if(this.reconnectStrategy=PeerClientReconnectStrategyFactory.create(this,e.networkReconnectConfig,this.logger,this.emitter),this.reconnectStrategy){this.reconnectStrategy.onFailure(this.handleTerminalConnectionFailure.bind(this));const e=this.reconnectStrategy.id;this.logger.info({msg:"Using reconnect strategy:",strategyId:e})}}}Yn=new WeakMap;var nr,rr,ir=n(5364);!function(e){e.CONFIG="config",e.UPDATE="update",e.START="start",e.STOP="stop"}(nr||(nr={})),function(e){e.VIDEO_SEND="video/send",e.VIDEO_RECEIVE="video/receive",e.INSERT_SEI="insertSei"}(rr||(rr={}));var or=n(5512),sr=n.n(or);function ar(){return sr()('/*! For license information please see scheduler.worker.worker.js.LICENSE.txt */\n(()=>{"use strict";var i,t;!function(i){i.CONFIG="config",i.UPDATE="update",i.START="start",i.STOP="stop"}(i||(i={})),function(i){i.VIDEO_SEND="video/send",i.VIDEO_RECEIVE="video/receive",i.INSERT_SEI="insertSei"}(t||(t={}));const s=self;const n=new class Scheduler{constructor(){this.config={frameRate:60,isRunning:!1}}setConfig(i){this.config=Object.assign(Object.assign({},this.config),i),this.config.isRunning&&(this.stop(),this.start())}start(){this.config.isRunning||(this.intervalId=setInterval((()=>{s.postMessage({type:i.UPDATE})}),1e3/this.config.frameRate),this.config.isRunning=!0)}stop(){this.config.isRunning&&(clearInterval(this.intervalId),this.intervalId=void 0,this.config.isRunning=!1)}};s.addEventListener("message",(function(t){var s;if(null===(s=null==t?void 0:t.data)||void 0===s?void 0:s.type)switch(t.data.type){case i.CONFIG:n.setConfig(t.data.payload||{});break;case i.START:n.start();break;case i.STOP:n.stop()}}))})();',"Worker",void 0,void 0)}var cr=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};class BroadcastCanvasManager{constructor(e,t,n){this.config=e,this.mediaStreamManager=t,this.analyticsTracker=n,this.handleWorkerEvent=e=>{var t;if((null===(t=e.data)||void 0===t?void 0:t.type)===nr.UPDATE)this.drawComposite()},this.mixer={video:[],audio:[]},this.schedulerWorker=new ar,this.running=!1,this.compositeEl=document.createElement("canvas"),this.compositeEl.height=this.config.streamConfig.maxResolution.height,this.compositeEl.width=this.config.streamConfig.maxResolution.width;const r=this.compositeEl.getContext("2d");if(null===r)throw new BroadcastClientError(Object.assign({},ge));this.compositeContext=r,this.compositeStream=this.compositeEl.captureStream(void 0!==typeof CanvasCaptureMediaStreamTrack?0:30);const i=Wn(this.compositeStream.getTracks(),qn.VIDEO);this.audioContext=new AudioContext,this.unlockAudioContext(),this.audioDestination=this.audioContext.createMediaStreamDestination(),this.setupSilence();const o=Wn(this.audioDestination.stream.getTracks(),qn.AUDIO);i&&this.mediaStreamManager.setTrack(qn.VIDEO,i),o&&this.mediaStreamManager.setTrack(qn.AUDIO,o),this.schedulerWorker.addEventListener("message",this.handleWorkerEvent),this.schedulerWorker.postMessage({type:nr.CONFIG,payload:{frameRate:this.config.streamConfig.maxFramerate}}),this.previewElement=null,this.previewCtx=null,this.nextMix=(new Date).getTime()}attachPreview(e){this.previewElement=e;const{width:t,height:n}=this.config.streamConfig.maxResolution;this.previewElement.width=t,this.previewElement.height=n,this.previewCtx=this.previewElement.getContext("2d")}detachPreview(){this.previewElement=null,this.previewCtx=null}setupSilence(){const e=this.audioContext.createConstantSource(),t=this.audioContext.createGain();t.gain.value=.001,e.connect(t),t.connect(this.audioDestination),e.start()}unlockAudioContext(){if("suspended"!==this.audioContext.state)return;const e=document.body,t=["touchstart","touchend","mousedown","keydown"],n=()=>{t.forEach((t=>{e.removeEventListener(t,r)}))},r=()=>{this.audioContext.resume().then(n)};t.forEach((t=>{e.addEventListener(t,r,!1)}))}getTracks(){return[this.mediaStreamManager.getTrack(qn.VIDEO),this.mediaStreamManager.getTrack(qn.AUDIO)]}getCanvasVideoTrack(){return this.mediaStreamManager.getTrack(qn.VIDEO)}getAudioInputDevice(e){if("string"!=typeof e)return;const t=this.mixer.audio.find((t=>{if(t.name===e)return t.source}));return null==t?void 0:t.source}getVideoInputDevice(e){if("string"==typeof e)return this.mixer.video.find((t=>t.name===e))}getCanvasDimensions(){return{height:this.compositeEl.height,width:this.compositeEl.width}}addVideoInputDevice(e,t,n){var r;return cr(this,void 0,void 0,(function*(){if("object"!=typeof e)throw new BroadcastClientError(Object.assign({},Ee));if(!t||"string"!=typeof t)throw new BroadcastClientError(Object.assign({},be));if(this.mixer.video.some((e=>e.name===t)))throw new BroadcastClientError(Object.assign({},Se));if(!n)throw new BroadcastClientError(Object.assign({},_e));if("number"!=typeof n.index)throw new BroadcastClientError(Object.assign({},ye));const i=function(){const e=document.createElement("video");return e.autoplay=!0,e.muted=!0,e.setAttribute("playsinline",""),e.setAttribute("webkit-playsinline",""),e}(),o=e.getVideoTracks(),[s]=o;if(!o.length)throw new BroadcastClientError(Object.assign({},me));const a=s.getConstraints(),c=ir({},a,{frameRate:this.config.streamConfig.maxFramerate});try{yield s.applyConstraints(c)}catch(e){let t="Unknown constraints error";e instanceof Error&&(t=e.message),this.analyticsTracker.trackEvent(new ErrorEvent({description:`${Ce.message}: ${t}`,isFatal:!1,code:Ce.code}))}const u=()=>cr(this,void 0,void 0,(function*(){let e=0;for(;e<5;)try{return void(yield i.play())}catch(t){if(!(t instanceof Error))throw new Error("unknown error trying to add video to broadcast");e++,yield new Promise((e=>setTimeout(e,150)))}throw new Error("Error playing video, tries exceeded")})),l=new MediaStream([s]);i.srcObject=l;try{yield u();const e={name:t,element:i,position:n,source:l,render:!0},o=(null===(r=s.getSettings)||void 0===r?void 0:r.call(s))||{};this.analyticsTracker.trackEvent(new InputDeviceAttachedEvent(Hn(o),o)),this.mixer.video.push(e)}catch(e){throw new BroadcastClientError(Object.assign(Object.assign({},me),{cause:e}))}}))}addImageSource(e,t,n){var r;return cr(this,void 0,void 0,(function*(){if(!e)throw new BroadcastClientError(Object.assign({},Ee));if(!t||"string"!=typeof t)throw new BroadcastClientError(Object.assign({},be));if("image"===e.tagName)throw new BroadcastClientError(Object.assign({},Te));if(this.mixer.video.some((e=>e.name===t)))throw new BroadcastClientError(Object.assign({},Se));if(!n)throw new BroadcastClientError(Object.assign({},_e));if("number"!=typeof n.index)throw new BroadcastClientError(Object.assign({},ye));if(e instanceof Image){const t=null===(r=e.src)||void 0===r?void 0:r.slice();try{const t=e.src?new URL(e.src):{};if(t.host&&t.hostname){const t=yield fetch(e.src).then((e=>cr(this,void 0,void 0,(function*(){return e.blob()})))),n=yield new Promise((e=>{const n=new FileReader;n.onload=()=>{e(n.result)},n.readAsDataURL(t)}));e.src=n}}catch(e){throw new BroadcastClientError(Object.assign(Object.assign({},Pe),{params:{details:`Image URL: ${t}`}}))}}const i={name:t,element:e,position:n,render:!0};this.mixer.video.push(i)}))}addAudioInputDevice(e,t){return cr(this,void 0,void 0,(function*(){if("object"!=typeof e)throw new BroadcastClientError(Object.assign({},Ee));if(!t||"string"!=typeof t)throw new BroadcastClientError(Object.assign({},be));if(this.mixer.audio.some((e=>e.name===t)))throw new BroadcastClientError(Object.assign({},Se));const n=e.getAudioTracks();if(!n.length)throw new BroadcastClientError(Object.assign({},ve));const r=this.audioContext.createMediaStreamSource(new MediaStream(n)),i=this.audioContext.createGain();i.gain.value=1,r.connect(i),i.connect(this.audioDestination);const o={name:t,source:e,audioTrackSource:r,gainNode:i};this.analyticsTracker.trackEvent(new InputDeviceAttachedEvent("audio",{deviceId:e.id})),this.mixer.audio.push(o)}))}removeImage(e){const t=this.mixer.video.findIndex((t=>t.name===e));if(t<0)throw new BroadcastClientError(Object.assign({},Re));this.mixer.video.splice(t,1)}removeVideoInputDevice(e){var t;const n=this.removeDevice(e,this.mixer.video);if(!n)throw new BroadcastClientError(Object.assign({},Ie));{const e=Wn(n.source.getTracks(),qn.VIDEO);if(!e)throw new BroadcastClientError(Object.assign({},Ie));n.element.srcObject=null,e.stop();const r=(null===(t=null==e?void 0:e.getSettings)||void 0===t?void 0:t.call(e))||{};this.analyticsTracker.trackEvent(new InputDeviceDetachedEvent(Hn(r),r))}}removeAudioInputDevice(e){const t=this.removeDevice(e,this.mixer.audio);if(null==t?void 0:t.audioTrackSource){for(const e of t.source.getTracks())e.stop(),this.analyticsTracker.trackEvent(new InputDeviceDetachedEvent("audio",{deviceId:e.id}));t.gainNode.disconnect(this.audioDestination)}else if(!t)throw new BroadcastClientError(Object.assign({},Ie))}updateVideoDeviceComposition(e,t){if(!e||"string"!=typeof e)throw new BroadcastClientError(Object.assign({},Ae));if(!t)throw new BroadcastClientError(Object.assign({},Oe));if("number"!=typeof t.index)throw new BroadcastClientError(Object.assign({},we));this.mixer.video.forEach(((n,r)=>{n.name===e&&(n.position=t)}))}exchangeVideoDevicePositions(e,t){const n=this.getVideoInputDevice(e),r=this.getVideoInputDevice(t);if(!n)throw new BroadcastClientError(Object.assign(Object.assign({},ke),{params:{details:`device with name: "${e}" not found`}}));if(!r)throw new BroadcastClientError(Object.assign(Object.assign({},ke),{params:{details:`device with name: "${t}" not found`}}));const i=Object.assign({},n.position),o=Object.assign({},r.position);for(const n of this.mixer.video)n.name===e&&(ur(o.x)?n.position=Object.assign(Object.assign({},n.position),o):n.position={index:o.index}),n.name===t&&(ur(i.x)?n.position=Object.assign(Object.assign({},n.position),i):n.position={index:i.index})}start(){this.running||(this.running=!0,this.schedulerWorker.postMessage({type:nr.CONFIG,payload:{frameRate:this.config.streamConfig.maxFramerate}}),this.schedulerWorker.postMessage({type:nr.START}))}stop(){this.running&&(this.running=!1,this.schedulerWorker.removeEventListener("message",this.handleWorkerEvent))}isCapturing(){return this.running}getAudioLatency(){return this.audioContext.baseLatency}getVideoLatency(){var e;return(null===(e=this.mediaStreamManager.getTrack(qn.VIDEO))||void 0===e?void 0:e.getConstraints().latency)||0}disableVideo(){this.mixer.video.forEach((e=>{e.render=!1}))}enableVideo(){this.mixer.video.forEach((e=>{e.render=!0}))}disableAudio(){this.mixer.audio.forEach((e=>{e.audioTrackSource&&(e.gainNode.gain.value=0)}))}enableAudio(){this.mixer.audio.forEach((e=>{e.audioTrackSource&&(e.gainNode.gain.value=1)}))}getDrawRegion(e,t,n){var r,i,o,s;let a=null!==(r=e.position.x)&&void 0!==r?r:0,c=null!==(i=e.position.y)&&void 0!==i?i:0;const u=null!==(o=e.position.width)&&void 0!==o?o:t-a,l=null!==(s=e.position.height)&&void 0!==s?s:n-c,d=u/l;let h=e.element.width,p=e.element.height;e.element instanceof HTMLVideoElement&&(h=e.element.videoWidth,p=e.element.videoHeight);const f=h/p;let g=u,m=l;return f>d?(g=u,m=2*Math.round(u/f/2),c+=(l-m)/2):f<d&&(m=l,g=2*Math.round(l*f/2),a+=(u-g)/2),{x:a,y:c,width:g,height:m}}drawComposite(){if(!this.shouldMix(new Date))return;this.compositeContext.clearRect(0,0,this.compositeEl.width,this.compositeEl.height),this.drawBlackScreen();const e=this.mixer.video.filter((e=>e.render));e.sort(((e,t)=>e.position.index-t.position.index));for(const t of e){const{x:e,y:n,width:r,height:i}=this.getDrawRegion(t,this.compositeEl.width,this.compositeEl.height);this.compositeContext.drawImage(t.element,e,n,r,i)}this.previewElement&&this.previewCtx&&this.previewCtx.drawImage(this.compositeEl,0,0,this.previewElement.width,this.previewElement.height),this.requestCanvasCapture()}requestCanvasCapture(){if(void 0!==typeof CanvasCaptureMediaStreamTrack)if("function"==typeof this.compositeStream.requestFrame){this.compositeStream.requestFrame()}else{this.mediaStreamManager.getTrack(qn.VIDEO).requestFrame()}}drawBlackScreen(){this.compositeContext.fillStyle="#000000",this.compositeContext.fillRect(0,0,this.compositeEl.width,this.compositeEl.height)}removeDevice(e,t){const n=t.findIndex((t=>(t=>t.name===e)(t)));if(!(n<0))return t.splice(n,1)[0]}shouldMix(e){if(e.getTime()<this.nextMix)return!1;for(;this.nextMix<=e.getTime();)this.nextMix+=1e3/this.config.streamConfig.maxFramerate;return!0}}function ur(e){return Number.isSafeInteger(e)}var lr,dr,hr=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))},pr=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class AmazonIVSBroadcastClient{constructor(e){this.config=e,lr.add(this),this.emitter=new mt,this.isValid=!0,this.emitter.on(xt.ERROR,this.stopBroadcast),this.config.ingestEndpoint&&(this.url=new URL(this.config.ingestEndpoint)),this.analyticsTracker=new AnalyticsTracker,this.mediaStreamManager=new MediaStreamManager;const t=new Logger(e.logLevel,e.logger);this.peerClient=new PeerClient(this.config,this.emitter,this.mediaStreamManager,t,this.analyticsTracker),this.broadcastCanvasManager=new BroadcastCanvasManager(e,this.mediaStreamManager,this.analyticsTracker),this.peerStatsTracker=new PeerStatsTracker(this.peerClient,this.broadcastCanvasManager,t,this.analyticsTracker),this.broadcastCanvasManager.start();Object.getOwnPropertyNames(AmazonIVSBroadcastClient.prototype).forEach((e=>{this[e]=new Proxy(this[e],{apply:(e,t,n)=>{if(!t.isValid)throw new BroadcastClientError(Object.assign({},Ve));return Reflect.apply(e,t,n)}})})),window.addEventListener("beforeunload",(()=>{this.analyticsTracker.stop(!0)}))}delete(){this.isValid=!1,this.peerClient.stop(),this.broadcastCanvasManager.stop(),this.emitter.removeAllListeners()}startBroadcast(e,t){return hr(this,void 0,void 0,(function*(){Ln.markSdkUsage(),pr(this,lr,"m",dr).call(this,e);const n=ft(t||this.config.ingestEndpoint);this.analyticsTracker.start(),this.peerStatsTracker.start(),yield this.peerClient.start(n,e),this.emitter.emit(xt.ACTIVE_STATE_CHANGE,!0),this.url=new URL(n),this.url&&this.analyticsTracker.trackEvent(new StartBroadcastEvent({protocol:"webrtc",hostname:this.url.hostname,port:this.url.port},cn.USER_INITIATED))}))}stopBroadcast(){var e,t,n;this.url&&this.analyticsTracker.trackEvent(new StopBroadcastEvent({protocol:"webrtc",hostname:this.url.hostname,port:this.url.port})),null===(e=this.peerStatsTracker)||void 0===e||e.stop(),null===(t=this.peerClient)||void 0===t||t.stop(),null===(n=this.emitter)||void 0===n||n.emit(xt.ACTIVE_STATE_CHANGE,!1)}getCanvasDimensions(){return this.broadcastCanvasManager.getCanvasDimensions()}addVideoInputDevice(e,t,n){return hr(this,void 0,void 0,(function*(){return this.broadcastCanvasManager.addVideoInputDevice(e,t,n)}))}addImageSource(e,t,n){return hr(this,void 0,void 0,(function*(){return this.broadcastCanvasManager.addImageSource(e,t,n)}))}addAudioInputDevice(e,t){return hr(this,void 0,void 0,(function*(){return this.broadcastCanvasManager.addAudioInputDevice(e,t)}))}removeVideoInputDevice(e){this.broadcastCanvasManager.removeVideoInputDevice(e)}removeAudioInputDevice(e){this.broadcastCanvasManager.removeAudioInputDevice(e)}removeImage(e){this.broadcastCanvasManager.removeImage(e)}updateVideoDeviceComposition(e,t){this.broadcastCanvasManager.updateVideoDeviceComposition(e,t)}exchangeVideoDevicePositions(e,t){this.broadcastCanvasManager.exchangeVideoDevicePositions(e,t)}getAudioInputDevice(e){return this.broadcastCanvasManager.getAudioInputDevice(e)}getVideoInputDevice(e){return this.broadcastCanvasManager.getVideoInputDevice(e)}getConnectionState(){return this.peerClient.getConnectionState()}getSessionId(){return this.peerClient.getSessionId()}on(e,t){this.emitter.on(e,t)}off(e,t){this.emitter.off(e,t)}getAudioContext(){return this.broadcastCanvasManager.audioContext}attachPreview(e){this.broadcastCanvasManager.attachPreview(e)}detachPreview(){this.broadcastCanvasManager.detachPreview()}disableVideo(){this.broadcastCanvasManager.disableVideo()}enableVideo(){this.broadcastCanvasManager.enableVideo()}disableAudio(){this.broadcastCanvasManager.disableAudio()}enableAudio(){this.broadcastCanvasManager.enableAudio()}}function fr(e){return new AmazonIVSBroadcastClient(function(e){const t=new Config;return t.streamConfig=e.streamConfig,t.ingestEndpoint=e.ingestEndpoint,t.logger=e.logger,t.logLevel=e.logLevel,t.networkReconnectConfig=e.networkReconnectConfig,t}(e))}lr=new WeakSet,dr=function(e){if("string"!=typeof e||!/^[a-zA-Z0-9_-]+$/.test(e))throw new BroadcastClientError(We)};const gr="1.30.0";var mr;!function(e){e.PUBLISH="publish",e.SUBSCRIBE="subscribe",e.JOIN="join",e.LEAVE="leave"}(mr||(mr={}));const vr=2,Er="X-Stages-Options",Sr="cap";class LeaveEvent extends StageAnalyticsEvent{constructor(e){super(gt.LEAVE,e.token,e.traceId,!1),Object.assign(this.properties,{action:mr.LEAVE,event_endpoint:e.eventEndpoint,whip_endpoint:e.whipEndpoint,reason:e.reason}),this.critical=!0}}function _r(e){const t="0123456789abcdef";let n="";for(let r=0;r<e;r+=1)n+=t.charAt(Math.floor(16*Math.random()));return n}class RequestUUID{constructor(){const e=_r;this.value=`${e(8)}-${e(4)}-${e(4)}-${e(4)}-${e(12)}`}}function yr(){return new RequestUUID}class TraceId{constructor(){const e=(Date.now()/1e3|0).toString(16);this.value=`1-${e}-${_r(24)}`}}function br(){return new TraceId}var Tr,Cr,Ir;!function(e){e.MESSAGE="message",e.RESPONSE="response"}(Tr||(Tr={})),function(e){e.STAGE_DELETED="STAGE_DELETED",e.PARTICIPANT_DISCONNECTED="PARTICIPANT_DISCONNECTED",e.TOKEN_INVALID="TOKEN_INVALID",e.TOKEN_EXPIRED="TOKEN_EXPIRED",e.TOKEN_INVALID_SIGNATURE="TOKEN_INVALID_SIGNATURE",e.TOKEN_MISSING="TOKEN_MISSING",e.INTERNAL="INTERNAL",e.BAD_REQUEST="BAD_REQUEST"}(Cr||(Cr={})),function(e){e[e.BAD_REQUEST=400]="BAD_REQUEST",e[e.UNAUTHORIZED=401]="UNAUTHORIZED",e[e.FORBIDDEN=403]="FORBIDDEN",e[e.NOT_FOUND=404]="NOT_FOUND",e[e.INTERNAL_SERVER_ERROR=500]="INTERNAL_SERVER_ERROR"}(Ir||(Ir={}));class StageClientError extends BroadcastClientError{constructor({token:e,traceId:t,code:n,tag:r,location:i,message:o,details:s,remoteParticipantId:a,requestUUID:c,fatal:u,nominal:l,action:d,count:h=1}){super({name:"StageClientError",message:o,code:n}),Error.captureStackTrace&&Error.captureStackTrace(this,StageClientError),this.action=d,this.token=e,this.traceId=t,this.code=n,this.tag=r,this.location=i,this.message=o,this.details=s,this.remoteParticipantId=a,this.requestUUID=c,this.fatal=u,this.nominal=l,this.count=h}}const Rr="signalling_session",Or="webrtc_sink",wr="webrtc_unsink",Ar="webrtc_source";function kr(e,t){switch(e){case mr.PUBLISH:return Or;case mr.SUBSCRIBE:return`webrtc_source:${t}`;default:return"unknown"}}function Pr(e,t){var n,r,i,o;const s={code:e.code,message:`${e.message}: ${t.name} ${t.message}`,fatal:null!==(n=e.fatal)&&void 0!==n&&n,nominal:null!==(r=e.nominal)&&void 0!==r&&r};return t instanceof StageClientError&&(s.fatal=null!==(i=t.fatal)&&void 0!==i&&i,s.nominal=null!==(o=t.nominal)&&void 0!==o&&o),s}function Dr(e,t){if(0===e)return Lr.UNKNOWN_SERVER_ERROR;if(!(e<400))if(e>=400&&e<=403)switch(t){case Nr.TokenExpired:return Lr.EXPIRED_TOKEN;case Nr.NoPermissions:return Lr.TOKEN_PERMISSIONS_DENIED;case Nr.StageAtCapacity:return Lr.STAGE_AT_CAPACITY;case Nr.NoMatchingCodec:return Lr.NO_MATCHING_CODEC;default:return Lr.UNKNOWN_SERVER_ERROR}else{if(404===e)return t===Nr.RemoteStreamNotFound?Lr.REMOTE_STREAM_NOT_FOUND:Lr.UNKNOWN_SERVER_ERROR;if(412===e)return t===Nr.AbortedMHCPError?Lr.MHCP_ABORTED:Lr.UNKNOWN_SERVER_ERROR;if(429===e)return t===Nr.StageAuthThrottled?Lr.STAGE_AUTH_THROTTLED:Lr.WHIP_TOO_MANY_REQUESTS;if(500!==e)return Lr.UNKNOWN_SERVER_ERROR;switch(t){case Nr.InternalMHCPError:return Lr.INTERNAL_MHCP_ERROR;case Nr.UnreachableMHCP:return Lr.UNREACHABLE_MHCP;case Nr.InvalidSessionStatus:return Lr.INVALID_SESSION_STATUS;default:return Lr.INTERNAL_SERVER_ERROR}}}var Nr;!function(e){e[e.Unspecified=2001]="Unspecified",e[e.TokenExpired=2002]="TokenExpired",e[e.NoPermissions=2003]="NoPermissions",e[e.RemoteStreamNotFound=2004]="RemoteStreamNotFound",e[e.StageAtCapacity=2005]="StageAtCapacity",e[e.InternalMHCPError=2006]="InternalMHCPError",e[e.UncategorizedMHCPError=2007]="UncategorizedMHCPError",e[e.UnreachableMHCP=2008]="UnreachableMHCP",e[e.InvalidSessionStatus=2010]="InvalidSessionStatus",e[e.PostWithoutOptions=2011]="PostWithoutOptions",e[e.AbortedMHCPError=2012]="AbortedMHCPError",e[e.StageAuthThrottled=2013]="StageAuthThrottled",e[e.NoMatchingCodec=2014]="NoMatchingCodec"}(Nr||(Nr={}));const Lr={MALFORMED_TOKEN:{code:1e3,message:"Token is malformed",fatal:!0,nominal:!0},EXPIRED_TOKEN:{code:1001,message:"Token expired and is no longer valid",fatal:!0,nominal:!0},STAGE_DELETED:{code:1037,message:"Stage has been deleted",fatal:!0,nominal:!0},PARTICIPANT_DISCONNECTED:{code:1038,message:"Participant has been disconnected",fatal:!0,nominal:!0},JOIN_SERVER_INTERNAL_ERROR:{code:1039,message:"Internal server error during join",fatal:!1,nominal:!1},JOIN_SERVER_BAD_REQUEST:{code:1040,message:"Bad request during join",fatal:!0,nominal:!1},UNPUBLISH_FAILURE:{code:1013,message:"Failed to unpublish",fatal:!1,nominal:!1},UNSUBSCRIBE_FAILURE:{code:1014,message:"Failed to unsubscribe",fatal:!1,nominal:!1},PUBLISH_FAILURE:{code:1015,message:"Failed to publish",fatal:!1,nominal:!1},SUBSCRIBE_FAILURE:{code:1016,message:"Failed to subscribe",fatal:!1,nominal:!1},JOIN_FAILURE:{code:1017,message:"Failed to join",fatal:!0,nominal:!1},JOIN_TIMED_OUT:{code:1019,message:"Join timed out",fatal:!0,nominal:!1},PUBLISH_TIMED_OUT:{code:1020,message:"Publish timed out",fatal:!1,nominal:!1},SUBSCRIBE_TIMED_OUT:{code:1021,message:"Subscribe timed out",fatal:!1,nominal:!1},NO_CANDIDATES:{code:1022,message:"No ICE candidates",fatal:!1,nominal:!1},OPERATION_ABORTED:{code:1023,message:"Request aborted",fatal:!1,nominal:!0},STAGE_AT_CAPACITY:{code:1024,message:"Stage at capacity",fatal:!0,nominal:!0},INTERNAL_SERVER_ERROR:{code:1025,message:"Internal server error",fatal:!0,nominal:!1},TOKEN_PERMISSIONS_DENIED:{code:1026,message:"Token permissions are not valid for the operation",fatal:!0,nominal:!1},REMOTE_STREAM_NOT_FOUND:{code:1027,message:"Contributor group (PUBLISH) or remote stream (SUBSCRIBE) not found",fatal:!0,nominal:!1},INTERNAL_MHCP_ERROR:{code:1028,message:"Authorization failed due to internal MHCP error",fatal:!0,nominal:!1},UNCATEGORIZED_MHCP_ERROR:{code:1029,message:"Authorization failed due to uncategorized MHCP error",fatal:!0,nominal:!1},UNREACHABLE_MHCP:{code:1030,message:"Authorization failed due to MHCP unreachable",fatal:!0,nominal:!1},INVALID_SESSION_STATUS:{code:1031,message:"Stream has already been published (PUBLISH) or subscribed to (SUBSCRIBE)",fatal:!0,nominal:!1},POST_WITHOUT_OPTIONS:{code:1032,message:"Cannot POST without OPTIONS in mandatory TURN",fatal:!0,nominal:!1},MHCP_ABORTED:{code:1033,message:"Publisher state conflict",fatal:!0,nominal:!1},STAGE_AUTH_THROTTLED:{code:1034,message:"Too many requests",fatal:!1,nominal:!1},NO_MATCHING_CODEC:{code:1035,message:"No matching codec found",fatal:!0,nominal:!1},CHIME_MEETING_NOT_FOUND:{code:1098,message:"Meeting or Attendee was deleted",fatal:!0,nominal:!0},UNKNOWN_SERVER_ERROR:{code:1099,message:"Service error code unknown or not found",fatal:!0,nominal:!1},XDP_CONNECTION_LOST:{code:1221,message:"Connection lost during SDP exchange",fatal:!1,nominal:!1},XDP_INVALID_ANSWER_MSG:{code:1222,message:"Invalid answer message received by client",fatal:!1,nominal:!1},XDP_TIMEOUT:{code:1223,message:"Failed to receive SDP answer within timeout period",fatal:!1,nominal:!1},XDP_UNEXPECTED_ERROR:{code:1224,message:"Unexpected error encountered",fatal:!1,nominal:!1},WEBSOCKET_MESSAGE_PARSE_FAILURE:{code:1204,message:"Failed to parse websocket message",fatal:!1,nominal:!1},WHIP_SESSION_RESOURCE_DELETED:{code:1206,message:"WHIP signaling session resource not found",fatal:!0,nominal:!0},WHIP_TOO_MANY_REQUESTS:{code:1207,message:"WHIP endpoint received too many requests",fatal:!1,nominal:!1},WHIP_OPTIONS_FAILURE:{code:1501,message:"Failed to get ICE Servers from OPTIONS",fatal:!1,nominal:!1},WHIP_POST_FAILURE:{code:1502,message:"WHIP post failure",fatal:!1,nominal:!1},WHIP_DELETE_FAILURE:{code:1503,message:"WHIP delete failure",fatal:!1,nominal:!1},WHIP_URL_MISSING:{code:1504,message:"WHIP delete failure",fatal:!1,nominal:!1},WHEP_SET_LAYER_REQUEST_FAILED:{code:1510,message:"Set layer request failed for reason: Unknown",fatal:!1,nominal:!1},WHEP_SET_LAYER_REQUEST_THROTTLED:{code:1511,message:"Too many set layer requests",fatal:!1,nominal:!0},WHEP_GET_LAYER_STATE_FAILED:{code:1512,message:"Get layer state failed for reason: Unknown",fatal:!1,nominal:!1},WHEP_GET_LAYER_STATE_THROTTLED:{code:1513,message:"Too many get layer state requests",fatal:!1,nominal:!0},EVENT_PLANE_WS_CREATE_FAILED:{code:1300,message:"Error creating WebSocket",fatal:!0,nominal:!1},EVENT_PLANE_WS_UNEXPECTED_CLOSE:{code:1302,message:"Unexpectedly not connected to event plane",fatal:!1,nominal:!1},EVENT_PLANE_PING_SEND_FAIL:{code:1303,message:"Ping send fail",fatal:!1,nominal:!1},EVENT_PLANE_PONG_TIMEOUT:{code:1304,message:"Pong timed out",fatal:!1,nominal:!1},EVENT_PLANE_WS_CLOSE_BEFORE_OPEN:{code:1305,message:"Connect attempt closed by server",fatal:!1,nominal:!1},PEER_CONNECTION_NETWORK_FAILURE:{code:1400,message:"PeerConnection is lost due to unknown network error",fatal:!1,nominal:!1},CREATE_OFFER_FAILURE:{code:1402,message:"Failed to set local description",fatal:!1,nominal:!1},CREATE_PEER_CONNECTION_FAILURE:{code:1403,message:"Failed to create a peer connection",fatal:!1,nominal:!1},ICE_CANDIDATE_ERROR:{code:1404,message:"ICE candidate error",fatal:!1,nominal:!1},SET_ANSWER_FAILURE:{code:1405,message:"Failed to set remote answer",fatal:!1,nominal:!1},NETWORK_FAILURE:{code:1406,message:"Failed due to network problem",fatal:!1,nominal:!1},SEI_INSERT_NOT_PUBLISHING_VIDEO:{code:1460,message:"SEI failed to insert due to not publishing video",fatal:!1,nominal:!0},SEI_INSERT_INBAND_NOT_ENABLED:{code:1461,message:"SEI failed to insert due to in-band messaging not being enabled",fatal:!1,nominal:!0},REASSIGNMENT_REQUEST_INVALID_LOCAL_PARTICIPANT_ID:{code:1470,message:"Invalid participant id in the reassignment message",fatal:!1,nominal:!1},REASSIGNMENT_REQUEST_INVALID_REMOTE_PARTICIPANT_ID:{code:1471,message:"Invalid remote participant id in the reassignment message",fatal:!1,nominal:!1},REASSIGNMENT_REQUEST_INVALID_REMOTE_PEER_CONNECTION_STATE:{code:1472,message:"Invalid subscriber peer connection state for reassignment",fatal:!1,nominal:!1},REASSIGNMENT_REQUEST_ALREADY_IN_PROGRESS:{code:1473,message:"Request rejected because client is already processing a previous reassignment request",fatal:!1,nominal:!1},UNEXPECTED_ERROR:{code:9999,message:"Encountered unexpected error condition. Expected StageClientError type.",fatal:!1,nominal:!1},TRANSFORM_UNEXPECTED_ERROR:{code:1480,message:"Unexpected error occurred during transform execution",fatal:!1,nominal:!1},TRANSFORM_TOO_MANY_ERRORS:{code:1481,message:"Transformer encountered too many consecutive errors",fatal:!1,nominal:!1},TRANSFORM_NOT_SUPPORTED_BY_PLATFORM:{code:1482,message:"Transforms are not supported by this platform",fatal:!1,nominal:!1},CODEC_HANDLE_INCOMPATIBLE_UNEXPECTED_ERROR:{code:1490,message:"Unexpected error occurred when handling incompatible codecs",fatal:!1,nominal:!1}};var Mr;!function(e){e.UNPUBLISH="unpublish",e.UNSUBSCRIBE="unsubscribe",e.UNLOAD="unload",e.CONNECTION_FAIL="connection fail",e.REASSIGNMENT="reassignment"}(Mr||(Mr={}));const xr="stageJoined",Br="stageParticipantJoined",Ur="stageParticipantLeft",jr="stageParticipantKicked",Fr="stageParticipantUpdated",Vr="localPublishingChanged",Gr="stageRefresh",Hr="stateChange",Wr="error",$r="reassignmentRequest",qr="incompatibleCodecs",zr="connectionStateChange",Kr="mediaStreamCreated",Jr="mediaStreamRemoved",Yr="error",Qr="stageStreamSeiMessageReceived",Xr="transformError",Zr="reassignmentStarted",ei="reassignmentSuccess",ti="reassignmentFailed",ni="open",ri="closed",ii="messageParseError",oi="refresh",si="error",ai="stageStateMessage",ci="sdpAnswer",ui="disconnectMessage",li="reassignmentMessage",di="incompatibleCodecs",hi="ssu";function pi(e){const t=function(e){return e.replace(/-/g,"+").replace(/_/g,"/").padEnd(e.length+(4-e.length%4)%4,"=")}(e);return n=t,window.atob(n);var n}class StageToken{constructor(e,t){var n;this.analyticsTracker=t,this.rawToken=e;const r=e.split(".");if(3!==r.length)throw Error(`Token format incorrect. length: ${r.length}`);try{this.header=JSON.parse(pi(r[0]))}catch(e){const t=e instanceof Error?`: ${e.message}`:"";throw Error(`Error parsing Stage Token header${t}`)}try{this.claims=JSON.parse(pi(r[1]))}catch(e){const t=e instanceof Error?`: ${e.message}`:"";throw Error(`Error parsing Stage Token claims${t}`)}this.signature=r[2];const{claims:i}=this;this.stageARN=i.resource,this.customerId=null!==(n=function(e){if(e.indexOf("arn:aws:")<0)return;const t=e.split(":");return t.length>=5?t[4]:void 0}(this.stageARN))&&void 0!==n?n:"unknown",this.participantID=i.jti,this.eventsURL=i.events_url,this.whipURL=Et("whipUrl")||i.whip_url,this.userID=i.user_id,this.expirationTime=i.exp,this.topic=i.topic,this.parseVersionFlags(i.version);const{attributes:o}=i;o&&(this.attrGsRole=o.gs_role,this.attrGsSessionId=o.gs_session_id)}getPublishEndpoint(){let e="";return this.whipURL&&this.participantID&&(e=`${this.whipURL}/publish/${this.participantID}`),e}getSubscribeEndpoint(e){let t="";return this.whipURL&&(t=`${this.whipURL}/subscribe/${e}`),t}assertTokenIsUnexpired(e,t,n,r){St("disableTokenValidation")||(!this.expirationTime||Date.now()/1e3>=this.expirationTime)&&this.analyticsTracker.trackErrorAndThrow(new StageClientError(Object.assign(Object.assign({},Lr.EXPIRED_TOKEN),{action:mr.JOIN,location:n,tag:t,token:this,traceId:e,remoteParticipantId:r,message:Lr.EXPIRED_TOKEN.message,details:`Token expired at ${this.expirationTime} and is no longer valid`})))}parseVersionFlags(e){if(!e)return;const t=e.split(".");2===t.length&&(this.versionFlags=parseInt(t[1],10))}shouldSendSilentAudio(){return void 0===this.versionFlags||!!(this.versionFlags&vr)}}function fi(e,t){return new StageToken(e,t)}var gi;!function(e){e.PUBLISH="publish",e.SUBSCRIBE="subscribe"}(gi||(gi={}));class ThrottleTimer{constructor(e,t){this.throttleDuration=0,this.throttled=!1,this.timeout=0,this.unthrottle=()=>{this.trailing&&this.trailingFn&&this.trailingFn(...this.trailingFnArgs),this.clear()},this.throttleDuration=e,this.trailing=!(t&&t.skipTrailing)}invoke(e,...t){return this.throttled?(this.trailingFn=e,this.trailingFnArgs=t,!1):(this.throttled=!0,this.timeout=window.setTimeout(this.unthrottle,this.throttleDuration),e(...t),!0)}clear(){clearTimeout(this.timeout),this.timeout=0,this.throttled=!1,delete this.trailingFn,delete this.trailingFnArgs}}class ServerRequestEvent extends StageAnalyticsEvent{constructor(e,t,n,r,i,o,s,a){super(gt.SERVER_REQUEST,t,s,!0),Object.assign(this.properties,{action:e,http_method:r,remote_participant_id:o,request_uuid:i,url:n,transport:a})}}const mi="draft-ietf-wish-whip-04";class TraceEvent extends StageAnalyticsEvent{constructor(e,t,n,r,i){super(gt.TRACE,e,t,!1),Object.assign(this.properties,{action:r,message:n,remote_participant_id:i})}}class ConnectionStateEvent extends StageAnalyticsEvent{constructor(e,t,n,r,i){super(gt.CONNECTION_STATE,t,n,!1),Object.assign(this.properties,{action:e,remote_participant_id:i,state:r})}}class IceGatheringStateEvent extends StageAnalyticsEvent{constructor(e,t,n,r,i){super(gt.ICE_GATHERING_STATE,t,n,!1),Object.assign(this.properties,{action:e,remote_participant_id:i,state:r})}}var vi;!function(e){e.POST="post",e.CONNECTED="connected",e.ICE_GATHERING="icegathering",e.SDP_EXCHANGE="sdpExchange",e.SET_REMOTE_DESC="setRemoteDesc",e.PEER_CONNECTION="peerConnection"}(vi||(vi={}));const Ei="start",Si="stop";class PeerClientPerformanceTracker{constructor(e,t){this.marks={},this.optionsDuration=0,this.postDuration=0,this.timeToCandidate=0,this.timeToConnected=0,this.sdpExchangeDuration=0,this.sdpExchangeTransport="",this.setRemoteDescDuration=0,this.peerConnectionDuration=0,this.action=e,this.traceId=t}markActionStart(){this.markStart(vi.CONNECTED)}markPostStart(){this.markStart(vi.POST)}markPostStop(){this.markStop(vi.POST),this.postDuration=this.measure(vi.POST)}markIceGatheringStart(){this.markStart(vi.ICE_GATHERING)}markIceGatheringStop(){this.markStop(vi.ICE_GATHERING),this.timeToCandidate=this.measure(vi.ICE_GATHERING)}markActionStop(){this.markStop(vi.CONNECTED),this.timeToConnected=this.measure(vi.CONNECTED),this.markStop(vi.PEER_CONNECTION),this.peerConnectionDuration=this.measure(vi.PEER_CONNECTION)}markSetRemoteDescStart(){this.markStart(vi.SET_REMOTE_DESC)}markSetRemoteDescStop(){const e=vi.SET_REMOTE_DESC;this.markStop(e),this.setRemoteDescDuration=this.measure(e),this.markStart(vi.PEER_CONNECTION)}markSdpExchangeStart(){this.markStart(vi.SDP_EXCHANGE)}markSdpExchangeStop(){const e=vi.SDP_EXCHANGE;this.markStop(e),this.sdpExchangeDuration=this.measure(e)}setTransport(e){this.sdpExchangeTransport=e}markStart(e){this.marks[`${this.namespace}.${e}.${Ei}`]=performance.now()}markStop(e){this.marks[`${this.namespace}.${e}.${Si}`]=performance.now()}measure(e){const t=`${this.namespace}.${e}.${Ei}`,n=`${this.namespace}.${e}.${Si}`,r=this.marks[t],i=this.marks[n];return void 0===r||void 0===i?0:i-r}get namespace(){return`ivswb.peerclient.${this.action}.${this.traceId.value}`}getMeasurements(){const{optionsDuration:e,postDuration:t,timeToCandidate:n,timeToConnected:r,sdpExchangeDuration:i,sdpExchangeTransport:o,setRemoteDescDuration:s,peerConnectionDuration:a}=this;return{optionsDuration:e,postDuration:t,timeToCandidate:n,timeToConnected:r,sdpExchangeDuration:i,sdpExchangeTransport:o,setRemoteDescDuration:s,peerConnectionDuration:a}}resetMeasurements(e){this.traceId=e,this.marks={},this.optionsDuration=0,this.postDuration=0,this.timeToCandidate=0,this.timeToConnected=0,this.sdpExchangeDuration=0,this.sdpExchangeTransport="",this.setRemoteDescDuration=0,this.peerConnectionDuration=0}}var _i=n(7363);class SdpMunger{constructor(e){this.sdp=e}static splitLines(e){return e.trim().split("\n").map((e=>e.trim()))}static splitSections(e){return e.split("\nm=").map(((e,t)=>(t>0?`m=${e}`:e).trim()+SdpMunger.CRLF))}getUniqueRtpHeaderExtensionId(e){const t=[];for(const n of e)if(/^a=extmap:/.test(n.trim())){const e=+n.split("a=extmap:")[1].split(" ")[0];t.includes(e)||t.push(e)}t.sort(((e,t)=>e-t));let n=0;for(const e of t){if(e-n>1)return n+1;n=e}return 14===n?-1:n+1}withVideoLayersAllocationRtpHeaderExtension(e){const t="http://www.webrtc.org/experiments/rtp-hdrext/video-layers-allocation00",n=e?e.getRtpHeaderExtensionId(t):-1,r=-1===n?this.getUniqueRtpHeaderExtensionId(SdpMunger.splitLines(this.sdp)):n,i=SdpMunger.splitSections(this.sdp),o=[];for(let e of i){if(/^m=video/.test(e)&&-1===SdpMunger.getRtpHeaderExtensionIdInSection(e,t)){const n=SdpMunger.splitLines(e),i=[];if(-1===r||this.hasRtpHeaderExtensionId(r)){o.push(e);continue}for(const e of n)if(i.push(e),/^a=sendrecv/.test(e.trim())){const e=`a=extmap:${r} ${t}`;i.push(e)}e=i.join(SdpMunger.CRLF)+SdpMunger.CRLF}else if(-1!==n&&/^m=video/.test(e)&&SdpMunger.getRtpHeaderExtensionIdInSection(e,t)!==n){const r=SdpMunger.splitLines(e),i=[];for(const e of r){if(/^a=extmap:/.test(e.trim())){if(e.split("a=extmap:")[1].split(" ")[1]===t){if(!this.hasRtpHeaderExtensionId(n)){const e=`a=extmap:${n} ${t}`;i.push(e)}continue}}i.push(e)}e=i.join(SdpMunger.CRLF)+SdpMunger.CRLF}o.push(e)}const s=o.join("");return new SdpMunger(s)}withOpusAudioConfig(e,t){const n=_i.qg(this.sdp);for(const r of n.media)if("audio"===r.type){const{payload:n}=r.rtp.find((e=>"opus"===e.codec));if(!n)continue;let i=r.fmtp.find((e=>e.payload===n));i||(i={payload:n,config:""});const o=_i.Sl(i.config);if(o.maxaveragebitrate=e,"boolean"==typeof t){const e=t?1:0;o["sprop-stereo"]=e,o.stereo=e}let s="";for(const e of Object.keys(o))s+=`${e}=${o[e]}; `;i.config=s.trim()}return new SdpMunger(_i.M9(n))}withoutAudioRtcpRSize(){var e;const t=_i.qg(this.sdp);for(const n of t.media){if("audio"!==n.type)continue;const t=void 0!==Rt(),r=null!==(e=Rt())&&void 0!==e&&e;t&&(n.rtcpRsize=r?void 0:"rtcp-rsize")}return new SdpMunger(_i.M9(t))}withFilteredCandidates(e){const t=_i.qg(this.sdp);return t.media.forEach((t=>{const n=t.candidates;if(n){const r=n.filter((t=>t.transport===e));t.candidates=r}})),new SdpMunger(_i.M9(t))}static getRtpHeaderExtensionIdInSection(e,t){const n=SdpMunger.splitLines(e);for(const e of n)if(/^a=extmap:/.test(e.trim())){const n=e.split("a=extmap:")[1].split(" "),r=+n[0];if(n[1]===t)return r}return-1}getRtpHeaderExtensionId(e){const t=SdpMunger.splitSections(this.sdp);for(const n of t)if(/^m=video/.test(n)){const t=SdpMunger.getRtpHeaderExtensionIdInSection(n,e);if(-1!==t)return t}return-1}hasRtpHeaderExtensionId(e){const t=SdpMunger.splitLines(this.sdp);for(const n of t)if(/^a=extmap:/.test(n.trim())){if(+n.split("a=extmap:")[1].split(" ")[0]===e)return!0}return!1}hasAudioNacksEnabled(){var e,t,n;return(null!==(n=null===(t=(null!==(e=_i.qg(this.sdp).media.filter((e=>"audio"===e.type))[0])&&void 0!==e?e:{}).rtcpFb)||void 0===t?void 0:t.filter((e=>"nack"===e.type)))&&void 0!==n?n:[]).length>0}}function yi(e){const{config:t}=e;return[{maxBitrate:t.maxBitrateBps}]}SdpMunger.CRLF="\r\n",SdpMunger.rfc7587LowestBitrate=6e3,SdpMunger.rfc7587HighestBitrate=51e4;function bi(e){return 1e3*e}const Ti=(e,...t)=>{const n=t.map((e=>"object"!=typeof e)).filter(Boolean).length>0;if("object"==typeof e&&!n)return(0,mn.merge)({},e,...t)},Ci=e=>Ii(e),Ii=e=>(0,mn.cloneDeep)(e),Ri=e=>{switch(e){case un.HIGHEST_QUALITY:return"highest";case un.LOWEST_QUALITY:default:return"lowest"}},Oi=e=>Object.freeze(e),wi=Object.freeze({DEFAULT_1080:Oi({maxBitrateKbps:2500,maxFramerate:30,width:1920,height:1080}),INACTIVE:Oi({maxBitrateKbps:0,maxFramerate:0,width:0,height:0})}),Ai=Object.freeze({DEFAULT_720:Oi({maxBitrateKbps:2500,maxFramerate:30,width:1280,height:720}),DEFAULT_540:Oi({maxBitrateKbps:1400,maxFramerate:15,width:960,height:540}),DEFAULT_480:Oi({maxBitrateKbps:1100,maxFramerate:15,width:854,height:480}),DEFAULT_360:Oi({maxBitrateKbps:600,maxFramerate:15,width:640,height:360}),DEFAULT_270:Oi({maxBitrateKbps:350,maxFramerate:15,width:480,height:270}),DEFAULT_180:Oi({maxBitrateKbps:150,maxFramerate:15,width:320,height:180}),DEFAULT_160:Oi({maxBitrateKbps:120,maxFramerate:15,width:284,height:160})}),ki=Object.freeze({HI:Oi(Object.assign({},Ai.DEFAULT_720)),MID:Oi(Object.assign(Object.assign({},Ai.DEFAULT_360),{maxBitrateKbps:700,maxFramerate:20})),LOW:Oi(Object.assign(Object.assign({},Ai.DEFAULT_180),{maxBitrateKbps:200,maxFramerate:15}))}),Pi=e=>({rid:e,active:!1,scaleFactor:Di(e),maxBitrateBps:bi(wi.INACTIVE.maxBitrateKbps),maxFramerate:wi.INACTIVE.maxFramerate,width:wi.INACTIVE.width,height:wi.INACTIVE.height}),Di=e=>{switch(e){case dn.HI:return 1;case dn.MID:return 2;case dn.LOW:return 4;default:return 1}},Ni=50,Li=2500,Mi=10,xi=30,Bi=160,Ui=1280,ji=720*Ui,Fi=16/9,Vi=12,Gi=128,Hi=64,Wi={[fn.DEFAULT]:0,[fn.LOW]:50,[fn.MEDIUM]:150,[fn.HIGH]:250},$i={[fn.DEFAULT]:0,[fn.LOW]:100,[fn.MEDIUM]:200,[fn.HIGH]:300};function qi(e){const{outbound:t,remoteInbound:n,networkQuality:r}=e;return{networkQuality:r,nackCount:t.nackCount,packetsSent:t.packetsSent,packetsLost:null==n?void 0:n.packetsLost,retransmittedPacketsSent:t.retransmittedPacketsSent,bytesSent:t.bytesSent,headerBytesSent:t.headerBytesSent,retransmittedBytesSent:t.retransmittedBytesSent,totalPacketSendDelay:t.totalPacketSendDelay}}function zi(e){var t,n,r;const{outbound:i,remoteInbound:o,networkQuality:s}=e;return{networkQuality:s,nackCount:i.nackCount,packetsSent:i.packetsSent,packetsLost:null==o?void 0:o.packetsLost,retransmittedPacketsSent:i.retransmittedPacketsSent,bytesSent:i.bytesSent,headerBytesSent:i.headerBytesSent,retransmittedBytesSent:i.retransmittedBytesSent,totalPacketSendDelay:i.totalPacketSendDelay,firCount:i.firCount,pliCount:i.pliCount,framesEncoded:i.framesEncoded,keyFramesEncoded:i.keyFramesEncoded,totalEncodeTime:i.totalEncodeTime,totalEncodedBytesTarget:i.totalEncodedBytesTarget,framesSent:i.framesSent,hugeFramesSent:i.hugeFramesSent,active:0!==(null!==(t=i.framesPerSecond)&&void 0!==t?t:0),qualityLimitationReason:i.qualityLimitationReason,qualityLimitationResolutionChanges:i.qualityLimitationResolutionChanges,qualityLimitationCpuDuration:null===(n=i.qualityLimitationDurations)||void 0===n?void 0:n.cpu,qualityLimitationBandwidthDuration:null===(r=i.qualityLimitationDurations)||void 0===r?void 0:r.bandwidth,frameWidth:i.frameWidth,frameHeight:i.frameHeight,framesPerSecond:i.framesPerSecond,rid:i.rid,ssrc:i.ssrc}}function Ki(e,t){const n=new Map,r=new Map;for(const i of t.values())if(i.kind===e&&"outbound-rtp"===i.type&&i.ssrc){const e=i.rid||fe;r.set(i.ssrc,e);let t=n.get(e);t||(t={},n.set(e,t)),t.outbound=i}for(const i of t.values())if(i.kind===e&&"remote-inbound-rtp"===i.type&&i.ssrc){const e=r.get(i.ssrc)||fe,t=n.get(e);t&&(t.remoteInbound=i)}return n}function Ji(e,t){const n=new Map;for(const r of t.values())if(r.kind===e&&"inbound-rtp"===r.type){const e=r.rid||fe;n.set(e,{inbound:r})}return n}function Yi(e,t){return e!==Xt.DOWN&&null!=t?t:e}const Qi=(e,t)=>{const n=[],r=Ln.getNetworkQuality(),i=Ki("audio",e);for(const e of i.values())if(e.outbound){const i=e.outbound.rid||fe,o=Yi(r,t.get(i)),s=qi({outbound:e.outbound,remoteInbound:e.remoteInbound,networkQuality:o});n.push(s)}if(n.length)return n},Xi=(e,t)=>{const n=[],r=Ln.getNetworkQuality(),i=Ki("video",e);for(const e of i.values())if(e.outbound){const i=e.outbound.rid||fe,o=zi({outbound:e.outbound,remoteInbound:e.remoteInbound});if(o.active){const e=Yi(r,t.get(i));o.networkQuality=e}n.push(o)}if(n.length)return n},Zi=(e,t)=>{const n=[],r=Ln.getNetworkQuality(),i=Ji("audio",e);for(const e of i.values())if(e.inbound){const i=e.inbound.id;if(!i)continue;const s=Yi(r,t.get(i)),a={networkQuality:(o={inbound:e.inbound,networkQuality:s}).networkQuality,nackCount:o.inbound.nackCount,packetsReceived:o.inbound.packetsReceived,packetsLost:o.inbound.packetsLost,packetsDiscarded:o.inbound.packetsDiscarded,bytesReceived:o.inbound.bytesReceived,headerBytesReceived:o.inbound.headerBytesReceived,jitterBufferDelay:o.inbound.jitterBufferDelay,jitterBufferEmittedCount:o.inbound.jitterBufferEmittedCount,jitter:o.inbound.jitter,totalSamplesReceived:o.inbound.totalSamplesReceived,concealedSamples:o.inbound.concealedSamples,silentConcealedSamples:o.inbound.silentConcealedSamples,concealmentEvents:o.inbound.concealmentEvents,insertedSamplesForDeceleration:o.inbound.insertedSamplesForDeceleration,removedSamplesForAcceleration:o.inbound.removedSamplesForAcceleration,audioLevel:o.inbound.audioLevel};n.push(a)}var o;if(n.length)return n},eo=(e,t)=>{const n=[],r=Ln.getNetworkQuality(),i=Ji("video",e);for(const e of i.values())if(e.inbound){const i=e.inbound.id;if(!i)continue;const s={networkQuality:(o={inbound:e.inbound,networkQuality:Yi(r,t.get(i))}).networkQuality,nackCount:o.inbound.nackCount,packetsReceived:o.inbound.packetsReceived,packetsLost:o.inbound.packetsLost,packetsDiscarded:o.inbound.packetsDiscarded,bytesReceived:o.inbound.bytesReceived,headerBytesReceived:o.inbound.headerBytesReceived,jitterBufferDelay:o.inbound.jitterBufferDelay,jitterBufferEmittedCount:o.inbound.jitterBufferEmittedCount,jitter:o.inbound.jitter,pliCount:o.inbound.pliCount,firCount:o.inbound.firCount,framesReceived:o.inbound.framesReceived,framesDecoded:o.inbound.framesDecoded,keyFramesDecoded:o.inbound.keyFramesDecoded,framesDropped:o.inbound.framesDropped,totalDecodeTime:o.inbound.totalDecodeTime,totalInterFrameDelay:o.inbound.totalInterFrameDelay,totalSquaredInterFrameDelay:o.inbound.totalSquaredInterFrameDelay,pauseCount:o.inbound.pauseCount,totalPausesDuration:o.inbound.totalPausesDuration,freezeCount:o.inbound.freezeCount,totalFreezesDuration:o.inbound.totalFreezesDuration,frameWidth:o.inbound.frameWidth,frameHeight:o.inbound.frameHeight,framesPerSecond:o.inbound.framesPerSecond,ssrc:o.inbound.ssrc};n.push(s)}var o;if(n.length)return n};var to=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};const no="H264",ro=e=>{const t=null==e?void 0:e.split("/");if(2===(null==t?void 0:t.length))return t[1]},io=(e,t)=>{const n=ro(e);if(void 0===e||void 0===n)return;const r={mimeSubtype:n};if(t){const e=(e=>{const t=e.split(";"),n=new Map;for(const e of t){const[t,r]=e.split("=");n.set(t,r)}return n})(t);switch(n){case no:{const t=e.get("profile-level-id");t&&((e,t)=>{if(t.length<6)return;const n=t.substring(0,4),r=parseInt(t.substring(4,6),16);e.profile=n,e.level=r})(r,t);break}case"H265":((e,t)=>{const n=t.get("profile-id")||"0",r=t.get("tier-flag")||"0",i=parseInt(t.get("level-id")||"0",10),o=[r,n].join("_");e.profile=o,e.level=i})(r,e)}}return r},oo=(e,t)=>e.sort(((e,n)=>{if(ro(e.mimeType)===no){const n=io(e.mimeType,e.sdpFmtpLine);if((null==n?void 0:n.profile)===t)return-1}return 0})),so=(e,t)=>{var n;const r=io(e.mimeType,e.sdpFmtpLine);return(null==r?void 0:r.mimeSubtype.toLowerCase())===t.mime.toLowerCase()&&0===(null===(n=null==r?void 0:r.profile)||void 0===n?void 0:n.toLowerCase().indexOf(t.config.toLowerCase()))},ao=(e,t)=>t.filter((e=>!e.mimeType.endsWith("rtx"))).filter((e=>-1===e.mimeType.indexOf("packetization-mode=0"))).find((t=>e.reduce(((e,n)=>e&&!1===so(t,n)),!0)));class PublishedVideoStatsEvent extends StageAnalyticsEvent{constructor(e,t,n,r,i,o,s,a,c){var u,l;super(gt.PUBLISHED_VIDEO_STATS,e,t,!1),Object.assign(this.properties,Object.assign({action:mr.PUBLISH,node:null!==(u=null==n?void 0:n.node)&&void 0!==u?u:"",cluster:null!==(l=null==n?void 0:n.cluster)&&void 0!==l?l:""},((e,t,n,r,i,o)=>{var s,a,c,u,l,d,h,p,f,g,m,v,E,S,_,y,b,T,C,I,R,O,w,A,k,P,D,N,L,M,x,B,U;const j=null!==(a=null===(s=null==e?void 0:e.qualityLimitationDurations)||void 0===s?void 0:s.cpu)&&void 0!==a?a:0,F=null!==(u=null===(c=null==e?void 0:e.qualityLimitationDurations)||void 0===c?void 0:c.bandwidth)&&void 0!==u?u:0,V=Math.max(null!==(l=null==e?void 0:e.bytesSent)&&void 0!==l?l:0,0),G=8*V/(null!=o?o:1),H=Math.max(null!==(d=null==t?void 0:t.packetsLost)&&void 0!==d?d:0,0),W=Math.max(null!==(h=null==e?void 0:e.packetsSent)&&void 0!==h?h:0,0),$=H/Math.max(W,1),q=io(null==r?void 0:r.mimeType,null==r?void 0:r.sdpFmtpLine);return{active:!!(null==e?void 0:e.framesPerSecond)&&0!==e.framesPerSecond,bytes_sent:V,codec_mime_type:null==q?void 0:q.mimeSubtype,codec_profile:null==q?void 0:q.profile,codec_level:null==q?void 0:q.level,configured_bitrate:null==i?void 0:i.max_bitrate,connection_bandwidth:null!==(f=null===(p=null==n?void 0:n.candidatePair)||void 0===p?void 0:p.availableOutgoingBitrate)&&void 0!==f?f:0,encode_bitrate:G,encoder_implementation:null!==(g=null==e?void 0:e.encoderImplementation)&&void 0!==g?g:"unknown",fir_count:null!==(m=null==e?void 0:e.firCount)&&void 0!==m?m:0,fraction_packets_lost:$,frame_height:Math.max(null!==(v=null==e?void 0:e.frameHeight)&&void 0!==v?v:0,0),frame_width:Math.max(null!==(E=null==e?void 0:e.frameWidth)&&void 0!==E?E:0,0),frames_encoded:null!==(S=null==e?void 0:e.framesEncoded)&&void 0!==S?S:0,frames_per_second:Math.max(null!==(_=null==e?void 0:e.framesPerSecond)&&void 0!==_?_:0,0),frames_sent:null!==(y=null==e?void 0:e.framesSent)&&void 0!==y?y:0,header_bytes_sent:null!==(b=null==e?void 0:e.headerBytesSent)&&void 0!==b?b:0,huge_frames_sent:null!==(T=null==e?void 0:e.hugeFramesSent)&&void 0!==T?T:0,key_frames_encoded:null!==(C=null==e?void 0:e.keyFramesEncoded)&&void 0!==C?C:0,nack_count:null!==(I=null==e?void 0:e.nackCount)&&void 0!==I?I:0,packets_lost:H,packets_sent:W,power_efficient_encoder:null!==(R=null==e?void 0:e.powerEfficientEncoder)&&void 0!==R&&R,pli_count:null!==(O=null==e?void 0:e.pliCount)&&void 0!==O?O:0,quality_limitation_reason:null!==(w=null==e?void 0:e.qualityLimitationReason)&&void 0!==w?w:"none",quality_limitation_resolution_changes:null!==(A=null==e?void 0:e.qualityLimitationResolutionChanges)&&void 0!==A?A:0,quality_limitation_cpu_duration:j,quality_limitation_bandwidth_duration:F,retransmitted_bytes_sent:null!==(k=null==e?void 0:e.retransmittedBytesSent)&&void 0!==k?k:0,retransmitted_packets_sent:null!==(P=null==e?void 0:e.retransmittedPacketsSent)&&void 0!==P?P:0,rid:null!==(D=null==e?void 0:e.rid)&&void 0!==D?D:fe,scalability_mode:null!==(N=null==e?void 0:e.scalabilityMode)&&void 0!==N?N:"unknown",target_bitrate:Math.max(null!==(L=null==e?void 0:e.targetBitrate)&&void 0!==L?L:0,0),total_encode_time:null!==(M=null==e?void 0:e.totalEncodeTime)&&void 0!==M?M:0,total_encoded_bytes_target:null!==(x=null==e?void 0:e.totalEncodedBytesTarget)&&void 0!==x?x:0,total_packet_send_delay:null!==(B=null==e?void 0:e.totalPacketSendDelay)&&void 0!==B?B:0,protocol:null===(U=null==n?void 0:n.localCandidate)||void 0===U?void 0:U.protocol}})(r,i,o,s,a,c)))}}class PublishedVideoStatsWindowEvent extends StageAnalyticsEvent{constructor(e,t,n,r,i,o,s,a,c,u,l,d){var h,p,f,g;super(gt.PUBLISHED_VIDEO_STATS_WINDOW,e,t,!1);const m=Math.max((null!==(h=null==r?void 0:r.timestamp)&&void 0!==h?h:0)-(null!==(p=null==i?void 0:i.timestamp)&&void 0!==p?p:0),0);Object.assign(this.properties,Object.assign({action:mr.PUBLISH,node:null!==(f=null==n?void 0:n.node)&&void 0!==f?f:"",cluster:null!==(g=null==n?void 0:n.cluster)&&void 0!==g?g:"",window_size_ms:m},((e,t,n,r,i,o,s,a,c,u)=>{var l,d,h,p,f,g,m,v,E,S,_,y,b,T,C,I,R,O,w,A,k,P,D,N,L,M,x,B,U,j,F,V,G,H,W,$,q,z,K,J,Y,Q,X,Z,ee,te,ne,re,ie,oe,se,ae,ce,ue;const le=null!==(d=null===(l=null==e?void 0:e.qualityLimitationDurations)||void 0===l?void 0:l.cpu)&&void 0!==d?d:0,de=null!==(p=null===(h=null==t?void 0:t.qualityLimitationDurations)||void 0===h?void 0:h.cpu)&&void 0!==p?p:0,he=null!==(g=null===(f=null==e?void 0:e.qualityLimitationDurations)||void 0===f?void 0:f.bandwidth)&&void 0!==g?g:0,pe=null!==(v=null===(m=null==t?void 0:t.qualityLimitationDurations)||void 0===m?void 0:m.bandwidth)&&void 0!==v?v:0,ge=Math.max((null!==(E=null==e?void 0:e.bytesSent)&&void 0!==E?E:0)-(null!==(S=null==t?void 0:t.bytesSent)&&void 0!==S?S:0),0),me="number"!=typeof a?1:a/1e3,ve=8*ge/me,Ee=Math.max((null!==(_=null==n?void 0:n.packetsLost)&&void 0!==_?_:0)-(null!==(y=null==r?void 0:r.packetsLost)&&void 0!==y?y:0),0),Se=Math.max((null!==(b=null==e?void 0:e.packetsSent)&&void 0!==b?b:0)-(null!==(T=null==t?void 0:t.packetsSent)&&void 0!==T?T:0),0),_e=Ee/Math.max(Se,1),ye=io(null==o?void 0:o.mimeType,null==o?void 0:o.sdpFmtpLine),be=8*(u||0)/me;return{active:!!(null==e?void 0:e.framesPerSecond)&&0!==(null==e?void 0:e.framesPerSecond),bytes_sent:ge,codec_mime_type:null==ye?void 0:ye.mimeSubtype,codec_profile:null==ye?void 0:ye.profile,codec_level:null==ye?void 0:ye.level,configured_bitrate:null==s?void 0:s.max_bitrate,connection_bandwidth:null!==(I=null===(C=null==i?void 0:i.candidatePair)||void 0===C?void 0:C.availableOutgoingBitrate)&&void 0!==I?I:0,encode_bitrate:ve,encoder_implementation:null!==(R=null==e?void 0:e.encoderImplementation)&&void 0!==R?R:"unknown",fir_count:Math.max((null!==(O=null==e?void 0:e.firCount)&&void 0!==O?O:0)-(null!==(w=null==t?void 0:t.firCount)&&void 0!==w?w:0),0),fraction_packets_lost:_e,frame_height:Math.max(null!==(A=null==e?void 0:e.frameHeight)&&void 0!==A?A:0,0),frame_width:Math.max(null!==(k=null==e?void 0:e.frameWidth)&&void 0!==k?k:0,0),frames_encoded:Math.max((null!==(P=null==e?void 0:e.framesEncoded)&&void 0!==P?P:0)-(null!==(D=null==t?void 0:t.framesEncoded)&&void 0!==D?D:0),0),frames_per_second:Math.max(null!==(N=null==e?void 0:e.framesPerSecond)&&void 0!==N?N:0,0),frames_sent:Math.max((null!==(L=null==e?void 0:e.framesSent)&&void 0!==L?L:0)-(null!==(M=null==t?void 0:t.framesSent)&&void 0!==M?M:0),0),header_bytes_sent:Math.max((null!==(x=null==e?void 0:e.headerBytesSent)&&void 0!==x?x:0)-(null!==(B=null==t?void 0:t.headerBytesSent)&&void 0!==B?B:0),0),huge_frames_sent:Math.max((null!==(U=null==e?void 0:e.hugeFramesSent)&&void 0!==U?U:0)-(null!==(j=null==t?void 0:t.hugeFramesSent)&&void 0!==j?j:0),0),key_frames_encoded:Math.max((null!==(F=null==e?void 0:e.keyFramesEncoded)&&void 0!==F?F:0)-(null!==(V=null==t?void 0:t.keyFramesEncoded)&&void 0!==V?V:0),0),nack_count:Math.max((null!==(G=null==e?void 0:e.nackCount)&&void 0!==G?G:0)-(null!==(H=null==t?void 0:t.nackCount)&&void 0!==H?H:0),0),packets_lost:Ee,packets_sent:Se,power_efficient_encoder:null!==(W=null==e?void 0:e.powerEfficientEncoder)&&void 0!==W&&W,pli_count:Math.max((null!==($=null==e?void 0:e.pliCount)&&void 0!==$?$:0)-(null!==(q=null==t?void 0:t.pliCount)&&void 0!==q?q:0),0),quality_limitation_reason:null!==(z=null==e?void 0:e.qualityLimitationReason)&&void 0!==z?z:"none",quality_limitation_resolution_changes:Math.max((null!==(K=null==e?void 0:e.qualityLimitationResolutionChanges)&&void 0!==K?K:0)-(null!==(J=null==t?void 0:t.qualityLimitationResolutionChanges)&&void 0!==J?J:0),0),quality_limitation_cpu_duration:Math.max(le-de,0),quality_limitation_bandwidth_duration:Math.max(he-pe,0),retransmitted_bytes_sent:Math.max((null!==(Y=null==e?void 0:e.retransmittedBytesSent)&&void 0!==Y?Y:0)-(null!==(Q=null==t?void 0:t.retransmittedBytesSent)&&void 0!==Q?Q:0),0),rid:null!==(X=null==e?void 0:e.rid)&&void 0!==X?X:fe,retransmitted_packets_sent:Math.max((null!==(Z=null==e?void 0:e.retransmittedPacketsSent)&&void 0!==Z?Z:0)-(null!==(ee=null==t?void 0:t.retransmittedPacketsSent)&&void 0!==ee?ee:0),0),scalability_mode:null!==(te=null==e?void 0:e.scalabilityMode)&&void 0!==te?te:"unknown",target_bitrate:Math.max(null!==(ne=null==e?void 0:e.targetBitrate)&&void 0!==ne?ne:0,0),total_encode_time:Math.max((null!==(re=null==e?void 0:e.totalEncodeTime)&&void 0!==re?re:0)-(null!==(ie=null==t?void 0:t.totalEncodeTime)&&void 0!==ie?ie:0),0),total_encoded_bytes_target:Math.max((null!==(oe=null==e?void 0:e.totalEncodedBytesTarget)&&void 0!==oe?oe:0)-(null!==(se=null==t?void 0:t.totalEncodedBytesTarget)&&void 0!==se?se:0),0),total_packet_send_delay:Math.max((null!==(ae=null==e?void 0:e.totalPacketSendDelay)&&void 0!==ae?ae:0)-(null!==(ce=null==t?void 0:t.totalPacketSendDelay)&&void 0!==ce?ce:0),0),sei_write_count:c,sei_bytes_sent:u,sei_bitrate:be,protocol:null===(ue=null==i?void 0:i.localCandidate)||void 0===ue?void 0:ue.protocol}})(r,i,o,s,a,c,u,m,l,d)))}}class PublishedAudioStatsEvent extends StageAnalyticsEvent{constructor(e,t,n,r,i,o,s,a,c,u){var l,d;super(gt.PUBLISHED_AUDIO_STATS,e,t,!1),Object.assign(this.properties,Object.assign({action:mr.PUBLISH,node:null!==(l=null==n?void 0:n.node)&&void 0!==l?l:"",cluster:null!==(d=null==n?void 0:n.cluster)&&void 0!==d?d:""},((e,t,n,r,i,o,s)=>{var a,c,u,l,d,h,p,f,g,m,v,E,S;const _=Math.max(null!==(a=null==e?void 0:e.bytesSent)&&void 0!==a?a:0,0),y=8*_/(null!=o?o:1),b=Math.max(null!==(c=null==t?void 0:t.packetsLost)&&void 0!==c?c:0,0),T=Math.max(null!==(u=null==e?void 0:e.packetsSent)&&void 0!==u?u:0,0),C=b/Math.max(T,1),I=io(null==r?void 0:r.mimeType,null==r?void 0:r.sdpFmtpLine);return{audio_nacks_enabled:null!==(l=null==s?void 0:s.audioNacks)&&void 0!==l&&l,bytes_sent:_,codec_mime_type:null==I?void 0:I.mimeSubtype,configured_bitrate:null!==(d=null==i?void 0:i.max_audio_bitrate_bps)&&void 0!==d?d:0,connection_bandwidth:null!==(p=null===(h=null==n?void 0:n.candidatePair)||void 0===h?void 0:h.availableOutgoingBitrate)&&void 0!==p?p:0,encode_bitrate:y,fraction_packets_lost:C,header_bytes_sent:null!==(f=null==e?void 0:e.headerBytesSent)&&void 0!==f?f:0,nack_count:null!==(g=null==e?void 0:e.nackCount)&&void 0!==g?g:0,packets_lost:b,packets_sent:T,retransmitted_bytes_sent:null!==(m=null==e?void 0:e.retransmittedBytesSent)&&void 0!==m?m:0,retransmitted_packets_sent:null!==(v=null==e?void 0:e.retransmittedPacketsSent)&&void 0!==v?v:0,target_bitrate:null!==(E=null==e?void 0:e.targetBitrate)&&void 0!==E?E:0,protocol:null===(S=null==n?void 0:n.localCandidate)||void 0===S?void 0:S.protocol}})(r,i,o,s,a,c,u)))}}class PublishedAudioStatsWindowEvent extends StageAnalyticsEvent{constructor(e,t,n,r,i,o,s,a,c,u,l){var d,h,p,f;super(gt.PUBLISHED_AUDIO_STATS_WINDOW,e,t,!1);const g=Math.max((null!==(d=null==r?void 0:r.timestamp)&&void 0!==d?d:0)-(null!==(h=null==i?void 0:i.timestamp)&&void 0!==h?h:0),0);Object.assign(this.properties,Object.assign({action:mr.PUBLISH,node:null!==(p=null==n?void 0:n.node)&&void 0!==p?p:"",cluster:null!==(f=null==n?void 0:n.cluster)&&void 0!==f?f:"",window_size_ms:g},((e,t,n,r,i,o,s,a,c)=>{var u,l,d,h,p,f,g,m,v,E,S,_,y,b,T,C,I,R,O,w,A,k;const P=Math.max((null!==(u=null==e?void 0:e.bytesSent)&&void 0!==u?u:0)-(null!==(l=null==t?void 0:t.bytesSent)&&void 0!==l?l:0),0),D=8*P/("number"!=typeof a?1:a/1e3),N=Math.max((null!==(d=null==n?void 0:n.packetsLost)&&void 0!==d?d:0)-(null!==(h=null==r?void 0:r.packetsLost)&&void 0!==h?h:0),0),L=Math.max((null!==(p=null==e?void 0:e.packetsSent)&&void 0!==p?p:0)-(null!==(f=null==t?void 0:t.packetsSent)&&void 0!==f?f:0),0),M=N/Math.max(L,1),x=io(null==o?void 0:o.mimeType,null==o?void 0:o.sdpFmtpLine);return{audio_nacks_enabled:null!==(g=null==c?void 0:c.audioNacks)&&void 0!==g&&g,bytes_sent:P,codec_mime_type:null==x?void 0:x.mimeSubtype,configured_bitrate:null!==(m=null==s?void 0:s.max_audio_bitrate_bps)&&void 0!==m?m:0,connection_bandwidth:null!==(E=null===(v=null==i?void 0:i.candidatePair)||void 0===v?void 0:v.availableOutgoingBitrate)&&void 0!==E?E:0,encode_bitrate:D,fraction_packets_lost:M,header_bytes_sent:Math.max((null!==(S=null==e?void 0:e.headerBytesSent)&&void 0!==S?S:0)-(null!==(_=null==t?void 0:t.headerBytesSent)&&void 0!==_?_:0),0),nack_count:Math.max((null!==(y=null==e?void 0:e.nackCount)&&void 0!==y?y:0)-(null!==(b=null==t?void 0:t.nackCount)&&void 0!==b?b:0),0),packets_lost:N,packets_sent:Math.max((null!==(T=null==e?void 0:e.packetsSent)&&void 0!==T?T:0)-(null!==(C=null==t?void 0:t.packetsSent)&&void 0!==C?C:0),0),retransmitted_bytes_sent:Math.max((null!==(I=null==e?void 0:e.retransmittedBytesSent)&&void 0!==I?I:0)-(null!==(R=null==t?void 0:t.retransmittedBytesSent)&&void 0!==R?R:0),0),retransmitted_packets_sent:Math.max((null!==(O=null==e?void 0:e.retransmittedPacketsSent)&&void 0!==O?O:0)-(null!==(w=null==t?void 0:t.retransmittedPacketsSent)&&void 0!==w?w:0),0),target_bitrate:Math.max(null!==(A=null==e?void 0:e.targetBitrate)&&void 0!==A?A:0,0),protocol:null===(k=null==i?void 0:i.localCandidate)||void 0===k?void 0:k.protocol}})(r,i,o,s,a,c,u,g,l)))}}class SubscribedVideoStatsEvent extends StageAnalyticsEvent{constructor(e,t,n,r,i,o,s,a){var c,u;super(gt.SUBSCRIBED_VIDEO_STATS,e,t,!1),Object.assign(this.properties,Object.assign({action:mr.SUBSCRIBE,node:null!==(c=null==r?void 0:r.node)&&void 0!==c?c:"",cluster:null!==(u=null==r?void 0:r.cluster)&&void 0!==u?u:"",remote_participant_id:n},((e,t,n,r)=>{var i,o,s,a,c,u,l,d,h,p,f,g,m,v,E,S,_,y,b,T,C,I,R,O;let w=0;(null==e?void 0:e.jitterBufferDelay)&&(null==e?void 0:e.jitterBufferEmittedCount)&&e.jitterBufferEmittedCount>0&&(w=e.jitterBufferDelay/e.jitterBufferEmittedCount);const A=null!=r?r:1,k=Math.max(null!==(i=null==e?void 0:e.bytesReceived)&&void 0!==i?i:0,0),P=8*k/A;let D=0;(null==e?void 0:e.totalDecodeTime)&&(null==e?void 0:e.framesDecoded)&&(D=e.totalDecodeTime/Math.max(null==e?void 0:e.framesDecoded,1));const N=Math.max(null!==(o=null==e?void 0:e.packetsLost)&&void 0!==o?o:0,0),L=Math.max(null!==(s=null==e?void 0:e.packetsReceived)&&void 0!==s?s:0,0),M=N/Math.max(L+N,1),x=io(null==n?void 0:n.mimeType,null==n?void 0:n.sdpFmtpLine);return{bytes_received:k,codec_mime_type:null==x?void 0:x.mimeSubtype,codec_profile:null==x?void 0:x.profile,codec_level:null==x?void 0:x.level,connection_bandwidth:null!==(c=null===(a=null==t?void 0:t.candidatePair)||void 0===a?void 0:a.availableIncomingBitrate)&&void 0!==c?c:0,decode_bitrate:P,decoder_implementation:null!==(u=null==e?void 0:e.decoderImplementation)&&void 0!==u?u:"unknown",fir_count:Math.max(null!==(l=null==e?void 0:e.firCount)&&void 0!==l?l:0,0),fraction_packets_lost:M,frame_decode_time_avg:D,frame_height:Math.max(null!==(d=null==e?void 0:e.frameHeight)&&void 0!==d?d:0,0),frame_width:Math.max(null!==(h=null==e?void 0:e.frameWidth)&&void 0!==h?h:0,0),frames_decoded:Math.max(null!==(p=null==e?void 0:e.framesDecoded)&&void 0!==p?p:0,0),frames_dropped:Math.max(null!==(f=null==e?void 0:e.framesDropped)&&void 0!==f?f:0,0),frames_received:Math.max(null!==(g=null==e?void 0:e.framesReceived)&&void 0!==g?g:0,0),freeze_count:Math.max(null!==(m=null==e?void 0:e.freezeCount)&&void 0!==m?m:0,0),frames_rendered:Math.max(null!==(v=null==e?void 0:e.framesRendered)&&void 0!==v?v:0,0),frames_per_second:Math.max(null!==(E=null==e?void 0:e.framesPerSecond)&&void 0!==E?E:0,0),header_bytes_received:Math.max(null!==(S=null==e?void 0:e.headerBytesReceived)&&void 0!==S?S:0,0),jitter_buffer_delay_avg:w,key_frames_decoded:Math.max(null!==(_=null==e?void 0:e.keyFramesDecoded)&&void 0!==_?_:0,0),nack_count:Math.max(null!==(y=null==e?void 0:e.nackCount)&&void 0!==y?y:0,0),packets_discarded:Math.max(null!==(b=null==e?void 0:e.packetsDiscarded)&&void 0!==b?b:0,0),packets_lost:N,packets_received:L,pause_count:Math.max(null!==(T=null==e?void 0:e.pauseCount)&&void 0!==T?T:0,0),pli_count:Math.max(null!==(C=null==e?void 0:e.pliCount)&&void 0!==C?C:0,0),power_efficient_decoder:null!==(I=null==e?void 0:e.powerEfficientDecoder)&&void 0!==I&&I,total_freezes_duration:Math.max(null!==(R=null==e?void 0:e.totalFreezesDuration)&&void 0!==R?R:0,0),total_pauses_duration:Math.max(null!==(O=null==e?void 0:e.totalPausesDuration)&&void 0!==O?O:0,0)}})(i,o,s,a)))}}class SubscribedVideoStatsWindowEvent extends StageAnalyticsEvent{constructor(e,t,n,r,i,o,s,a,c,u,l){var d,h,p,f;super(gt.SUBSCRIBED_VIDEO_STATS_WINDOW,e,t,!1);const g=Math.max((null!==(d=null==i?void 0:i.timestamp)&&void 0!==d?d:0)-(null!==(h=null==o?void 0:o.timestamp)&&void 0!==h?h:0),0);Object.assign(this.properties,Object.assign({action:mr.SUBSCRIBE,node:null!==(p=null==r?void 0:r.node)&&void 0!==p?p:"",cluster:null!==(f=null==r?void 0:r.cluster)&&void 0!==f?f:"",window_size_ms:g,remote_participant_id:n},((e,t,n,r,i,o,s,a)=>{var c,u,l,d,h,p,f,g,m,v,E,S,_,y,b,T,C,I,R,O,w,A,k,P,D,N,L,M,x,B,U,j,F,V,G,H,W,$,q,z,K,J,Y,Q,X;let Z=0,ee=0;if((null==e?void 0:e.jitterBufferEmittedCount)&&(null==t?void 0:t.jitterBufferEmittedCount)&&e.jitterBufferEmittedCount>t.jitterBufferEmittedCount){(null==e?void 0:e.jitterBufferDelay)&&(null==t?void 0:t.jitterBufferDelay)&&(Z=(e.jitterBufferDelay-t.jitterBufferDelay)/(e.jitterBufferEmittedCount-t.jitterBufferEmittedCount));const n=null==t?void 0:t.jitterBufferMinimumDelay,r=null==e?void 0:e.jitterBufferMinimumDelay;n&&r&&(ee=(r-n)/(e.jitterBufferEmittedCount-t.jitterBufferEmittedCount))}const te=Math.max((null!==(c=null==e?void 0:e.bytesReceived)&&void 0!==c?c:0)-(null!==(u=null==t?void 0:t.bytesReceived)&&void 0!==u?u:0),0),ne="number"!=typeof i?1:i/1e3,re=8*te/ne,ie=Math.max((null!==(l=null==e?void 0:e.totalDecodeTime)&&void 0!==l?l:0)-(null!==(d=null==t?void 0:t.totalDecodeTime)&&void 0!==d?d:0),0),oe=Math.max((null!==(h=null==e?void 0:e.framesDecoded)&&void 0!==h?h:0)-(null!==(p=null==t?void 0:t.framesDecoded)&&void 0!==p?p:0),0),se=ie/Math.max(oe,1),ae=Math.max((null!==(f=null==e?void 0:e.packetsLost)&&void 0!==f?f:0)-(null!==(g=null==t?void 0:t.packetsLost)&&void 0!==g?g:0),0),ce=Math.max((null!==(m=null==e?void 0:e.packetsReceived)&&void 0!==m?m:0)-(null!==(v=null==t?void 0:t.packetsReceived)&&void 0!==v?v:0),0),ue=ae/Math.max(ce+ae,1),le=io(null==r?void 0:r.mimeType,null==r?void 0:r.sdpFmtpLine),de=8*(a||0)/ne;return{bytes_received:te,codec_mime_type:null==le?void 0:le.mimeSubtype,codec_profile:null==le?void 0:le.profile,codec_level:null==le?void 0:le.level,connection_bandwidth:null!==(S=null===(E=null==n?void 0:n.candidatePair)||void 0===E?void 0:E.availableIncomingBitrate)&&void 0!==S?S:0,decode_bitrate:re,decoder_implementation:null!==(_=null==e?void 0:e.decoderImplementation)&&void 0!==_?_:"unknown",fir_count:Math.max((null!==(y=null==e?void 0:e.firCount)&&void 0!==y?y:0)-(null!==(b=null==t?void 0:t.firCount)&&void 0!==b?b:0),0),fraction_packets_lost:ue,frame_decode_time_avg:se,frame_height:Math.max(null!==(T=null==e?void 0:e.frameHeight)&&void 0!==T?T:0,0),frame_width:Math.max(null!==(C=null==e?void 0:e.frameWidth)&&void 0!==C?C:0,0),frames_decoded:Math.max((null!==(I=null==e?void 0:e.framesDecoded)&&void 0!==I?I:0)-(null!==(R=null==t?void 0:t.framesDecoded)&&void 0!==R?R:0),0),frames_dropped:Math.max((null!==(O=null==e?void 0:e.framesDropped)&&void 0!==O?O:0)-(null!==(w=null==t?void 0:t.framesDropped)&&void 0!==w?w:0),0),frames_received:Math.max((null!==(A=null==e?void 0:e.framesReceived)&&void 0!==A?A:0)-(null!==(k=null==t?void 0:t.framesReceived)&&void 0!==k?k:0),0),freeze_count:Math.max((null!==(P=null==e?void 0:e.freezeCount)&&void 0!==P?P:0)-(null!==(D=null==t?void 0:t.freezeCount)&&void 0!==D?D:0),0),frames_rendered:Math.max(null!==(N=null==e?void 0:e.framesRendered)&&void 0!==N?N:0,0),frames_per_second:Math.max(null!==(L=null==e?void 0:e.framesPerSecond)&&void 0!==L?L:0,0),header_bytes_received:Math.max((null!==(M=null==e?void 0:e.headerBytesReceived)&&void 0!==M?M:0)-(null!==(x=null==t?void 0:t.headerBytesReceived)&&void 0!==x?x:0),0),configured_jitter_buffer_min_delay_ms:null!=o?o:0,jitter_buffer_min_obtainable_delay:ee,jitter_buffer_delay_avg:Z,key_frames_decoded:Math.max((null!==(B=null==e?void 0:e.keyFramesDecoded)&&void 0!==B?B:0)-(null!==(U=null==t?void 0:t.keyFramesDecoded)&&void 0!==U?U:0),0),nack_count:Math.max((null!==(j=null==e?void 0:e.nackCount)&&void 0!==j?j:0)-(null!==(F=null==t?void 0:t.nackCount)&&void 0!==F?F:0),0),packets_discarded:Math.max((null!==(V=null==e?void 0:e.packetsDiscarded)&&void 0!==V?V:0)-(null!==(G=null==t?void 0:t.packetsDiscarded)&&void 0!==G?G:0),0),packets_lost:ae,packets_received:ce,pause_count:Math.max((null!==(H=null==e?void 0:e.pauseCount)&&void 0!==H?H:0)-(null!==(W=null==t?void 0:t.pauseCount)&&void 0!==W?W:0),0),pli_count:Math.max((null!==($=null==e?void 0:e.pliCount)&&void 0!==$?$:0)-(null!==(q=null==t?void 0:t.pliCount)&&void 0!==q?q:0),0),power_efficient_decoder:null!==(z=null==e?void 0:e.powerEfficientDecoder)&&void 0!==z&&z,total_freezes_duration:Math.max((null!==(K=null==e?void 0:e.totalFreezesDuration)&&void 0!==K?K:0)-(null!==(J=null==t?void 0:t.totalFreezesDuration)&&void 0!==J?J:0),0),total_pauses_duration:Math.max((null!==(Y=null==e?void 0:e.totalPausesDuration)&&void 0!==Y?Y:0)-(null!==(Q=null==t?void 0:t.totalPausesDuration)&&void 0!==Q?Q:0),0),sei_read_count:s,sei_bytes_received:a,sei_bitrate:de,protocol:null===(X=null==n?void 0:n.localCandidate)||void 0===X?void 0:X.protocol}})(i,o,s,a,g,c,u,l)))}}class SubscribedAudioStatsEvent extends StageAnalyticsEvent{constructor(e,t,n,r,i,o,s,a,c){var u,l;super(gt.SUBSCRIBED_AUDIO_STATS,e,t,!1),Object.assign(this.properties,Object.assign({action:mr.SUBSCRIBE,node:null!==(u=null==r?void 0:r.node)&&void 0!==u?u:"",cluster:null!==(l=null==r?void 0:r.cluster)&&void 0!==l?l:"",remote_participant_id:n},((e,t,n,r,i)=>{var o,s,a,c,u,l,d,h,p,f,g,m,v,E,S,_,y,b;let T=0;(null==e?void 0:e.jitterBufferDelay)&&(null==e?void 0:e.jitterBufferEmittedCount)&&e.jitterBufferEmittedCount>0&&(T=e.jitterBufferDelay/e.jitterBufferEmittedCount);const C=null!=r?r:1,I=Math.max(null!==(o=null==e?void 0:e.bytesReceived)&&void 0!==o?o:0,0),R=8*I/C,O=Math.max(null!==(s=null==e?void 0:e.packetsLost)&&void 0!==s?s:0,0),w=Math.max(null!==(a=null==e?void 0:e.packetsReceived)&&void 0!==a?a:0,0),A=O/Math.max(w+O,1),k=Math.max(null!==(c=null==e?void 0:e.concealedSamples)&&void 0!==c?c:0,0),P=Math.max(null!==(u=null==e?void 0:e.totalSamplesReceived)&&void 0!==u?u:0,0),D=k/Math.max(P,1),N=io(null==n?void 0:n.mimeType,null==n?void 0:n.sdpFmtpLine);return{audio_level:null!==(l=null==e?void 0:e.audioLevel)&&void 0!==l?l:0,audio_nacks_enabled:null!==(d=null==i?void 0:i.audioNacks)&&void 0!==d&&d,bytes_received:I,codec_mime_type:null==N?void 0:N.mimeSubtype,connection_bandwidth:null!==(p=null===(h=null==t?void 0:t.candidatePair)||void 0===h?void 0:h.availableIncomingBitrate)&&void 0!==p?p:0,concealed_samples:k,concealment_events:Math.max(null!==(f=null==e?void 0:e.concealmentEvents)&&void 0!==f?f:0,0),silent_concealed_samples:Math.max(null!==(g=null==e?void 0:e.silentConcealedSamples)&&void 0!==g?g:0,0),decode_bitrate:R,fraction_audio_concealed:D,fraction_packets_lost:A,header_bytes_received:Math.max(null!==(m=null==e?void 0:e.headerBytesReceived)&&void 0!==m?m:0,0),inserted_samples_for_deceleration:Math.max(null!==(v=null==e?void 0:e.insertedSamplesForDeceleration)&&void 0!==v?v:0,0),jitter_buffer_delay_avg:T,packets_discarded:Math.max(null!==(E=null==e?void 0:e.packetsDiscarded)&&void 0!==E?E:0,0),retransmitted_packets_received:Math.max(null!==(S=null==e?void 0:e.retransmittedPacketsReceived)&&void 0!==S?S:0,0),retransmitted_bytes_received:Math.max(null!==(_=null==e?void 0:e.retransmittedBytesReceived)&&void 0!==_?_:0,0),packets_lost:O,packets_received:w,nack_count:Math.max(null!==(y=null==e?void 0:e.nackCount)&&void 0!==y?y:0,0),removed_samples_for_acceleration:Math.max(null!==(b=null==e?void 0:e.removedSamplesForAcceleration)&&void 0!==b?b:0,0),total_samples_received:P}})(i,o,s,a,c)))}}class SubscribedAudioStatsWindowEvent extends StageAnalyticsEvent{constructor(e,t,n,r,i,o,s,a,c,u){var l,d,h,p;super(gt.SUBSCRIBED_AUDIO_STATS_WINDOW,e,t,!1);const f=Math.max((null!==(l=null==i?void 0:i.timestamp)&&void 0!==l?l:0)-(null!==(d=null==o?void 0:o.timestamp)&&void 0!==d?d:0),0);Object.assign(this.properties,Object.assign({action:mr.SUBSCRIBE,window_size_ms:f,node:null!==(h=null==r?void 0:r.node)&&void 0!==h?h:"",cluster:null!==(p=null==r?void 0:r.cluster)&&void 0!==p?p:"",remote_participant_id:n},((e,t,n,r,i,o,s)=>{var a,c,u,l,d,h,p,f,g,m,v,E,S,_,y,b,T,C,I,R,O,w,A,k,P,D,N,L,M,x,B,U,j;let F=0,V=0;if((null==e?void 0:e.jitterBufferEmittedCount)&&(null==t?void 0:t.jitterBufferEmittedCount)&&e.jitterBufferEmittedCount>t.jitterBufferEmittedCount){(null==e?void 0:e.jitterBufferDelay)&&(null==t?void 0:t.jitterBufferDelay)&&(F=(e.jitterBufferDelay-t.jitterBufferDelay)/(e.jitterBufferEmittedCount-t.jitterBufferEmittedCount));const n=null==t?void 0:t.jitterBufferMinimumDelay,r=null==e?void 0:e.jitterBufferMinimumDelay;n&&r&&(V=(r-n)/(e.jitterBufferEmittedCount-t.jitterBufferEmittedCount))}const G="number"!=typeof i?1:i/1e3,H=Math.max((null!==(a=null==e?void 0:e.bytesReceived)&&void 0!==a?a:0)-(null!==(c=null==t?void 0:t.bytesReceived)&&void 0!==c?c:0),0),W=8*H/G,$=Math.max((null!==(u=null==e?void 0:e.packetsLost)&&void 0!==u?u:0)-(null!==(l=null==t?void 0:t.packetsLost)&&void 0!==l?l:0),0),q=Math.max((null!==(d=null==e?void 0:e.packetsReceived)&&void 0!==d?d:0)-(null!==(h=null==t?void 0:t.packetsReceived)&&void 0!==h?h:0),0),z=$/Math.max(q+$,1),K=Math.max((null!==(p=null==e?void 0:e.concealedSamples)&&void 0!==p?p:0)-(null!==(f=null==t?void 0:t.concealedSamples)&&void 0!==f?f:0),0),J=Math.max((null!==(g=null==e?void 0:e.totalSamplesReceived)&&void 0!==g?g:0)-(null!==(m=null==t?void 0:t.totalSamplesReceived)&&void 0!==m?m:0),0),Y=K/Math.max(J,1),Q=io(null==r?void 0:r.mimeType,null==r?void 0:r.sdpFmtpLine);return{audio_level:null!==(v=null==e?void 0:e.audioLevel)&&void 0!==v?v:0,audio_nacks_enabled:null!==(E=null==o?void 0:o.audioNacks)&&void 0!==E&&E,bytes_received:H,codec_mime_type:null==Q?void 0:Q.mimeSubtype,connection_bandwidth:null!==(_=null===(S=null==n?void 0:n.candidatePair)||void 0===S?void 0:S.availableIncomingBitrate)&&void 0!==_?_:0,decode_bitrate:W,concealed_samples:K,concealment_events:Math.max((null!==(y=null==e?void 0:e.concealmentEvents)&&void 0!==y?y:0)-(null!==(b=null==t?void 0:t.concealmentEvents)&&void 0!==b?b:0),0),silent_concealed_samples:Math.max((null!==(T=null==e?void 0:e.silentConcealedSamples)&&void 0!==T?T:0)-(null!==(C=null==t?void 0:t.silentConcealedSamples)&&void 0!==C?C:0),0),fraction_audio_concealed:Y,fraction_packets_lost:z,header_bytes_received:Math.max((null!==(I=null==e?void 0:e.headerBytesReceived)&&void 0!==I?I:0)-(null!==(R=null==t?void 0:t.headerBytesReceived)&&void 0!==R?R:0),0),inserted_samples_for_deceleration:Math.max((null!==(O=null==e?void 0:e.insertedSamplesForDeceleration)&&void 0!==O?O:0)-(null!==(w=null==t?void 0:t.insertedSamplesForDeceleration)&&void 0!==w?w:0),0),configured_jitter_buffer_min_delay_ms:null!=s?s:0,jitter_buffer_min_obtainable_delay:V,jitter_buffer_delay_avg:F,packets_discarded:Math.max((null!==(A=null==e?void 0:e.packetsDiscarded)&&void 0!==A?A:0)-(null!==(k=null==t?void 0:t.packetsDiscarded)&&void 0!==k?k:0),0),packets_lost:$,packets_received:q,nack_count:Math.max((null!==(P=null==e?void 0:e.nackCount)&&void 0!==P?P:0)-(null!==(D=null==t?void 0:t.nackCount)&&void 0!==D?D:0),0),removed_samples_for_acceleration:Math.max((null!==(N=null==e?void 0:e.removedSamplesForAcceleration)&&void 0!==N?N:0)-(null!==(L=null==t?void 0:t.removedSamplesForAcceleration)&&void 0!==L?L:0),0),retransmitted_packets_received:Math.max((null!==(M=null==e?void 0:e.retransmittedPacketsReceived)&&void 0!==M?M:0)-(null!==(x=null==t?void 0:t.retransmittedPacketsReceived)&&void 0!==x?x:0),0),retransmitted_bytes_received:Math.max((null!==(B=null==e?void 0:e.retransmittedBytesReceived)&&void 0!==B?B:0)-(null!==(U=null==t?void 0:t.retransmittedBytesReceived)&&void 0!==U?U:0),0),total_samples_received:J,protocol:null===(j=null==n?void 0:n.localCandidate)||void 0===j?void 0:j.protocol}})(i,o,s,a,f,c,u)))}}class SimulcastLayerInfoEvent extends StageAnalyticsEvent{constructor(e,t,n,r,i=mr.PUBLISH,o=!1,s=""){super(gt.SIMULCAST_LAYER_INFO,e,t,!1),Object.assign(this.properties,{rid:n,active:r,selected:o,source:i===mr.PUBLISH?"publisher":"subscriber",remote_participant_id:s})}}const co=e=>{console.warn(`[IVS Stages] ${e}`)};var uo,lo,ho;!function(e){e.Mobile="mobile",e.Tablet="tablet",e.Desktop="desktop",e.Tv="tv"}(uo||(uo={})),function(e){e.IOS="iOS",e.MacOS="macOS",e.Windows="Windows",e.Android="Android"}(lo||(lo={})),function(e){e.Safari="Safari",e.Firefox="Firefox",e.Chrome="Chrome",e.IE="Internet Explorer",e.Edge="Microsoft Edge"}(ho||(ho={}));const po=function(e){const t=fo(e);return{platform:{isMobile:go(uo.Mobile,t),isTablet:go(uo.Tablet,t),isDesktop:go(uo.Desktop,t),isTv:go(uo.Tv,t)},os:{name:vo(t),version:mo(t),isIOS:Eo(lo.IOS,t),isMacOS:Eo(lo.MacOS,t),isWindows:Eo(lo.Windows,t),isAndroid:Eo(lo.Android,t)},browser:{name:_o(t),version:So(t),isSafari:yo(ho.Safari,t),isFirefox:yo(ho.Firefox,t),isChrome:yo(ho.Chrome,t),isIE:yo(ho.IE,t),isEdge:yo(ho.Edge,t)}}}(window.navigator.userAgent);function fo(e){try{return kt.getParser(e||window.navigator.userAgent)}catch(e){}}function go(e,t){return()=>(t||(t=fo()),!(!t||t.getPlatformType(!0)!==e.toLowerCase()))}function mo(e){return()=>(e||(e=fo()),e&&e.getOSVersion()||"")}function vo(e){return()=>(e||(e=fo()),e&&e.getOSName()||"")}function Eo(e,t){return()=>(t||(t=fo()),!(!t||t.getOSName(!0)!==e.toLowerCase()))}function So(e){return()=>(e||(e=fo()),e&&e.getBrowserVersion()||"")}function _o(e){return()=>(e||(e=fo()),e&&e.getBrowserName()||"")}function yo(e,t){return()=>(t||(t=fo()),!(!t||t.getBrowserName().toLowerCase()!==e.toLowerCase()))}const bo={name:"SimulcastUnsupported",message:`Simulcast is only supported on Chromium browsers at bitrates over ${ki.MID.maxBitrateKbps}Kbps`,code:100},To={name:"SimulcastLayerInvalidType",message:"Layer configuration is invalid: ",code:101},Co={name:"SimulcastMaxLayersExceeded",message:"No more than 3 simulcast layers may be configured",code:102},Io={name:"SimulcastDuplicateLayersConfigured",message:"Two duplicate layers are configured. At minimum bitrate, framerate, or dimensions must differ",code:103},Ro={name:"SimulcastMaxLayerBitrateExceeded",message:`maxBitrateKbps cannot exceed ${Li} Kbps`,code:105},Oo={name:"SimulcastMinLayerBitrateExceeded",message:`maxBitrateKbps cannot be less than ${Ni} Kbps`,code:106},wo={name:"SimulcastMaxLayerFramerateExceeded",message:`maxFramerate cannot exceed ${xi} fps`,code:107},Ao={name:"SimulcastMinLayerFramerateExceeded",message:`maxFramerate cannot be less than ${Mi} fps`,code:108},ko={name:"SimulcastMaxLayerDimensionsExceeded",message:`dimensions cannot exceed max resolution of ${Ui}x720`,code:109},Po={name:"SimulcastMinLayerDimensionsExceeded",message:`width or height cannot be lower than ${Bi}`,code:110},Do={name:"SimulcastLayerConfigurationConflict",message:"Layer configuration conflict: ",code:111},No={name:"SimulcastLayerOrientationMismatch",message:"Layer orientation different from input video track: ",code:112},Lo={name:"SimulcastLayerInputResolutionInsufficient",message:"Input video resolution is lower than the configured layer: ",code:113},Mo={name:"SimulcastLayerInputFramerateInsufficient",message:"Input video framerate is lower than the configured layer: ",code:114};class SimulcastConfigurationError extends Error{constructor({name:e,message:t,code:n,details:r,cause:i,params:o}){super(t),Error.captureStackTrace&&Error.captureStackTrace(this,SimulcastConfigurationError),this.name=e,this.message=t,this.code=n,this.details=r,this.cause=i,this.params=o}}const xo=e=>({rid:e.rid,active:e.active,scaleResolutionDownBy:e.scaleFactor,maxBitrate:e.maxBitrateBps,maxFramerate:e.maxFramerate}),Bo=(e,t)=>e.width*e.height>t.width*t.height||e.maxBitrateKbps>t.maxBitrateKbps||e.maxFramerate>t.maxFramerate?1:Uo(e,t)?0:-1,Uo=(e,t)=>{if("object"!=typeof e||"object"!=typeof t)return!1;const n=Object.keys(e);for(const r of n)if(e[r]!==t[r])return!1;return!0},jo=e=>{const{width:t,height:n}=Fo(e);return t*n},Fo=e=>{const{height:t,width:n}=e;let r=Ui/Fi,i=Ui;return void 0!==t&&(r=t),void 0!==n&&(i=n),t&&!n&&(i=t*Fi),!t&&n&&(r=n/Fi),{height:r,width:i}},Vo=e=>{const{width:t,height:n}=e;return t/n>=1?hn.LANDSCAPE:hn.PORTRAIT},Go=(e,t,n)=>{var r;const i=null!==(r=e.getSettings().frameRate)&&void 0!==r?r:xi;return Object.assign(Object.assign({},n),{active:!0,height:t.height,width:t.width,maxBitrateBps:bi(t.maxBitrateKbps),maxFramerate:Math.min(t.maxFramerate,i),scaleFactor:Ho(t,e)})},Ho=(e,t)=>{const n=jo(t.getSettings()),r=jo(e);if(r>=n)return 1;const i=1/Math.sqrt(r/n);return Math.max(i,1)},Wo=e=>{if("object"!=typeof e){const e=Object.assign({},To);throw e.message+=" is not an object",new SimulcastConfigurationError(e)}},$o=(e,t)=>{if("number"!=typeof e){const e=Object.assign({},To);throw e.message+="maxBitrateKbps is not a number",new SimulcastConfigurationError(e)}if(e<Ni)throw new SimulcastConfigurationError(Object.assign({},Oo));if(e>Li)throw new SimulcastConfigurationError(Object.assign({},Ro));if(t&&e>t){const e=Object.assign({},Do);throw e.message+=`maxBitrateKbps cannot be greater than stage maxVideoBitrateKbps of ${t}`,new SimulcastConfigurationError(e)}},qo=(e,t)=>{if("number"!=typeof e){const e=Object.assign({},To);throw e.message+="maxFramerate is not a number",new SimulcastConfigurationError(e)}if(e<Mi)throw new SimulcastConfigurationError(Object.assign({},Ao));if(e>xi)throw new SimulcastConfigurationError(Object.assign({},wo));if(t&&e>t){const e=Object.assign({},Do);throw e.message+=`maxFramerate cannot be greater than stage maxFramerate of ${t} `,new SimulcastConfigurationError(e)}},zo=(e,t)=>{var n;if("number"!=typeof e||"number"!=typeof t){const e=Object.assign({},To);throw e.message+="width and height must be numbers",new SimulcastConfigurationError(e)}if(e<Bi||t<Bi)throw new SimulcastConfigurationError(Object.assign({},Po));const r=null!==(n=St("enable1080pResolution"))&&void 0!==n&&n,i=r?1920:Ui;if(e>i||t>i)throw new SimulcastConfigurationError(Object.assign({},ko));if(e*t>(r?2073600:ji))throw new SimulcastConfigurationError(Object.assign({},ko))},Ko=(e,t)=>{const n=Fo(t.getSettings()),r=Vo(n);r!==Vo(e)&&co(`${No.message}forcing orientation to ${r}`)},Jo=(e,t)=>{var n,r,i,o,s;let a=(0,mn.cloneDeep)(t);const c=null!==(n=a.simulcast)&&void 0!==n?n:{},u=!po.browser.isChrome()&&!po.browser.isEdge(),l=null!==(i=null===(r=e.getSettings())||void 0===r?void 0:r.displaySurface)&&void 0!==i&&i,d=null!==(o=a.maxVideoBitrateKbps)&&void 0!==o?o:Li,h=!(!!Array.isArray(null===(s=t.simulcast)||void 0===s?void 0:s.layers)||!t.maxVideoBitrateKbps)&&d<ki.MID.maxBitrateKbps;if("boolean"==typeof c.enabled&&c.enabled&&(u||l||h)){a.simulcast={enabled:!1};const{name:e,message:t}=bo;co(`${e}${t}, disabling the feature`)}return a=((e,t)=>{var n,r;const i=t,o=null===(n=t.simulcast)||void 0===n?void 0:n.layers;if(void 0===o)return i;if(!Array.isArray(o)){const e=Object.assign({},To);throw e.message+=" layers is not an array",new SimulcastConfigurationError(e)}if(0===o.length)return null===(r=i.simulcast)||void 0===r||delete r.layers,i;if(o.length>3)throw new SimulcastConfigurationError(Object.assign({},Co));if((0,mn.uniqWith)(o,Uo).length!==o.length)throw new SimulcastConfigurationError(Object.assign({},Io));for(const n of o)Wo(n),$o(n.maxBitrateKbps,t.maxVideoBitrateKbps),qo(n.maxFramerate,t.maxFramerate),zo(n.width,n.height),Ko(n,e);return i})(e,a),a};function Yo(e){return e.track.kind===pn.AUDIO}function Qo(e){return e.track.kind===pn.VIDEO&&"object"==typeof e.config}function Xo(e){if(void 0!==e&&(e<Ni||e>Li))throw new Error(`Stage bitrate must be a number between ${Ni} kbps and ${Li} kbps inclusive`)}function Zo(e){return void 0!==e&&("maxBitrate"in e||"maxVideoBitrateKbps"in e||"maxFramerate"in e||"simulcast"in e||"inBandMessaging"in e||"minBitrate"in e)}function es(e,t){if(void 0===t)return t;let n=(0,mn.cloneDeep)(t);return Zo(n)?(void 0!==n.maxBitrate&&(n.maxVideoBitrateKbps=n.maxBitrate,co("maxBitrate is deprecated in favor of maxVideoBitrateKbps")),n=Jo(e,n),Xo(n.maxVideoBitrateKbps),Xo(n.minBitrate),function(e){if(void 0!==e&&(e>xi||e<Mi))throw new Error(`Stage framerate must be between ${Mi} fps and ${xi} fps inclusive`)}(n.maxFramerate),function(e){if(void 0!==e){if("object"!=typeof e)throw new Error("In-band messaging config must be an object");if("boolean"!=typeof e.enabled)throw new Error("In-band messaging config enabled property must be a boolean")}}(n.inBandMessaging)):(function(e){if(void 0!==e&&(e<Vi||e>Gi))throw new Error(`Stage audio bitrate must be between ${Vi} Kbps and ${Gi} Kbps inclusive`)}(n.maxAudioBitrateKbps),function(e){if(void 0!==e&&"boolean"!=typeof e)throw new Error("Stage stereo prop must be a boolean")}(n.stereo)),n}const ts=(e,t,n)=>{var r;const i={[dn.HI]:Pi(dn.HI),[dn.MID]:Pi(dn.MID),[dn.LOW]:Pi(dn.LOW)},o=t.simulcast,s=null==n?void 0:n.simulcast;let a=o.layers.sort(Bo);const c=null!==(r=null==s?void 0:s.layers)&&void 0!==r?r:[],u=a.length,l=c.length;a=a.map((n=>{((e,t)=>{const{width:n,height:r}=Fo(t.getSettings()),{width:i,height:o}=e;if(i*o>n*r){const e=`forcing layer of ${i}x${o} to the input dimensions ${n}x${r}`,{name:t,message:s}=Lo;co(`${t}${s}${e}`)}})(n,e),((e,t)=>{var n;const r=null!==(n=t.getSettings().frameRate)&&void 0!==n?n:xi,i=e.maxFramerate;if(i>r){const e=`forcing layer of ${i}fps to the input framerate of ${r}`,{name:t,message:n}=Mo;co(`${t}${n}${e}`)}})(n,e);let r=((e,t)=>{const{maxVideoBitrateKbps:n}=t,r=e;return n&&e.maxBitrateKbps>n&&(r.maxBitrateKbps=n),r})(n,t);return r=((e,t)=>{const{maxFramerate:n}=t,r=e;return n&&e.maxFramerate>n&&(r.maxFramerate=n),r})(n,t),r}));return(0===l||3===l)&&3===u?(i.hi=Go(e,a[2],i.hi),i.mid=Go(e,a[1],i.mid),i.low=Go(e,a[0],i.low),ln.ok(i)):1===l&&1===u?(i.hi=Go(e,a[0],i.hi),ln.ok(i)):2===l&&2===u?(i.hi=Go(e,a[1],i.hi),i.low=Go(e,a[0],i.low),ln.ok(i)):ln.err(null)},ns=(e,t,n)=>{const r=t.simulcast,i=t.inBandMessaging,o=bi(t.minBitrate),s=bi(t.maxVideoBitrateKbps),a=t.maxFramerate;let c=[{maxBitrate:s,maxFramerate:a}];const u=ts(e,t,null!=n?n:{});return r.enabled&&u.ok&&(c=(e=>{const{hi:t,mid:n,low:r}=e;return[xo(r),xo(n),xo(t)]})(u.value)),{track:e,config:{minBitrateBps:o,maxBitrateBps:s,maxFramerate:a,inBandMessagingEnabled:i.enabled,simulcastEnabled:r.enabled,simulcastLayers:u.ok?u.value:void 0,encodingLayers:c}}},rs=e=>{const t=e.mediaStreamTrack,n=e.normalizedConfig;let r={};const i=e.validatedExternalConfig;return Zo(i)&&(r=i),function(e){return e.kind===pn.AUDIO}(t)?((e,t)=>{const n={maxBitrateBps:bi(t.maxAudioBitrateKbps)},r=null==t?void 0:t.stereo;return"boolean"==typeof r&&(n.stereo=r),{track:e,config:n}})(t,n):ns(t,n,r)},is=(e,t)=>{const n={minBitrate:Ni,maxBitrate:Li,maxVideoBitrateKbps:Li,maxFramerate:xi,simulcast:{enabled:!1,layers:[Object.assign({},ki.HI),Object.assign({},ki.MID),Object.assign({},ki.LOW)]},maxAudioBitrateKbps:Hi,stereo:!1,inBandMessaging:{enabled:!1}},r=(0,mn.cloneDeep)(t),i=Object.assign(Object.assign({},n),r);return Zo(r)&&(r.simulcast&&(i.simulcast=Object.assign(Object.assign({},n.simulcast),r.simulcast)),r.inBandMessaging&&(i.inBandMessaging=Object.assign(Object.assign({},n.inBandMessaging),r.inBandMessaging))),i},os=(e,t)=>{if("number"==typeof e)return e;const n=t?Wi:$i;return void 0!==n[e]?n[e]:0};class MultihostConfigurationEvent extends StageAnalyticsEvent{constructor(e,t,n,r){super(gt.MULTIHOST_CONFIGURATION,e,t,!1),Object.assign(this.properties,Object.assign(Object.assign({},n),{action:r}))}}class MultihostSubscribeConfigurationEvent extends StageAnalyticsEvent{constructor(e,t,n,r,i){super(gt.MULTIHOST_SUBSCRIBE_CONFIGURATION,e,t,!1);const o={trigger:n,remote_participant_id:r,min_delay_when_publishing:os(i.jitterBuffer.minDelayWhenPublishing,!0),min_delay_when_subscribe_only:os(i.jitterBuffer.minDelayWhenSubscribeOnly,!1),in_band_messaging_enabled:i.inBandMessaging.enabled,simulcast_initial_layer_preference:i.simulcast.initialLayerPreference,simulcast_layer_poll_interval_ms:i.simulcast.layerPollingIntervalMs,simulcast_layer_poll_enabled:i.simulcast.layerPollingEnabled};Object.assign(this.properties,o)}}var ss=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};class PeerClientStatsReporter{constructor(e,t,n,r,i){this.analyticsTracker=i,this.simulcastEnabled=!1,this.simulcastState={low:!1,mid:!1,hi:!1},this.sdp=new SdpMunger(""),this.sdpFeatures={audioNacks:!1},this.multihostConfiguration=PeerClientStatsReporter.defaultMultihostConfiguration(),this.prevOutboundVideoStats=new Map,this.prevInboundVideoStats=new Map,this.prevRemoteInboundStats=new Map,this.sfuResource={node:"",cluster:""},this.connectionStartedTimestamp=Date.now(),this.seiStats={seiReadCnt:0,seiBytesRead:0,seiWriteCnt:0,seiBytesWritten:0},this.prevVideoReceiverTransformerStats={seiReadCnt:0,seiBytesRead:0},this.prevVideoSenderTransformerStats={seiWriteCnt:0,seiBytesWritten:0},this.vidNetworkQualityMap=new Map,this.audioNetworkQualityMap=new Map,this.onPeerConnectionStateChange=()=>{switch(this.getConnectionState()){case Gt.CONNECTED:this.connectionStartedTimestamp=Date.now(),this.setupIntervals();break;case Gt.FAILED:this.flushStats()}},this.action=e,this.token=t,this.traceId=n,this.identifier=r}static defaultMultihostConfiguration(){return{video_codec:"unknown",width:0,height:0,max_bitrate:0,min_bitrate:0,target_fps:0,echo_cancellation:!1,auto_gain:!1,noise_suppression:!1,enable_simulcast:!1,max_audio_bitrate_bps:bi(Gi),hi_video_layer:"",mid_video_layer:"",low_video_layer:""}}set sdpAnswer(e){try{this.sdp=new SdpMunger(e),this.sdpFeatures.audioNacks=this.sdp.hasAudioNacksEnabled()}catch(e){}}start(e,t=!1){this.peerConnection=e,this.simulcastEnabled=t,this.prevOutboundAudioStats=void 0,this.prevOutboundVideoStats=new Map,this.prevRemoteInboundStats=new Map,this.peerConnection.addEventListener("connectionstatechange",this.onPeerConnectionStateChange)}stop(){var e;clearInterval(this.uploadStatsInterval),this.uploadStatsInterval=void 0,null===(e=this.peerConnection)||void 0===e||e.removeEventListener("connectionstatechange",this.onPeerConnectionStateChange)}updateSfuResource(e){this.sfuResource=e}updateMultihostConfiguration(e,t){var n,r,i,o,s,a,c,u,l;return ss(this,void 0,void 0,(function*(){if(this.action!==mr.PUBLISH||!this.peerConnection)return;const d=PeerClientStatsReporter.defaultMultihostConfiguration();if(t){const e=this.peerConnection.getSenders().filter((e=>null!==e.track&&"video"===e.track.kind));let c="unknown";if(e.length>0){(yield e[0].getStats()).forEach((e=>{if("codec"===e.type&&(d.video_codec=e.mimeType,e.sdpFmtpLine)){const t=e.sdpFmtpLine.match(/profile-level-id=([a-f0-9]+)/);t&&t.length>0&&(c=t[1])}}))}const u=t.track.getSettings();d.width=null!==(n=u.width)&&void 0!==n?n:0,d.height=null!==(r=u.height)&&void 0!==r?r:0,d.target_fps=null!==(i=u.frameRate)&&void 0!==i?i:0,t.config?(d.max_bitrate=t.config.maxBitrateBps,d.min_bitrate=t.config.minBitrateBps,d.enable_simulcast=t.config.simulcastEnabled):(d.max_bitrate=bi(Li),d.min_bitrate=bi(Ni),d.enable_simulcast=!1),t.config.simulcastEnabled&&(d.hi_video_layer=this.mapLayerToMetric(c,null===(o=t.config.simulcastLayers)||void 0===o?void 0:o.hi),d.mid_video_layer=this.mapLayerToMetric(c,null===(s=t.config.simulcastLayers)||void 0===s?void 0:s.mid),d.low_video_layer=this.mapLayerToMetric(c,null===(a=t.config.simulcastLayers)||void 0===a?void 0:a.low))}if(e){const t=e.track.getSettings();d.auto_gain=null!==(c=t.autoGainControl)&&void 0!==c&&c,d.echo_cancellation=null!==(u=t.echoCancellation)&&void 0!==u&&u,d.noise_suppression=null!==(l=t.noiseSuppression)&&void 0!==l&&l,d.max_audio_bitrate_bps=e.config.maxBitrateBps,d.stereo=e.config.stereo}(0,mn.isEqual)(d,this.multihostConfiguration)||(this.analyticsTracker.trackEventNoSharedProps(new MultihostConfigurationEvent(this.token,this.traceId,d,this.action)),this.multihostConfiguration=d)}))}resetTransformers(e,t){this.senderVideoTransformer=t,this.receiveVideoTransformer=e,this.prevVideoReceiverTransformerStats={seiReadCnt:0,seiBytesRead:0},this.prevVideoSenderTransformerStats={seiWriteCnt:0,seiBytesWritten:0}}getStats(e){var t;return ss(this,void 0,void 0,(function*(){const n=yield null===(t=this.peerConnection)||void 0===t?void 0:t.getStats(e),{action:r}=this;if(n)if("audio"===e.kind){if(r===mr.PUBLISH)return{action:r,rawReport:n,stats:Qi(n,this.audioNetworkQualityMap)};if(r===mr.SUBSCRIBE)return{action:r,rawReport:n,stats:Zi(n,this.audioNetworkQualityMap)}}else{if(r===mr.PUBLISH)return{action:r,rawReport:n,stats:Xi(n,this.vidNetworkQualityMap)};if(r===mr.SUBSCRIBE)return{action:r,rawReport:n,stats:eo(n,this.vidNetworkQualityMap)}}}))}mapLayerToMetric(e,t){if(!t||!t.active)return"";return`${`${t.height}x${t.width}`}_${`${t.maxFramerate}fps`}_${t.maxBitrateBps/1e3+"kbps"}_${e}`}updateJitterBufferMinDelay(e){this.jitterBufferMinDelayInMs=e}setupIntervals(){this.action===mr.PUBLISH&&this.simulcastEnabled&&!this.pollSimulcastLayerInterval&&(this.pollSimulcastLayers(),this.pollSimulcastLayerInterval=this.startInterval(this.pollSimulcastLayers,5e3)),this.uploadStatsInterval||(this.uploadStats(),this.uploadStatsInterval=this.startInterval(this.uploadStats,1e4))}startInterval(e,t){return setInterval(e.bind(this),t)}getConnectionState(){var e;if(!this.peerConnection)return Gt.NONE;const t=null!==(e=this.peerConnection.connectionState)&&void 0!==e?e:this.peerConnection.iceConnectionState;try{return zt(t)}catch(e){return Gt.IDLE}}pollSimulcastLayers(){var e;return ss(this,void 0,void 0,(function*(){if(this.getConnectionState()===Gt.CONNECTED){const t=yield null===(e=this.peerConnection)||void 0===e?void 0:e.getStats();if(!t)return;t.forEach((e=>{var t;if("outbound-rtp"===e.type){const n=0!==(null!==(t=e.framesPerSecond)&&void 0!==t?t:0);switch(e.rid){case"low":n!==this.simulcastState.low&&(this.simulcastState.low=n,this.analyticsTracker.trackEventNoSharedProps(new SimulcastLayerInfoEvent(this.token,this.traceId,e.rid,n)));break;case"mid":n!==this.simulcastState.mid&&(this.simulcastState.mid=n,this.analyticsTracker.trackEventNoSharedProps(new SimulcastLayerInfoEvent(this.token,this.traceId,e.rid,n)));break;case"hi":n!==this.simulcastState.hi&&(this.simulcastState.hi=n,this.analyticsTracker.trackEventNoSharedProps(new SimulcastLayerInfoEvent(this.token,this.traceId,e.rid,n)))}}}))}}))}flushStats(){var e;return ss(this,void 0,void 0,(function*(){const t=yield null===(e=this.peerConnection)||void 0===e?void 0:e.getStats();t&&(this.action===mr.PUBLISH?this.uploadPublisherStats(t):this.action===mr.SUBSCRIBE&&this.uploadSubscriberStats(t))}))}uploadStats(){var e;return ss(this,void 0,void 0,(function*(){if(this.getConnectionState()===Gt.CONNECTED){const t=yield null===(e=this.peerConnection)||void 0===e?void 0:e.getStats();if(!t)return;this.action===mr.PUBLISH?this.uploadPublisherStats(t):this.action===mr.SUBSCRIBE&&this.uploadSubscriberStats(t)}}))}uploadPublisherStats(e){var t,n;const r={audio:{},video:[],candidateStats:{}},i=new Map,o=(Date.now()-this.connectionStartedTimestamp)/1e3,s=Object.assign({},this.multihostConfiguration),{seiWriteCnt:a,seiBytesWritten:c}=this.updateAndDiffSeiPublishStatsSinceLastUpdate(null===(t=this.senderVideoTransformer)||void 0===t?void 0:t.getSenderStats());if(this.seiStats.seiWriteCnt+=a,this.seiStats.seiBytesWritten+=c,e.forEach((t=>{if("outbound-rtp"===t.type){const n=e.get(t.remoteId),o=this.prevRemoteInboundStats.get(t.remoteId);switch(n&&this.prevRemoteInboundStats.set(n.id,n),t.kind){case"audio":r.audio=this.updateOutboundAudio(t),r.audio.remoteInbound=n,r.audio.prevRemoteInbound=o,r.audio.codec=i.get(t.codecId);break;case"video":r.video.push(Object.assign({},this.updateOutboundVideo(t),{remoteInbound:n,prevRemoteInbound:o,codec:i.get(t.codecId)}))}}"candidate-pair"===t.type&&t.nominated&&(r.candidateStats.candidatePair=t,r.candidateStats.localCandidate=e.get(t.localCandidateId),r.candidateStats.remoteCandidate=e.get(t.remoteCandidate)),"codec"===t.type&&i.set(t.id,t)})),r.video.forEach((e=>{var t,n;const{outbound:r,prevOutbound:i}=e;if(!r)return;const o=null!==(n=null===(t=e.outbound)||void 0===t?void 0:t.rid)&&void 0!==n?n:fe;this.updateNetworkQualityPublish(o,this.vidNetworkQualityMap,r,i)})),r.audio.outbound){const e=null!==(n=r.audio.outbound.rid)&&void 0!==n?n:fe;this.updateNetworkQualityPublish(e,this.audioNetworkQualityMap,r.audio.outbound,r.audio.prevOutbound)}this.analyticsTracker.trackEventNoSharedProps(new PublishedAudioStatsEvent(this.token,this.traceId,this.sfuResource,r.audio.outbound,r.audio.remoteInbound,r.candidateStats,r.audio.codec,s,o,this.sdpFeatures)),r.audio.prevOutbound&&this.analyticsTracker.trackEventNoSharedProps(new PublishedAudioStatsWindowEvent(this.token,this.traceId,this.sfuResource,r.audio.outbound,r.audio.prevOutbound,r.audio.remoteInbound,r.audio.prevRemoteInbound,r.candidateStats,r.audio.codec,s,this.sdpFeatures)),r.video.forEach((e=>{this.analyticsTracker.trackEventNoSharedProps(new PublishedVideoStatsEvent(this.token,this.traceId,this.sfuResource,e.outbound,e.remoteInbound,r.candidateStats,e.codec,s,o)),e.prevOutbound&&this.analyticsTracker.trackEventNoSharedProps(new PublishedVideoStatsWindowEvent(this.token,this.traceId,this.sfuResource,e.outbound,e.prevOutbound,e.remoteInbound,e.prevRemoteInbound,r.candidateStats,e.codec,s,this.seiStats.seiWriteCnt,this.seiStats.seiBytesWritten))}))}updateNetworkQualityPublish(e,t,n,r){var i,o,s,a;let c=0;const u=Ln.getNetworkQuality(),l=null!==(i=n.packetsSent)&&void 0!==i?i:0,d=null!==(o=n.nackCount)&&void 0!==o?o:0;if(r)if(u===Xt.DOWN)t.set(e,Xt.DOWN);else{c=(d-(null!==(s=null==r?void 0:r.nackCount)&&void 0!==s?s:0))/(l-(null!==(a=null==r?void 0:r.packetsSent)&&void 0!==a?a:0));const n=this.convertLostRatioToQuality(c);t.set(e,n)}else t.set(e,u)}updateNetworkQualitySubscribe(e,t,n){var r,i,o,s;let a=0;const c=Ln.getNetworkQuality(),u=null!==(r=null==t?void 0:t.packetsReceived)&&void 0!==r?r:0,l=null!==(i=null==t?void 0:t.nackCount)&&void 0!==i?i:0;if(!t)return;const d=t.id;if(d)if(n)if(c===Xt.DOWN)e.set(d,Xt.DOWN);else{a=(l-(null!==(o=null==n?void 0:n.nackCount)&&void 0!==o?o:0))/(u-(null!==(s=null==n?void 0:n.packetsReceived)&&void 0!==s?s:0));const t=this.convertLostRatioToQuality(a);e.set(d,t)}else e.set(d,c)}uploadSubscriberStats(e){var t,n;const r={audio:{},video:{},candidateStats:{}},i=new Map,o=(Date.now()-this.connectionStartedTimestamp)/1e3,s=null!==(t=this.jitterBufferMinDelayInMs)&&void 0!==t?t:0,{seiReadCnt:a,seiBytesRead:c}=this.updateAndDiffSeiSubscribeStatsSinceLastUpdate(null===(n=this.receiveVideoTransformer)||void 0===n?void 0:n.getReceiverStats());this.seiStats.seiReadCnt+=a,this.seiStats.seiBytesRead+=c,e.forEach((t=>{if("inbound-rtp"===t.type)switch(t.kind){case"audio":r.audio=this.updateInboundAudio(t),r.audio.codec=i.get(t.codecId),this.updateNetworkQualitySubscribe(this.audioNetworkQualityMap,r.audio.inbound,r.audio.prevInbound);break;case"video":r.video=this.updateInboundVideo(t),r.video.codec=i.get(t.codecId),this.updateNetworkQualitySubscribe(this.vidNetworkQualityMap,r.video.inbound,r.video.prevInbound)}"candidate-pair"===t.type&&t.nominated&&(r.candidateStats.candidatePair=t,r.candidateStats.localCandidate=e.get(t.localCandidateId),r.candidateStats.remoteCandidate=e.get(t.remoteCandidate)),"codec"===t.type&&i.set(t.id,t)})),this.analyticsTracker.trackEventNoSharedProps(new SubscribedAudioStatsEvent(this.token,this.traceId,this.identifier,this.sfuResource,r.audio.inbound,r.candidateStats,r.audio.codec,o,this.sdpFeatures)),r.audio.prevInbound&&this.analyticsTracker.trackEventNoSharedProps(new SubscribedAudioStatsWindowEvent(this.token,this.traceId,this.identifier,this.sfuResource,r.audio.inbound,r.audio.prevInbound,r.candidateStats,r.audio.codec,this.sdpFeatures,s)),this.analyticsTracker.trackEventNoSharedProps(new SubscribedVideoStatsEvent(this.token,this.traceId,this.identifier,this.sfuResource,r.video.inbound,r.candidateStats,r.video.codec,o)),r.video.prevInbound&&this.analyticsTracker.trackEventNoSharedProps(new SubscribedVideoStatsWindowEvent(this.token,this.traceId,this.identifier,this.sfuResource,r.video.inbound,r.video.prevInbound,r.candidateStats,r.video.codec,s,this.seiStats.seiReadCnt,this.seiStats.seiBytesRead))}updateAndDiffSeiSubscribeStatsSinceLastUpdate(e){const t=this.prevVideoReceiverTransformerStats;if(!e)return{seiReadCnt:t.seiReadCnt,seiBytesRead:t.seiBytesRead};const n=e.seiReadCnt-t.seiReadCnt,r=e.seiBytesRead-t.seiBytesRead;return this.prevVideoReceiverTransformerStats={seiReadCnt:e.seiReadCnt,seiBytesRead:e.seiBytesRead},{seiReadCnt:n,seiBytesRead:r}}updateAndDiffSeiPublishStatsSinceLastUpdate(e){const t=this.prevVideoSenderTransformerStats;if(!e)return{seiWriteCnt:t.seiWriteCnt,seiBytesWritten:t.seiBytesWritten};const n=e.seiWriteCnt-t.seiWriteCnt,r=e.seiBytesWritten-t.seiBytesWritten;return this.prevVideoSenderTransformerStats={seiWriteCnt:e.seiWriteCnt,seiBytesWritten:e.seiBytesWritten},{seiWriteCnt:n,seiBytesWritten:r}}updateOutboundAudio(e){const t=e,n=this.prevOutboundAudioStats,r=e.id===(null==n?void 0:n.id)?n:void 0;return this.prevOutboundAudioStats=e,{outbound:t,prevOutbound:r}}updateInboundAudio(e){const t=e,n=this.prevInboundAudioStats,r=e.id===(null==n?void 0:n.id)?n:void 0;return this.prevInboundAudioStats=e,{inbound:t,prevInbound:r}}updateInboundVideo(e){const t=e,n=this.prevInboundVideoStats.get(fe),r=e.id===(null==n?void 0:n.id)?n:void 0;return this.prevInboundVideoStats.set(fe,e),{inbound:t,prevInbound:r}}updateOutboundVideo(e){const t=e,n=this.getPrevOutboundVideo(e),r=e.id===(null==n?void 0:n.id)?n:void 0;return this.setPrevVideoStat(e),{outbound:t,prevOutbound:r}}getPrevOutboundVideo(e){return this.simulcastEnabled&&e.rid&&this.prevOutboundVideoStats.has(e.rid)?this.prevOutboundVideoStats.get(e.rid):!this.simulcastEnabled&&this.prevOutboundVideoStats.has(fe)?this.prevOutboundVideoStats.get(fe):void 0}setPrevVideoStat(e){this.simulcastEnabled&&e.rid?this.prevOutboundVideoStats.set(e.rid,e):this.simulcastEnabled||this.prevOutboundVideoStats.set(fe,e)}convertLostRatioToQuality(e){return e<=0?Xt.EXCELLENT:e<=.01?Xt.GOOD:e<=.03?Xt.NORMAL:e<=.1?Xt.POOR:Xt.DOWN}}class MinuteEvent extends StageAnalyticsEvent{constructor(e,t,n,r,i){super(gt.MINUTE,e,t,!1),Object.assign(this.properties,{action:r?mr.PUBLISH:mr.SUBSCRIBE,is_publishing:r,minutes_logged:n,subscribed_number:i})}}class PublishEvent extends StageAnalyticsEvent{constructor(e){super(gt.PUBLISH,e.token,e.traceId,!1),Object.assign(this.properties,{action:mr.PUBLISH,remote_participant_id:e.token.participantID})}}class UnpublishEvent extends StageAnalyticsEvent{constructor(e){super(gt.UNPUBLISH,e.token,e.traceId,!0),Object.assign(this.properties,{action:mr.PUBLISH,remote_participant_id:e.token.participantID})}}class SubscribeEvent extends StageAnalyticsEvent{constructor(e){var t,n,r,i;super(gt.SUBSCRIBE,e.token,e.traceId,!1),Object.assign(this.properties,{action:mr.SUBSCRIBE,remote_participant_id:e.subscribedId,subscribed_id:e.subscribedId,is_edp_connected:e.isEdpConnected,is_reassignment:e.isReassignment,node:null!==(n=null===(t=e.preAttemptSfuResource)||void 0===t?void 0:t.node)&&void 0!==n?n:"",cluster:null!==(i=null===(r=e.preAttemptSfuResource)||void 0===r?void 0:r.cluster)&&void 0!==i?i:""})}}class UnsubscribeEvent extends StageAnalyticsEvent{constructor(e){super(gt.UNSUBSCRIBE,e.token,e.traceId,!0),Object.assign(this.properties,{action:mr.SUBSCRIBE,remote_participant_id:e.unsubscribedId,unsubscribed_id:e.unsubscribedId})}}class PublishStartedEvent extends StageAnalyticsEvent{constructor(e){var t,n,r,i;super(gt.PUBLISH_STARTED,e.token,e.traceId,!1),Object.assign(this.properties,{action:mr.PUBLISH,options_duration:e.optionsDuration,post_duration:e.postDuration,remote_participant_id:e.token.participantID,time_to_candidate:e.timeToCandidate,total_duration:e.totalDuration,edp_initial_connect_duration:e.edpInitialConnectDuration,edp_initial_connect_retry_times:e.edpInitialConnectRetries,edp_initial_state_duration:e.edpInitialStateDuration,edp_state_update_count:e.edpStateUpdateCount,sdp_exchange_duration:e.sdpExchangeDuration,sdp_exchange_transport:e.sdpExchangeTransport,set_remote_desc_duration:e.setRemoteDescDuration,peer_connection_duration:e.peerConnectionDuration,node:null!==(n=null===(t=e.sfuResource)||void 0===t?void 0:t.node)&&void 0!==n?n:"",cluster:null!==(i=null===(r=e.sfuResource)||void 0===r?void 0:r.cluster)&&void 0!==i?i:"",publish_retry_times:e.publishRetries,total_duration_with_retries:e.totalDurationWithRetries,protocol:e.protocol})}}class PublishFailedEvent extends StageAnalyticsEvent{constructor(e){super(gt.PUBLISH_FAILED,e.token,e.traceId,!1),Object.assign(this.properties,{action:mr.PUBLISH,code:e.code,message:e.message,fatal:e.fatal,nominal:e.nominal,protocol:e.protocol})}}class PublishEndedEvent extends StageAnalyticsEvent{constructor(e){super(gt.PUBLISH_ENDED,e.token,e.traceId,!0),Object.assign(this.properties,{action:mr.PUBLISH,remote_participant_id:e.token.participantID,unpublish_successful:e.isUnpublishSuccessful,reason:e.reason,protocol:e.protocol})}}class SubscribeStartedEvent extends StageAnalyticsEvent{constructor(e){var t,n,r,i;super(gt.SUBSCRIBE_STARTED,e.token,e.traceId,!1),Object.assign(this.properties,{action:mr.SUBSCRIBE,options_duration:e.optionsDuration,post_duration:e.postDuration,remote_participant_id:e.remoteParticipantId,time_to_candidate:e.timeToCandidate,total_duration:e.totalDuration,edp_initial_connect_duration:e.edpInitialConnectDuration,edp_initial_connect_retry_times:e.edpInitialConnectRetries,edp_initial_state_duration:e.edpInitialStateDuration,edp_initial_state_publishing_count:e.edpInitialStatePublishingCount,edp_state_update_count:e.edpStateUpdateCount,sdp_exchange_duration:e.sdpExchangeDuration,sdp_exchange_transport:e.sdpExchangeTransport,set_remote_desc_duration:e.setRemoteDescDuration,peer_connection_duration:e.peerConnectionDuration,node:null!==(n=null===(t=e.sfuResource)||void 0===t?void 0:t.node)&&void 0!==n?n:"",cluster:null!==(i=null===(r=e.sfuResource)||void 0===r?void 0:r.cluster)&&void 0!==i?i:"",total_duration_with_retries:e.totalDurationWithRetries,subscribe_retry_times:e.subscribeRetryTimes,is_reassignment:e.isReassignment,protocol:e.protocol})}}class SubscribeFailedEvent extends StageAnalyticsEvent{constructor(e){super(gt.SUBSCRIBE_FAILED,e.token,e.traceId,!1),Object.assign(this.properties,{action:mr.SUBSCRIBE,remote_participant_id:e.remoteParticipantId,code:e.code,message:e.message,fatal:e.fatal,nominal:e.nominal,is_reassignment:e.isReassignment,protocol:e.protocol})}}class SubscribeEndedEvent extends StageAnalyticsEvent{constructor(e){super(gt.SUBSCRIBE_ENDED,e.token,e.traceId,!0),Object.assign(this.properties,{action:mr.SUBSCRIBE,remote_participant_id:e.remoteParticipantId,unsubscribe_successful:e.isUnsubscribeSuccessful,reason:e.reason,protocol:e.protocol}),this.critical=!0}}class StateUpdatedEvent extends StageAnalyticsEvent{constructor(e){super(gt.STATE_UPDATED,e.token,e.traceId,!1),Object.assign(this.properties,{audio_muted:e.isAudioMuted,is_disconnected:e.isDisconnected,is_publishing:e.isPublishing,other_participant_id:e.otherParticipantId,other_participant_user_id:e.otherParticipantUserId,video_stopped:e.isVideoStopped})}}class FirstFrameEvent extends StageAnalyticsEvent{constructor(e){var t,n,r,i,o;super(gt.FIRST_FRAME,e.token,e.traceId,!1),Object.assign(this.properties,{action:mr.SUBSCRIBE,remote_participant_id:e.remoteParticipantId,edp_initial_connect_duration:e.edpInitialConnectDuration,edp_initial_connect_retry_times:e.edpInitialConnectRetries,edp_initial_state_duration:e.edpInitialStateDuration,edp_initial_state_publishing_count:e.edpInitialStatePublishingCount,edp_state_update_count:e.edpStateUpdateCount,sdp_exchange_duration:e.sdpExchangeDuration,sdp_exchange_transport:e.sdpExchangeTransport,set_remote_desc_duration:e.setRemoteDescDuration,peer_connection_duration:e.peerConnectionDuration,node:null!==(n=null===(t=e.sfuResource)||void 0===t?void 0:t.node)&&void 0!==n?n:"",cluster:null!==(i=null===(r=e.sfuResource)||void 0===r?void 0:r.cluster)&&void 0!==i?i:"",video_was_paused:e.videoWasPaused,first_frame_duration:e.firstFrameDuration,total_duration_with_retries:e.totalDurationWithRetries,subscribe_retry_times:e.subscribeRetryTimes,media_type:e.mediaType,configured_jitter_buffer_min_delay_ms:null!==(o=e.currentJitterBufferMinDelayInMs)&&void 0!==o?o:0,protocol:e.protocol})}}class EDPPongEvent extends StageAnalyticsEvent{constructor(e){super(gt.EDP_PONG,e.token,e.traceId,!1),Object.assign(this.properties,{event_endpoint:e.eventEndpoint,protocol:e.protocol,edp_rtt:e.edpRttMs})}}class JoinEvent extends StageAnalyticsEvent{constructor(e){super(gt.JOIN,e.token,e.traceId,!1),Object.assign(this.properties,{action:mr.JOIN,event_endpoint:e.eventEndpoint,whip_endpoint:e.whipEndpoint})}}class JoinAttemptEvent extends StageAnalyticsEvent{constructor(e){super(gt.JOIN_ATTEMPT,e.token,e.traceId,!1),Object.assign(this.properties,{action:mr.JOIN,event_endpoint:e.eventEndpoint,whip_endpoint:e.whipEndpoint})}}class JoinFailedEvent extends StageAnalyticsEvent{constructor(e){super(gt.JOIN_ATTEMPT_FAILED,e.token,e.traceId,!1),Object.assign(this.properties,{action:mr.JOIN,event_endpoint:e.eventEndpoint,whip_endpoint:e.whipEndpoint,code:e.code,message:e.message,fatal:e.fatal,nominal:e.nominal,connect_retry_times:e.retryCnt})}}class EDPDisconnectedEvent extends StageAnalyticsEvent{constructor(e){super(gt.EDP_DISCONNECTED,e.token,e.traceId,!1),Object.assign(this.properties,{event_endpoint:e.eventEndpoint,protocol:e.protocol}),this.critical=!0}}class EDPConnectedEvent extends StageAnalyticsEvent{constructor(e){super(gt.EDP_CONNECTED,e.token,e.traceId,!1),Object.assign(this.properties,{event_endpoint:e.eventEndpoint,protocol:e.protocol,connect_retry_times:e.numRetries}),this.critical=!0}}class StageSocket{constructor(e,t,n){this.token=e,this.analyticsTracker=n,this.protocol="",this.connecting=!1,this.closing=!1,this.windowUnloading=!1,this.maxConnectRetries=6,this.connectionAttempts=0,this.latestSequenceNumber=0,this.nextConnectionAttemptId=0,this.connectTimeoutId=0,this.latestPingTimestamp=0,this.pingIntervalId=0,this.pongTimeoutId=0,this.pingIntervalMs=15e3,this.pongTimeoutMs=3e4,this.attemptConnect=e=>{this.latestSequenceNumber=0,this.traceId=e||br(),this.connectionAttempts++,this.trackJoinAttempt(this.connectionAttempts);const{topic:t,rawToken:n}=this.token;this.connecting=!0,this.closing=!1;try{const e=encodeURIComponent(this.traceId.value),r=`topic=${t}/publishers`,i=`traceid=${e}`,o="error_over_ws=1",s=`${this.addr}?${o}&${r}&${i}`;this.socket=this.createWebSocket(s,n),this.socket.onmessage=this.onMessage.bind(this),this.socket.onerror=this.onError.bind(this),this.socket.onclose=this.onClose.bind(this),this.socket.onopen=this.onOpen.bind(this),this.protocol=this.socket.protocol}catch(e){const t=e instanceof Error?e.message:void 0,n=this.createError(Lr.EVENT_PLANE_WS_CREATE_FAILED,t);this.trackJoinFailed(n,this.getRetryCount()),this.emitter.emit(si,n)}},this.triggerSocketOpen=e=>{this.clearConnectionAttemptTimeouts();const t=this.getRetryCount();this.connectionAttempts=0,this.connecting=!1,this.trackJoinStarted(t),this.emitter.emit(ni,{retryCnt:t,traceId:this.traceId,initialStageState:e}),this.pingIntervalId=window.setInterval(this.ping,this.pingIntervalMs)},this.ping=()=>{var e;if(this.logger.debug({msg:`${this.id}sending PING`}),!this.isSocketOpen()){const e=`${this.id} attempting to ping an unopened socket`;return this.logger.warn({msg:e}),void this.traceJoinOp(e)}this.latestPingTimestamp=performance.now(),0===this.pongTimeoutId&&(this.pongTimeoutId=window.setTimeout(this.pongTimedOut,this.pongTimeoutMs)),null===(e=this.socket)||void 0===e||e.send(JSON.stringify({type:"PING"}))},this.pongTimedOut=()=>{if(!this.isSocketOpen()){const e=`${this.id} attempting pong timeout on an unopened socket`;return this.logger.warn({msg:e}),void this.traceJoinOp(e)}this.logger.debug({msg:`${this.id} Pong timed out!`}),this.clearPingPongTracking();const e=this.createError(Lr.EVENT_PLANE_PONG_TIMEOUT);this.emitter.emit(si,e)},this.beforeUnload=()=>{this.emitter.emit(ri,"beforeunload"),this.windowUnloading=!0},this.sendSdpOffer=(e,t,n,r,i,o,s,a)=>{var c;const u={type:"aws:ivs:SDP_OFFER",payload:{whipUrl:t,requestId:r,traceId:n,platform:"web",sdk:"1.30.0",whipVersion:mi,content:e,contentType:"application/sdp"}};i&&(u.payload.forceNode=i),o&&(u.payload.assignmentToken=o),s&&(u.payload.multiCodec=s);const l=void 0===It(),d=It()||l;a&&d&&(u.payload.initialLayerPref=Ri(a)),null===(c=this.socket)||void 0===c||c.send(JSON.stringify(u))},this.checkNonFatalRetriesLimit=e=>{if(e.fatal)return ln.ok(!0);if(this.connectionAttempts<=this.maxConnectRetries)return ln.ok(!0);this.logger.debug({msg:`${this.id} maximum non-fatal retries of ${this.maxConnectRetries} exceeded`});const t=this.createError(Lr.JOIN_TIMED_OUT);return ln.err(t)},this.getRetryCount=()=>Math.max(this.connectionAttempts-1,0),this.trackSocketError=e=>{this.connecting&&this.trackJoinFailed(e,this.getRetryCount()),this.analyticsTracker.trackError(e)},this.trackJoinEnded=()=>{this.analyticsTracker.trackEventNoSharedProps(new EDPDisconnectedEvent({token:this.token,eventEndpoint:this.token.eventsURL,traceId:this.traceId,protocol:this.protocol}))},this.traceJoinOp=e=>{this.analyticsTracker.trackEventNoSharedProps(new TraceEvent(this.token,this.traceId,e,mr.JOIN))},this.logger=new ScopedLogger(t,de.SOCKET),this.emitter=new mt.EventEmitter,this.traceId=br(),this.id=`[${yr().value}] `;const r=_t("socketPingMs");void 0!==r&&(this.pingIntervalMs=r);const i=_t("socketPongMs");void 0!==i&&(this.pongTimeoutMs=i);const o=_t("socketConnectMaxRetries");void 0!==o&&(this.maxConnectRetries=o),window.addEventListener("beforeunload",this.beforeUnload)}connect(e,t,n=!1){this.close(),this.logger.debug({msg:`${this.id}connecting to ${this.addr}`}),this.addr=e,this.traceId=t,n&&!this.connecting&&(window.clearTimeout(this.connectTimeoutId),this.connectTimeoutId=window.setTimeout(this.connectTimedOut.bind(this),12e3)),this.attemptConnect(t)}send(e){var t;this.logger.debug({msg:`${this.id}sending ${JSON.stringify(e)}`}),this.logger.debug({msg:`${this.id}isReady called`}),this.isSocketOpen()?null===(t=this.socket)||void 0===t||t.send(JSON.stringify(e)):this.logger.warn({msg:"Trying to send data over stage socket that is not ready"})}close(){this.logger.debug({msg:`${this.id}closing`});const e=this.connecting,t=this.isSocketOpen(),n=this.socket&&this.socket.readyState===this.socket.CLOSING,r=this.getRetryCount();if(this.markSocketAsClosed(),this.clearPingPongTracking(),this.clearConnectionAttemptTimeouts(),this.connectionAttempts=0,this.socket)if(this.cleanupWebSocket(),t&&this.isStateMessageReceived()){const e="intentional-close";this.trackJoinEnded(),this.emitter.emit(ri,e)}else if(e&&!n){const e=this.createError(Lr.OPERATION_ABORTED);this.trackJoinFailed(e,r),this.analyticsTracker.trackError(e),this.emitter.emit(si,e)}}markSocketAsClosed(){this.closing=!0,this.connecting=!1}removeAllListeners(){window.removeEventListener("beforeunload",this.beforeUnload),this.emitter.removeAllListeners()}createWebSocket(e,t){return new WebSocket(e,t)}cleanupWebSocket(){this.socket&&(this.socket.close(),this.socket.onmessage=null,this.socket.onerror=null,this.socket.onclose=null,this.socket.onopen=null,this.socket=void 0)}createError(e,t){return new StageClientError(Object.assign({action:mr.JOIN,traceId:this.traceId,token:this.token,location:"StageSocket.connection",tag:Rr,details:t},e))}on(e,t){this.emitter.on(e,t)}off(e,t){this.emitter.off(e,t)}onMessage(e){this.logger.debug({msg:`${this.id}received message: ${e.data}`});try{const t=JSON.parse(e.data);switch(t.type){case"STAGE_STATE":case"aws:ivs:STAGE_STATE":{const e=t.payload.sequenceNumber;e>this.latestSequenceNumber&&(0===this.latestSequenceNumber&&this.connectTimeoutId>0?(this.triggerSocketOpen(t),window.setTimeout((()=>{this.emitter.emit(ai,t)}))):this.emitter.emit(ai,t),this.latestSequenceNumber=e);break}case"PONG":window.clearTimeout(this.pongTimeoutId),this.pongTimeoutId=0,this.analyticsTracker.trackEventNoSharedProps(new EDPPongEvent({token:this.token,eventEndpoint:this.token.eventsURL,protocol:this.protocol,traceId:this.traceId,edpRttMs:performance.now()-this.latestPingTimestamp}));break;case"REFRESH":this.emitter.emit(oi);break;case"aws:ivs:SDP_ANSWER":this.emitter.emit(ci,t.payload);break;case"aws:ivs:DISCONNECT":this.emitter.emit(ui,t.payload);break;case"aws:ivs:REASSIGN":this.emitter.emit(li,t.payload);break;case"aws:ivs:INCOMPATIBLE_CODECS":this.emitter.emit(di,t.payload);break;case"aws:ivs:SSU":this.emitter.emit(hi,t.payload);break;case"aws:ivs:JOIN_ERROR":this.handleJoinError(t.payload);break;default:(0,mn.noop)()}}catch(e){this.logger.debug({msg:`onMessage JSON Parse error: ${e}`}),this.emitter.emit(ii,e)}}onError(e){this.logger.debug({msg:`${this.id}error: ${JSON.stringify(e)}`})}onClose(e){if(this.logger.debug({msg:`${this.id} onClose triggered with code (closing = ${this.closing}, connecting = ${this.connecting})`}),this.clearPingPongTracking(),this.closing)return void(this.closing=!1);if(this.windowUnloading)return;const t=`code: ${null==e?void 0:e.code}, reason: ${null==e?void 0:e.reason}, wasClean: ${null==e?void 0:e.wasClean}`;if(this.connecting){const e=this.createError(Lr.EVENT_PLANE_WS_CLOSE_BEFORE_OPEN,t);return void this.handleSocketError(e)}this.logger.debug({msg:`${this.id}unexpected close`}),this.emitter.emit(ri,"unknown");const n=this.createError(Lr.EVENT_PLANE_WS_UNEXPECTED_CLOSE,t);this.trackJoinEnded(),this.emitter.emit(si,n)}onOpen(){this.logger.debug({msg:`${this.id} socket opened`}),this.clearConnectionAttemptTimeouts(),this.connectTimeoutId=window.setTimeout(this.triggerSocketOpen,12e3)}clearConnectionAttemptTimeouts(){window.clearTimeout(this.nextConnectionAttemptId),window.clearTimeout(this.connectTimeoutId),this.nextConnectionAttemptId=0,this.connectTimeoutId=0}clearConnectionAttempts(){this.connectionAttempts=0}connectTimedOut(){this.connecting=!1,this.logger.debug({msg:`${this.id} Connect timed out!`});const e=this.createError(Lr.JOIN_TIMED_OUT);this.isSocketConnecting()&&this.trackJoinFailed(e,this.getRetryCount()),this.emitter.emit(si,e),this.close()}clearPingPongTracking(){window.clearInterval(this.pingIntervalId),window.clearTimeout(this.pongTimeoutId),this.pingIntervalId=0,this.pongTimeoutId=0}handleJoinError(e){const t=function(e){var t,n;let r;switch(e.code){case Cr.TOKEN_EXPIRED:r=Lr.EXPIRED_TOKEN;break;case Cr.TOKEN_INVALID:case Cr.TOKEN_INVALID_SIGNATURE:case Cr.TOKEN_MISSING:r=Lr.MALFORMED_TOKEN;break;case Cr.STAGE_DELETED:r=Lr.STAGE_DELETED;break;case Cr.PARTICIPANT_DISCONNECTED:r=Lr.PARTICIPANT_DISCONNECTED;break;case Cr.INTERNAL:r=Lr.JOIN_SERVER_INTERNAL_ERROR;break;case Cr.BAD_REQUEST:r=Lr.JOIN_SERVER_BAD_REQUEST;break;default:r=Object.assign(Object.assign({},Lr.JOIN_FAILURE),{message:e.message||Lr.JOIN_FAILURE.message})}return Object.assign(Object.assign({},r),{fatal:null!==(t=e.fatal)&&void 0!==t?t:r.fatal,nominal:null!==(n=e.nominal)&&void 0!==n?n:r.nominal})}(e),n=this.createError(t,`JOIN_ERROR: ${e.code}`);this.logger.debug({msg:`${this.id} received JOIN_ERROR: ${JSON.stringify(e)}`}),this.handleSocketError(n)}handleSocketError(e){const t=this.checkNonFatalRetriesLimit(e);let n=e;t.ok||(n=t.error,n.details=`Timeout triggered by ${e.code}`),this.trackSocketError(n),this.markSocketAsClosed(),this.clearPingPongTracking(),this.clearConnectionAttemptTimeouts(),this.cleanupWebSocket(),n.fatal?(this.clearConnectionAttempts(),this.emitter.emit(si,n)):this.queueExponentialBackoffRetry()}queueExponentialBackoffRetry(){let e=Math.pow(2,this.connectionAttempts-1);e>32&&(e=32),this.logger.debug({msg:`${this.id} reconnecting in ${e} seconds`}),window.clearTimeout(this.nextConnectionAttemptId),this.nextConnectionAttemptId=window.setTimeout(this.attemptConnect,1e3*e)}isSocketConnecting(){return this.socket&&this.socket.readyState===this.socket.CONNECTING}isSocketOpen(){return this.socket&&this.socket.readyState===this.socket.OPEN}isStateMessageReceived(){return 0!==this.latestSequenceNumber}trackJoinStarted(e){this.analyticsTracker.trackEventNoSharedProps(new EDPConnectedEvent({token:this.token,eventEndpoint:this.token.eventsURL,numRetries:e,protocol:this.protocol,traceId:this.traceId}))}trackJoinAttempt(e){const{token:t,traceId:n}=this;this.analyticsTracker.trackEvent(new JoinAttemptEvent({token:t,eventEndpoint:(null==t?void 0:t.eventsURL)||"",whipEndpoint:(null==t?void 0:t.whipURL)||"",traceId:n}))}trackJoinFailed(e,t){const{token:n,traceId:r,code:i,message:o,fatal:s,nominal:a}=e;this.analyticsTracker.trackEvent(new JoinFailedEvent({token:n,eventEndpoint:n.eventsURL,whipEndpoint:n.whipURL,traceId:r,code:i,message:o,fatal:s,nominal:a,retryCnt:t}))}}var as=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};var cs,us,ls,ds;!function(e){e.SDP_EXCHANGE="xdp",e.JITTER_BUFFER_MIN_DELAY_MS="jit_buf_min_delay_ms"}(cs||(cs={})),function(e){e.USER_INITIATED="user-initiated",e.CLIENT_RECONNECT="reconnect",e.TOKEN_REUSED="token-reused",e.UNKNOWN="unknown",e.PARTICIPANT_DISCONNECTED="participant-disconnected",e.STAGE_DELETED="stage-deleted",e.TOKEN_EXPIRED="token-expired"}(us||(us={})),function(e){e[e.NOT_CONNECTED=0]="NOT_CONNECTED",e[e.CONNECTION_LOST=1]="CONNECTION_LOST",e[e.TIMEDOUT=2]="TIMEDOUT",e[e.ABORTED=3]="ABORTED",e[e.INVALID_MESSAGE=4]="INVALID_MESSAGE",e[e.UNEXPECTED_ERROR=5]="UNEXPECTED_ERROR"}(ls||(ls={})),function(e){e.DISCONNECTED="disconnected",e.CONNECTING="connecting",e.CONNECTED="connected",e.ERRORED="errored"}(ds||(ds={}));class StageConnection extends TypedEmitter{constructor(e,t,n){super(),this.token=e,this.nonScopedLogger=t,this.analyticsTracker=n,this.participants=new Map,this.disconnected=[],this.state={value:ds.DISCONNECTED,context:{connectStartTime:0,hasConnected:!1}},this.features={sdpExchange:!1},this.stats=this.resetStats(),this.stageMinutesLogged=0,this.isStagePublishing=!1,this.onConnecting=(e,t)=>{this.logger.debug({msg:"onConnecting",context:e,event:t}),e.connectStartTime=performance.now();const n="RECONNECT"===t.type;n&&this.stageSocket.close();const{eventsURL:r}=this.token;this.emit(Hr,ds.CONNECTING),this.state.value=ds.CONNECTING;const i=!n;this.stageSocket.connect(r,this.traceId,i)},this.onConnected=(e,t)=>{this.logger.debug({msg:"onConnected",context:e,event:t}),e.hasConnected=!0,this.emit(xr),this.emit(Hr,ds.CONNECTED),this.state.value=ds.CONNECTED},this.onDisconnected=(e,t)=>{this.logger.debug({msg:"onDisconnected",context:e}),this.state.value=ds.DISCONNECTED,this.stopStageMinuteLoggedInterval(!0),this.stageSocket.close(),e.hasConnected=!1,this.participants=new Map,this.disconnected=[],this.stageSocket.removeAllListeners(),this.resetStats(),this.emit(Hr,ds.DISCONNECTED,t)},this.onErrored=(e,t)=>{var n;this.logger.error({msg:"Connection failure occurred",err:t.payload.error}),this.emit(Hr,ds.ERRORED),this.emit(Wr,t.payload.error),this.state.value=ds.ERRORED;const r=t.payload.error;if(r instanceof StageClientError&&r.fatal&&(null===(n=r.details)||void 0===n?void 0:n.includes("JOIN_ERROR"))&&e.hasConnected){const e=this.mapJoinErrorCodeToDisconnectReason(r);this.processStateUpdate({type:"DISCONNECT",reason:e})}else e.hasConnected?this.processStateUpdate({type:"RECONNECT"}):this.stageSocket.close()},this.processStateUpdate=e=>{const t=this.state.value,n=this.state.context;switch(t){case ds.DISCONNECTED:"CONNECT"===e.type&&this.onConnecting(n,e);break;case ds.CONNECTING:"RECONNECT"===e.type?this.onConnecting(n,e):"DISCONNECT"===e.type?this.onDisconnected(n,e.reason):"CONNECT_SUCCESS"===e.type?this.onConnected(n,e):"ERROR"===e.type&&this.onErrored(n,e);break;case ds.CONNECTED:"RECONNECT"===e.type?this.onConnecting(n,e):"DISCONNECT"===e.type?this.onDisconnected(n,e.reason):"ERROR"===e.type&&this.onErrored(n,e);break;case ds.ERRORED:"RECONNECT"===e.type?this.onConnecting(n,e):"DISCONNECT"===e.type&&this.onDisconnected(n,e.reason)}},this.measureConnect=(e,t)=>{const n=this.stats.edpConnectCount,r=n+1,i=performance.now(),o=i-t;return Object.assign(this.stats,{edpConnectCount:r,edpConnectDuration:o}),0===n&&Object.assign(this.stats,{edpInitialStartConnectTime:t,edpInitialFinishConnectTime:i,edpInitialConnectDuration:o,edpInitialConnectRetries:e}),this.stats},this.measureStateUpdate=e=>{const{edpInitialFinishConnectTime:t}=this.stats,n=this.stats.edpStateUpdateCount,r=n+1;return Object.assign(this.stats,{edpStateUpdateCount:r}),0===n&&Object.assign(this.stats,{edpInitialStateDuration:performance.now()-t,edpInitialStatePublishingCount:e}),this.stats},this.trackMessageParseError=e=>{this.logger.error({msg:"Message Parse Error occurred",err:e.err});const t=new StageClientError({token:e.token,traceId:e.traceId,code:Lr.WEBSOCKET_MESSAGE_PARSE_FAILURE.code,tag:e.tag,location:e.location,message:e.message,details:e.err.message});this.analyticsTracker.trackEvent(new StageErrorEvent(t))},this.trackStageSocketMessageParseError=(e,t,n)=>{this.trackMessageParseError({token:e,traceId:t,tag:Rr,location:"StageConnection.onMessage",message:Lr.WEBSOCKET_MESSAGE_PARSE_FAILURE.message,err:n})},this.trackStageStateMessageParseError=(e,t,n,r)=>{this.trackMessageParseError({token:e,traceId:t,tag:Rr,location:"StageConnection.onStageStateMessage",message:r,err:n})},this.onDisconnectMessage=e=>{this.analyticsTracker.trackEventNoSharedProps(new TraceEvent(this.token,this.traceId,`DISCONNECT message received: ${e.code}:${e.reason}`,mr.JOIN));let t=us.UNKNOWN;if("PARTICIPANT_DISCONNECTED"===e.code)t=us.PARTICIPANT_DISCONNECTED;else if("STAGE_DELETED"===e.code)t=us.STAGE_DELETED;else if("TOKEN_REUSED"===e.code&&(t=us.TOKEN_REUSED,St("disableTokenReuseMessage")))return void console.warn("Token reuse is detected, but skipping as feature is disabled");console.warn(`Disconnecting client due to: ${e.reason}`),this.processStateUpdate({type:"DISCONNECT",reason:t})},this.onReassignmentMessage=e=>{this.emit($r,e)},this.onIncompatibleCodecsMessage=e=>{this.emit(qr,e)},this.onSsuMessage=e=>{var t;const n=window.atob(null!==(t=e.A)&&void 0!==t?t:"").trim();n&&n.startsWith("http")?Ln.currentEndpoint=n:this.logger.warn({msg:"SSU Url invalid"})},this.onStageStateMessage=(e,t,n)=>{var r,i;this.logger.debug({msg:"State Stage Message occurred",state:n});const o=n.payload,s=null!==(r=o.participants)&&void 0!==r?r:[],a=null!==(i=o.disconnected)&&void 0!==i?i:[],c=[],u=[];this.measureStateUpdate(s.length),this.enableFeaturesBasedOnServerFeatures(o.serverFeatures||[]);const l=(n,r)=>{this.analyticsTracker.trackEventNoSharedProps(new StateUpdatedEvent({token:e,otherParticipantId:n.id,otherParticipantUserId:n.userId,isAudioMuted:n.audioMuted,isVideoStopped:n.videoStopped,isPublishing:n.isPublishing,isDisconnected:r,traceId:t}))};this.participants.forEach((e=>{const t=s.find((t=>t.id===e.id));if(t){let n=!0,r=!1;["isPublishing","id","audioMuted","joinedAt","userId","videoStopped"].forEach((i=>{n=n&&t[i.toString()]===e[i.toString()],n||(e[i.toString()]=t[i.toString()],r=!0)})),Object.keys(e.attributes).forEach((i=>{n=n&&t.attributes[i]===e.attributes[i],n||(e.attributes=t.attributes,r=!0)})),r&&(l(e,!1),this.emit(Fr,t))}else u.push(e)})),s.forEach((e=>{this.participants.get(e.id)||c.push(e)})),u.forEach((e=>{this.participants.delete(e.id),l(e,!0),this.emit(Ur,e)})),c.forEach((e=>{this.participants.set(e.id,e),l(e,!1),this.emit(Br,e)})),a.forEach((e=>{this.disconnected.find((t=>t.id===e.id))||(this.disconnected.push(e),"KICKED"===e.status&&this.emit(jr,e))})),this.disconnected=a},this.nonScopedLogger=t,this.logger=new ScopedLogger(t,de.CONNECTION),this.stageSocket=new StageSocket(e,this.nonScopedLogger,n),this.token=e,this.traceId=br()}resetStats(){return this.stats={isConnected:!1,edpInitialStartConnectTime:0,edpInitialFinishConnectTime:0,edpConnectCount:0,edpInitialConnectDuration:0,edpConnectDuration:0,edpInitialStateDuration:0,edpInitialStatePublishingCount:0,edpStateUpdateCount:0,edpInitialConnectRetries:0},this.stats}connect(e){return as(this,void 0,void 0,(function*(){return this.logger.debug({msg:"connect invoked",token:this.token,traceId:e}),this.traceId=e,this.state.value!==ds.DISCONNECTED&&(this.logger.debug({msg:"Disconnecting previous connection"}),this.processStateUpdate({type:"DISCONNECT",reason:us.CLIENT_RECONNECT})),new Promise(((t,n)=>{this.stageSocket.on(ni,(e=>{var n,r;const{retryCnt:i,initialStageState:o}=e;o&&this.enableFeaturesBasedOnServerFeatures(null!==(r=null===(n=o.payload)||void 0===n?void 0:n.serverFeatures)&&void 0!==r?r:[]),this.traceId=e.traceId||br(),this.measureConnect(i,this.state.context.connectStartTime),this.processStateUpdate({type:"CONNECT_SUCCESS"}),this.startStageMinuteLoggedInterval(this.token,this.traceId),t(this.traceId)})),this.stageSocket.on(si,(e=>{n(e),this.processStateUpdate({type:"ERROR",payload:{error:e}})})),this.stageSocket.on(oi,(()=>{this.logger.debug({msg:"Refresh event occurred"}),this.emit(Gr),this.processStateUpdate({type:"RECONNECT"})})),this.stageSocket.on(ai,(e=>this.onStageStateMessage(this.token,this.traceId,e))),this.stageSocket.on(ii,(e=>this.trackStageSocketMessageParseError(this.token,this.traceId,e))),this.stageSocket.on(ui,this.onDisconnectMessage),this.stageSocket.on(li,this.onReassignmentMessage),this.stageSocket.on(di,this.onIncompatibleCodecsMessage),this.stageSocket.on(hi,this.onSsuMessage),this.stageSocket.on(ri,(e=>{this.stopStageMinuteLoggedInterval()})),this.processStateUpdate({type:"CONNECT",payload:{token:this.token,traceId:e}})}))}))}disconnect(){return this.logger.debug({msg:"disconnect invoked"}),this.processStateUpdate({type:"DISCONNECT",reason:us.USER_INITIATED}),this.traceId}getParticipant(e){return this.participants.get(e)}listConnectedParticipants(){const e=[];return this.participants.forEach((t=>{t.subscribed&&e.push(t)})),e}listAvailableParticipants(){return Array.from(this.participants.values())}emitStageState(e,t){this.stageSocket.send({audioMuted:e,type:"SET_STATE",version:"0",videoStopped:t})}setStagePublishing(e){this.isStagePublishing=e,this.emit(Vr,this.isStagePublishing)}getIsStagePublishing(){return this.isStagePublishing}startStageMinuteLoggedInterval(e,t){this.uploadStageMinutesBroadcastInterval||(this.analyticsTracker.trackEvent(new MinuteEvent(e,t,this.stageMinutesLogged,this.isStagePublishing,0)),this.stageMinutesLogged++,this.uploadStageMinutesBroadcastInterval=setInterval((()=>{this.analyticsTracker.trackEvent(new MinuteEvent(e,null!=t?t:br(),this.stageMinutesLogged,this.isStagePublishing,0)),this.stageMinutesLogged++}),6e4))}stopStageMinuteLoggedInterval(e=!1){this.uploadStageMinutesBroadcastInterval&&(clearInterval(this.uploadStageMinutesBroadcastInterval),this.uploadStageMinutesBroadcastInterval=void 0),e&&(this.stageMinutesLogged=0)}enableFeaturesBasedOnServerFeatures(e){const t=(e,t)=>{this.trackStageStateMessageParseError(this.token,this.traceId,t,`Could not parse "${e}" from the Eevee server features list`)},n=e.includes(cs.SDP_EXCHANGE);this.features.sdpExchange!==n&&(this.logger.debug({msg:`XDP SDP exchange feature toggled: ${n}`}),this.features.sdpExchange=n);const r=e.find((e=>-1!==e.indexOf(cs.JITTER_BUFFER_MIN_DELAY_MS))),i=e=>{this.logger.debug({msg:`jitterBufferMinDelay feature updated to: ${e}`}),this.features.jitterBufferMinDelayInMs=e};if(void 0!==r)try{const e=r.split("=")[1],t=parseInt(e,10);if(isNaN(t))throw new Error("Unable to parse - result is NaN");if(t<0)throw new Error("Unable to apply - result is negative");void 0!==this.features.jitterBufferMinDelayInMs&&this.features.jitterBufferMinDelayInMs===t||i(t)}catch(e){t(r,e),i(void 0)}else i(void 0)}mapJoinErrorCodeToDisconnectReason(e){switch(e.code){case Lr.PARTICIPANT_DISCONNECTED.code:return us.PARTICIPANT_DISCONNECTED;case Lr.STAGE_DELETED.code:return us.STAGE_DELETED;case Lr.EXPIRED_TOKEN.code:return us.TOKEN_EXPIRED;default:return us.UNKNOWN}}isConnected(){return this.state.value===ds.CONNECTED}supportsSdpExchange(){return this.features.sdpExchange}jitterBufferMinDelayInMs(){return this.features.jitterBufferMinDelayInMs}getConnectionStats(){return Object.assign({},this.stats,{isConnected:this.isConnected()})}exchangeSdp(e,t,n,r,i,o,s,a,c){return as(this,void 0,void 0,(function*(){return this.isConnected()?new Promise(((u,l)=>{const d=window.setTimeout((()=>{h(),l(ls.TIMEDOUT)}),12e3),h=()=>{window.clearTimeout(d),this.stageSocket.off(ci,p),this.stageSocket.off(si,f)},p=e=>{e.requestId===r&&(h(),u(e))},f=()=>{h(),l(ls.CONNECTION_LOST)};null==i||i.addEventListener("abort",(()=>{h(),l(ls.ABORTED)})),this.stageSocket.on(ci,p),this.stageSocket.on(si,f),this.stageSocket.sendSdpOffer(e,t,n,r,o,s,a,c)})):Promise.reject(ls.NOT_CONNECTED)}))}}class BaseSdpExchanger{constructor(e){this.token=e}}const hs=new RegExp("^(?:[a-z+]+:)?//","i");function ps(e){return hs.test(e)}function fs({sdpExchangeTransport:e,serverHttpResponse:t,serverErrorCode:n}){return`sdpExchangeTransport: ${e}, serverHttpResponse: ${t}, serverErrorCode: ${n}`}var gs=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};const ms={[ls.ABORTED]:Lr.OPERATION_ABORTED,[ls.NOT_CONNECTED]:Lr.EVENT_PLANE_WS_UNEXPECTED_CLOSE,[ls.CONNECTION_LOST]:Lr.XDP_CONNECTION_LOST,[ls.TIMEDOUT]:Lr.XDP_TIMEOUT,[ls.INVALID_MESSAGE]:Lr.XDP_INVALID_ANSWER_MSG,[ls.UNEXPECTED_ERROR]:Lr.XDP_UNEXPECTED_ERROR};class EdpSdpExchanger extends BaseSdpExchanger{constructor(e,t,n,r){super(e),this.token=e,this.stageConnection=t,this.contextData=n,this.analyticsTracker=r}exchange(e){return gs(this,void 0,void 0,(function*(){const t=yr(),{action:n}=this.contextData,{sdpOffer:r,url:i,traceId:o,forceNode:s,assignmentToken:a,multiCodec:c,abortController:u,initialLayerPreference:l}=e;let d;this.trackAttempt(i,t,o);try{d=yield this.stageConnection.exchangeSdp(r,i,o.value,t.value,null==u?void 0:u.signal,s,a,c,l)}catch(e){if("number"==typeof e)throw this.createClientSideErrorFromReasonCode(e,o,t,n)}if(!d)return;const{httpStatusCode:h,errorCode:p,location:f,content:g,sessionDeleteLink:m,subscriberControlLink:v,videoLayersLink:E}=d;if(h>=200&&h<300)return{sdpAnswer:g,url:i,location:f,sessionDeleteLink:m,mediaControls:v,layerControls:E};throw this.createServerSideError(o,t,h,p,n)}))}trackAttempt(e,t,n){const{remoteParticipantId:r,action:i}=this.contextData;this.analyticsTracker.trackEventNoSharedProps(new ServerRequestEvent(i,this.token,e,"POST",t.value,r,n,"xdp"))}createServerSideError(e,t,n,r,i){const o=this.baseErrorProps(e,t);let s=Dr(n,r);return s||(s=Lr.UNKNOWN_SERVER_ERROR),new StageClientError(Object.assign(Object.assign(Object.assign({action:i},o),s),{details:fs({sdpExchangeTransport:"xdp",serverHttpResponse:n,serverErrorCode:r})}))}baseErrorProps(e,t){const{remoteParticipantId:n,action:r}=this.contextData;return{token:this.token,traceId:e,tag:kr(r,n),location:"EdpSdpExchanger.exchange",requestUUID:t,remoteParticipantId:n}}createClientSideErrorFromReasonCode(e,t,n,r){const i=this.baseErrorProps(t,n),o=ms[e];return new StageClientError(o?Object.assign(Object.assign({action:r},i),o):Object.assign(Object.assign({action:r},i),Lr.XDP_INVALID_ANSWER_MSG))}getTransport(){return"sdp"}}var vs=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};class HttpSdpExchanger extends BaseSdpExchanger{constructor(e,t,n){super(e),this.contextData=t,this.analyticsTracker=n}exchange(e){var t,n,r;return vs(this,void 0,void 0,(function*(){const i=yr(),{token:o}=this,{action:s,remoteParticipantId:a}=this.contextData,{sdpOffer:c,url:u,traceId:l,forceNode:d,assignmentToken:h,multiCodec:p,abortController:f,initialLayerPreference:g}=e;try{const e="POST",t="http";this.analyticsTracker.trackEventNoSharedProps(new ServerRequestEvent(s,o,u,e,i.value,a,l,t));const n={data:c,headers:{Authorization:`Bearer ${o.rawToken}`,"Content-Type":"application/sdp","X-Stages-Platform":"web","X-Stages-Request-ID":i.value,"X-Stages-SDK":"1.30.0","X-Stages-Session-ID":this.analyticsTracker.getSessionId(),"X-Stages-Trace-ID":l.value,"X-Stages-WHIP-Version":mi,[Er]:(m=JSON.stringify({[Sr]:["sau"]}),btoa(m).replace(/[^A-Za-z0-9+/]/g,""))},method:e,responseType:"text",url:u,signal:null==f?void 0:f.signal,params:{}};d&&(n.params.force_node=d),h&&(n.params.assignment_token=h),p&&(n.params.multi_codec=!0);const r=void 0===It(),v=It()||r;g&&n.headers&&v&&(n.headers["X-Stages-Initial-Layer-Pref"]=Ri(g));const{data:E,headers:S,request:_}=yield $t(n),y=this.parseWhipResource(u,S.location,S.link);return{url:_.responseURL,sdpAnswer:E,location:null==y?void 0:y.location,sessionDeleteLink:null==y?void 0:y.sessionDeleteLink,mediaControls:null==y?void 0:y.mediaControls,layerControls:null==y?void 0:y.layerControls}}catch(e){if(Mt().isCancel(e)){throw new StageClientError(Object.assign(Object.assign({},Pr(Lr.OPERATION_ABORTED,e)),{action:s,token:o,traceId:l,tag:kr(s,a),location:"StagePeerClient.start",requestUUID:i,remoteParticipantId:a}))}const c=Number(null===(t=null==e?void 0:e.response)||void 0===t?void 0:t.status)||-1,u=(null===(r=null===(n=null==e?void 0:e.response)||void 0===n?void 0:n.data)||void 0===r?void 0:r.code)||-1,d=function(e,t){var n;if(!(e instanceof Lt.AxiosError&&e.response&&"number"==typeof e.response.status))return t;if(e instanceof Lt.AxiosError&&"ERR_NETWORK"===e.code)return Lr.NETWORK_FAILURE;const r=Dr(Number(e.response.status),null===(n=e.response.data)||void 0===n?void 0:n.code);return r||t}(e,Lr.WHIP_POST_FAILURE);throw new StageClientError(Object.assign(Object.assign({},Pr(d,e)),{action:s,token:o,traceId:l,tag:kr(s,a),details:fs({sdpExchangeTransport:"http",serverHttpResponse:c,serverErrorCode:u}),location:"StagePeerClient.start",requestUUID:i,remoteParticipantId:a}))}var m}))}parseWhipResource(e,t,n){const r=new URL(e);let i;return i=function(e,t,n){if(!n)return e;if(e||(e={}),ps(n))return e.location=n,e;const r=t.port?`:${t.port}`:"";return e.location=`${t.protocol}//${t.hostname}${r}${n}`,e}(i,r,t),i=function(e,t,n){if(!n)return e;e||(e={});const r=e;return n.split(",").forEach((e=>{const n=/<(.+)>;\s?rel="([a-z:-]+)"/.exec(e);if(3!==(null==n?void 0:n.length))return;let i;if(ps(n[1]))i=n[1];else{const e=t.port?`:${t.port}`:"";i=`${t.protocol}//${t.hostname}${e}${n[1]}`}switch(n[2]){case"urn:ietf:params:whip:ivs-stages:session-delete":r.sessionDeleteLink=i;break;case"urn:ietf:params:whep:core:playback-controls":r.mediaControls=i;break;case"urn:ietf:params:whep:ext:core:layer":r.layerControls=i;break;default:return}})),r}(i,r,n),i}getTransport(){return"http"}}function Es(e){const{connection:t,token:n,action:r,identifier:i,tracker:o}=e,s=t&&t.supportsSdpExchange()&&t.isConnected(),a=r===mr.SUBSCRIBE&&s&&!Tt()&&!St("disableXdpSubscribe"),c=r===mr.PUBLISH&&s&&!Tt()&&!St("disableXdpPublish");return a||c?new EdpSdpExchanger(n,t,{action:r,remoteParticipantId:i},o):new HttpSdpExchanger(n,{action:r,remoteParticipantId:i},o)}function Ss({stageErrorValue:e,action:t,token:n,traceId:r,tag:i,identifier:o,details:s}){return new StageClientError(Object.assign(Object.assign({},e),{token:n,traceId:r,location:"peer-client",tag:i,action:t,remoteParticipantId:o,details:s}))}var _s;function ys(e){var t;return(null===(t=null==e?void 0:e.sender)||void 0===t?void 0:t.createEncodedStreams)?_s.INSERTABLE_STREAMS:window.RTCRtpSender&&"transform"in RTCRtpSender.prototype&&window.RTCRtpScriptTransform?_s.ENCODED_TRANSFORMS:_s.NONE}function bs(e){var t;return(null===(t=null==e?void 0:e.receiver)||void 0===t?void 0:t.createEncodedStreams)?_s.INSERTABLE_STREAMS:window.RTCRtpReceiver&&"transform"in RTCRtpReceiver.prototype&&window.RTCRtpScriptTransform?_s.ENCODED_TRANSFORMS:_s.NONE}function Ts(){return sr()('/*! For license information please see transform.worker.worker.js.LICENSE.txt */\n(()=>{"use strict";const e=new Uint8Array([158,80,78,165,238,90,79,2,148,159,176,51,163,118,141,162]);var t;!function(e){e.VIDEO_SEND="video/send",e.VIDEO_RECEIVE="video/receive",e.INSERT_SEI="insertSei"}(t||(t={}));function n(t,n){const{transformerId:s,type:r,payloads:a}=n;let o=[];if("sei"===n.type){const{value:n,messages:s}=function(t,n){function s(e,t,n){return n+t.length<=e.byteLength&&t.every(((t,s)=>e.getUint8(n+s)===t))}function r(e,t){const n=function(e,t){return new Uint8Array([0,0,1,6,5,...t,...e])}(e,function(e){const t=[];for(;e>=255;)t.push(255),e-=255;return t.push(e),new Uint8Array(t)}(t.length+e.length)),s=function(e){const t=[...e];let n=3;for(;n<t.length-2;)0!==t[n]||0!==t[n+1]||0!==t[n+2]&&1!==t[n+2]&&2!==t[n+2]&&3!==t[n+2]?n+=1:(t.splice(n+2,0,3),n+=3);return t}(new Uint8Array([...n,...t,128]));return new Uint8Array(s)}function a(e,n){const r=function(e){const t=new DataView(e);for(let e=0;e<t.byteLength-4;e++)if(s(t,[0,0,1],e)){const n=31&t.getUint8(e+3);if(n>=1&&n<=5)return e}return-1}(t.data);if(r>=0){const e=new ArrayBuffer(t.data.byteLength+n.byteLength),s=new Uint8Array(e);return s.set(new Uint8Array(t.data.slice(0,r)),0),s.set(n,r),s.set(new Uint8Array(t.data.slice(r)),r+n.byteLength),e}return e}return function(){const s=[];for(let o=0;o<n.length;o+=1){const i=r(e,new Uint8Array(n[o]));t.data=a(t.data,i),s.push({uuid:e,payload:n[o]})}return{value:t,messages:s}}()}(t,a||[]);t=n,o=s}return{success:!0,frame:t,transformerId:s,type:r,seiResult:o}}const s=function(){let e=[];const t=new Map;return{add:({payload:t,repeatCount:n})=>(e.push({payload:t,repeatCount:n}),!0),poll(n){t.has(n)||t.set(n,[]),t.size>0&&(t.forEach((t=>{t.push(...e)})),e=[]);const s=t.get(n)||[],r=s.filter((e=>e.repeatCount>0)).map((e=>Object.assign(Object.assign({},e),{repeatCount:e.repeatCount-1})));return t.set(n,r),s}}}(),r=e=>(t,r)=>{try{const a=t.getMetadata().synchronizationSource,o=(s?s.poll(a):[]).map((e=>e.payload)),i=n(t,Object.assign(Object.assign({},e),{payloads:o}));r.enqueue(i.frame),self.postMessage(Object.assign({success:i.success,seiResult:i.seiResult},e))}catch(t){self.postMessage(Object.assign({success:!1},e))}},a=e=>(t,n)=>{try{const s=function(e,t){const{type:n,transformerId:s}=t;if("sei"===n){const t=function(e){function t(e,t,n){return n+t.length<e.byteLength&&t.every(((t,s)=>e.getUint8(n+s)===t))}function n(e){const t=[];let n=0;for(;n<e.length;)0===e[n]&&0===e[n+1]&&3===e[n+2]?(t.push(e[n]),t.push(e[n+1]),n+=3):(t.push(e[n]),n+=1);return new Uint8Array(t)}function s(e){let t=2;const n=e.byteLength;for(;t<n;){let s=0;for(;t<n&&255===e[t];)s+=255,t++;s+=e[t],t++;const r=Math.min(t+s,n),a=new Uint8Array(e.slice(t,r));return{uuid:a.slice(0,16),payload:a.slice(16)}}}return{messages:function(e){const r=new DataView(e.data),a=[];let o=0;if(!t(r,[0,0,1],0)&&!t(r,[0,0,0,1],0))return[];for(;o<r.byteLength-5;)if(t(r,[0,0,1],o)){const i=o+3;o=i;const c=31&r.getUint8(o),u=31&r.getUint8(o+1);if(6===c&&5===u){for(;o<r.byteLength&&!t(r,[0,0,1],o);)o++;const c=o,u=s(n(new Uint8Array(e.data.slice(i,c))));u&&a.push(Object.assign({},u))}else o++}else o++;return a}(e),frame:e}}(e),{frame:r,messages:a}=t;return{success:!0,frame:r,type:n,transformerId:s,seiResult:a}}return{success:!0,frame:e,transformerId:s,type:n}}(t,e);n.enqueue(s.frame),self.postMessage(Object.assign({success:s.success,seiResult:s.seiResult},e))}catch(t){self.postMessage(Object.assign({success:!1},e))}};function o(e,t,n,s){const o=new TransformStream({transform:"video/send"===e?r(t):a(t)});n.pipeThrough(o).pipeTo(s)}const i=self;i.addEventListener("message",(function(e){var n,r,a;if(!(null===(n=null==e?void 0:e.data)||void 0===n?void 0:n.operation)||!(null===(r=null==e?void 0:e.data)||void 0===r?void 0:r.transformerId))return;const{operation:i,transformerId:c}=e.data;switch(i){case t.VIDEO_SEND:case t.VIDEO_RECEIVE:o(i,{method:i,transformerId:c,type:"sei"},e.data.readable,e.data.writable);break;case t.INSERT_SEI:s.add({payload:e.data.payload,repeatCount:null!==(a=e.data.repeatCount)&&void 0!==a?a:0})}})),i.addEventListener("rtctransform",(function(e){const t=e.transformer;if(!t)return;o(t.options.method,t.options,t.readable,t.writable)}))})();',"Worker",void 0,void 0)}!function(e){e.NONE="none",e.ENCODED_TRANSFORMS="encodedTransforms",e.INSERTABLE_STREAMS="insertableStreams"}(_s||(_s={}));const Cs=(()=>{const e={};return{getWorker:t=>(e[t]||(e[t]=new Ts),e[t]),destroy:t=>{var n;null===(n=e[t])||void 0===n||n.terminate(),e[t]=void 0}}})();var Is;!function(e){e.NOT_PUBLISHING_VIDEO="NOT_PUBLISHING_VIDEO",e.INBAND_MESSAGING_NOT_ENABLED="INBAND_MESSAGING_NOT_ENABLED",e.INVALID_REPEAT_COUNT="INVALID_REPEAT_COUNT",e.PAYLOAD_SIZE_INVALID="PAYLOAD_SIZE_INVALID",e.PAYLOAD_RATE_EXCEEDED="PAYLOAD_RATE_EXCEEDED",e.INVALID_TRACK_TYPE="INVALID_TRACK_TYPE"}(Is||(Is={}));class SeiSendRequestValidator{constructor(e){this.maxFramerate=e,this.queued=[]}validateMessagePayload(e,t){if(e.byteLength<=0)return ln.err(Is.PAYLOAD_SIZE_INVALID);if(t<0||t>30)return ln.err(Is.INVALID_REPEAT_COUNT);if(e.byteLength>1024)return ln.err(Is.PAYLOAD_SIZE_INVALID);this.queued=this.trimPastPayloads(this.queued,1e3);const{before:n,after:r}=this.getPayloadSums(this.queued);if(n+e.byteLength>10240)return ln.err(Is.PAYLOAD_RATE_EXCEEDED);if(r+e.byteLength*Math.max(1,t)>10240)return ln.err(Is.PAYLOAD_RATE_EXCEEDED);if(this.queued.push({byteLength:e.byteLength,timestamp:Date.now()}),t>0){const n=1e3/this.maxFramerate;let r=Date.now()+n;for(let i=0;i<t;i+=1)this.queued.push({byteLength:e.byteLength,timestamp:r}),r+=n}return ln.ok(!0)}trimPastPayloads(e,t){const n=Date.now()-t;return e.filter((e=>e.timestamp>n))}getPayloadSums(e){const t=Date.now();return e.reduce(((e,n)=>{const{before:r,after:i}=e;return n.timestamp<=t?{before:r+n.byteLength,after:i}:{before:r,after:i+n.byteLength}}),{before:0,after:0})}}const Rs="seiMessageReceived",Os="error";var ws;!function(e){e.CREATED="created",e.INITIALIZED="initialized",e.DESTROYED="destroyed"}(ws||(ws={}));class VideoReceiverTransformer extends TypedEmitter{constructor(e){super(),this.sessionId=e,this.state=ws.CREATED,this.transformerId=yr().value,this.prevResultWasError=!1,this.consecutiveErrorResults=0,this.seiReadCnt=0,this.seiBytesRead=0,this.onMessage=e=>{this.onTransformResult(e.data)}}initializeInsertableStreams(e){var t,n;this.worker=Cs.getWorker(this.sessionId);const r=e.receiver.createEncodedStreams(),{readable:i,writable:o}=r;null===(t=this.worker)||void 0===t||t.postMessage({operation:"video/receive",transformerId:this.transformerId,readable:i,writable:o},[i,o]),null===(n=this.worker)||void 0===n||n.addEventListener("message",this.onMessage)}initializeEncodedTransforms(e){var t;this.worker=Cs.getWorker(this.sessionId);const n={method:"video/receive",type:"sei",transformerId:this.transformerId};e.receiver.transform=new RTCRtpScriptTransform(this.worker,n),null===(t=this.worker)||void 0===t||t.addEventListener("message",this.onMessage)}initialize(e,t){if(this.state!==ws.CREATED)return!1;const n=bs(e);if(n===_s.NONE)return!1;if(t&&n===_s.INSERTABLE_STREAMS)this.initializeInsertableStreams(e);else{if(t||n!==_s.ENCODED_TRANSFORMS)return!1;this.initializeEncodedTransforms(e)}return this.transceiver=e,this.state=ws.INITIALIZED,!0}onTransceiverAdd(e){return this.initialize(e,!0)}onTrackEvent(e){return"video"===e.track.kind&&this.initialize(e.transceiver,!1)}static isSupported(e){return bs(e)!==_s.NONE}onTransformResult(e){return e.transformerId===this.transformerId&&(e.success?(this.prevResultWasError=!1,this.consecutiveErrorResults=0,!!e.seiResult&&(e.seiResult.forEach((e=>{const{payload:t,uuid:n}=e;this.updateReadStats(e),this.emit(Rs,{uuid:n,payload:t})})),e.seiResult.length>0)):(this.prevResultWasError&&this.consecutiveErrorResults++,this.consecutiveErrorResults>=300&&this.onError(e,Lr.TRANSFORM_TOO_MANY_ERRORS),this.prevResultWasError=!0,this.onError(e,Lr.TRANSFORM_UNEXPECTED_ERROR),!1))}updateReadStats(e){this.seiReadCnt++,this.seiBytesRead+=e.payload.byteLength}getReceiverStats(){const{seiBytesRead:e,seiReadCnt:t}=this;return{seiReadCnt:t,seiBytesRead:e}}onError(e,t){const{type:n}=e;this.emit(Os,{type:n,stageErrorValue:t})}destroy(){var e,t;this.state!==ws.DESTROYED&&(this.removeAllListeners(),null===(e=this.worker)||void 0===e||e.removeEventListener("message",this.onMessage),(null===(t=this.transceiver)||void 0===t?void 0:t.receiver)&&(this.transceiver.receiver.transform=null),this.state=ws.DESTROYED)}getState(){return this.state}}class VideoSenderTransformer{constructor(e){this.sessionId=e,this.state=ws.CREATED,this.transformerId=yr().value,this.seiWriteCnt=0,this.seiBytesWritten=0,this.onMessage=e=>{this.onTransformResult(e.data)}}initializeInsertableStreams(e,t){var n,r;this.worker=Cs.getWorker(this.sessionId);const i=e.sender.createEncodedStreams(),{readable:o,writable:s}=i;null===(n=this.worker)||void 0===n||n.postMessage({operation:"video/send",transformerId:this.transformerId,readable:o,writable:s},[o,s]),null===(r=this.worker)||void 0===r||r.addEventListener("message",this.onMessage)}initializeEncodedTransforms(e,t){var n;this.worker=Cs.getWorker(this.sessionId);const r={method:"video/send",type:"sei",transformerId:this.transformerId,encodingLayers:t};e.sender.transform=new RTCRtpScriptTransform(this.worker,r),null===(n=this.worker)||void 0===n||n.addEventListener("message",this.onMessage)}initialize(e){var t;if(this.state!==ws.CREATED)return!1;const n=ys(e);if(n===_s.NONE)return!1;const r=e.sender.getParameters(),i=(null===(t=null==r?void 0:r.encodings)||void 0===t?void 0:t.length)||1;if(n===_s.INSERTABLE_STREAMS)this.initializeInsertableStreams(e,i);else{if(n!==_s.ENCODED_TRANSFORMS)return!1;this.initializeEncodedTransforms(e,i)}return this.transceiver=e,this.state=ws.INITIALIZED,!0}static isSupported(e){return ys(e)!==_s.NONE}sendSeiMessage(e,t){var n;return this.state===ws.INITIALIZED&&this.transceiver?(null===(n=this.worker)||void 0===n||n.postMessage({operation:"insertSei",transformerId:this.transformerId,payload:e,repeatCount:t}),ln.ok(!0)):ln.err(Is.NOT_PUBLISHING_VIDEO)}onTransceiverAdd(e){return this.initialize(e)}onTrackEvent(e){return!1}onTransformResult(e){return e.transformerId===this.transformerId&&(e.success&&this.updateSendStats(e),e.success)}updateSendStats(e){e.seiResult&&e.seiResult.forEach((e=>{this.seiWriteCnt++,this.seiBytesWritten+=e.payload.byteLength}))}getSenderStats(){const{seiBytesWritten:e,seiWriteCnt:t}=this;return{seiWriteCnt:t,seiBytesWritten:e}}destroy(){var e;this.state!==ws.DESTROYED&&((null===(e=this.transceiver)||void 0===e?void 0:e.receiver)&&(this.transceiver.receiver.transform=null),this.state=ws.DESTROYED)}getState(){return this.state}}class SelectedPairChangeEvent extends StageAnalyticsEvent{constructor(e,t,n,r,i,o,s,a,c){super(gt.SELECTED_PAIR_CHANGE,t,n,!1),Object.assign(this.properties,{action:e,protocol:r,local_type:i,local_addr:o,remote_addr:s,local_candidate_priority:a,remote_participant_id:c})}}var As=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};let ks=null;class StagePeerClient extends TypedEmitter{constructor(e,t,n,r,i,o,s,a,c){var u;if(super(),this.analyticsTracker=o,this.subscribeConfig=c,this.sfuResource={node:"",cluster:""},this.protocol="",this.incompatibleCodecs=new Set,this.connect=({audioOnly:e=!1,traceId:t,iceRestartOptions:n})=>As(this,void 0,void 0,(function*(){const{token:r,tag:i,identifier:o,action:s}=this,a=!!n,c=new AbortController;let u,l,d;this.abortController=c,this.traceId=t,this.protocol="",this.perfTracker.resetMeasurements(t);const h=()=>{u&&this.off(jt,u),l&&this.off(Bt,l)},p=new Promise(((e,n)=>{const h=function({action:e,token:t,traceId:n,tag:r,identifier:i}){const o=e===mr.SUBSCRIBE?Lr.SUBSCRIBE_TIMED_OUT:Lr.PUBLISH_TIMED_OUT;return new StageClientError(Object.assign(Object.assign({},o),{action:e,token:t,traceId:n,tag:r,location:"connect",remoteParticipantId:i}))}({action:s,token:r,traceId:t,tag:i,identifier:o}),p=function({action:e,token:t,traceId:n,tag:r}){const i=Lr.OPERATION_ABORTED;return new StageClientError(Object.assign(Object.assign({},i),{token:t,traceId:n,location:"peer-client.connect",tag:r,action:e}))}({action:s,token:r,traceId:t,tag:i}),f=setTimeout((()=>{this.stop(),this.analyticsTracker.trackError(h),n(h)}),1e4);u=e=>{clearTimeout(f),a||this.stop(),n(e)},l=o=>{if(o===Gt.CONNECTED)clearTimeout(f),e();else if(o===Gt.FAILED){const e=function({action:e,token:t,traceId:n,tag:r}){return new StageClientError(Object.assign(Object.assign({},Lr.PEER_CONNECTION_NETWORK_FAILURE),{token:t,traceId:n,location:"peer-client.connect",tag:r,action:e}))}({action:s,token:r,traceId:t,tag:i});clearTimeout(f),n(e)}},this.on(jt,u),this.on(Bt,l),d=()=>{clearTimeout(f)},c.signal.aborted&&(clearTimeout(f),n(p)),c.signal.addEventListener("abort",(()=>{clearTimeout(f),n(p)}))}));try{const r=yield Promise.all([(()=>As(this,void 0,void 0,(function*(){a||(yield this.start(),this.mediaStream=yield this.initializePeerConnection(e));const t=null==n?void 0:n.assignmentToken,r=null==n?void 0:n.nodeOverride;return yield this.exchangeSdp({iceRestart:a,nodeOverride:r,assignmentToken:t,abortController:c}),this.mediaStream})))(),p]);this.statsReporter.traceId=t;const i=r[0];if(this.abortController=void 0,!a&&s===mr.PUBLISH)try{yield this.verifyOrUpdateTransceiverSync()}catch(e){this.logger.error({err:e,msg:"error syncing transceivers"})}return{mediaStream:i}}catch(e){throw d&&d(),e}finally{h()}})),this.disconnect=(e=!1)=>As(this,void 0,void 0,(function*(){var t;const{token:n,action:r}=this;null===(t=this.abortController)||void 0===t||t.abort(),this.stop(),this.protocol="",e?this.cleanup(r,n.participantID,n,e):yield this.cleanup(r,n.participantID,n,e)})),this.resetTransformers=()=>{var e,t;null===(e=this.videoSenderTransformer)||void 0===e||e.destroy(),this.videoSenderTransformer=this.createVideoSenderTransformer(),null===(t=this.videoReceiverTransformer)||void 0===t||t.destroy(),this.videoReceiverTransformer=this.createVideoReceiverTransformer(),this.statsReporter.resetTransformers(this.videoReceiverTransformer,this.videoSenderTransformer)},this.onTrack=e=>{var t,n;const{token:r,action:i,traceId:o,identifier:s}=this;this.trace(r,o,`onTrack: ${e.track.kind}`,i,s),this.sendInBandMessagingEnabled&&(null===(t=this.videoSenderTransformer)||void 0===t||t.onTrackEvent(e)),this.receiveInBandMessagingEnabled&&(null===(n=this.videoReceiverTransformer)||void 0===n||n.onTrackEvent(e))},this.onIceGatheringStateChange=()=>{var e,t,n;const{token:r,action:i,traceId:o,identifier:s}=this;if("gathering"===(null===(e=this.peerConnection)||void 0===e?void 0:e.iceGatheringState)?this.perfTracker.markIceGatheringStart():"complete"===(null===(t=this.peerConnection)||void 0===t?void 0:t.iceGatheringState)&&this.perfTracker.markIceGatheringStop(),this.peerConnection){const e=this.peerConnection.iceGatheringState,t=new IceGatheringStateEvent(i,r,o,e,s);this.analyticsTracker.trackEventNoSharedProps(t)}this.trace(r,o,`ICE gathering state change: ${null===(n=this.peerConnection)||void 0===n?void 0:n.iceGatheringState}`,i,s)},this.onSelectedCandidatePairChange=()=>{var e,t,n,r,i,o,s,a,c,u,l,d,h,p;const{token:f,action:g,traceId:m,identifier:v}=this,E=null===(t=null===(e=this.peerConnection)||void 0===e?void 0:e.getReceivers()[0].transport)||void 0===t?void 0:t.iceTransport,S=null==E?void 0:E.getSelectedCandidatePair();if(S){const{local:e,remote:t}=S,E=`Selected candidate pair change (local, remote): ${null==e?void 0:e.candidate}, ${null==t?void 0:t.candidate}`;this.logger.debug({msg:E});const _=new SelectedPairChangeEvent(g,f,m,null!==(r=null===(n=S.local)||void 0===n?void 0:n.protocol)&&void 0!==r?r:"",null!==(o=null===(i=S.local)||void 0===i?void 0:i.type)&&void 0!==o?o:"",null!==(a=null===(s=S.local)||void 0===s?void 0:s.address)&&void 0!==a?a:"",null!==(u=null===(c=S.remote)||void 0===c?void 0:c.address)&&void 0!==u?u:"",null!==(d=null===(l=S.local)||void 0===l?void 0:l.priority)&&void 0!==d?d:0,v);this.analyticsTracker.trackEvent(_),this.protocol=null!==(p=null===(h=S.local)||void 0===h?void 0:h.protocol)&&void 0!==p?p:""}},this.onIceCandidate=e=>As(this,void 0,void 0,(function*(){var t,n;const{identifier:r,action:i,traceId:o}=this,s=null===(t=e.target.localDescription)||void 0===t?void 0:t.sdp.includes("relay");this.analyticsTracker.trackEventNoSharedProps(new TraceEvent(this.token,o,`ice candidate: hasRelay = ${s}, candidate = ${null===(n=e.candidate)||void 0===n?void 0:n.candidate}`,i,r))})),this.onMute=()=>As(this,void 0,void 0,(function*(){const{token:e,action:t,traceId:n,identifier:r}=this;this.trace(e,n,"Track has muted",t,r)})),this.onUnMute=()=>As(this,void 0,void 0,(function*(){const{token:e,action:t,traceId:n,identifier:r}=this;this.trace(e,n,"Track has unmuted",t,r)})),this.fetchAndSetRemoteDescription=e=>As(this,void 0,void 0,(function*(){var t,n,r,i;const o=null===(n=null===(t=this.peerConnection)||void 0===t?void 0:t.localDescription)||void 0===n?void 0:n.sdp;o||this.logger.warn({msg:"Unexpected state: No SDP offer when attempting to fetch remote description"});const{token:s,traceId:a,action:c,identifier:u,tag:l}=this,{endpointURL:d,nodeOverride:h,assignmentToken:p,multiCodec:f,abortController:g}=e;let m;this.perfTracker.markPostStart(),this.perfTracker.markSdpExchangeStart();try{const e=Es({connection:this.stageConnection,action:c,token:s,identifier:this.identifier,tracker:this.analyticsTracker});this.perfTracker.setTransport(e.getTransport());const t=h||Et("node")||Et("dataPlaneEndpoint");m=yield e.exchange({sdpOffer:o,url:d,traceId:a,forceNode:t,assignmentToken:p,multiCodec:f,abortController:g,initialLayerPreference:null===(r=this.simulcastSubscribeConfig)||void 0===r?void 0:r.initialLayerPreference})}catch(e){let t=e;t instanceof StageClientError||(t=new StageClientError(Object.assign(Object.assign({},Lr.UNEXPECTED_ERROR),{action:c,token:s,traceId:a,tag:l,details:e instanceof Error?e.message:"",location:"sdp-exchange"}))),t instanceof StageClientError&&(this.analyticsTracker.trackError(t),this.emit(jt,t))}if(this.perfTracker.markSdpExchangeStop(),!m)return;const{location:v,sessionDeleteLink:E,mediaControls:S}=m;let _=m.sdpAnswer;try{_=this.mungeSdpAnswer(_),m.sdpAnswer=_}catch(e){this.logger.error({err:e,msg:"Error while attempting to munge SDP, keeping original answer"})}this.statsReporter.sdpAnswer=_,this.emit(Ut,m),v&&(this.whipResource={location:v,sessionDeleteLink:E,mediaControls:S},this.sfuResource=function(e){const t=e.match(/https:\/\/([^/]+)\//);if(t){const e=t[1].split(".");if(e[0].includes("video-rtx"))return{node:`${e[0]}.${e[1]}`,cluster:e[1]}}}(v)||{node:"",cluster:""},this.statsReporter.updateSfuResource(this.sfuResource));try{this.perfTracker.markSetRemoteDescStart(),yield null===(i=this.peerConnection)||void 0===i?void 0:i.setRemoteDescription({sdp:_,type:"answer"}),this.perfTracker.markSetRemoteDescStop(),this.perfTracker.markPostStop()}catch(e){const t=new StageClientError(Object.assign(Object.assign({},Lr.SET_ANSWER_FAILURE),{action:c,token:s,traceId:a,tag:kr(c,u),location:"setRemoteDescription",remoteParticipantId:u,details:e instanceof Error?e.message:""}));this.analyticsTracker.trackError(t),this.emit(jt,t)}})),this.cleanup=(e,t,n,r=!1)=>As(this,void 0,void 0,(function*(){var i,o,s;const a=yr();if(this.toggleStageConnectionListeners(!1),this.currentJitterBufferMinDelayInMs=void 0,this.stageConnection=void 0,this.closeFailedPeerConnections(),!(null===(i=this.whipResource)||void 0===i?void 0:i.location))return this.trace(n,this.traceId,"whipResource location not known, exiting cleanup",e,t),void this.analyticsTracker.trackError(new StageClientError(Object.assign(Object.assign({},Lr.WHIP_URL_MISSING),{action:e,token:n,traceId:this.traceId,tag:kr(e,t),location:e===mr.SUBSCRIBE?"unsubscribe":"unpublish",requestUUID:a,remoteParticipantId:t})));let c=this.whipResource.location;if(this.trace(n,this.traceId,`use hostnamecachedurl: ${c}`,e,t),r){if(null===(s=this.whipResource)||void 0===s?void 0:s.sessionDeleteLink){c=this.whipResource.sessionDeleteLink,this.trace(n,this.traceId,`DELETE via session-delete beacon path: ${c}`,e,t);try{navigator.sendBeacon(c,JSON.stringify({authorization:n.rawToken}))}catch(r){this.analyticsTracker.trackErrorAndThrow(new StageClientError(Object.assign(Object.assign({},Pr(Lr.WHIP_DELETE_FAILURE,r)),{action:e,token:n,traceId:this.traceId,tag:kr(e,t),location:mr.SUBSCRIBE?"unsubscribe":"unpublish",requestUUID:a,remoteParticipantId:t})))}}}else try{yield Mt().delete(c,{headers:{Authorization:`Bearer ${n.rawToken}`,"X-Stages-Platform":"web","X-Stages-Request-ID":a.value,"X-Stages-SDK":"1.30.0","X-Stages-Session-ID":this.analyticsTracker.getSessionId(),"X-Stages-Trace-ID":this.traceId.value,"X-Stages-WHIP-Version":mi}})}catch(r){404===(null===(o=r.response)||void 0===o?void 0:o.status)?this.trace(n,this.traceId,`DELETE returned 404, ignoring, action = ${e}, uuid = ${a.value}`,e,t):this.analyticsTracker.trackErrorAndThrow(new StageClientError(Object.assign(Object.assign({},Pr(Lr.WHIP_DELETE_FAILURE,r)),{action:e,token:n,traceId:this.traceId,tag:kr(e,t),location:mr.SUBSCRIBE?"unsubscribe":"unpublish",requestUUID:a,remoteParticipantId:t})))}})),this.getConnectionState=()=>{if(!this.peerConnection)return Gt.NONE;const e=this.peerConnection.connectionState||this.peerConnection.iceConnectionState;try{return zt(e)}catch(t){return this.logger.warn({msg:"Unhandled connection state:",rawState:e}),Gt.IDLE}},this.onIceCandidateError=e=>{const{token:t,traceId:n,tag:r}=this;if(701!==e.errorCode){const e=new StageClientError(Object.assign(Object.assign({},Lr.ICE_CANDIDATE_ERROR),{action:this.action,token:t,traceId:n,tag:r,location:"onIceCandidateError",remoteParticipantId:this.identifier}));this.analyticsTracker.trackError(e),this.emit(jt,e)}},this.onIceConnectionStateChange=()=>{var e,t;const{token:n,traceId:r,action:i,identifier:o}=this;this.trace(n,r,`ICE connection state change: ${null===(e=this.peerConnection)||void 0===e?void 0:e.iceConnectionState}`,i,o),"checking"===(null===(t=this.peerConnection)||void 0===t?void 0:t.iceConnectionState)&&this.peerConnection.getTransceivers().forEach((({receiver:e,sender:t})=>{[e,t].forEach((e=>{var t,n;null===(n=null===(t=null==e?void 0:e.transport)||void 0===t?void 0:t.iceTransport)||void 0===n||n.addEventListener("selectedcandidatepairchange",this.onSelectedCandidatePairChange)}))})),this.onConnectionStateChange()},this.createVideoSenderTransformer=()=>new VideoSenderTransformer(this.analyticsTracker.getSessionId()),this.createVideoReceiverTransformer=()=>{const e=new VideoReceiverTransformer(this.analyticsTracker.getSessionId()),{token:t,tag:n,identifier:r,action:i,traceId:o}=this;e.on(Rs,(e=>{this.emit(Ft,e)}));const s=function(e,t){let n=0;return function(...r){const i=Date.now();i-n>=t&&(n=i,e(...r))}}((e=>{const s=`Transform error occurred: ${e.type}`,a=Ss({traceId:o,token:t,tag:n,identifier:r,action:i,details:s,stageErrorValue:Lr.TRANSFORM_UNEXPECTED_ERROR});this.logger.warn({err:a,msg:"Error encountered when transforming receiver",error:e})}),1e3),a=s=>{const a=`Too many errors occurred: ${s.type}`,c=Ss({traceId:o,token:t,tag:n,identifier:r,action:i,details:a,stageErrorValue:Lr.TRANSFORM_TOO_MANY_ERRORS});this.logger.error({err:c,msg:"Too many errors encountered when transforming receiver. Shutting down transformer.",error:s}),e.destroy(),this.analyticsTracker.trackError(c),this.emit(Vt,c)};return e.on(Os,(e=>{e.stageErrorValue.code!==Lr.TRANSFORM_TOO_MANY_ERRORS.code?s(e):a(e)})),e},this.onConnectionStateChange=()=>{if(this.peerConnection){const e=this.peerConnection.connectionState||this.peerConnection.iceConnectionState,{token:t,traceId:n,identifier:r,action:i}=this,o=new ConnectionStateEvent(i,t,n,e,r);this.analyticsTracker.trackEventNoSharedProps(o),this.trace(t,n,`connection state change: ${e}`,i,r)}const e=this.getConnectionState();switch(e){case Gt.CONNECTED:this.closeFailedPeerConnections(),this.perfTracker.markActionStop(),this.emit(Bt,e),this.statsReporter.updateMultihostConfiguration(this.publishAudioStream,this.publishVideoStream);break;case Gt.FAILED:this.storeFailedPeerConnection(this.peerConnection),this.destroyPeerConnection({closeConnection:!1}),this.emit(Bt,e),this.handleConnectionFailure();break;default:this.emit(Bt,e)}},this.onIncompatibleCodecs=e=>As(this,void 0,void 0,(function*(){if(e.forEach((e=>{let t=!1;this.incompatibleCodecs.forEach((n=>{n.config===e.config&&n.mime===e.mime&&(t=!0)})),t||this.incompatibleCodecs.add(e)})),this.peerConnection)try{yield(t=this.peerConnection,n=[...this.incompatibleCodecs],to(void 0,void 0,void 0,(function*(){var e;for(const r of t.getSenders()){const t=r.getParameters();if(t.codecs.length>1){const i=t.codecs[0];let o=!1;for(const e of n)so(i,e)&&(o=!0);if(o){const i=ao(n,t.codecs);null===(e=t.encodings)||void 0===e||e.forEach((e=>{e.active&&(e.codec=i)})),yield r.setParameters(t)}}}})))}catch(e){const{token:t,action:n,traceId:r,identifier:i}=this,o=new StageClientError(Object.assign(Object.assign({},Lr.CODEC_HANDLE_INCOMPATIBLE_UNEXPECTED_ERROR),{action:n,token:t,traceId:r,tag:kr(n,i),location:"onIncompatibleCodecs",remoteParticipantId:i,details:e instanceof Error?e.message:""}));this.analyticsTracker.trackError(o),this.emit(jt,o)}var t,n})),this.token=e,this.logger=new ScopedLogger(t,de.WEBRTC),this.action=n,this.tag=r,this.traceId=i,n===mr.SUBSCRIBE&&!s)throw new Error("Subscribe action provided without subscriber Id");this.jitterBufferConfig=null==c?void 0:c.jitterBuffer,this.simulcastSubscribeConfig=null==c?void 0:c.simulcast,this.subscriberId=s,this.stageConnection=a,this.failedPeerConnections=[],this.receiveInBandMessagingEnabled=!!(null===(u=this.subscribeConfig)||void 0===u?void 0:u.inBandMessaging.enabled),this.perfTracker=new PeerClientPerformanceTracker(this.action,this.traceId),this.statsReporter=new PeerClientStatsReporter(n,e,i,this.identifier,this.analyticsTracker),this.handlePublishingChangedBinding=this.handlePublishingChanged.bind(this),this.toggleStageConnectionListeners(!0)}get videoMediaId(){var e,t;return null!==(t=null===(e=this.videoTransceiver)||void 0===e?void 0:e.mid)&&void 0!==t?t:null}toggleStageConnectionListeners(e){var t,n;e?null===(t=this.stageConnection)||void 0===t||t.on(Vr,this.handlePublishingChangedBinding):null===(n=this.stageConnection)||void 0===n||n.off(Vr,this.handlePublishingChangedBinding)}updateSubscribeConfig(e){var t,n;if(this.jitterBufferConfig=e.jitterBuffer,this.simulcastSubscribeConfig=e.simulcast,this.action===mr.SUBSCRIBE){const t=e.inBandMessaging.enabled;this.receiveInBandMessagingEnabled!==t&&this.logger.warn({msg:"Cannot mutate in-band messaging config value for receiver"})}this.applyJitterBufferMinDelayConditionally(null!==(n=null===(t=this.stageConnection)||void 0===t?void 0:t.getIsStagePublishing())&&void 0!==n&&n)}verifyOrUpdateTransceiverSync(){var e,t;return As(this,void 0,void 0,(function*(){if(this.publishVideoStream){const t=this.getTransceiverForKind("video");t?this.publishVideoStream.track.id!==(null===(e=t.sender.track)||void 0===e?void 0:e.id)&&(this.logger.debug({msg:"found out of sync video transceiver... updating"}),yield this.replaceOrUpdateStream(this.publishVideoStream)):this.logger.warn({msg:"missing transceiver for video"})}if(this.publishAudioStream){const e=this.getTransceiverForKind("audio");e?this.publishAudioStream.track.id!==(null===(t=e.sender.track)||void 0===t?void 0:t.id)&&(this.logger.debug({msg:"found out of sync audio transceiver... updating"}),yield this.replaceOrUpdateStream(this.publishAudioStream)):this.logger.warn({msg:"missing transceiver for audio"})}}))}start(){return As(this,void 0,void 0,(function*(){const{token:e,action:t,traceId:n,identifier:r}=this;t!==mr.PUBLISH||e.claims.capabilities.allow_publish||this.analyticsTracker.trackErrorAndThrow(new StageClientError(Object.assign(Object.assign({},Pr(Lr.TOKEN_PERMISSIONS_DENIED,new Error("Cannot publish with subscribe only token"))),{action:t,token:e,traceId:n,tag:kr(t,r),location:"StagePeerClient.start",remoteParticipantId:r})));const i=function({action:e,identifier:t,token:n,analyticsTracker:r}){let i="";const o=fi(n,r);switch(e){case mr.PUBLISH:i=o.getPublishEndpoint();break;case mr.SUBSCRIBE:t&&(i=o.getSubscribeEndpoint(t))}return i}({action:t,identifier:r,token:e.rawToken,analyticsTracker:this.analyticsTracker});try{this.perfTracker.markActionStart(),this.endpointURL=i,this.createPeerConnection(),this.trace(e,n,"peer connection created",t,r)}catch(i){const o=new StageClientError(Object.assign(Object.assign({action:t},Pr(Lr.CREATE_PEER_CONNECTION_FAILURE,i)),{token:e,traceId:n,tag:kr(t,r),location:"StagePeerClient.start",remoteParticipantId:r}));t===mr.PUBLISH&&this.emit(Bt,Gt.FAILED),this.emit(jt,o),this.analyticsTracker.trackErrorAndThrow(o)}}))}mungeSdpOffer(e,t,n){if(n.simulcastEnabled&&(e=new SdpMunger(e).withVideoLayersAllocationRtpHeaderExtension().sdp),t===mr.SUBSCRIBE)e=new SdpMunger(e).withOpusAudioConfig(bi(Gi),!0).sdp;else if(t===mr.PUBLISH&&n.audioConfig){const{maxBitrateBps:t,stereo:r}=n.audioConfig;e=new SdpMunger(e).withOpusAudioConfig(t,r).sdp}return e}mungeSdpAnswer(e){po.browser.isFirefox()&&this.publishAudioStream&&this.action===mr.PUBLISH&&(e=new SdpMunger(e).withOpusAudioConfig(this.publishAudioStream.config.maxBitrateBps,void 0).sdp);const t=po.browser.isChrome()||po.browser.isEdge();this.action===mr.SUBSCRIBE&&t&&(e=new SdpMunger(e).withoutAudioRtcpRSize().sdp);const n=function(){const e=Et("subscribeForceIceProtocol");if("tcp"===e||"udp"===e)return e}();return this.action===mr.SUBSCRIBE&&n&&(e=new SdpMunger(e).withFilteredCandidates(n).sdp),e}createPeerConnection(){var e;this.logger.debug({msg:"setting up peer connection"}),this.peerConnection&&(this.logger.debug({msg:"peer connection is already established, cleaning up previous connection"}),this.destroyPeerConnection({closeConnection:!1})),this.peerConnection=new RTCPeerConnection({iceTransportPolicy:"all"}),this.statsReporter.start(this.peerConnection,null===(e=this.publishVideoStream)||void 0===e?void 0:e.config.simulcastEnabled),this.peerConnection.addEventListener("connectionstatechange",this.onConnectionStateChange),this.peerConnection.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.peerConnection.addEventListener("icecandidateerror",this.onIceCandidateError),this.peerConnection.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this.peerConnection.addEventListener("icecandidate",this.onIceCandidate),this.peerConnection.addEventListener("track",this.onTrack),this.peerConnection.addEventListener("mute",this.onMute),this.peerConnection.addEventListener("unmute",this.onUnMute)}destroyPeerConnection(e){var t,n,r,i,o,s,a,c,u;this.statsReporter.stop(),null===(t=this.peerConnection)||void 0===t||t.removeEventListener("connectionstatechange",this.onConnectionStateChange),null===(n=this.peerConnection)||void 0===n||n.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),null===(r=this.peerConnection)||void 0===r||r.removeEventListener("icecandidateerror",this.onIceCandidateError),null===(i=this.peerConnection)||void 0===i||i.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),null===(o=this.peerConnection)||void 0===o||o.removeEventListener("icecandidate",this.onIceCandidate),null===(s=this.peerConnection)||void 0===s||s.removeEventListener("track",this.onTrack),null===(a=this.peerConnection)||void 0===a||a.removeEventListener("mute",this.onMute),null===(c=this.peerConnection)||void 0===c||c.removeEventListener("unmute",this.onUnMute),(e.closeConnection||this.action===mr.PUBLISH)&&(null===(u=this.peerConnection)||void 0===u||u.close()),this.peerConnection=void 0}closeFailedPeerConnections(){for(const e of this.failedPeerConnections)null==e||e.close();this.failedPeerConnections=[]}storeFailedPeerConnection(e){e&&this.action!==mr.PUBLISH&&this.failedPeerConnections.push(e)}stop(){var e,t;null===(e=this.videoReceiverTransformer)||void 0===e||e.destroy(),null===(t=this.videoSenderTransformer)||void 0===t||t.destroy(),this.destroyPeerConnection({closeConnection:!0})}getTransceiverForKind(e){if(!this.peerConnection)return;const t=this.peerConnection.getTransceivers();return"audio"===e?t.find((e=>"0"===e.mid)):"video"===e?t.find((e=>"1"===e.mid)):void 0}removeTrack(e){return As(this,void 0,void 0,(function*(){if("audio"===e||"video"===e)if(this.peerConnection)try{const t=this.getTransceiverForKind(e);if(!t)return void this.logger.warn({msg:`tried removing track type ${e} but couldn't find transceiver`});yield t.sender.replaceTrack(null),e===pn.AUDIO?this.publishAudioStream=void 0:this.publishVideoStream=void 0,yield this.statsReporter.updateMultihostConfiguration(this.publishAudioStream,this.publishVideoStream)}catch(e){this.logger.warn({msg:"error replacing track",err:e})}else e===pn.AUDIO?this.publishAudioStream=void 0:this.publishVideoStream=void 0;else this.logger.warn({msg:"RemoveTrack called with invalid track type",trackType:e})}))}replaceOrUpdateStream(e){return As(this,void 0,void 0,(function*(){if(e.track){if(Yo(e)?this.publishAudioStream=e:Qo(e)&&(this.publishVideoStream=e),this.peerConnection)try{const t=this.getTransceiverForKind(e.track.kind);if(!t)return void this.logger.warn({msg:`tried replacing track type ${e.track.kind} but couldn't find transceiver`,track:e.track});if(Qo(e)){const n=t.sender.getParameters(),r=e.config.encodingLayers;n.encodings=n.encodings.map((e=>{var t;const n=null!==(t=e.rid)&&void 0!==t?t:"",i=r.find((e=>{var t;return(null!==(t=e.rid)&&void 0!==t?t:"")===n}));return i?Object.assign(Object.assign({},e),i):e})),yield t.sender.setParameters(n)}else if(Yo(e)){const n=t.sender.getParameters(),r=yi(e)[0];n.encodings=n.encodings.map((e=>Object.assign(Object.assign({},e),r))),yield t.sender.setParameters(n)}yield t.sender.replaceTrack(e.track),yield this.statsReporter.updateMultihostConfiguration(this.publishAudioStream,this.publishVideoStream)}catch(e){this.logger.warn({msg:"error replacing track",err:e})}}else this.logger.warn({msg:"Unexpected call to replaceOrUpdateStream with no track"})}))}initializePeerConnection(e=!1){var t,n,r,i,o,s,a,c;return As(this,void 0,void 0,(function*(){const{traceId:u,token:l,action:d,identifier:h}=this;er(this.peerConnection),this.resetTransformers();let p=new MediaStream;if(d===mr.PUBLISH){this.publishAudioStream||(this.publishAudioStream={track:this.getSilentAudio(),config:{maxBitrateBps:bi(Vi),stereo:!1}});const e=this.peerConnection.getTransceivers(),s=[];e.forEach((e=>{var t;s.concat(null===(t=e.sender.track)||void 0===t?void 0:t.id)})),p=new MediaStream([this.publishAudioStream.track,null===(t=this.publishVideoStream)||void 0===t?void 0:t.track].filter((e=>!!e&&!s.includes(e.id))));const a=p.getAudioTracks()[0]||"audio",c=p.getVideoTracks()[0]||"video",f={direction:"sendonly",streams:[p],sendEncodings:yi(this.publishAudioStream)},g={direction:"sendrecv",streams:[p],sendEncodings:null===(n=this.publishVideoStream)||void 0===n?void 0:n.config.encodingLayers};this.peerConnection.addTransceiver(a,f),this.trace(l,u,`track added, type: ${a.kind||a}`,d,h);const m=this.peerConnection.addTransceiver(c,g);this.trace(l,u,`track added, type: ${c.kind||c}`,d,h);const v=!!(null===(i=null===(r=this.publishVideoStream)||void 0===r?void 0:r.config)||void 0===i?void 0:i.inBandMessagingEnabled);void 0===this.sendInBandMessagingEnabled?this.sendInBandMessagingEnabled=v:this.sendInBandMessagingEnabled!==v&&this.logger.warn({msg:"Cannot mutate in-band messaging config value for sender"}),this.sendInBandMessagingEnabled&&!VideoSenderTransformer.isSupported(m)?this.handleTransformNotSupported():this.sendInBandMessagingEnabled&&(null===(o=this.videoSenderTransformer)||void 0===o||o.onTransceiverAdd(m))}else d===mr.SUBSCRIBE&&(l.shouldSendSilentAudio()?this.peerConnection.addTransceiver(this.getSilentAudio(),{direction:"sendrecv"}):this.peerConnection.addTransceiver("audio",{direction:"recvonly"}),this.trace(l,u,"track added, type: audio",d,h),e||(this.videoTransceiver=this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.trace(l,u,"track added, type: video",d,h),this.receiveInBandMessagingEnabled&&!VideoReceiverTransformer.isSupported(this.videoTransceiver)?this.handleTransformNotSupported():this.receiveInBandMessagingEnabled&&(null===(s=this.videoReceiverTransformer)||void 0===s||s.onTransceiverAdd(this.videoTransceiver))),this.peerConnection.getTransceivers().forEach((e=>{e.receiver?(this.logger.info({msg:"dbg: Subscribe succeeded, adding media track to participant mediaStream"}),null==p||p.addTrack(e.receiver.track)):this.logger.info({msg:"dbg: Subscribe succeeded, but Transceiver were negotiated without Receiver"})})),this.applyJitterBufferMinDelayConditionally(null!==(c=null===(a=this.stageConnection)||void 0===a?void 0:a.getIsStagePublishing())&&void 0!==c&&c));return p}))}handlePublishingChanged(e){this.logger.debug({msg:`[handlePublishingChanged (${this.subscriberId})] isStagePublishing: ${e}, currentMinDelay: ${this.currentJitterBufferMinDelayInMs}`}),this.action===mr.SUBSCRIBE&&this.applyJitterBufferMinDelayConditionally(e)}applyJitterBufferMinDelayConditionally(e){const t=this.currentJitterBufferMinDelayInMs,n=this.calcJitterBufferMinDelay(e,this.jitterBufferConfig);if(e){if(void 0===t||t>n){const e=`[applyJitterBufferMinDelayConditionally (${this.subscriberId})] participant is publishing and min delay is unset or > configured; attempting to update to ${n}`;this.logger.debug({msg:e}),this.trace(this.token,this.traceId,e,this.action,this.identifier),this.applyAndTrackJitterBufferMinDelay(n)}}else if(void 0===t||n!==t){const e=`[applyJitterBufferMinDelayConditionally (${this.subscriberId})] participant is subscribe-only and min delay is unset or != configured; attempting to update to ${n}`;this.logger.debug({msg:e}),this.trace(this.token,this.traceId,e,this.action,this.identifier),this.applyAndTrackJitterBufferMinDelay(n)}}calcJitterBufferMinDelay(e,t){var n,r,i;let o=0;if(!(()=>{const e=RTCRtpReceiver.prototype;return!(!e||"object"!=typeof e)&&("jitterBufferTarget"in e||"playoutDelayHint"in e)})())return 0;if(e)o=os(null!==(n=null==t?void 0:t.minDelayWhenPublishing)&&void 0!==n?n:fn.DEFAULT,e);else{o=os(null!==(r=null==t?void 0:t.minDelayWhenSubscribeOnly)&&void 0!==r?r:fn.DEFAULT,e);const n=null===(i=this.stageConnection)||void 0===i?void 0:i.jitterBufferMinDelayInMs();(null==t?void 0:t.minDelayWhenSubscribeOnly)===fn.DEFAULT&&void 0!==n&&(o=n,this.logger.debug({msg:`[calcJitterBufferMinDelay] overriding min delay with remote value: ${o}`}))}return o}applyAndTrackJitterBufferMinDelay(e){var t,n;this.currentJitterBufferMinDelayInMs=e,this.statsReporter.updateJitterBufferMinDelay(e),void 0!==e&&(null===(n=null===(t=this.peerConnection)||void 0===t?void 0:t.getTransceivers())||void 0===n||n.forEach((t=>{t.receiver&&this.applyJitterBufferMinDelay(t.receiver,e)})))}applyJitterBufferMinDelay(e,t){let n="Unable to set jitter buffer min delay";if("jitterBufferTarget"in e)n=`setting jitterBufferTarget to: ${t} for track: ${e.track.kind}`,this.logger.debug({msg:n}),e.jitterBufferTarget=t;else if("playoutDelayHint"in e){const r=t/1e3;n=`setting playoutDelayHint to: ${t} for track: ${e.track.kind}`,this.logger.debug({msg:n}),e.playoutDelayHint=r}else this.logger.warn({msg:n});this.trace(this.token,this.traceId,n,this.action,this.identifier)}exchangeSdp(e){var t,n,r;return As(this,void 0,void 0,(function*(){const{traceId:i,token:o,action:s,identifier:a,tag:c,endpointURL:u}=this,{iceRestart:l=!1,nodeOverride:d,assignmentToken:h,abortController:p}=e;let f;this.logger.debug({msg:`Exchanging SDP: ${i.value}, iceRestart=${l}, nodeOverride=${d}, assignmentToken=${h}`}),er(this.peerConnection),s===mr.PUBLISH&&Ct()&&(this.logger.debug({msg:"Applying publisher codec preference for main profile."}),((e,t)=>{var n,r;const i=null===(n=RTCRtpReceiver.getCapabilities("video"))||void 0===n?void 0:n.codecs;if(!i)return;let o=i;o=oo(i,"42e0"),t.preferMainProfile&&(o=oo(i,"4d00")),null===(r=e.getTransceivers().find((e=>"video"===e.receiver.track.kind)))||void 0===r||r.setCodecPreferences(o)})(this.peerConnection,{preferMainProfile:Ct()}));try{this.trace(o,i,"Creating offer",s,a),f=yield this.peerConnection.createOffer({iceRestart:l})}catch(e){const t=new StageClientError(Object.assign(Object.assign({},Pr(Lr.CREATE_OFFER_FAILURE,e)),{action:s,token:o,traceId:i,tag:c,location:"exchangeSdp",remoteParticipantId:a}));this.emit(jt,t),this.analyticsTracker.trackErrorAndThrow(t)}f.sdp&&(f.sdp=this.mungeSdpOffer(f.sdp,s,{simulcastEnabled:null!==(n=null===(t=this.publishVideoStream)||void 0===t?void 0:t.config.simulcastEnabled)&&void 0!==n&&n,audioConfig:null===(r=this.publishAudioStream)||void 0===r?void 0:r.config})),this.trace(o,i,"Setting local description",s,a),yield this.peerConnection.setLocalDescription(f),this.trace(o,i,"local description set",s,a),u||this.logger.warn({msg:"Unexpected state: No endpointURL specified for fetching of remote description."});const g=s===mr.PUBLISH&&Ct()||s===mr.SUBSCRIBE&&St("multiCodecAnswer");yield this.fetchAndSetRemoteDescription({endpointURL:u,nodeOverride:d,assignmentToken:h,multiCodec:g,abortController:p})}))}getReports(){var e;return As(this,void 0,void 0,(function*(){try{const t=(yield null===(e=this.peerConnection)||void 0===e?void 0:e.getStats())||[],n=[];return t.forEach((e=>{n.push(e)})),n}catch(e){return[]}}))}requestRTCStats(e){return As(this,void 0,void 0,(function*(){if(this.peerConnection)return this.statsReporter.getStats(e)}))}get identifier(){return this.subscriberId||this.token.participantID}handleTransformNotSupported(){const{token:e,tag:t,identifier:n,action:r,traceId:i}=this,o=Ss({traceId:i,token:e,tag:t,identifier:n,action:r,stageErrorValue:Lr.TRANSFORM_NOT_SUPPORTED_BY_PLATFORM});this.logger.error({err:o,msg:"Transforms not supported by this platform"}),this.analyticsTracker.trackError(o),this.emit(Vt,o)}handleConnectionFailure(){return As(this,void 0,void 0,(function*(){const{token:e,traceId:t,tag:n}=this;this.analyticsTracker.trackError(new StageClientError(Object.assign(Object.assign({},Lr.PEER_CONNECTION_NETWORK_FAILURE),{action:this.action,token:e,traceId:t,tag:n,location:"onIceCandidateError",remoteParticipantId:this.identifier})))}))}getSilentAudio(){ks||(ks=new AudioContext);const e=ks.createOscillator(),t=ks.createGain();e.connect(t);const n=ks.createMediaStreamDestination();return t.connect(n),t.gain.value=0,e.start(),n.stream.getAudioTracks()[0]}getActionMeasurements(){return this.perfTracker.getMeasurements()}getProtocol(){return this.protocol}initStreamsToPublish(e){this.publishVideoStream=e.find(Qo),this.publishAudioStream=e.find(Yo)}getSfuResource(){return this.sfuResource}getExpectedJitterBufferMinDelayInMs(){var e,t;return this.calcJitterBufferMinDelay(null!==(t=null===(e=this.stageConnection)||void 0===e?void 0:e.getIsStagePublishing())&&void 0!==t&&t,this.jitterBufferConfig)}trace(e,t,n,r,i){this.analyticsTracker.trackEventNoSharedProps(new TraceEvent(e,t,n,r,i))}sendSeiMessage(e,t){const n=this.getTransceiverForKind("video");return this.videoSenderTransformer&&this.sendInBandMessagingEnabled?this.action===mr.PUBLISH&&n?this.videoSenderTransformer.sendSeiMessage(e,t):ln.err(Is.NOT_PUBLISHING_VIDEO):ln.err(Is.INBAND_MESSAGING_NOT_ENABLED)}}const Ps=mr.SUBSCRIBE;class SubscribeTracker{constructor(e,t,n){this.analyticsTracker=e,this.token=t,this.remoteId=n,this.action=Ps}trackAttempt({stageConnectionStats:e,isReassignment:t=!1,traceIdOverride:n,preAttemptSfuResource:r}){const{action:i,analyticsTracker:o,token:s,remoteId:a}=this,c=n||br();return o.trackEvent(new SubscribeEvent({token:this.token,subscribedId:this.remoteId,traceId:c,isEdpConnected:e.isConnected,isReassignment:t,preAttemptSfuResource:r})),{getTraceId:()=>c,trackSubscribeStarted({totalDurationWithRetries:n,retryTimes:r,sfuResource:i,peerClientPerfStats:u,protocol:l}){const{optionsDuration:d,postDuration:h,timeToCandidate:p,timeToConnected:f,sdpExchangeDuration:g,sdpExchangeTransport:m,setRemoteDescDuration:v,peerConnectionDuration:E}=u,{edpInitialConnectDuration:S,edpInitialConnectRetries:_,edpInitialStateDuration:y,edpInitialStatePublishingCount:b,edpStateUpdateCount:T}=e;o.trackEvent(new SubscribeStartedEvent({token:s,traceId:c,remoteParticipantId:a,optionsDuration:d,postDuration:h,timeToCandidate:p,totalDuration:f,edpInitialConnectDuration:S,edpInitialConnectRetries:_,edpInitialStateDuration:y,edpInitialStatePublishingCount:b,edpStateUpdateCount:T,sdpExchangeDuration:g,sdpExchangeTransport:m,setRemoteDescDuration:v,peerConnectionDuration:E,sfuResource:i,totalDurationWithRetries:n,subscribeRetryTimes:r,isReassignment:t,protocol:l}))},trackSubscribeFirstFrame:({peerClientPerfStats:t,totalDurationWithRetries:n,sfuResource:r,retryTimes:i,currentJitterBufferMinDelayInMs:o,mediaType:s,firstFrameDuration:u,protocol:l})=>{const{sdpExchangeDuration:d,sdpExchangeTransport:h,setRemoteDescDuration:p,peerConnectionDuration:f}=t,{edpInitialConnectDuration:g,edpInitialConnectRetries:m,edpInitialStateDuration:v,edpInitialStatePublishingCount:E,edpStateUpdateCount:S}=e;this.analyticsTracker.trackEvent(new FirstFrameEvent({token:this.token,traceId:c,remoteParticipantId:a,edpInitialConnectDuration:g,edpInitialConnectRetries:m,edpInitialStateDuration:v,edpInitialStatePublishingCount:E,edpStateUpdateCount:S,sdpExchangeDuration:d,sdpExchangeTransport:h,setRemoteDescDuration:p,peerConnectionDuration:f,videoWasPaused:!1,firstFrameDuration:u,mediaType:s,sfuResource:r,totalDurationWithRetries:n,subscribeRetryTimes:i,currentJitterBufferMinDelayInMs:o,protocol:l}))},trackSubscribeFailed(n,r,u){const l=((e,t,n)=>{if(e instanceof StageClientError)return e;let r="";return e instanceof Lt.AxiosError&&(r+=`AxiosError - ${e.code}`),new StageClientError(Object.assign(Object.assign(Object.assign({},Lr.SUBSCRIBE_FAILURE),{action:Ps,token:t,traceId:n,tag:Ar,location:"subscribe",details:`${r} ${null==e?void 0:e.message}`}),{fatal:!0}))})(n,s,c);o.trackEvent(new SubscribeFailedEvent({token:s,traceId:c,remoteParticipantId:a,code:l.code,message:l.message,fatal:l.fatal,nominal:l.nominal,isReassignment:t,protocol:r}));const{isConnected:d}=e,h=new StageClientError(Object.assign(Object.assign({},Lr.SUBSCRIBE_FAILURE),{action:i,token:s,traceId:c,tag:kr(mr.SUBSCRIBE,a),location:"subscribe",remoteParticipantId:a,isEdpConnected:d,details:u}));return n instanceof StageClientError&&(h.fatal=n.fatal,h.nominal=n.nominal,h.location=`subscribe > ${n.location}`),o.trackError(h),l},trackUnsubscribe:()=>{o.trackEvent(new UnsubscribeEvent({token:s,unsubscribedId:a,traceId:c}))},trackEndSucceeded:(e,t)=>{o.trackEvent(new SubscribeEndedEvent({token:s,traceId:c,remoteParticipantId:a,isUnsubscribeSuccessful:!0,reason:e,protocol:t}))},trackEndFailed:(e,t)=>{const n=new StageClientError(Object.assign(Object.assign({},Lr.UNSUBSCRIBE_FAILURE),{token:s,traceId:c,tag:kr(mr.SUBSCRIBE,a),location:"unsubscribe",remoteParticipantId:a}));return e!==Mr.UNLOAD&&e!==Mr.UNSUBSCRIBE||o.trackError(n),o.trackEvent(new SubscribeEndedEvent({token:s,traceId:c,remoteParticipantId:a,isUnsubscribeSuccessful:!0,reason:e,protocol:t})),n}}}}class PlaybackLayerRequest extends StageAnalyticsEvent{constructor(e,t,n,r,i,o){super(gt.PLAYBACK_LAYER_REQUEST,e,t,!1),Object.assign(this.properties,{media_type:n,remote_participant_id:r,track_id:i,layer_id:o})}}class PlaybackLayerState extends StageAnalyticsEvent{constructor(e,t,n,r,i,o=1){super(gt.PLAYBACK_LAYER_STATE,e,t,!1),Object.assign(this.properties,{media_type:n,remote_participant_id:r,track_id:i,request_count:o})}}var Ds,Ns,Ls,Ms;!function(e){e.PAUSE="pause",e.PLAY="play"}(Ds||(Ds={})),function(e){e.IDLE="idle",e.ACTIVE="active",e.ERRORED="errored",e.DESTROYED="destroyed"}(Ns||(Ns={})),function(e){e.SUCCESS="success"}(Ls||(Ls={})),function(e){e.FAILED="failed",e.DESTROYED="destroyed",e.THROTTLED="throttled"}(Ms||(Ms={}));var xs=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};class RemotePlaybackController{constructor(e){this.state=Ns.IDLE,this.mid=null,this.playbackEndpoint=null,this.layersEndpoint=null,this.stopVideo=()=>xs(this,void 0,void 0,(function*(){return this.state!==Ns.ACTIVE?(this.logCommandSkipped("stopVideo"),this.mapSkippedResultFromState(this.state)):this.sendPlaybackRequest(Ds.PAUSE)})),this.startVideo=()=>xs(this,void 0,void 0,(function*(){return this.state!==Ns.ACTIVE?(this.logCommandSkipped("startVideo"),this.mapSkippedResultFromState(this.state)):this.sendPlaybackRequest(Ds.PLAY)})),this.setLayer=e=>xs(this,void 0,void 0,(function*(){return this.state!==Ns.ACTIVE?(this.logCommandSkipped("setLayer"),this.mapSkippedResultFromState(this.state)):this.sendLayerRequest(e)})),this.unsetLayer=()=>xs(this,void 0,void 0,(function*(){return this.state!==Ns.ACTIVE?(this.logCommandSkipped("unsetLayer"),this.mapSkippedResultFromState(this.state)):this.sendLayerRequest()})),this.getLayers=()=>xs(this,void 0,void 0,(function*(){return this.state!==Ns.ACTIVE?(this.logCommandSkipped("getLayers"),this.mapSkippedResultFromState(this.state)):this.sendLayerStateRequest()})),this.sendPlaybackRequest=e=>xs(this,void 0,void 0,(function*(){if(!this.mid)return this.logger.warn({msg:"mid is unexpectedly undefined"}),(0,ln.err)(Ms.FAILED);if(!this.playbackEndpoint)return this.logger.warn({msg:"Playback endpoint is unset and required for playback control requests"}),(0,ln.err)(Ms.FAILED);this.logger.info({msg:`Sending ${e} request to ${this.playbackEndpoint}`});const t=e===Ds.PAUSE?{pause:[this.mid]}:{play:[this.mid]},n=this.createPostWhepRequest(t);return fetch(this.playbackEndpoint,n).then((t=>{if(t.status>=300){const e=new Error(`Error sending media controls request: ${t.status}:${t.statusText}`);return this.logger.error({err:e}),(0,ln.err)(Ms.FAILED)}return this.logger.debug({msg:`Request to ${e} was successful: ${t.status}`}),(0,ln.ok)(Ls.SUCCESS)})).catch((e=>(this.logger.error({err:e,msg:"Error sending media controls request"}),(0,ln.err)(Ms.FAILED))))})),this.sendLayerRequest=e=>xs(this,void 0,void 0,(function*(){if(!this.mid)return this.logger.warn({msg:"mid is unexpectedly undefined"}),(0,ln.err)(Ms.FAILED);if(!this.layersEndpoint)return this.logger.warn({msg:"Layers endpoint is unset and required for layer requests"}),(0,ln.err)(Ms.FAILED);const t="string"==typeof e,n=t?{mediaId:this.mid,encodingId:e}:{},r=t?`set : ${e}`:"unset layer";this.logger.info({msg:`sendLayerRequest for ${r} at ${this.layersEndpoint}`});const i=this.createPostWhepRequest(n);return this.trackLayerRequest(null!=e?e:"auto"),fetch(this.layersEndpoint,i).then((e=>this.state===Ns.DESTROYED?(0,ln.err)(Ms.DESTROYED):e.status>=300?this.handleLayerRequestError(e.status,e.statusText):(this.logger.debug({msg:`Request to ${r} was successful: ${e.status}`}),(0,ln.ok)(Ls.SUCCESS)))).catch((e=>this.handleLayerRequestError(0,e.message)))})),this.sendLayerStateRequest=()=>xs(this,void 0,void 0,(function*(){if(!this.mid)return this.logger.warn({msg:"mid is unexpectedly undefined"}),(0,ln.err)(Ms.FAILED);if(!this.layersEndpoint)return this.logger.warn({msg:"Layers endpoint is unset and required for layer requests"}),(0,ln.err)(Ms.FAILED);this.logger.info({msg:`sendLayerStateRequest for ${this.mid} at ${this.layersEndpoint}`});const e=this.createGetWhepRequest();return this.trackLayerStateRequest(),fetch(this.layersEndpoint,e).then((e=>xs(this,void 0,void 0,(function*(){var t;if(this.state===Ns.DESTROYED)return(0,ln.err)(Ms.DESTROYED);if(e.status>=300)return this.handleLayerStateRequestError(e.status,e.statusText);const n=yield e.json(),r=null!==(t=null==n?void 0:n.layers)&&void 0!==t?t:[],i=JSON.stringify(r,null,2);return this.logger.debug({msg:`sendLayerStateRequest was successful: ${i}`}),(0,ln.ok)(r)})))).catch((e=>this.handleLayerStateRequestError(0,e.message)))})),this.logger=new ScopedLogger(e.logger,de.REMOTE_PLAYBACK),this.token=e.token,this.traceId=e.traceId,this.analyticsTracker=e.analyticsTracker,this.remoteParticipantId=e.remoteParticipantId}set mediaId(e){if(this.state!==Ns.DESTROYED){if(this.mid=e,null===this.mid)return this.logger.info({msg:"media id is unset, controller is transitioning to idle state"}),void(this.state=Ns.IDLE);(this.playbackEndpoint||this.layersEndpoint)&&(this.state=Ns.ACTIVE)}else this.logCommandSkipped("set mediaId")}set endpoints(e){var t,n;if(this.state!==Ns.DESTROYED){if(this.playbackEndpoint=null!==(t=e.playback)&&void 0!==t?t:null,this.layersEndpoint=null!==(n=e.layers)&&void 0!==n?n:null,!this.playbackEndpoint||!this.layersEndpoint){const e={playbackEndpoint:this.playbackEndpoint,layersEndpoint:this.layersEndpoint};return this.logger.info({msg:`no endpoints are set, transitioning to idle state: ${JSON.stringify(e,null)}`}),void(this.state=Ns.IDLE)}this.mid&&(this.state=Ns.ACTIVE)}else this.logCommandSkipped("set endpoints")}destroy(){this.state=Ns.DESTROYED,this.mid=null,this.playbackEndpoint=null,this.layersEndpoint=null}logCommandSkipped(e="command"){this.logger.info({msg:`skipping ${e}, controller state invalid: ${this.state}`})}mapSkippedResultFromState(e){return e===Ns.DESTROYED?(0,ln.err)(Ms.DESTROYED):(0,ln.err)(Ms.FAILED)}createPostWhepRequest(e){return{method:"POST",headers:this.createRequestHeaders(),body:JSON.stringify(e)}}createGetWhepRequest(){return{method:"GET",headers:this.createRequestHeaders()}}createRequestHeaders(){var e,t;return{Authorization:`Bearer ${this.token.rawToken}`,"Content-Type":"application/json","X-Stages-Platform":"web","X-Stages-Request-ID":yr().value,"X-Stages-SDK":"1.30.0","X-Stages-Session-ID":this.analyticsTracker.getSessionId(),"X-Stages-Trace-ID":null!==(t=null===(e=this.traceId)||void 0===e?void 0:e.value)&&void 0!==t?t:"","X-Stages-WHIP-Version":mi}}trackLayerRequest(e){var t;this.analyticsTracker.trackEventNoSharedProps(new PlaybackLayerRequest(this.token,this.traceId,qn.VIDEO,this.remoteParticipantId,null!==(t=this.mid)&&void 0!==t?t:"unknown",e))}trackLayerStateRequest(e=1){var t;this.analyticsTracker.trackEventNoSharedProps(new PlaybackLayerState(this.token,this.traceId,qn.VIDEO,this.remoteParticipantId,null!==(t=this.mid)&&void 0!==t?t:"unknown",e))}handleLayerRequestError(e,t){const n=`sendLayerRequest failed for reason: ${e} ${t}`;let r,i;if(429===e)r=Ms.THROTTLED,i=Lr.WHEP_SET_LAYER_REQUEST_THROTTLED;else r=Ms.FAILED,i=Lr.WHEP_SET_LAYER_REQUEST_FAILED;return this.trackRequestError(i,n),(0,ln.err)(r)}handleLayerStateRequestError(e,t){const n=`sendLayerStateRequest failed for reason: ${e} ${t}`;let r,i;if(429===e)r=Ms.THROTTLED,i=Lr.WHEP_GET_LAYER_STATE_THROTTLED;else r=Ms.FAILED,i=Lr.WHEP_GET_LAYER_STATE_FAILED;return this.trackRequestError(i,n),(0,ln.err)(r)}trackRequestError(e,t){const n=new Error(t);this.logger.error({err:n}),e.message=t;const r=this.createError(e);this.analyticsTracker.trackError(r)}createError(e,t){return new StageClientError(Object.assign({action:mr.SUBSCRIBE,traceId:this.traceId,token:this.token,location:"RemotePlaybackController",tag:Ar,details:t},e))}}var Bs,Us,js,Fs,Vs=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))},Gs=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};!function(e){e.DISCONNECTED="disconnected",e.CONNECTING="connecting",e.CONNECTED="connected",e.ERRORED="errored"}(js||(js={})),function(e){e.NONE="none",e.AUDIO_ONLY="audio_only",e.AUDIO_VIDEO="audio_video"}(Fs||(Fs={}));class StageSubscription extends TypedEmitter{constructor(e,t,n,r,i,o,s){super(),this.id=e,this.token=t,this.stageConnection=n,this.nonScopedLogger=r,this.analyticsTracker=i,this.desiredSubscribeType=o,Bs.add(this),this.isSubscriptionActive=!1,this.subscriptionState={connectionState:js.DISCONNECTED,subscribeInProgress:!1},this.previousSignalState={isTargetPublishing:!1},this.failedRetries=0,this.startConnectingTimestamp=-1,this.throttler=new ThrottleTimer(1e3),this.cleanupFirstFrameTracking=qt,this.actualSubscribeType=Fs.NONE,this.action=mr.SUBSCRIBE,this.updateDesiredSubscribeType=e=>{this.desiredSubscribeType=e,this.attemptToActualizeSubscribeType()},this.updateSubscribeConfig=e=>{this.peerClient.updateSubscribeConfig(e)},this.getDesiredSubscribeType=()=>this.desiredSubscribeType,this.attemptToActualizeSubscribeType=()=>{const e=this.actualSubscribeType,t=this.desiredSubscribeType;this.logger.debug({msg:`Attempt to actualize subscribe type to ${t}`}),this.subscriptionState.connectionState===js.CONNECTED&&t!==Fs.NONE&&e!==t&&this.applyVideoControlsBySubscribeType(t,e)},this.onParticipantUpdated=e=>{Gs(this,Bs,"m",Us).call(this,e)&&(this.logger.debug({msg:"onParticipantUpdated",participant:e}),this.processStateUpdate({isTargetPublishing:e.isPublishing}))},this.onParticipantJoined=e=>{Gs(this,Bs,"m",Us).call(this,e)&&(this.logger.debug({msg:"onParticipantJoined",participant:e}),this.processStateUpdate({isTargetPublishing:e.isPublishing}))},this.onParticipantLeft=e=>{Gs(this,Bs,"m",Us).call(this,e)&&(this.logger.debug({msg:"onParticipantLeft",participant:e}),this.processStateUpdate({isTargetPublishing:!1}))},this.onPeerClientConnectionStateChange=e=>{const t=this.stageConnection.getParticipant(this.id);this.logger.debug({msg:`onPeerClientConnectionStateChange: ${e}`,state:e,targetParticipant:t}),this.processStateUpdate({peerClientState:e})},this.onPeerClientTransformError=e=>{this.emit(Xr,e)},this.onSdpNegotiated=e=>{this.remotePlaybackController.endpoints={playback:e.mediaControls,layers:e.layerControls}},this.seiMessageHandler=e=>{this.emit(Qr,e)},this.requestRTCStats=e=>Vs(this,void 0,void 0,(function*(){return this.peerClient.requestRTCStats(e)})),this.trySubscribe=e=>Vs(this,void 0,void 0,(function*(){var t,n;if(this.logger.debug({msg:`Subscribe attempt started: ${e}`}),!this.isSubscriptionActive)return this.logger.warn({msg:"Subscribe attempt invalid: Subscription is inactive"}),!1;this.logger.debug({msg:"Subscribe attempt is valid."}),this.startConnectingTimestamp<0&&(this.startConnectingTimestamp=performance.now()),this.subscriptionState.connectionState!==js.ERRORED&&(this.logger.debug({msg:"Updating state to CONNECTING"}),this.updateState({connectionState:js.CONNECTING}));const r=this.stageConnection.getConnectionStats(),i=this.peerClient.getExpectedJitterBufferMinDelayInMs(),o=this.peerClient.getSfuResource();this.attemptTracker=this.subscribeTracker.trackAttempt({stageConnectionStats:r,preAttemptSfuResource:o});try{this.remotePlaybackController.traceId=this.attemptTracker.getTraceId();const{mediaStream:e}=yield this.subscribe(this.attemptTracker.getTraceId()),t=performance.now()-this.startConnectingTimestamp,n=this.peerClient.getSfuResource();this.remotePlaybackController.mediaId=this.peerClient.videoMediaId;const r=this.failedRetries;this.attemptToActualizeSubscribeType();const o=this.peerClient.getActionMeasurements(),s=this.peerClient.getProtocol();if(this.attemptTracker.trackSubscribeStarted({sfuResource:n,totalDurationWithRetries:t,retryTimes:r,peerClientPerfStats:o,protocol:s}),e){this.cleanupFirstFrameTracking();const a=this.actualSubscribeType,c=this.attemptTracker,u=(e,a)=>{c.trackSubscribeFirstFrame({peerClientPerfStats:o,sfuResource:n,totalDurationWithRetries:t,retryTimes:r,currentJitterBufferMinDelayInMs:i,mediaType:a,firstFrameDuration:e,protocol:s})};this.cleanupFirstFrameTracking=this.measureFirstFrameDuration({mediaStream:e,subscribeType:a,callback:u})}return this.throttler.clear(),this.failedRetries=0,this.startConnectingTimestamp=-1,e&&this.emit(Kr,e,this.remotePlaybackController),this.logger.debug({msg:"Subscribe attempt succeeded"}),!0}catch(r){const i=null!==(n=null===(t=this.peerClient)||void 0===t?void 0:t.getProtocol())&&void 0!==n?n:"",o=this.attemptTracker.trackSubscribeFailed(r,i);this.logger.error({log:"Subscribe attempt failed",err:r}),this.onTrySubscribeFailure(o,e)}return!1}));const a=br();this.peerClient=new StagePeerClient(t,this.nonScopedLogger,this.action,kr(this.action,e),a,i,e,n,s),this.logger=new ScopedLogger(r,de.SUBSCRIPTION),this.subscribeTracker=new SubscribeTracker(this.analyticsTracker,t,e),this.remotePlaybackController=new RemotePlaybackController({token:t,analyticsTracker:i,traceId:a,logger:this.nonScopedLogger,remoteParticipantId:this.id})}applyVideoControlsBySubscribeType(e,t){try{e===Fs.AUDIO_ONLY?this.remotePlaybackController.stopVideo().catch((e=>{this.logger.error({err:e,msg:"Remote playback request to stop video failed"})})):e===Fs.AUDIO_VIDEO&&this.remotePlaybackController.startVideo().catch((e=>{this.logger.error({err:e,msg:"Remote playback request to start video failed"})})),this.actualSubscribeType=e,this.logger.debug({msg:`Desired subscribe type actualized from ${t} to ${e}.`})}catch(n){this.logger.error({err:n,msg:`Error updating subscribe type from ${t} to ${e}.`})}}processStateUpdate(e){const t=this.previousSignalState,n=Object.assign({},t,e);if(!this.isSubscriptionActive)return void this.logger.warn({msg:"Unexpected processStateUpdate when subscription is inactive"});n.isTargetPublishing?e.peerClientState===Gt.CONNECTED?this.updateState({connectionState:js.CONNECTED,subscribeInProgress:!0}):e.peerClientState===Gt.FAILED&&this.subscriptionState.subscribeInProgress&&(this.attemptTracker&&this.attemptTracker.trackEndFailed(Mr.CONNECTION_FAIL,this.peerClient.getProtocol()),this.updateState({subscribeInProgress:!1}),this.emit(Jr)):(t.isTargetPublishing&&this.subscriptionState.subscribeInProgress&&(this.logger.debug({msg:"Scheduling an unsubscribe on the event loop"}),this.unsubscribe()),this.throttler.clear(),this.updateState({connectionState:js.DISCONNECTED}));const r=!t.isTargetPublishing&&e.isTargetPublishing,i=this.subscriptionState.connectionState===js.CONNECTED&&e.peerClientState===Gt.FAILED;(r||i)&&this.throttledTrySubscribe("onSignalState change: isTargetPublishing is now true"),Object.assign(this.previousSignalState,e)}onTrySubscribeFailure(e,t){this.logger.debug({msg:"Changing/keeping state FAILED"});const n=e.fatal,r=e.code===Lr.OPERATION_ABORTED.code,i=this.failedRetries<=4;if(!r&&!n&&i){const e=1e3*Math.pow(2,this.failedRetries);this.logger.debug({msg:`Retrying in ${e}ms`}),this.failedRetries++,this.nextAttemptTimerId=window.setTimeout((()=>Vs(this,void 0,void 0,(function*(){this.throttledTrySubscribe(t)}))),e)}else this.updateState({connectionState:js.ERRORED}),this.emit(Yr,e),this.onTerminalFailure()}onTerminalFailure(){this.previousSignalState.isTargetPublishing=!1,this.startConnectingTimestamp=-1,this.failedRetries=0}start(){this.isSubscriptionActive=!0,this.peerClient.on(Bt,this.onPeerClientConnectionStateChange),this.peerClient.on(Ut,this.onSdpNegotiated),this.peerClient.on(Ft,this.seiMessageHandler),this.peerClient.on(Vt,this.onPeerClientTransformError),this.stageConnection.on(Fr,this.onParticipantUpdated),this.stageConnection.on(Br,this.onParticipantJoined),this.stageConnection.on(Ur,this.onParticipantLeft),this.stageConnection.on(jr,this.onParticipantLeft);let e=!0;if(this.stageConnection.isConnected()){const t=this.stageConnection.getParticipant(this.id);e=!!(null==t?void 0:t.isPublishing)}this.processStateUpdate({isTargetPublishing:e})}throttledTrySubscribe(e){return this.throttler.invoke(this.trySubscribe,e)}updateState(e){void 0!==e.subscribeInProgress&&(this.subscriptionState.subscribeInProgress=e.subscribeInProgress),e.connectionState&&this.subscriptionState.connectionState!==e.connectionState&&(this.subscriptionState.connectionState=e.connectionState,this.emit(zr,this.subscriptionState.connectionState))}stop(e=!1){this.peerClient.off(Bt,this.onPeerClientConnectionStateChange),this.peerClient.off(Vt,this.onPeerClientTransformError),this.peerClient.off(Ut,this.onSdpNegotiated),this.peerClient.off(Ft,this.seiMessageHandler),this.unsubscribe(e),this.throttler.clear(),this.stageConnection.off(Fr,this.onParticipantUpdated),this.stageConnection.off(Br,this.onParticipantJoined),this.stageConnection.off(Ur,this.onParticipantLeft),this.stageConnection.off(jr,this.onParticipantLeft),this.isSubscriptionActive=!1,this.updateState({connectionState:js.DISCONNECTED})}isActive(){return this.isSubscriptionActive}subscribe(e,t){return Vs(this,void 0,void 0,(function*(){const{token:n,id:r}=this;n.assertTokenIsUnexpired(e,kr(mr.SUBSCRIBE,r),"subscribe",r);const{mediaStream:i}=yield this.peerClient.connect({audioOnly:t,traceId:e});return{peerClient:this.peerClient,mediaStream:i}}))}unsubscribe(e=!1){return Vs(this,void 0,void 0,(function*(){if(window.clearTimeout(this.nextAttemptTimerId),this.remotePlaybackController.destroy(),!this.isSubscriptionActive||!this.attemptTracker||this.subscriptionState.connectionState===js.DISCONNECTED)return;this.cleanupFirstFrameTracking(),this.attemptTracker.trackUnsubscribe();const t=e?Mr.UNLOAD:Mr.UNSUBSCRIBE,n=this.peerClient.getProtocol();try{e?this.peerClient.disconnect(e):yield this.peerClient.disconnect(e),this.updateState({subscribeInProgress:!1}),this.attemptTracker.trackEndSucceeded(t,n)}catch(e){this.attemptTracker.trackEndFailed(t,n)}}))}triggerIceRestart(e){var t;return Vs(this,void 0,void 0,(function*(){const n=this.stageConnection.getConnectionStats(),r=this.peerClient.getSfuResource(),i=this.subscribeTracker.trackAttempt({stageConnectionStats:n,isReassignment:!0,traceIdOverride:e.traceId,preAttemptSfuResource:r}),o=performance.now();try{this.emit(Zr),this.logger.debug({msg:`Triggering attempt. Current node: ${this.peerClient.getSfuResource().node}`}),yield this.peerClient.connect({iceRestartOptions:e,traceId:e.traceId}),this.logger.debug({msg:`Successful ICE restart attempt. Current node: ${this.peerClient.getSfuResource().node}`});const n=performance.now()-o,r=this.peerClient.getSfuResource(),s=this.peerClient.getActionMeasurements();null===(t=this.attemptTracker)||void 0===t||t.trackEndSucceeded(Mr.REASSIGNMENT,this.peerClient.getProtocol()),this.applyVideoControlsBySubscribeType(this.actualSubscribeType,this.actualSubscribeType),i.trackSubscribeStarted({totalDurationWithRetries:n,sfuResource:r,retryTimes:0,peerClientPerfStats:s,protocol:this.peerClient.getProtocol()}),this.emit(ei)}catch(e){this.emit(ti),this.logger.error({msg:"ICE restart attempt failed",err:e});const t=this.peerClient.getSfuResource(),n=i.trackSubscribeFailed(e,this.peerClient.getProtocol(),`iceRestart=true, startNode=${r.node}, endNode=${null==t?void 0:t.node}`);throw n.code===Lr.SUBSCRIBE_TIMED_OUT.code&&this.onTrySubscribeFailure(n,"ice restart timeout"),e}}))}measureFirstFrameDuration({mediaStream:e,subscribeType:t,callback:n}){const r=performance.now(),i=e=>{const t=performance.now()-r;n(t,e),"audio"===e?s():o()};let o=qt,s=qt;return t!==Fs.AUDIO_ONLY&&(o=function(e,t){return Kt(e,"video",t)}(e,i)),s=function(e,t){return Kt(e,"audio",t)}(e,i),()=>{o(),s()}}}var Hs,Ws;Bs=new WeakSet,Us=function(e){return e.id===this.id},function(e){e.JOIN_ERROR="JOIN_ERROR",e.PUBLISH_ERROR="PUBLISH_ERROR",e.SUBSCRIBE_ERROR="SUBSCRIBE_ERROR"}(Hs||(Hs={})),function(e){e[e.TOKEN_MALFORMED=1]="TOKEN_MALFORMED",e[e.TOKEN_EXPIRED=2]="TOKEN_EXPIRED",e[e.TIMEOUT=3]="TIMEOUT",e[e.FAILED=4]="FAILED",e[e.CANCELED=5]="CANCELED",e[e.STAGE_AT_CAPACITY=6]="STAGE_AT_CAPACITY",e[e.CODEC_MISMATCH=7]="CODEC_MISMATCH",e[e.TOKEN_NOT_ALLOWED=8]="TOKEN_NOT_ALLOWED",e[e.STAGE_DELETED=9]="STAGE_DELETED",e[e.PARTICIPANT_DISCONNECTED=10]="PARTICIPANT_DISCONNECTED"}(Ws||(Ws={}));const $s={[Ws.TOKEN_MALFORMED]:"Token is malformed",[Ws.TOKEN_EXPIRED]:"Token expired and is no longer valid",[Ws.TIMEOUT]:"Operation timed out",[Ws.FAILED]:"Operation failed",[Ws.CANCELED]:"Operation canceled",[Ws.STAGE_AT_CAPACITY]:"Stage at capacity",[Ws.CODEC_MISMATCH]:"Client codec is not supported",[Ws.TOKEN_NOT_ALLOWED]:"Token not allowed to perform operation",[Ws.STAGE_DELETED]:"Stage has been deleted, unable to join",[Ws.PARTICIPANT_DISCONNECTED]:"Participant has been disconnected, unable to join"},qs={[Lr.EXPIRED_TOKEN.code]:Ws.TOKEN_EXPIRED,[Lr.MALFORMED_TOKEN.code]:Ws.TOKEN_MALFORMED,[Lr.JOIN_SERVER_BAD_REQUEST.code]:Ws.FAILED,[Lr.TOKEN_PERMISSIONS_DENIED.code]:Ws.TOKEN_NOT_ALLOWED,[Lr.OPERATION_ABORTED.code]:Ws.CANCELED,[Lr.JOIN_TIMED_OUT.code]:Ws.TIMEOUT,[Lr.STAGE_DELETED.code]:Ws.STAGE_DELETED,[Lr.PARTICIPANT_DISCONNECTED.code]:Ws.PARTICIPANT_DISCONNECTED,[Lr.EVENT_PLANE_WS_CREATE_FAILED.code]:Ws.FAILED,[Lr.PUBLISH_TIMED_OUT.code]:Ws.TIMEOUT,[Lr.PUBLISH_FAILURE.code]:Ws.FAILED,[Lr.SUBSCRIBE_TIMED_OUT.code]:Ws.TIMEOUT,[Lr.SUBSCRIBE_FAILURE.code]:Ws.FAILED,[Lr.STAGE_AT_CAPACITY.code]:Ws.STAGE_AT_CAPACITY,[Lr.NO_MATCHING_CODEC.code]:Ws.CODEC_MISMATCH,[Lr.NETWORK_FAILURE.code]:Ws.FAILED,[Lr.INTERNAL_SERVER_ERROR.code]:Ws.FAILED,[Lr.REMOTE_STREAM_NOT_FOUND.code]:Ws.FAILED,[Lr.INTERNAL_MHCP_ERROR.code]:Ws.FAILED,[Lr.UNREACHABLE_MHCP.code]:Ws.FAILED,[Lr.INVALID_SESSION_STATUS.code]:Ws.FAILED,[Lr.MHCP_ABORTED.code]:Ws.FAILED,[Lr.EVENT_PLANE_PONG_TIMEOUT.code]:Ws.FAILED,[Lr.EVENT_PLANE_WS_UNEXPECTED_CLOSE.code]:Ws.FAILED},zs={[Lr.SEI_INSERT_NOT_PUBLISHING_VIDEO.code]:"SEI insert failed due to not publishing video",[Lr.SEI_INSERT_INBAND_NOT_ENABLED.code]:"SEI insert failed due to in-band messaging not being enabled for the stage stream"};class stage_error_manager_StageErrorEvent extends Error{constructor(e,t,n){super(),this.code=e,this.category=t,this.message=n,this.name="StageError",this.errorDetails=[],this.message=`[${t}] ${n}`}addDetails(e){this.errorDetails.push(e)}get details(){return this.errorDetails.length?JSON.stringify(this.errorDetails):""}toString(){return`\n${this.message}\ndetails - ${this.details}\n        `.trim()}}var Ks,Js,Ys;function Qs(e,t){let n;if(e instanceof StageClientError){if(t===Hs.JOIN_ERROR&&(e.code===Lr.EVENT_PLANE_PONG_TIMEOUT.code||e.code===Lr.EVENT_PLANE_WS_UNEXPECTED_CLOSE.code))return;const r=qs[e.code];r&&(n=function(e,t,n){var r,i,o;const s=$s[e],a=new stage_error_manager_StageErrorEvent(e,t,s);return a.addDetails({stageErrorMessage:s,stageErrorCode:e,stageErrorCategory:t,stageArn:null===(r=n.token)||void 0===r?void 0:r.stageARN,traceId:null===(i=n.traceId)||void 0===i?void 0:i.value,causeCode:n.code,causeDetails:n.details,causeMessage:n.message,causeLocation:n.location,participantId:null===(o=n.token)||void 0===o?void 0:o.participantID,timeUTC:(new Date).toISOString()}),a}(r,t,e))}return n}!function(e){e.ERROR="error"}(Ks||(Ks={}));class StageErrorManager extends TypedEmitter{constructor(e){super(),this.logger=e,this.handleError=(e,t,n=!0)=>{const r=function(e){let t;return e instanceof StageClientError&&(t=zs[e.code]),t}(e),i=Qs(e,t);if(r&&this.logger.warn({msg:r}),i)return n&&this.emit(Ks.ERROR,i),i}}}!function(e){e.INTERNAL="internal",e.REMOTE="remote",e.API="api"}(Js||(Js={})),function(e){e.ADDITIVE="additive",e.REPLACE="replace"}(Ys||(Ys={}));class ConfigManager{constructor(e){this.logger=new ScopedLogger(e.logger,de.CONNECTION),this.subscribeConfig={defaults:e.subscribeDefaults,participants:{}}}handleSubscribeConfigUpdate(e,t,n,r=Ys.REPLACE){t=(e=>{const t=Ii(e);if(void 0!==t.jitterBuffer){const e=e=>{if("number"==typeof e){if(e<0)return 0;if(e>4e3)return 4e3}return e};void 0!==t.jitterBuffer.minDelayWhenPublishing&&(t.jitterBuffer.minDelayWhenPublishing=e(t.jitterBuffer.minDelayWhenPublishing)),void 0!==t.jitterBuffer.minDelayWhenSubscribeOnly&&(t.jitterBuffer.minDelayWhenSubscribeOnly=e(t.jitterBuffer.minDelayWhenSubscribeOnly))}return t})(t),void 0===this.subscribeConfig.participants[e]&&(this.subscribeConfig.participants[e]={internalOverrides:{},apiOverrides:{},remoteOverrides:{},lastMerged:this.subscribeConfig.defaults});const i=this.subscribeConfig.participants[e];switch(n){case Js.INTERNAL:i.internalOverrides=this.handleSubscribeConfigLevelMerging(i.internalOverrides,t,r);break;case Js.REMOTE:i.remoteOverrides=this.handleSubscribeConfigLevelMerging(i.remoteOverrides,t,r);break;case Js.API:i.apiOverrides=this.handleSubscribeConfigLevelMerging(i.apiOverrides,t,r);break;default:!function(e){throw new Error(`Unknown case kind: ${e}`)}(n)}const o=Ti(this.subscribeConfig.defaults,i.internalOverrides,i.remoteOverrides,i.apiOverrides);if(void 0===o)return this.logger.warn({msg:`Unable to merge subscribe configs for participant: ${e} | ${i}, ${t}`}),!1;const s=!1===(a=i.lastMerged,c=o,"object"==typeof a&&"object"==typeof c&&(0,mn.isEqual)(a,c));var a,c;return i.lastMerged=o,this.subscribeConfig.participants[e]=i,s}handleExternalSubscribeConfigUpdate(e,t,n,r=Ys.REPLACE){const i=(e=>{const t={};return"object"!=typeof e?ln.err(new Error("Invalid input")):(void 0!==e.jitterBuffer&&(t.jitterBuffer={},void 0!==e.jitterBuffer.minDelay&&(t.jitterBuffer.minDelayWhenSubscribeOnly=e.jitterBuffer.minDelay)),void 0!==e.inBandMessaging&&(t.inBandMessaging={enabled:!0===e.inBandMessaging.enabled}),void 0!==e.simulcast&&(t.simulcast={},void 0!==e.simulcast.initialLayerPreference&&(t.simulcast.initialLayerPreference=e.simulcast.initialLayerPreference)),ln.ok(t))})(t);return!0===i.ok&&this.handleSubscribeConfigUpdate(e,i.value,n,r)}handleSubscribeConfigLevelMerging(e,t,n){if(n===Ys.REPLACE)return t;{const r=Ti(e,t);return void 0===r?(this.logger.warn({msg:`Unable to merge '${e}' and '${t}' with type ${n}`}),e):r}}getSubscribeConfigSnapshot(e){return void 0===this.subscribeConfig.participants[e]?Ci(this.subscribeConfig.defaults):Ci(this.subscribeConfig.participants[e].lastMerged)}}class ReassignmentRequestEvent extends StageAnalyticsEvent{constructor(e){super(gt.REASSIGNMENT_REQUEST,e.token,e.traceId,!1),Object.assign(this.properties,{target_local_participant_id:e.targetLocalParticipantId,target_remote_participant_id:e.targetRemoteParticipantId}),this.critical=!0}}var Xs,Zs,ea,ta,na,ra=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};class StageStream extends TypedEmitter{constructor(e,t){super(),this.setGetStats=e=>{this._getInternalStats=e},this.getStats=()=>ra(this,void 0,void 0,(function*(){return this.requestRTCStats()})),this.requestRTCStats=()=>ra(this,void 0,void 0,(function*(){if(!this._getInternalStats)return;const e=yield this._getInternalStats(this.mediaStreamTrack);return e?e.rawReport:void 0})),this._getInternalStats=t,this.id=e.id,this.isMuted=!e.enabled,this.mediaStreamTrack=e,this.streamType="audio"===this.mediaStreamTrack.kind?qn.AUDIO:qn.VIDEO}cleanup(){this.removeAllListeners(),this._getInternalStats=void 0}}!function(e){e.IDLE="IDLE",e.INITIALIZING="INITIALIZING",e.ACTIVE="ACTIVE",e.CONTROLS_PAUSED="CONTROLS_PAUSED",e.DESTROYED="DESTROYED"}(Xs||(Xs={})),function(e){e.LAYERS_CHANGED="LAYERS_CHANGED",e.LAYER_SELECTED="LAYER_SELECTED",e.ADAPTION_CHANGED="ADAPTION_CHANGED"}(Zs||(Zs={})),function(e){e.LAYERS_CHANGED="LAYERS_CHANGED",e.LAYER_SELECTED="LAYER_SELECTED",e.ADAPTION_CHANGED="ADAPTION_CHANGED"}(ea||(ea={})),function(e){e.UNAVAILABLE="unavailable",e.SELECTED="selected"}(ta||(ta={})),function(e){e.LOCAL_STREAM_MUTE_CHANGED="localStreamMutedChanged",e.LOCAL_STREAM_INSERT_SEI_MSG_REQUEST="localStreamInsertSeiMsgRequest"}(na||(na={}));var ia,oa,sa,aa=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};class LocalStageStream extends StageStream{constructor(e,t){super(e),this.setMuted=e=>{e!==this.isMuted&&(this.mediaStreamTrack.enabled=!e,this.isMuted=e,this.emit(na.LOCAL_STREAM_MUTE_CHANGED,this))},this.insertSeiMessage=(e,t)=>aa(this,void 0,void 0,(function*(){let n;if("audio"===this.streamType)n=Is.INVALID_TRACK_TYPE;else if(this.mediaConfig.inBandMessaging.enabled){const r=this.validator.validateMessagePayload(e,(null==t?void 0:t.repeatCount)||0);n=ln.getErr(r)}else n=Is.INBAND_MESSAGING_NOT_ENABLED;n?console.warn(`Unable to insert SEI message due to ${n}`):this.emit(na.LOCAL_STREAM_INSERT_SEI_MSG_REQUEST,this,e,t)})),this.requestQualityStats=()=>aa(this,void 0,void 0,(function*(){if(!this._getInternalStats)return;const e=yield this._getInternalStats(this.mediaStreamTrack);return e?e.stats:void 0})),this.validatedExternalConfig=es(e,t),this.normalizedConfig=is(0,this.validatedExternalConfig),this.mediaConfig=(0,mn.cloneDeep)(this.normalizedConfig),this.validator=new SeiSendRequestValidator(xi)}}class StageStrategyWrapper{constructor(e,t){this.strategy=e,this.logger=t}setStrategy(e){this.strategy=e}hasStrategy(e){return void 0!==this.strategy[e]}stageStreamsToPublish(){let e=[];try{e=this.strategy.stageStreamsToPublish(),e=e.filter((e=>e instanceof LocalStageStream))}catch(e){return this.logger.warn({msg:"error executing stageStreamsToPublish treating this as a no-op",err:e}),console.error("Error executing stageStreamsToPublish",e),ln.err(e)}let t=0,n=0;for(const r of e)"audio"===r.mediaStreamTrack.kind?t++:"video"===r.mediaStreamTrack.kind&&n++;if(t>1||n>1){const e=Error("stageStreamsToPublish strategy function returned more than 1 video or audio stream and as a result will not publish",{cause:"UserStrategy"});return ln.err(e)}return ln.ok(e)}shouldPublishParticipant(e){try{return ln.ok(this.strategy.shouldPublishParticipant(e))}catch(e){return this.logger.warn({msg:"error executing shouldPublishParticipant treating this as a no-op",err:e}),console.error("Error executing shouldPublishParticipant",e),ln.err(e)}}shouldSubscribeToParticipant(e){try{return ln.ok(this.strategy.shouldSubscribeToParticipant(e))}catch(e){return this.logger.warn({msg:"error executing shouldSubscribeToParticipant. Treating it as a no-op",err:e}),console.error("Error executing shouldSubscribeToParticipant",e),ln.err(e)}}subscribeConfiguration(e){var t,n;try{return ln.ok(null===(n=(t=this.strategy).subscribeConfiguration)||void 0===n?void 0:n.call(t,e))}catch(e){return this.logger.warn({msg:"error executing subscribeConfiguration. Treating it as a no-op",err:e}),console.error("Error executing subscribeConfiguration",e),ln.err(e)}}preferredLayerForStream(e,t){var n,r;try{return ln.ok(null===(r=(n=this.strategy).preferredLayerForStream)||void 0===r?void 0:r.call(n,e,t))}catch(e){return this.logger.warn({msg:"error executing preferredLayerForStream. Treating it as a no-op",err:e}),console.error("Error executing preferredLayerForStream",e),ln.err(e)}}}class StageParticipant extends TypedEmitter{constructor(e,t){super(),this.audioMuted=!0,this.videoStopped=!0,this.publishState=oa.NOT_PUBLISHED,this.logger=t,this.info=e,this.audioMuted=e.audioMuted,this.videoStopped=e.videoStopped}}!function(e){e.PUBLISH="publish",e.SUBSCRIBE="subscribe"}(ia||(ia={})),function(e){e.NOT_PUBLISHED="not_published",e.ATTEMPTING_PUBLISH="attempting_publish",e.PUBLISHED="published",e.ERRORED="errored"}(oa||(oa={})),function(e){e.NOT_SUBSCRIBED="not_subscribed",e.ATTEMPTING_SUBSCRIBE="attempting_subscribe",e.SUBSCRIBED="subscribed",e.ERRORED="errored"}(sa||(sa={}));function ca(e){return e.map((e=>e.remote))}function ua(e){return{label:e.encodingId,bitrateBps:1e3*e.bitrate,width:e.width,height:e.height,framesPerSecond:e.framesPerSecond,selected:e.selected}}function la(e,t){const n=e.width*e.height,r=t.width*t.height;return n>r||e.bitrateBps>t.bitrateBps||e.framesPerSecond>t.framesPerSecond?1:n===r&&e.bitrateBps===t.bitrateBps&&e.framesPerSecond===t.framesPerSecond?0:-1}var da=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};class RemoteStageStream extends TypedEmitter{constructor(e){var t,n,r;super(),this.onAdaptionChanged=e=>{this.emit(ea.ADAPTION_CHANGED,e)},this.onLayersChanged=e=>{this.emit(ea.LAYERS_CHANGED,e)},this.onLayerSelected=(e,t)=>{this.emit(ea.LAYER_SELECTED,e,t)},this.setGetStats=()=>{},this.requestRTCStats=()=>da(this,void 0,void 0,(function*(){var e;return null===(e=this.internalStream)||void 0===e?void 0:e.requestRTCStats()})),this.requestQualityStats=()=>da(this,void 0,void 0,(function*(){if(this.internalStream)try{const e=yield this.internalStream.getInternalStats();if(!e)return;return e.stats}catch(e){return}})),this.getStats=()=>da(this,void 0,void 0,(function*(){var e;return null===(e=this.internalStream)||void 0===e?void 0:e.requestRTCStats()})),this.setMuted=e=>{var t;null===(t=this.internalStream)||void 0===t||t.setMuted(e)},this.getLayers=()=>{var e,t;return null!==(t=null===(e=this.internalStream)||void 0===e?void 0:e.layers)&&void 0!==t?t:this.cachedLayers},this.getSelectedLayer=()=>{var e,t;return null!==(t=null===(e=this.internalStream)||void 0===e?void 0:e.selectedLayer)&&void 0!==t?t:this.cachedSelectedLayer},this.getLowestQualityLayer=()=>{var e,t;return null!==(t=null===(e=this.internalStream)||void 0===e?void 0:e.lowestQualityLayer)&&void 0!==t?t:this.cachedLowestLowestLayer},this.getHighestQualityLayer=()=>{var e,t;return null!==(t=null===(e=this.internalStream)||void 0===e?void 0:e.highestQualityLayer)&&void 0!==t?t:this.cachedHighestQualityLayer},this.internalStream=e,this.cachedId=this.internalStream.id,this.cachedParticipantInfo=(0,mn.cloneDeep)(this.internalStream.participantInfo),this.cachedStreamType=this.internalStream.streamType,this.cachedMediaStreamTrack=null!==(r=null===(n=(t=this.internalStream.mediaStreamTrack).clone)||void 0===n?void 0:n.call(t))&&void 0!==r?r:{},this.cachedIsMuted=this.internalStream.isMuted,this.cachedIsAdapting=this.internalStream.isAdapting,this.cachedLayers=this.internalStream.layers,this.updateCachedStreamData(),this.internalStream.on(Zs.ADAPTION_CHANGED,this.onAdaptionChanged),this.internalStream.on(Zs.LAYERS_CHANGED,this.onLayersChanged),this.internalStream.on(Zs.LAYER_SELECTED,this.onLayerSelected)}updateCachedStreamData(){var e,t,n,r,i;this.cachedLayers=null!==(t=null===(e=this.internalStream)||void 0===e?void 0:e.layers)&&void 0!==t?t:[],this.cachedHighestQualityLayer=null===(n=this.internalStream)||void 0===n?void 0:n.highestQualityLayer,this.cachedLowestLowestLayer=null===(r=this.internalStream)||void 0===r?void 0:r.lowestQualityLayer,this.cachedSelectedLayer=null===(i=this.internalStream)||void 0===i?void 0:i.selectedLayer}get id(){var e,t;return null!==(t=null===(e=this.internalStream)||void 0===e?void 0:e.id)&&void 0!==t?t:this.cachedId}get participantInfo(){var e,t;return null!==(t=null===(e=this.internalStream)||void 0===e?void 0:e.participantInfo)&&void 0!==t?t:this.cachedParticipantInfo}get streamType(){var e,t;return null!==(t=null===(e=this.internalStream)||void 0===e?void 0:e.streamType)&&void 0!==t?t:this.cachedStreamType}get mediaStreamTrack(){var e,t;return null!==(t=null===(e=this.internalStream)||void 0===e?void 0:e.mediaStreamTrack)&&void 0!==t?t:this.cachedMediaStreamTrack}get isMuted(){var e,t;return null!==(t=null===(e=this.internalStream)||void 0===e?void 0:e.isMuted)&&void 0!==t?t:this.cachedIsMuted}set isMuted(e){var t;null===(t=this.internalStream)||void 0===t||t.setMuted(e)}get isAdapting(){var e,t;return null!==(t=null===(e=this.internalStream)||void 0===e?void 0:e.isAdapting)&&void 0!==t?t:this.cachedIsAdapting}cleanup(){var e,t,n;this.updateCachedStreamData(),null===(e=this.internalStream)||void 0===e||e.off(Zs.ADAPTION_CHANGED,this.onAdaptionChanged),null===(t=this.internalStream)||void 0===t||t.off(Zs.LAYERS_CHANGED,this.onLayersChanged),null===(n=this.internalStream)||void 0===n||n.off(Zs.LAYER_SELECTED,this.onLayerSelected),this.internalStream=void 0,this.removeAllListeners()}}var ha,pa,fa=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};class InternalStageStream extends StageStream{constructor({track:e,info:t,getStats:n,remotePlaybackController:r,analyticsTracker:i,token:o,subscribeConfig:s}){super(e,n),this.hasRemoteListenersForLayerEvents=()=>{const e=this.remote;return e.hasListenersFor(ea.ADAPTION_CHANGED)||e.hasListenersFor(ea.LAYERS_CHANGED)||e.hasListenersFor(ea.LAYER_SELECTED)},this.setMuted=e=>{this.isMuted=e,this.mediaStreamTrack.enabled=!e},this.setLayer=e=>{const t=(0,mn.cloneDeep)(e);if(this.queueLayerUpdateForValidState(t))return void this.logger.debug({msg:`setLayer:${t} queued, skipping for now`});const n=function(e,t){if(!e)return(0,ln.ok)(void 0);const n="string"==typeof e?e:e.label,r=t.filter((e=>e.label===n))[0];return r?(0,ln.ok)(r):(0,ln.err)(`Provided layer with id ${n} does not exist`)}(t,this._layers);if(!n.ok){const e=n.error;return void this.logger.error({err:e,msg:"Unable to select layer, skipping selection"})}const r=n.value;if(this.isNextUpdateAdaptionOnly(r))return this.logger.warn({msg:"setLayer:dynamic"}),void this.handleDynamicUpdate();this.isFirstLayerUpdate()||!this.isRepeatLayerSelection(r)||this.isAdapting?r&&(this.logger.warn({msg:`setLayer:${JSON.stringify(r)} `}),this.handleManualUpdate(r)):this.logger.debug({msg:"Setting the same layer, same adaption state, skipping selection"})},this.state=Xs.INITIALIZING,this.prevState=Xs.IDLE,this.analyticsTracker=i,this.token=o,this.id=e.id,this.info=t,this.mediaStreamTrack=e,this.remotePlaybackController=r,this.layerPollingIntervalId=null,this.weakRemoteMap=new WeakMap,this.weakRemoteKey={id:"remote"},this.commandMap=new Map,this.subscribeConfig=s,this._isAdapting=!0,this._layers=[],this._selectedLayer=null;const a=yt();this.logger=new ScopedLogger(new Logger(a),de.REMOTE_STAGE_STREAM),this.streamType===qn.AUDIO?this.isMuted=t.audioMuted:this.isMuted=t.videoStopped,this.initializeLayerPolling();this.pollInternalLayers(!0)}transitionStateTo(e){this.state!==e&&(this.prevState=this.state,this.state=e)}initializeLayerPolling(){$n(this.mediaStreamTrack)?this.streamType!==qn.AUDIO?(this.logger.debug({msg:"Setting up RemoteStageStream, requesting initial layers"}),null!==this.layerPollingIntervalId&&clearInterval(this.layerPollingIntervalId),this.layerPollingIntervalId=setInterval((()=>{this.pollInternalLayers()}),this.subscribeConfig.simulcast.layerPollingIntervalMs)):this.logger.debug({msg:"Skipping initializing polling for audio streams"}):this.logger.debug({msg:"Skipping initializing polling, media track is not active"})}startLayerPolling(){null===this.layerPollingIntervalId?this.initializeLayerPolling():this.logger.debug({msg:"Skipping start polling request, already started"})}stopLayerPolling(){null!==this.layerPollingIntervalId?(clearInterval(this.layerPollingIntervalId),this.layerPollingIntervalId=null):this.logger.debug({msg:"Skipping stop polling request, already stopped"})}pollInternalLayers(e=!1){if(!$n(this.mediaStreamTrack))return void this.pauseControls();if(this.streamType===qn.AUDIO)return this.logger.debug({msg:"Skipping layer poll request for audio stream"}),void this.transitionStateTo(Xs.ACTIVE);const t=!this.hasRemoteListenersForLayerEvents(),n=!this.subscribeConfig.simulcast.layerPollingEnabled;!e&&t&&n?this.logger.debug({msg:"Skipping layer request due to no listeners"}):this.remotePlaybackController.getLayers().then((e=>{if(this.isStateValidForLayerUpdates()){if(!e.ok)throw Error(e.error);this.updateInternalLayersFromRemote(e.value),this.transitionStateTo(Xs.ACTIVE),this.flushCommandQueue()}else this.logger.warn({msg:"Stream controls have been paused, skipping getLayers"})})).catch((e=>{this.logger.error({err:e,msg:"Error calling getLayers, returning current layers"})}))}updateInternalLayersFromRemote(e){const t=this._layers,n=e.map(ua).sort(la),r=!(0,mn.isEqual)(n,t);this._layers=n;const i=this._selectedLayer,o=this._layers.filter((e=>e.selected))[0],s=!(0,mn.isEqual)(o,i);i&&(i.selected=!1),this._selectedLayer=o,s&&(this.trackLayerUpdate(i),this.trackLayerUpdate(o)),this.isCommandQueueEmpty()&&(r&&this.emitLayersChanged(),s&&this.emitLayerSelected(o))}flushCommandQueue(){if(this.isCommandQueueEmpty())return;const e=Array.from(this.commandMap.keys());this.logger.debug({msg:`Flushing active commands from map ${e}`});for(const e of this.commandMap.keys()){const t=this.commandMap.get(e);null==t||t()}this.commandMap.clear()}queueLayerUpdateForValidState(e){if(!e)return this.commandMap.delete("setLayer"),!1;if(this.state===Xs.INITIALIZING){const t=this.setLayer.bind(this,e);return this.commandMap.set("setLayer",t),!0}return!1}handleDynamicUpdate(){if(!this.isStateValidForLayerUpdates())return void this.logger.warn({msg:"Stream controls have been paused, skipping dynamic mode transition"});const e=this._isAdapting;this._isAdapting=!0,this.emitAdaptionChanged(),this.remotePlaybackController.unsetLayer().then((t=>{if(!this.isStateValidForLayerUpdates())return this.logger.warn({msg:"Stream controls have been paused, skipping dynamic mode transition"}),void this.resetAdaptionStateOnError(e,`Stream in invalid state: ${this.state}`);t.ok?this.logger.debug({msg:"Layer successfully unset, restarting dynamic adaption"}):this.resetAdaptionStateOnError(e,t.error)})).catch((()=>{}))}resetAdaptionStateOnError(e,t){this._isAdapting=e,this.emitAdaptionChanged(),this.logger.error({err:t,msg:"Error unsetting layer, reverting adaption state"})}handleManualUpdate(e){if(!this.isStateValidForLayerUpdates())return void this.logger.warn({msg:"Stream controls have been paused, skipping manual updates"});const t=this._isAdapting,n=this._selectedLayer;n&&(n.selected=!1),this._isAdapting=!1,this._selectedLayer=e,e.selected=!0,t!==this._isAdapting&&this.emitAdaptionChanged(),this.updateLocalLayerStateBeforeRemote(e,n),this.trackLayerUpdate(n),this.trackLayerUpdate(e),this.emitLayersChanged(),this.emitLayerSelected(e),this.remotePlaybackController.setLayer(e.label).then((r=>{if(!this.isStateValidForLayerUpdates()){this.logger.warn({msg:"Stream controls have been paused, skipping dynamic mode transition"});const r=`Stream in invalid state: ${this.state}`;return this.resetAdaptionStateOnError(t,r),void this.resetLayerOnError(n,e,r)}if(!r.ok){const i=r.error;return this.resetAdaptionStateOnError(t,i),void this.resetLayerOnError(n,e,i)}this.logger.debug({msg:`Layer successfully selected: ${e.label}`})})).catch((()=>{}))}applyExistingControlState(){var e;this._isAdapting?this.remotePlaybackController.unsetLayer().then((()=>{})).catch((()=>{})):(null===(e=this._selectedLayer)||void 0===e?void 0:e.label)&&this.remotePlaybackController.setLayer(this._selectedLayer.label).then((()=>{})).catch((()=>{}))}resetLayerOnError(e,t,n){t&&(t.selected=!1),e&&(e.selected=!0),this._selectedLayer=e,this.logger.error({err:n,msg:"Error unsetting layer, leaving current selection in place"}),this.updateLocalLayerStateBeforeRemote(e,t),this.emitLayersChanged(),null!==e&&this.emitLayerSelected(e,ta.UNAVAILABLE),this.trackLayerUpdate(t),this.trackLayerUpdate(e)}updateLocalLayerStateBeforeRemote(e,t){this._layers=this._layers.map((n=>n.label===(null==e?void 0:e.label)?e:n.label===(null==t?void 0:t.label)?t:n)).sort(la)}trackLayerUpdate(e){var t,n;this.analyticsTracker.trackEventNoSharedProps(new SimulcastLayerInfoEvent(this.token,br(),null!==(t=null==e?void 0:e.label)&&void 0!==t?t:"auto",!0,mr.SUBSCRIBE,null!==(n=null==e?void 0:e.selected)&&void 0!==n&&n,this.info.id))}isNextUpdateAdaptionOnly(e){return void 0===e&&this.isFirstLayerUpdate()||void 0===e&&!this.isAdapting}isFirstLayerUpdate(){return null===this._selectedLayer}isRepeatLayerSelection(e){var t;return(null===(t=this._selectedLayer)||void 0===t?void 0:t.label)===(null==e?void 0:e.label)}isStateValidForLayerUpdates(){return this.state===Xs.ACTIVE||this.state===Xs.INITIALIZING}isCommandQueueEmpty(){return 0===this.commandMap.size}emitLayerSelected(e,t=ta.SELECTED){this.logger.debug({msg:`Emitting layers selected ${JSON.stringify(e,null,2)}`}),this.emit(Zs.LAYER_SELECTED,(0,mn.cloneDeep)(e),t)}emitLayersChanged(){this.emit(Zs.LAYERS_CHANGED,(0,mn.cloneDeep)(this._layers))}emitAdaptionChanged(){this.emit(Zs.ADAPTION_CHANGED,this._isAdapting)}get remote(){const e=this.weakRemoteMap.get(this.weakRemoteKey);if(e)return e;const t=new RemoteStageStream(this);return this.weakRemoteMap.set(this.weakRemoteKey,t),t}get participantInfo(){return(0,mn.cloneDeep)(this.info)}get isAdapting(){return this._isAdapting}get layers(){return(0,mn.cloneDeep)(this._layers)}get selectedLayer(){var e;return(0,mn.cloneDeep)(null!==(e=this._selectedLayer)&&void 0!==e?e:void 0)}get highestQualityLayer(){return(0,mn.cloneDeep)(this.layers[this.layers.length-1])}get lowestQualityLayer(){return(0,mn.cloneDeep)(this.layers[0])}getInternalStats(){return fa(this,void 0,void 0,(function*(){if(this._getInternalStats)return this._getInternalStats(this.mediaStreamTrack)}))}pauseControls(){this.transitionStateTo(Xs.CONTROLS_PAUSED),this.stopLayerPolling()}resumeControls(){this.applyExistingControlState(),this.startLayerPolling(),this.transitionStateTo(Xs.ACTIVE)}updateSubscribeConfig(e){const t=this.subscribeConfig;this.subscribeConfig=e;t.simulcast.layerPollingIntervalMs!==e.simulcast.layerPollingIntervalMs&&this.isStateValidForLayerUpdates()&&this.initializeLayerPolling()}cleanup(){this.transitionStateTo(Xs.DESTROYED),super.cleanup(),this.weakRemoteMap.delete(this.weakRemoteKey),this.stopLayerPolling(),this._layers=[],this._selectedLayer=null,this._isAdapting=!0,this.commandMap.clear()}}!function(e){e.STATE_CHANGE="stateChange",e.MEDIA_STREAM_ADDED="mediaStreamAdded",e.MEDIA_STREAM_REMOVED="mediaStreamRemoved",e.MEDIA_STREAM_MUTE_CHANGED="mediaStreamMuteChanged",e.ERROR="error"}(ha||(ha={})),function(e){e.SUBSCRIPTION_STATE_CHANGE="subscriptionStateChange",e.MEDIA_STREAM_SEI_MESSAGE_RECEIVED="mediaStreamSeiMessageReceived"}(pa||(pa={}));const ga=Object.assign(Object.assign({},ha),pa);var ma;!function(e){e.PUBLICATION_STATE_CHANGE="publicationStateChange"}(ma||(ma={}));const va=Object.assign(Object.assign({},ha),ma);var Ea=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};class RemoteStageParticipant extends StageParticipant{constructor(e,t,n,r,i,o,s,a=!1){super(e,new ScopedLogger(r,de.REMOTE_PARTICIPANT)),this.subscribeState=sa.NOT_SUBSCRIBED,this.reassigning=!1,this.streams=[],this.left=!1,this.onSubscriptionStateChange=e=>{this.logger.debug({msg:"subscriptionStateChange",state:e}),e===js.DISCONNECTED?this.updateSubscriptionState(sa.NOT_SUBSCRIBED):e===js.CONNECTED?this.updateSubscriptionState(sa.SUBSCRIBED):e===js.CONNECTING?this.updateSubscriptionState(sa.ATTEMPTING_SUBSCRIBE):e===js.ERRORED?(this.emitStreamsRemovedByType(this.getDesiredSubscribeType()),this.cleanupStreams(),this.updateSubscriptionState(sa.ERRORED)):this.logger.warn({msg:"FIXME onSubscriptionStateChange UNHANDLED STATE",state:e})},this.onSubscriptionStreamRemoved=()=>{this.logger.debug({msg:"onSubscriptionStreamRemoved"}),this.emitStreamsRemovedByType(this.getDesiredSubscribeType()),this.cleanupStreams()},this.onSubscriptionStreamCreated=(e,t)=>{this.logger.debug({msg:"onSubscriptionStreamCreated",stream:e}),this.pruneInactiveStreams();let n=e.getTracks().map((e=>{const n=new InternalStageStream({track:e,info:this.info,getStats:this.subscription.requestRTCStats,remotePlaybackController:t,analyticsTracker:this.analyticsTracker,token:this.token,subscribeConfig:this.subscribeConfig});return this.streams.push(n),n}));this.subscription.getDesiredSubscribeType()===Fs.AUDIO_ONLY&&(n=n.filter((e=>e.streamType!==qn.VIDEO))),this.emit(ga.MEDIA_STREAM_ADDED,n)},this.onSubscriptionError=e=>{this.emit(ga.ERROR,e)},this.onSubscriptionSeiMessageReceived=e=>{this.emit(ga.MEDIA_STREAM_SEI_MESSAGE_RECEIVED,e)},this.onSubscriptionTransformError=e=>{this.emit(ga.ERROR,e)},this.onSubscriptionReassignmentStart=()=>{for(const e of this.streams)e.pauseControls()},this.onSubscriptionReassignmentDone=()=>{for(const e of this.streams)e.resumeControls()},this.updateSubscribeStateIfNecessary=(e,t)=>{if(!this.info.capabilities.has(ia.SUBSCRIBE))return;void 0!==t&&(this.subscribeConfig=t,this.subscription.updateSubscribeConfig(t),this.streams.forEach((e=>{e.updateSubscribeConfig(t)})));const n=e!==Fs.NONE&&this.publishState===oa.PUBLISHED,r=this.subscribeState!==sa.NOT_SUBSCRIBED&&this.subscribeState!==sa.ERRORED;if(n&&!r)this.subscription.updateDesiredSubscribeType(e),this.subscribe();else if(!n&&r)this.unsubscribe(),this.subscription.updateDesiredSubscribeType(e);else if(this.subscribeState===sa.SUBSCRIBED&&this.subscription.getDesiredSubscribeType()!==e)try{e===Fs.AUDIO_ONLY?this.emit(ga.MEDIA_STREAM_REMOVED,this.filterStreamsByType(this.streams,qn.VIDEO)):e===Fs.AUDIO_VIDEO&&this.emit(ga.MEDIA_STREAM_ADDED,this.filterStreamsByType(this.streams,qn.VIDEO)),this.subscription.updateDesiredSubscribeType(e)}catch(e){this.logger.error({err:e,msg:"error updating subscribe type"})}},this.updatePublishState=e=>{const t=e&&this.publishState===oa.PUBLISHED,n=!e&&this.publishState===oa.NOT_PUBLISHED;return!t&&!n&&(this.info.isPublishing=e,this.publishState=e?oa.PUBLISHED:oa.NOT_PUBLISHED,!0)},this.updateStreamState=(e,t)=>{this.audioMuted!==e&&(this.audioMuted=e,this.info.audioMuted=e,this.updateStreamMuteState(qn.AUDIO,e)),this.videoStopped!==t&&(this.videoStopped=t,this.info.videoStopped=t,this.updateStreamMuteState(qn.VIDEO,t))},this.updateStreamMuteState=(e,t)=>{const n=this.filterStreamsByType(this.streams,e),r=n[n.length-1];if(!r){const t=`state update received for ${this.info.id} for non-existent ${e} stream`;return this.logger.warn({msg:t}),void this.traceRemoteParticipantMsg(t)}r.setMuted(t),this.emit(ga.MEDIA_STREAM_MUTE_CHANGED,r)},this.cleanup=()=>{this.removeAllListeners()},this.quickUnsubscribe=()=>this.subscribeState!==sa.NOT_SUBSCRIBED&&this.subscription.stop(!0),this.getDesiredSubscribeType=()=>this.subscription.getDesiredSubscribeType(),this.isReassigning=()=>this.reassigning,this.analyticsTracker=s,this.token=t,this.subscribeConfig=o,this.createSubscription=()=>{const a=new StageSubscription(e.id,t,n,r,s,i,o);return a.on(zr,this.onSubscriptionStateChange),a.on(Kr,this.onSubscriptionStreamCreated),a.on(Jr,this.onSubscriptionStreamRemoved),a.on(Yr,this.onSubscriptionError),a.on(Qr,this.onSubscriptionSeiMessageReceived),a.on(Xr,this.onSubscriptionTransformError),a.on(Zr,this.onSubscriptionReassignmentStart),a.on(ei,this.onSubscriptionReassignmentDone),a.on(ti,this.onSubscriptionReassignmentDone),a},this.subscription=this.createSubscription(),a&&(this.publishState=oa.PUBLISHED)}updateSubscriptionState(e){e!==this.subscribeState&&(this.subscribeState=e,this.emit(ga.SUBSCRIPTION_STATE_CHANGE,this.subscribeState))}pruneInactiveStreams(){const e=[];this.streams=this.streams.filter((t=>!!$n(t.mediaStreamTrack)||(e.push(t),!1)));const t=e.length;if(0===t)return;const n=this.filterStreamsByType(e,qn.AUDIO).length,r=t-n;this.traceRemoteParticipantMsg(`Pruning inactive streams (${n} audio, ${r} video)`),this.emitStreamsRemoved(e),e.forEach((e=>{e.remote.cleanup(),e.cleanup()}))}filterStreamsByType(e,t){return e.filter((e=>e.streamType===t))}participantLeave(){this.left=!0}subscribe(){this.left?this.logger.warn({msg:"tried to subscribe to a participant that left"}):(this.updateSubscriptionState(sa.ATTEMPTING_SUBSCRIBE),this.logger.debug({msg:"subscribe"}),this.subscription.start())}unsubscribe(){if(this.subscribeState===sa.NOT_SUBSCRIBED)return;this.logger.debug({msg:"unsubscribe"}),this.subscription.stop(),this.subscription.off(zr,this.onSubscriptionStateChange),this.subscription.off(Kr,this.onSubscriptionStreamCreated),this.subscription.off(Jr,this.onSubscriptionStreamRemoved),this.subscription.off(Yr,this.onSubscriptionError),this.subscription.off(Xr,this.onSubscriptionTransformError);const e=this.getDesiredSubscribeType();this.subscription=this.createSubscription(),this.emitStreamsRemovedByType(e),this.updateSubscriptionState(sa.NOT_SUBSCRIBED),this.cleanupStreams()}emitStreamsRemovedByType(e){switch(e){case Fs.AUDIO_VIDEO:this.emitStreamsRemoved(this.streams);break;case Fs.AUDIO_ONLY:this.emitStreamsRemoved(this.filterStreamsByType(this.streams,qn.AUDIO));case Fs.NONE:}}emitStreamsRemoved(e){this.emit(ga.MEDIA_STREAM_REMOVED,e)}cleanupStreams(){0!==this.streams.length&&(this.logger.debug({msg:"Cleaning up streams due to internal removal"}),this.streams.forEach((e=>{e.remote.cleanup(),e.cleanup()})),this.streams=[])}traceRemoteParticipantMsg(e){this.analyticsTracker.trackEventNoSharedProps(new TraceEvent(this.token,br(),e,mr.SUBSCRIBE,this.info.id))}triggerIceRestart(e){return Ea(this,void 0,void 0,(function*(){this.reassigning=!0;try{yield this.subscription.triggerIceRestart(e)}finally{this.reassigning=!1}}))}}const Sa=mr.PUBLISH;function _a(e,t,n){return new StageClientError(Object.assign(Object.assign({},e),{token:t,traceId:n,location:"stage-publication.sendSeiMessage",tag:Or,action:mr.PUBLISH}))}class PublishTracker{constructor(e,t){this.analyticsTracker=e,this.token=t,this.action=Sa,this.traceId=br()}trackPublish(e){const{action:t,traceId:n,analyticsTracker:r,token:i}=this;return r.trackEvent(new PublishEvent({token:i,traceId:n})),{getTraceId:()=>n,trackPublishStarted({totalDurationWithRetries:t,retryTimes:o,sfuResource:s,peerClientPerfStats:a,protocol:c}){const{optionsDuration:u,postDuration:l,timeToCandidate:d,timeToConnected:h,sdpExchangeDuration:p,sdpExchangeTransport:f,setRemoteDescDuration:g,peerConnectionDuration:m}=a,{edpInitialConnectDuration:v,edpInitialConnectRetries:E,edpInitialStateDuration:S,edpStateUpdateCount:_}=e;r.trackEvent(new PublishStartedEvent({token:i,traceId:n,optionsDuration:u,postDuration:l,timeToCandidate:d,totalDuration:h,edpInitialConnectDuration:v,edpInitialConnectRetries:E,edpInitialStateDuration:S,edpStateUpdateCount:_,sdpExchangeDuration:p,sdpExchangeTransport:f,setRemoteDescDuration:g,peerConnectionDuration:m,publishRetries:o,totalDurationWithRetries:t,sfuResource:s,protocol:c}))},trackPublishFailed(e,o){const s=((e,t,n)=>{if(e instanceof StageClientError)return e;let r="";return e instanceof Lt.AxiosError&&(r+=`AxiosError - ${e.code}`),new StageClientError(Object.assign(Object.assign(Object.assign({},Lr.PUBLISH_FAILURE),{action:Sa,token:t,traceId:n,tag:Or,location:"publish",details:`${r} ${e.message}`}),{fatal:!0}))})(e,i,n);r.trackEvent(new PublishFailedEvent({token:i,traceId:n,code:s.code,message:s.message,fatal:s.fatal,nominal:s.nominal,protocol:o}));const a=new StageClientError(Object.assign(Object.assign({},Lr.PUBLISH_FAILURE),{action:t,token:i,traceId:n,tag:Or,location:"publish"}));return e instanceof StageClientError&&(a.fatal=e.fatal,a.nominal=e.nominal,a.location=`publish > ${e.location}`),r.trackError(a),s},trackUnpublish:()=>{r.trackEvent(new UnpublishEvent({token:i,traceId:n}))},trackEndSucceeded:(e,t)=>{r.trackEvent(new PublishEndedEvent({token:i,isUnpublishSuccessful:!0,traceId:n,reason:e,protocol:t}))},trackEndFailed:(e,t)=>{const o=new StageClientError(Object.assign(Object.assign({},Lr.UNPUBLISH_FAILURE),{token:i,traceId:n,tag:wr,location:"unpublish"}));return e!==Mr.UNLOAD&&e!==Mr.UNPUBLISH||this.analyticsTracker.trackError(o),r.trackEvent(new PublishEndedEvent({token:i,isUnpublishSuccessful:!1,traceId:n,reason:e,protocol:t})),o},createSeiNotPublishingVideoError:()=>_a(Lr.SEI_INSERT_NOT_PUBLISHING_VIDEO,i,n),createSeiInBandMessagingNotEnabledError:()=>_a(Lr.SEI_INSERT_INBAND_NOT_ENABLED,i,n)}}}var ya,ba,Ta=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};!function(e){e.DISCONNECTED="disconnected",e.CONNECTING="connecting",e.CONNECTED="connected",e.ERRORED="errored"}(ya||(ya={})),function(e){e.STATE_CHANGE="stateChange",e.ERROR="error",e.TRANSFORM_ERROR="transformError"}(ba||(ba={}));class StagePublication extends TypedEmitter{constructor(e,t,n,r){super(),this.token=e,this.stageConnection=t,this.nonScopedLogger=n,this.analyticsTracker=r,this.streamsToPublish=[],this.publicationState=ya.DISCONNECTED,this.latestPubAttemptNum=0,this.startConnectingTimestamp=-1,this.action=mr.PUBLISH,this.start=e=>{this.publicationState===ya.DISCONNECTED||this.publicationState===ya.ERRORED?(this.streamsToPublish=e,this.latestPubAttemptNum=0,this.processStateUpdate()):this.logger.warn({msg:"publication cannot be started if not in disconnected or error state"})},this.requestRTCStats=e=>Ta(this,void 0,void 0,(function*(){return this.peerClient.requestRTCStats(e)})),this.stop=(e=!1)=>Ta(this,void 0,void 0,(function*(){this.peerClient.off(Bt,this.onPeerClientConnectionStateChange),this.peerClient.off(Vt,this.onPeerClientTransformError),yield this.unpublish(e),this.updateState(ya.DISCONNECTED)})),this.processStateUpdate=e=>{const{publicationState:t}=this;t===ya.DISCONNECTED||t===ya.ERRORED?0===this.latestPubAttemptNum&&(this.startConnectingTimestamp=performance.now(),this.updateState(ya.CONNECTING),this.tryPublish()):t===ya.CONNECTING?e===Gt.CONNECTED&&this.updateState(ya.CONNECTED):t===ya.CONNECTED&&e===Gt.FAILED&&(this.attemptTracker&&this.attemptTracker.trackEndFailed(Mr.CONNECTION_FAIL,this.peerClient.getProtocol()),0===this.latestPubAttemptNum&&(this.startConnectingTimestamp=performance.now(),this.updateState(ya.CONNECTING),this.tryPublish()))},this.updateState=e=>{this.publicationState=e,this.emit(ba.STATE_CHANGE,e)},this.tryPublish=()=>Ta(this,void 0,void 0,(function*(){if(this.latestPubAttemptNum++,this.latestPubAttemptNum<=4){const e=this.stageConnection.getConnectionStats();this.attemptTracker=this.publishTracker.trackPublish(e);try{this.logger.debug({msg:`attempting to publish, attemptNum: ${this.latestPubAttemptNum}`}),yield this.publish(this.streamsToPublish,this.attemptTracker.getTraceId()),this.logger.debug({msg:"publish succeeded!"});const e=this.peerClient.getSfuResource(),t=this.latestPubAttemptNum-1,n=performance.now()-this.startConnectingTimestamp,r=this.peerClient.getActionMeasurements();this.attemptTracker.trackPublishStarted({sfuResource:e,totalDurationWithRetries:n,retryTimes:t,peerClientPerfStats:r,protocol:this.peerClient.getProtocol()}),this.latestPubAttemptNum=0}catch(e){this.logger.error({msg:"publish failed!",err:e});const t=this.attemptTracker.trackPublishFailed(e,this.peerClient.getProtocol()),n=t.code===Lr.OPERATION_ABORTED.code,r=t.fatal,i=4===this.latestPubAttemptNum;if(n)return;if(r||i)return this.logger.error({msg:`Stopping attempts: isFatal=${r}, isLastAttempt=${i}`,err:e}),this.updateState(ya.ERRORED),void this.emit(ba.ERROR,t);const o=1e3*Math.pow(2,this.latestPubAttemptNum);this.logger.debug({msg:`attempt failed, retrying in ${o}ms`}),this.nextAttemptTimerId=window.setTimeout((()=>{this.tryPublish()}),o)}}})),this.publish=(e,t)=>Ta(this,void 0,void 0,(function*(){this.peerClient.initStreamsToPublish(e);yield this.peerClient.connect({audioOnly:!1,traceId:t})})),this.unpublish=(e=!1)=>Ta(this,void 0,void 0,(function*(){if(window.clearTimeout(this.nextAttemptTimerId),this.publicationState===ya.DISCONNECTED||this.publicationState===ya.ERRORED||!this.attemptTracker)return;this.attemptTracker.trackUnpublish();const t=e?Mr.UNLOAD:Mr.UNPUBLISH,n=this.peerClient.getProtocol();try{e?this.peerClient.disconnect(e):yield this.peerClient.disconnect(e),this.attemptTracker.trackEndSucceeded(t,n)}catch(e){this.attemptTracker.trackEndFailed(t,n)}})),this.replaceOrUpdateStream=e=>Ta(this,void 0,void 0,(function*(){this.streamsToPublish.find((t=>t.track.kind===e.track.kind))?this.streamsToPublish=this.streamsToPublish.map((t=>t.track.kind===e.track.kind?e:t)):this.streamsToPublish.push(e),yield this.peerClient.replaceOrUpdateStream(e)})),this.onPeerClientConnectionStateChange=e=>{this.logger.debug({msg:`onPeerClientConnectionStateChange: ${e}`,state:e}),this.processStateUpdate(e)},this.onPeerClientTransformError=e=>{this.emit(ba.TRANSFORM_ERROR,e)},this.onIncompatibleCodecs=e=>Ta(this,void 0,void 0,(function*(){yield this.peerClient.onIncompatibleCodecs(e)})),this.sendSeiMessage=(e,t)=>{if(this.publicationState!==ya.CONNECTED)return this.attemptTracker&&this.emit(ba.ERROR,this.attemptTracker.createSeiNotPublishingVideoError()),ln.err(Is.NOT_PUBLISHING_VIDEO);const n=this.peerClient.sendSeiMessage(e,t),r=ln.getErr(n);return r&&this.attemptTracker&&(r===Is.INBAND_MESSAGING_NOT_ENABLED?this.emit(ba.ERROR,this.attemptTracker.createSeiInBandMessagingNotEnabledError()):r===Is.NOT_PUBLISHING_VIDEO&&this.emit(ba.ERROR,this.attemptTracker.createSeiNotPublishingVideoError())),n},this.peerClient=new StagePeerClient(e,this.nonScopedLogger,this.action,kr(this.action),br(),this.analyticsTracker,void 0,t,void 0),this.logger=new ScopedLogger(n,de.PUBLICATION),this.peerClient.on(Bt,this.onPeerClientConnectionStateChange),this.peerClient.on(Vt,this.onPeerClientTransformError),this.publishTracker=new PublishTracker(this.analyticsTracker,this.token)}removeTrack(e){return Ta(this,void 0,void 0,(function*(){this.streamsToPublish=this.streamsToPublish.filter((t=>t.track.kind!==e)),yield this.peerClient.removeTrack(e)}))}}var Ca,Ia=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};class LocalStageParticipant extends StageParticipant{constructor(e,t,n,r,i){super(e,new ScopedLogger(n,de.LOCAL_PARTICIPANT)),this.onPublicationStateChange=e=>{switch(this.logger.debug({msg:"publicationStateChange",state:e}),e){case"connected":this.connection.setStagePublishing(!0),this.updatePublishState(oa.PUBLISHED);break;case"connecting":this.updatePublishState(oa.ATTEMPTING_PUBLISH);break;case"errored":this.updatePublishState(oa.ERRORED),this.connection.setStagePublishing(!1);break;default:return void this.logger.warn({msg:"FIXME onPublicationStateChange UNHANDLED STATE",state:e})}},this.onPublicationError=e=>{this.emit(va.ERROR,e)},this.updatePublishState=e=>{this.info.isPublishing=e===oa.PUBLISHED,this.publishState=e,this.emit(va.PUBLICATION_STATE_CHANGE,this.publishState)},this.handleMute=e=>{e.streamType===qn.AUDIO&&(this.audioMuted=e.isMuted,this.info.audioMuted=e.isMuted),e.streamType===qn.VIDEO&&(this.videoStopped=e.isMuted,this.info.videoStopped=e.isMuted),this.connection.emitStageState(this.audioMuted,this.videoStopped),this.emit(va.MEDIA_STREAM_MUTE_CHANGED,e)},this.handleInsertSeiMsgRequest=(e,t,n)=>{this.sendSeiMessage(t,null==n?void 0:n.repeatCount)},this.publish=e=>{this.logger.debug({msg:"publish"}),e.forEach((e=>{e&&(this.setupStreamListeners(e),e.streamType===qn.AUDIO?(this.audioStream=e,this.audioMuted=!e.mediaStreamTrack.enabled,this.info.audioMuted=this.audioMuted):e.streamType===qn.VIDEO&&(this.videoStream=e,this.videoStopped=!e.mediaStreamTrack.enabled,this.info.videoStopped=this.videoStopped),e.setGetStats(this.publication.requestRTCStats))})),this.connection.emitStageState(this.audioMuted,this.videoStopped);const t=e.map((e=>rs(e)));this.publication.start(t)},this.cleanup=()=>this.removeAllListeners(),this.quickUnpublish=()=>this.publishState!==oa.NOT_PUBLISHED&&this.publishState!==oa.ERRORED&&void this.publication.stop(!0),this.onIncompatibleCodecs=e=>Ia(this,void 0,void 0,(function*(){yield this.publication.onIncompatibleCodecs(e)})),this.sendSeiMessage=(e,t=0)=>this.publication.sendSeiMessage(e,t),this.sendSeiMessageString=(e,t=0)=>{const n=(new TextEncoder).encode(e);return this.publication.sendSeiMessage(n,t)},this.connection=r,this.createPublication=()=>{const e=new StagePublication(t,r,n,i);return e.on(ba.STATE_CHANGE,this.onPublicationStateChange),e.on(ba.ERROR,this.onPublicationError),e.on(ba.TRANSFORM_ERROR,this.onPublicationError),e},this.publication=this.createPublication()}setupStreamListeners(e){e.on(na.LOCAL_STREAM_MUTE_CHANGED,this.handleMute),e.streamType===qn.VIDEO&&e.on(na.LOCAL_STREAM_INSERT_SEI_MSG_REQUEST,this.handleInsertSeiMsgRequest)}removeTrack(e){var t,n,r;e.streamType===qn.AUDIO?(null===(t=this.audioStream)||void 0===t||t.off(na.LOCAL_STREAM_MUTE_CHANGED,this.handleMute),this.audioStream=void 0,this.audioMuted=!0,this.info.audioMuted=!0):e.streamType===qn.VIDEO&&(null===(n=this.videoStream)||void 0===n||n.off(na.LOCAL_STREAM_MUTE_CHANGED,this.handleMute),null===(r=this.videoStream)||void 0===r||r.off(na.LOCAL_STREAM_INSERT_SEI_MSG_REQUEST,this.handleMute),this.videoStream=void 0,this.videoStopped=!0,this.info.videoStopped=!0),this.connection.emitStageState(this.audioMuted,this.videoStopped),this.publication.removeTrack(e.streamType)}replaceOrAddTrack(e){return Ia(this,void 0,void 0,(function*(){this.setupStreamListeners(e),e.setGetStats(this.publication.requestRTCStats),e.streamType===qn.AUDIO?(this.audioStream=e,this.audioMuted=!e.mediaStreamTrack.enabled):e.streamType===qn.VIDEO&&(this.videoStream=e,this.videoStopped=!e.mediaStreamTrack.enabled),this.connection.emitStageState(this.audioMuted,this.videoStopped);const t=rs(e);yield this.publication.replaceOrUpdateStream(t)}))}unpublish(){if(this.publishState===oa.NOT_PUBLISHED||this.publishState===oa.ERRORED)return;this.logger.debug({msg:"unpublish"}),this.connection.setStagePublishing(!1),this.publication.stop(),this.publication.off(ba.STATE_CHANGE,this.onPublicationStateChange),this.publication.off(ba.ERROR,this.onPublicationError),this.publication.off(ba.TRANSFORM_ERROR,this.onPublicationError);const e=[this.audioStream,this.videoStream].filter((e=>!!e));e.forEach((e=>{e.cleanup()})),this.audioStream=void 0,this.videoStream=void 0,this.emit(va.MEDIA_STREAM_REMOVED,e),this.updatePublishState(oa.NOT_PUBLISHED),this.publication=this.createPublication()}}!function(e){e.STAGE_CONNECTION_STATE_CHANGED="stageConnectionStateChanged",e.STAGE_PARTICIPANT_JOINED="stageParticipantJoined",e.STAGE_PARTICIPANT_LEFT="stageParticipantLeft",e.STAGE_PARTICIPANT_STREAMS_ADDED="stageParticipantStreamsAdded",e.STAGE_PARTICIPANT_STREAMS_REMOVED="stageParticipantStreamsRemoved",e.STAGE_STREAM_MUTE_CHANGED="stageStreamMuteChanged",e.STAGE_STREAM_SEI_MESSAGE_RECEIVED="stageStreamSeiMessageReceived",e.STAGE_STREAM_LAYERS_CHANGED="stageStreamLayersChanged",e.STAGE_STREAM_LAYER_SELECTED="stageStreamLayerSelected",e.STAGE_STREAM_ADAPTION_CHANGED="stageStreamAdaptionChanged",e.STAGE_PARTICIPANT_SUBSCRIBE_STATE_CHANGED="stageParticipantSubscribeStateChanged",e.STAGE_PARTICIPANT_PUBLISH_STATE_CHANGED="stageParticipantPublishStateChanged",e.ERROR="error",e.STAGE_LEFT="stageLeft"}(Ca||(Ca={}));var Ra=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))};const Oa=e=>!!e;class Stage extends TypedEmitter{constructor(e,t){super(),this.connectionState=ds.DISCONNECTED,this.participants=new Map,this.connectionStateErrored=!1,this.onConnectionStateChanged=(e,t)=>{var n,r;this.connectionState=e,e===ds.ERRORED&&(this.connectionStateErrored=!0),e===ds.CONNECTED&&this.localParticipant&&this.localParticipant.publishState!==oa.NOT_PUBLISHED&&this.stageConnection.emitStageState(null===(n=this.localParticipant)||void 0===n?void 0:n.audioMuted,null===(r=this.localParticipant)||void 0===r?void 0:r.videoStopped);if(e===ds.CONNECTED&&this.connectionStateErrored&&(this.connectionStateErrored=!1,this.refreshStrategy()),e===ds.DISCONNECTED){if(t&&t!==us.CLIENT_RECONNECT&&t!==us.USER_INITIATED){let e=wa.UNKNOWN;!function(e){return Object.values(wa).includes(e)}(t)?this.logger.warn({msg:`DISCONNECTED reason is not a StageLeftReason: ${t}`}):e=t,this.cleanup(e)}}else this.emit(Ca.STAGE_CONNECTION_STATE_CHANGED,this.connectionState)},this.setupLocalParticipantOnce=()=>{var e;this.localParticipant?this.analyticsTracker.trackEventNoSharedProps(new TraceEvent(this.token,null!==(e=this.joinTraceId)&&void 0!==e?e:new TraceId,"reusing local participant from repeat join",mr.JOIN,"")):this.createLocalParticipant()},this.createLocalParticipant=()=>{const e=function(e){var t,n;const r=new Set;return e.token.claims.capabilities.allow_publish&&r.add(ia.PUBLISH),e.token.claims.capabilities.allow_subscribe&&r.add(ia.SUBSCRIBE),{id:e.token.participantID,userId:null!==(t=e.token.userID)&&void 0!==t?t:"",attributes:null!==(n=e.token.claims.attributes)&&void 0!==n?n:{},capabilities:r,isLocal:!0,userInfo:{},videoStopped:e.videoStopped,audioMuted:e.audioMuted,isPublishing:e.isPublishing}}({token:this.token,videoStopped:!0,audioMuted:!0,isPublishing:!1});this.localParticipant=new LocalStageParticipant(e,this.token,this.logger.unwrap(),this.stageConnection,this.analyticsTracker),this.localParticipant.on(va.PUBLICATION_STATE_CHANGE,(e=>{this.onPublishStateChanged(this.localParticipant.info,e)})),this.localParticipant.on(va.MEDIA_STREAM_REMOVED,this.onLocalStreamsRemoved),this.localParticipant.on(va.MEDIA_STREAM_MUTE_CHANGED,(e=>{this.localParticipant?this.onStreamMuteChange(this.localParticipant.info,e):this.logger.warn({msg:"tried to emit a stream mute change event for undefined local participant"})})),this.localParticipant.on(va.ERROR,(e=>{this.errorManager.handleError(e,Hs.PUBLISH_ERROR)})),this.emit(Ca.STAGE_PARTICIPANT_JOINED,e)},this.onRemoteParticipantJoined=e=>{if(e.id===this.token.participantID)return;const t=function(e){return{id:e.id,userId:e.userId,attributes:e.attributes,capabilities:new Set([ia.SUBSCRIBE]),isLocal:!1,userInfo:{},videoStopped:e.videoStopped,audioMuted:e.audioMuted,isPublishing:e.isPublishing}}(e);if(this.participants.has(t.id))return void this.logger.warn({msg:"Remote participant already tracked"});let n=Fs.NONE;t.capabilities.has(ia.SUBSCRIBE)&&(n=ln.getOk_or(this.strategyWrapper.shouldSubscribeToParticipant(t),n),this.updateManagerWithExternalSubscribeConfig(t,"joined"));const r=this.configManager.getSubscribeConfigSnapshot(t.id),i=new RemoteStageParticipant(t,this.token,this.stageConnection,this.logger.unwrap(),n,r,this.analyticsTracker,e.isPublishing);this.participants.set(t.id,i),this.setupRemoteParticipantListeners(i),this.emit(Ca.STAGE_PARTICIPANT_JOINED,i.info),i.updateSubscribeStateIfNecessary(n)},this.setupRemoteParticipantListeners=e=>{e.on(ga.SUBSCRIPTION_STATE_CHANGE,(t=>{this.onParticipantSubscribeStateChanged(e.info.id,t)})),e.on(ga.MEDIA_STREAM_ADDED,(t=>{const n=this.participants.get(e.info.id);if(n){for(const e of t)this.setupRemoteParticipantStreamEvents(n.info,e);this.emit(Ca.STAGE_PARTICIPANT_STREAMS_ADDED,n.info,ca(t)),this.updateStreamLayerForParticipantInfo(e.info,e.streams)}else this.logger.warn({msg:"Got stream add for participant no longer being tracked"})})),e.on(ga.MEDIA_STREAM_REMOVED,(t=>{const n=this.participants.get(e.info.id);n?this.emit(Ca.STAGE_PARTICIPANT_STREAMS_REMOVED,n.info,ca(t)):this.logger.warn({msg:"Got stream remove for participant no longer being tracked"})})),e.on(ga.MEDIA_STREAM_MUTE_CHANGED,(t=>{this.onStreamMuteChange(e.info,t.remote)})),e.on(ga.ERROR,(e=>{this.errorManager.handleError(e,Hs.SUBSCRIBE_ERROR)})),e.on(ga.MEDIA_STREAM_SEI_MESSAGE_RECEIVED,(t=>{this.onSeiMessageReceived(e.info,t)}))},this.onRemoteParticipantLeft=e=>{if(this.connectionState!==ds.CONNECTED)return;const t=this.participants.get(e);t?(t.participantLeave(),t.unsubscribe(),t.cleanup(),this.participants.delete(e),this.emitParticipantLeave(t.info)):this.logger.warn({msg:"Remote participant no longer tracked"})},this.emitParticipantLeave=e=>{this.emit(Ca.STAGE_PARTICIPANT_LEFT,e)},this.onRemoteParticipantStateChanged=e=>{const t=this.participants.get(e.id);if(!t)return void this.logger.warn({msg:"Remote participant updated but not tracked"});t.updatePublishState(e.isPublishing)&&this.onPublishStateChanged(t.info,t.publishState),t.updateStreamState(e.audioMuted,e.videoStopped);const n=this.strategyWrapper.shouldSubscribeToParticipant(t.info);if(ln.isNotOk(n))return;this.updateManagerWithExternalSubscribeConfig(t.info,"updated");const r=this.configManager.getSubscribeConfigSnapshot(t.info.id),i=ln.getOk_or(n,Fs.NONE);t.updateSubscribeStateIfNecessary(i,r)},this.onPublishStateChanged=(e,t)=>{this.emit(Ca.STAGE_PARTICIPANT_PUBLISH_STATE_CHANGED,e,t)},this.onParticipantSubscribeStateChanged=(e,t)=>{const n=this.participants.get(e);n?this.emit(Ca.STAGE_PARTICIPANT_SUBSCRIBE_STATE_CHANGED,n.info,t):this.logger.warn({msg:"Remote participant subscribe state changed but not tracked"})},this.onLocalStreamsAdded=e=>{this.localParticipant&&this.emit(Ca.STAGE_PARTICIPANT_STREAMS_ADDED,this.localParticipant.info,e)},this.onLocalStreamsRemoved=e=>{this.localParticipant&&this.emit(Ca.STAGE_PARTICIPANT_STREAMS_REMOVED,this.localParticipant.info,e)},this.onStreamMuteChange=(e,t)=>{this.emit(Ca.STAGE_STREAM_MUTE_CHANGED,e,t)},this.onSeiMessageReceived=(e,t)=>{this.emit(Ca.STAGE_STREAM_SEI_MESSAGE_RECEIVED,e,t)},this.leave=()=>{this.cleanup(wa.USER_INITIATED)},this.onBeforeUnloadCleanup=()=>{var e;this.participants.forEach((e=>{e.quickUnsubscribe()})),null===(e=this.localParticipant)||void 0===e||e.quickUnpublish(),this.stageConnection.disconnect(),this.emit(Ca.STAGE_CONNECTION_STATE_CHANGED,ds.DISCONNECTED),this.analyticsTracker.stop(!0)},this.cleanup=e=>{if(!this.localParticipant)return;this.analyticsTracker.trackEventNoSharedProps(new LeaveEvent({token:this.token,eventEndpoint:this.token.eventsURL,whipEndpoint:this.token.whipURL,traceId:this.joinTraceId,reason:e})),this.localParticipant.unpublish(),this.localParticipant.cleanup();const t=this.localParticipant.info;this.localParticipant=void 0,this.emitParticipantLeave(t);const n=this.participants.entries();for(const[e,t]of n)t.unsubscribe(),this.participants.delete(e),t.cleanup(),this.emitParticipantLeave(t.info);Cs.destroy(this.analyticsTracker.getSessionId()),this.stageConnection.disconnect(),this.emit(Ca.STAGE_CONNECTION_STATE_CHANGED,ds.DISCONNECTED),this.emit(Ca.STAGE_LEFT,e),this.analyticsTracker.stop(!1),window.removeEventListener("beforeunload",this.onBeforeUnloadCleanup)},this.refreshStrategy=()=>{this.participants.forEach((e=>{if(e.info.capabilities.has(ia.SUBSCRIBE)){const t=this.strategyWrapper.shouldSubscribeToParticipant(e.info);if(ln.isNotOk(t))return;const n=ln.getOk_or(t,Fs.NONE);this.updateManagerWithExternalSubscribeConfig(e.info,"updated");const r=this.configManager.getSubscribeConfigSnapshot(e.info.id);e.updateSubscribeStateIfNecessary(n,r),this.updateStreamLayerForParticipantInfo(e.info,e.streams)}})),this.updateStreamsToPublishIfNecessary()},this.updateManagerWithExternalSubscribeConfig=(e,t)=>{var n;const r=ln.getOk(this.strategyWrapper.subscribeConfiguration(e)),i=ln.getOk(this.getRemoteSubscribeConfiguration()),o=this.getInternalSubscribeOverrides(),s=e.id;let a=!1;r&&(a=this.configManager.handleExternalSubscribeConfigUpdate(s,r,Js.API));let c=!1;i&&(c=this.configManager.handleSubscribeConfigUpdate(s,i,Js.REMOTE));let u=!1;if(o&&(u=this.configManager.handleSubscribeConfigUpdate(s,o,Js.INTERNAL)),a||u||c){const e=this.configManager.getSubscribeConfigSnapshot(s);this.analyticsTracker.trackEventNoSharedProps(new MultihostSubscribeConfigurationEvent(this.token,null!==(n=this.joinTraceId)&&void 0!==n?n:br(),"joined"===t?"initial":"ad-hoc",s,e))}},this.getRemoteSubscribeConfiguration=()=>{const e=Ln.getRemoteSubscribeConfig({customerId:this.token.customerId});return e?ln.ok(e):ln.err("No payload found")},this.updateStreamsToPublishIfNecessary=()=>{var e;if(!this.localParticipant)return;if(!(null===(e=this.localParticipant)||void 0===e?void 0:e.info.capabilities.has(ia.PUBLISH)))return;const t=this.localParticipant.publishState!==oa.NOT_PUBLISHED&&this.localParticipant.publishState!==oa.ERRORED,n=this.strategyWrapper.shouldPublishParticipant(this.localParticipant.info);if(ln.isNotOk(n))return;let r=ln.getOk_or(n,!1);if(!t&&!r)return;if(t&&!r)return void this.localParticipant.unpublish();const i=this.strategyWrapper.stageStreamsToPublish();if(ln.isNotOk(i)){const e=ln.getErr(i);if(e instanceof Error&&"UserStrategy"===e.cause)throw e;return}const o=ln.getOk_or(i,[]);r=r&&o.length>0,!t&&r?(this.localParticipant.publish(o),this.onLocalStreamsAdded(o)):this.syncTracksToPublish(o)},this.syncTracksToPublish=e=>{var t;if(!this.localParticipant)return;const n=this.localParticipant.audioStream,r=this.localParticipant.videoStream,{updates:i,streamsToAdd:o,streamsToRemove:s}=this.determineStreamUpdates(n,r,e);if(i.length){for(const e of i)e.newStream?null===(t=this.localParticipant)||void 0===t||t.replaceOrAddTrack(e.newStream):e.oldStream&&this.localParticipant.removeTrack(e.oldStream);0!==s.length&&this.onLocalStreamsRemoved(s),0!==o.length&&this.onLocalStreamsAdded(o)}},this.determineStreamUpdates=(e,t,n=[])=>{const r=[],i=n.slice(0,2);if(i.sort(((e,t)=>e.streamType===qn.AUDIO?-1:1)),0===i.length)e&&r.push({oldStream:e}),t&&r.push({oldStream:t});else if(1===i.length){const n=i[0];n.streamType===qn.AUDIO?t&&r.push({oldStream:t}):n.streamType===qn.VIDEO&&e&&r.push({oldStream:e})}i.forEach((n=>{var i,o;n.streamType===qn.AUDIO?e?e.id===n.id&&(0,mn.isEqual)(e.mediaConfig,n.mediaConfig)||(!!(null===(i=e.mediaConfig)||void 0===i?void 0:i.stereo)!=!!(null===(o=n.mediaConfig)||void 0===o?void 0:o.stereo)&&this.logger.warn({msg:"Ignoring change to audio stream's stereo configuration. Re-publish to change stereo configuraiton."}),r.push({oldStream:e,newStream:n})):r.push({newStream:n}):n.streamType===qn.VIDEO&&(t?t.id===n.id&&(0,mn.isEqual)(t.mediaConfig,n.mediaConfig)||r.push({oldStream:t,newStream:n}):r.push({newStream:n}))}));const o=r.map((e=>e.newStream)).filter(Oa),s=r.map((e=>e.oldStream)).filter(Oa);return{updates:r,streamsToAdd:o,streamsToRemove:s}},this.onReassignmentMessage=e=>Ra(this,void 0,void 0,(function*(){if(St("disableReassignments"))return void this.logger.debug({msg:"REASSIGN message ignored: disableReassignments is configured"});if(!po.browser.isChrome())return void this.logger.debug({msg:"REASSIGN message ignored: browser is not chrome"});const t=br();this.trackReassignmentRequest(e,t);const n=this.participants.get(e.remoteParticipantId),r=this.token.participantID,i=function(e,{localParticipantId:t,remoteParticipant:n}){const{participantId:r}=e;if(t!==r)return ln.err(Object.assign(Object.assign({},Lr.REASSIGNMENT_REQUEST_INVALID_LOCAL_PARTICIPANT_ID),{details:`Invalid participantId received: ${r}`}));if(!n)return ln.err(Object.assign(Object.assign({},Lr.REASSIGNMENT_REQUEST_INVALID_REMOTE_PARTICIPANT_ID),{details:`Invalid remoteParticipantId received: ${n}`}));if(n.isReassigning())return ln.err(Lr.REASSIGNMENT_REQUEST_ALREADY_IN_PROGRESS);const i=n.subscription.peerClient.getConnectionState();return[Gt.CONNECTED,Gt.DISCONNECTED].includes(i)?ln.ok(n):ln.err(Object.assign(Object.assign({},Lr.REASSIGNMENT_REQUEST_INVALID_REMOTE_PEER_CONNECTION_STATE),{details:`connectionState: ${i}`}))}(e,{localParticipantId:r,remoteParticipant:n});if(!i.ok)this.trackReassignmentRequestRejected(i.error,t);else try{const{token:n,nodeOverride:r}=e;yield i.value.triggerIceRestart({assignmentToken:n,traceId:t,nodeOverride:r})}catch(e){this.logger.error({msg:"Reassignment failed.",err:e})}})),this.onIncompatibleCodecsMessage=e=>Ra(this,void 0,void 0,(function*(){var t;yield null===(t=this.localParticipant)||void 0===t?void 0:t.onIncompatibleCodecs(e.codecs)})),this.analyticsTracker=new AnalyticsTracker;const n=yt();this.logger=new ScopedLogger(new Logger(n),de.STAGE),this.strategyWrapper=new StageStrategyWrapper(t,this.logger),this.configManager=new ConfigManager({logger:this.logger.unwrap(),subscribeDefaults:{jitterBuffer:{minDelayWhenPublishing:fn.DEFAULT,minDelayWhenSubscribeOnly:fn.DEFAULT},inBandMessaging:{enabled:!1},simulcast:{initialLayerPreference:un.LOWEST_QUALITY,layerPollingEnabled:!0,layerPollingIntervalMs:3e3}}}),this.errorManager=new StageErrorManager(this.logger.unwrap());try{this.token=fi(e,this.analyticsTracker)}catch(t){const n=new StageClientError(Object.assign({action:mr.JOIN,token:e,traceId:br(),tag:Rr,location:"Stage.constructor"},Lr.MALFORMED_TOKEN));throw t instanceof Error&&(n.details=t.message),this.errorManager.handleError(n,Hs.JOIN_ERROR)||t}Ln.cacheRealTimeContext({customerId:this.token.customerId}),this.stageConnection=new StageConnection(this.token,this.logger.unwrap(),this.analyticsTracker),this.setupListeners()}setupListeners(){this.stageConnection.on(Hr,((e,t)=>{this.onConnectionStateChanged(e,t)})),this.stageConnection.on(Br,(e=>{this.onRemoteParticipantJoined(e)})),this.stageConnection.on(Ur,(e=>{this.onRemoteParticipantLeft(e.id)})),this.stageConnection.on(Fr,(e=>{var t;e.id!==(null===(t=this.localParticipant)||void 0===t?void 0:t.info.id)&&this.onRemoteParticipantStateChanged(e)})),this.stageConnection.on($r,(e=>Ra(this,void 0,void 0,(function*(){yield this.onReassignmentMessage(e)})))),this.stageConnection.on(qr,(e=>Ra(this,void 0,void 0,(function*(){yield this.onIncompatibleCodecsMessage(e)})))),this.stageConnection.on(Wr,(e=>{e instanceof StageClientError&&this.analyticsTracker.trackError(e),this.errorManager.handleError(e,Hs.JOIN_ERROR)})),this.errorManager.on(Ks.ERROR,(e=>{this.emit(Ca.ERROR,e)}))}setupRemoteParticipantStreamEvents(e,t){const n=t.remote;t.on(Zs.ADAPTION_CHANGED,(t=>{this.emit(Ca.STAGE_STREAM_ADAPTION_CHANGED,e,n,t)})),t.on(Zs.LAYERS_CHANGED,(r=>{this.emit(Ca.STAGE_STREAM_LAYERS_CHANGED,e,n,r),this.updateStreamLayerForParticipantInfo(e,[t])})),t.on(Zs.LAYER_SELECTED,((t,r)=>{this.emit(Ca.STAGE_STREAM_LAYER_SELECTED,e,n,t,r)})),t.layers.length>0&&(this.emit(Ca.STAGE_STREAM_LAYERS_CHANGED,e,n,n.getLayers()),this.emit(Ca.STAGE_STREAM_LAYER_SELECTED,e,n,n.getSelectedLayer(),ta.SELECTED))}join(){return Ra(this,void 0,void 0,(function*(){Ln.markSdkUsage(),this.analyticsTracker.start(),this.joinTraceId=br(),this.analyticsTracker.trackEvent(new JoinEvent({token:this.token,eventEndpoint:this.token.eventsURL,whipEndpoint:this.token.whipURL,traceId:this.joinTraceId}));try{this.token.assertTokenIsUnexpired(br(),Rr,"join")}catch(e){throw this.errorManager.handleError(e,Hs.JOIN_ERROR)||e}try{this.joinTraceId=yield this.stageConnection.connect(this.joinTraceId),this.connectionState===ds.CONNECTED&&(this.setupLocalParticipantOnce(),this.updateStreamsToPublishIfNecessary()),window.addEventListener("beforeunload",this.onBeforeUnloadCleanup)}catch(e){throw this.logger.error({err:e,msg:"error joining stage"}),this.errorManager.handleError(e,Hs.JOIN_ERROR,!1)||e}}))}replaceStrategy(e){this.strategyWrapper.setStrategy(e),this.refreshStrategy()}getInternalSubscribeOverrides(){const e=this.strategyWrapper.hasStrategy("preferredLayerForStream"),t=this.hasListenersFor(Ca.STAGE_STREAM_LAYERS_CHANGED)||this.hasListenersFor(Ca.STAGE_STREAM_ADAPTION_CHANGED)||this.hasListenersFor(Ca.STAGE_STREAM_LAYER_SELECTED);return{simulcast:{layerPollingEnabled:e||t}}}updateStreamLayerForParticipantInfo(e,t){t.forEach((t=>{if("audio"===t.streamType)return;const n=this.strategyWrapper.preferredLayerForStream(e,t.remote),r=ln.getOk_or(n,void 0);t.setLayer(r)}))}trackReassignmentRequestRejected(e,t){const{token:n}=this,r=new StageClientError(Object.assign(Object.assign({},e),{token:n,action:mr.JOIN,traceId:t,tag:Ar,location:"publish"}));this.logger.error({err:r,msg:"Reassignment request rejected."}),this.analyticsTracker.trackError(r)}trackReassignmentRequest(e,t){const{token:n}=this;this.analyticsTracker.trackEvent(new ReassignmentRequestEvent({token:n,traceId:t,targetLocalParticipantId:e.participantId,targetRemoteParticipantId:e.remoteParticipantId}))}}var wa;!function(e){e.UNKNOWN="unknown",e.USER_INITIATED="user-initiated",e.TOKEN_REUSED="token-reused",e.PARTICIPANT_DISCONNECTED="participant-disconnected",e.STAGE_DELETED="stage-deleted"}(wa||(wa={}));const Aa=a})(),r})()));